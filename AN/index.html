<!-- Angel Numbers Tracker v1.1A2 -->
<!--
Version Detail Notes (BOF)
App: Angel Numbers Tracker
Version: v1.1A2
Base: v1.1A1 (conceptual baseline)
Key changes:
- Home panel is Identify (with fixed bottom actions + scrollable meaning/details area).
- Start swipe left/right only when touch starts within 150px of screen edge.
- Calendar day list popup implemented: tight list of entries for a day; tap an entry to view details.
- Add-to-Calendar opens a popup (number + notes + Add). Removed “in app only” wording and removed Copy/Export from Add popup.
- Removed Export button from Calendar screen.
- Version shown under logo (small, no padding). Triple-tap version shows heart modal message.
- No autofocus on number field to prevent keyboard on load.
- Scroll fixes: middle content scrolls; meaning/details area has its own right-side scrollbar.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Angel Numbers Tracker</title>

  <link rel="manifest" id="manifestLink" href="#" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;

      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --accent:#2b4e7a;

      --text:rgba(235,245,255,.88);
      --muted:rgba(235,245,255,.60);
      --muted2:rgba(235,245,255,.42);

      --btnBlue1:#2f6fff;
      --btnBlue2:#1b4fd8;

      --danger1:#3a0e16;
      --danger2:#6b1022;

      --radius:26px;
      --radius2:18px;
      --shadow:0 18px 40px rgba(0,0,0,.45);

      --pad:16px;
      --headerH:84px;
      --footerH:210px; /* accommodates 4 buttons + spacing */
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 30% -10%, rgba(45,120,255,.20), transparent 60%),
        radial-gradient(900px 500px at 85% 0%, rgba(150,80,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      touch-action: manipulation;
    }

    .app{
      position:relative;
      height:100%;
      width:100%;
      display:flex;
      flex-direction:column;
      padding-top:calc(var(--safeT) + 10px);
      padding-left:12px;
      padding-right:12px;
      padding-bottom:calc(var(--safeB) + 10px);
      gap:10px;
    }

    /* Top logo bar */
    .topbar{
      height:var(--headerH);
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:8px 10px 0 10px;
    }

    .logoBadge{
      width:52px;
      height:52px;
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(235,245,255,.14);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      margin-top:2px;
    }
    .logoBadge svg{width:36px;height:36px;opacity:.95}

    .brandWrap{
      flex:1 1 auto;
      min-width:0;
      padding-top:4px;
      display:flex;
      flex-direction:column;
      gap:0;
    }
    .brand{
      font-weight:800;
      letter-spacing:.2px;
      font-size:40px;
      line-height:1.05;
      background:linear-gradient(90deg, rgba(180,120,255,.95), rgba(70,140,255,.95));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow: 0 14px 35px rgba(0,0,0,.35);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin:0;
    }
    .versionTop{
      margin:0;
      padding:0;              /* no padding per request */
      font-size:12px;
      line-height:1;
      color:rgba(235,245,255,.35);
      letter-spacing:.2px;
      user-select:none;
      width:fit-content;
    }

    /* Main card */
    .card{
      position:relative;
      flex:1 1 auto;
      width:100%;
      border-radius:34px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(235,245,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding:0;
      display:flex;
      flex-direction:column;
    }

    .cardInner{
      position:relative;
      height:100%;
      width:100%;
      border-radius:34px;
      border:1px solid rgba(43,78,122,.55);
      margin:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background:
        radial-gradient(900px 420px at 35% 10%, rgba(60,120,255,.12), transparent 60%),
        radial-gradient(650px 420px at 90% 15%, rgba(160,80,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(12,21,40,.72), rgba(10,18,35,.76));
    }

    /* Horizontal panels */
    .panelStrip{
      position:relative;
      width:200%;
      height:100%;
      display:flex;
      transform:translateX(0%);
      transition: transform 220ms ease;
    }
    .panel{
      width:50%;
      height:100%;
      display:flex;
      flex-direction:column;
      padding:18px 18px 0 18px;
      gap:12px;
      overflow:hidden;
    }

    /* Identify panel layout: scrollable middle + fixed footer buttons */
    .panelTitle{
      font-size:44px;
      font-weight:800;
      letter-spacing:.2px;
      margin:4px 0 0 0;
      color:rgba(235,245,255,.90);
      text-shadow: 0 16px 35px rgba(0,0,0,.35);
    }

    .inputRow{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .field{
      flex:1 1 auto;
      height:64px;
      border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(235,245,255,.14);
      outline:none;
      color:rgba(235,245,255,.88);
      font-size:24px;
      padding:0 18px;
      box-shadow: inset 0 0 0 2px rgba(40,110,255,.20);
    }
    .field:focus{
      border-color: rgba(160,200,255,.34);
      box-shadow: inset 0 0 0 2px rgba(40,110,255,.34), 0 8px 20px rgba(0,0,0,.25);
    }

    .midScroll{
      position:relative;
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding-right:2px;
      padding-bottom:10px;
    }

    .detailsCard{
      border-radius:26px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
      border:1px solid rgba(235,245,255,.13);
      padding:16px 16px 12px 16px;
      box-shadow: inset 0 0 0 1px rgba(43,78,122,.22);
    }

    .detailsTop{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .bigNum{
      font-size:54px;
      font-weight:900;
      line-height:1;
      letter-spacing:.6px;
      margin:0;
    }
    .pill{
      flex:0 0 auto;
      border-radius:999px;
      padding:10px 14px;
      font-size:18px;
      color:rgba(235,245,255,.72);
      background:rgba(255,255,255,.04);
      border:1px solid rgba(235,245,255,.12);
      align-self:flex-start;
      margin-top:6px;
    }

    .meaningScroll{
      max-height:300px; /* internal scroll region requested */
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding-right:10px; /* space for scrollbar */
    }
    /* force visible scrollbar feel on WebKit */
    .meaningScroll::-webkit-scrollbar{width:8px}
    .meaningScroll::-webkit-scrollbar-thumb{
      background:rgba(235,245,255,.18);
      border-radius:999px;
    }
    .meaningScroll::-webkit-scrollbar-track{
      background:rgba(0,0,0,.12);
      border-radius:999px;
    }

    .para{
      margin:10px 0;
      color:rgba(235,245,255,.74);
      font-size:18px;
      line-height:1.35;
    }
    .meta{
      margin:10px 0 0 0;
      color:rgba(235,245,255,.55);
      font-size:18px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .divider{
      height:1px;
      background:rgba(235,245,255,.10);
      margin:14px 0 10px 0;
    }
    .hint{
      margin:10px 0 0 0;
      color:rgba(235,245,255,.42);
      font-size:16px;
      line-height:1.25;
    }

    .subFooter{
      margin-top:12px;
      color:rgba(235,245,255,.38);
      font-size:16px;
      line-height:1.25;
    }

    .btnDock{
      position:relative;
      flex:0 0 auto;
      padding:10px 0 calc(12px + var(--safeB)) 0;
      background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.18));
    }

    .btnStack{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .btn{
      width:100%;
      height:78px;
      border-radius:999px;
      border:1px solid rgba(235,245,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:rgba(235,245,255,.82);
      font-size:34px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 16px 30px rgba(0,0,0,.28);
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{
      background:linear-gradient(180deg, rgba(47,111,255,.95), rgba(27,79,216,.95));
      border-color: rgba(170,210,255,.26);
      color:white;
      text-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .btnDanger{
      background:linear-gradient(180deg, rgba(107,16,34,.72), rgba(58,14,22,.78));
      border-color: rgba(255,140,160,.18);
      color:rgba(255,235,238,.92);
    }

    .tinyFooterRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 4px 0 4px;
      color:rgba(235,245,255,.28);
      font-size:14px;
      user-select:none;
    }

    /* Calendar panel */
    .calHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-top:4px;
    }
    .calTitle{
      font-size:32px;
      font-weight:900;
      margin:6px 0 0 0;
      color:rgba(235,245,255,.88);
    }
    .calControls{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:6px;
    }
    .chipBtn{
      height:56px;
      padding:0 18px;
      border-radius:999px;
      border:1px solid rgba(235,245,255,.14);
      background:rgba(255,255,255,.04);
      color:rgba(235,245,255,.72);
      font-size:22px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .chipBtn:active{transform:translateY(1px)}

    .monthRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:4px;
    }
    select.monthSelect{
      flex:1 1 auto;
      height:58px;
      border-radius:20px;
      border:1px solid rgba(235,245,255,.14);
      background:rgba(255,255,255,.04);
      color:rgba(235,245,255,.80);
      font-size:22px;
      padding:0 16px;
      outline:none;
    }

    .dow{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:10px;
      margin-top:10px;
      padding:0 2px;
      color:rgba(235,245,255,.40);
      font-weight:800;
      font-size:16px;
      text-transform:uppercase;
      letter-spacing:.7px;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:10px;
      margin-top:12px;
      padding-bottom:12px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
      min-height:0;
    }
    .day{
      position:relative;
      height:70px;
      border-radius:18px;
      border:1px solid rgba(235,245,255,.10);
      background:rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(235,245,255,.52);
      font-size:20px;
      font-weight:800;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .day.isOther{opacity:.35}
    .day.isToday{
      border-color: rgba(160,200,255,.30);
      box-shadow: inset 0 0 0 2px rgba(40,110,255,.18);
    }
    .day.hasEntries{
      border-color: rgba(47,111,255,.26);
      box-shadow: inset 0 0 0 2px rgba(47,111,255,.16);
      color:rgba(235,245,255,.74);
    }

    .calHint{
      color:rgba(235,245,255,.34);
      font-size:16px;
      padding:10px 4px 14px 4px;
    }

    /* Modal system */
    .modalShade{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modalShade.show{display:flex}
    .modal{
      width:min(520px, 100%);
      border-radius:30px;
      background:linear-gradient(180deg, rgba(10,18,35,.94), rgba(8,14,28,.96));
      border:1px solid rgba(43,78,122,.65);
      box-shadow: 0 30px 70px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }
    .modalInner{
      padding:18px 18px 16px 18px;
    }
    .modalX{
      position:absolute;
      top:14px;
      right:14px;
      width:56px;
      height:56px;
      border-radius:18px;
      border:1px solid rgba(235,245,255,.14);
      background:rgba(255,255,255,.04);
      color:rgba(235,245,255,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:30px;
      font-weight:900;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .modalX:active{transform:translateY(1px)}

    .modalTitle{
      margin:6px 0 8px 0;
      font-size:40px;
      font-weight:900;
      color:rgba(235,245,255,.90);
    }
    .modalText{
      color:rgba(235,245,255,.66);
      font-size:18px;
      line-height:1.35;
      margin:0 0 12px 0;
    }

    .modalFieldLabel{
      font-size:18px;
      font-weight:800;
      color:rgba(235,245,255,.55);
      margin:12px 0 6px 0;
    }
    .modalInput{
      width:100%;
      height:60px;
      border-radius:18px;
      border:1px solid rgba(235,245,255,.14);
      background:rgba(255,255,255,.04);
      color:rgba(235,245,255,.86);
      outline:none;
      font-size:22px;
      padding:0 16px;
    }
    .modalTextarea{
      width:100%;
      height:96px;
      border-radius:18px;
      border:1px solid rgba(235,245,255,.14);
      background:rgba(255,255,255,.04);
      color:rgba(235,245,255,.86);
      outline:none;
      font-size:18px;
      padding:14px 16px;
      resize:none;
    }

    .modalBtns2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .modalBtn{
      height:68px;
      border-radius:999px;
      border:1px solid rgba(235,245,255,.16);
      background:rgba(255,255,255,.05);
      color:rgba(235,245,255,.80);
      font-size:28px;
      font-weight:900;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modalBtn:active{transform:translateY(1px)}
    .modalBtnPrimary{
      background:linear-gradient(180deg, rgba(47,111,255,.95), rgba(27,79,216,.95));
      border-color: rgba(170,210,255,.26);
      color:white;
    }

    /* Day list modal */
    .dayListWrap{
      margin-top:10px;
      border-radius:22px;
      border:1px solid rgba(235,245,255,.12);
      background:rgba(255,255,255,.03);
      overflow:hidden;
      max-height:360px;
    }
    .dayList{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      max-height:360px;
    }
    .dayRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px; /* vertically tight */
      border-bottom:1px solid rgba(235,245,255,.08);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dayRow:last-child{border-bottom:none}
    .dayRow:active{background:rgba(255,255,255,.04)}
    .dayRowNum{
      font-size:26px;
      font-weight:950;
      letter-spacing:.4px;
      color:rgba(235,245,255,.86);
    }
    .dayRowTime{
      font-size:16px;
      font-weight:800;
      color:rgba(235,245,255,.45);
    }
    .dayRowNote{
      margin-top:2px;
      font-size:14px;
      color:rgba(235,245,255,.40);
      line-height:1.2;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .dayRowLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    /* Heart modal */
    .heartBig{
      font-size:110px;
      line-height:1;
      text-align:center;
      margin:8px 0 0 0;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.35));
    }
    .heartMsg{
      text-align:center;
      font-size:28px;
      font-weight:900;
      margin:8px 0 18px 0;
      color:rgba(235,245,255,.90);
    }

    /* Small utility */
    .srOnly{
      position:absolute;
      left:-9999px;
      top:auto;
      width:1px;height:1px;
      overflow:hidden;
    }
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <div class="topbar">
      <div class="logoBadge" aria-hidden="true">
        <svg viewBox="0 0 64 64" fill="none">
          <path d="M32 10c8 0 14 6 14 14" stroke="rgba(235,245,255,.75)" stroke-width="3.4" stroke-linecap="round"/>
          <path d="M18 22c-7 3-10 8-10 14 0 9 8 16 18 16 2 0 4-.3 6-1.1" stroke="rgba(120,170,255,.85)" stroke-width="3.6" stroke-linecap="round"/>
          <path d="M46 22c7 3 10 8 10 14 0 9-8 16-18 16-2 0-4-.3-6-1.1" stroke="rgba(180,120,255,.85)" stroke-width="3.6" stroke-linecap="round"/>
          <path d="M20 36c6 0 8 10 12 10s6-10 12-10" stroke="rgba(235,245,255,.70)" stroke-width="3.2" stroke-linecap="round"/>
          <path d="M32 46v8" stroke="rgba(235,245,255,.55)" stroke-width="3.2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="brandWrap">
        <h1 class="brand">Angel Numbers Tracker</h1>
        <div class="versionTop" id="versionTop" title="Triple-tap">v1.1A2</div>
      </div>
    </div>

    <div class="card">
      <div class="cardInner">
        <div class="panelStrip" id="panelStrip">
          <!-- Panel 0: Identify -->
          <section class="panel" id="panelIdentify" aria-label="Identify Angel Number">
            <div class="panelTitle">Identify Angel Number</div>

            <div class="inputRow">
              <input
                id="numInput"
                class="field"
                inputmode="numeric"
                autocomplete="off"
                autocapitalize="off"
                spellcheck="false"
                placeholder="Enter a number (e.g., 1111)"
              />
            </div>

            <div class="midScroll" id="identifyMidScroll">
              <div class="detailsCard">
                <div class="detailsTop">
                  <p class="bigNum" id="bigNum">—</p>
                  <div class="pill" id="patternPill">Pattern: —</div>
                </div>

                <div class="meaningScroll" id="meaningScroll">
                  <div class="para" id="meaningText">
                    Enter a number above to see its commonly shared meaning.
                  </div>

                  <div class="divider"></div>

                  <div class="meta" id="lensText">
How to use: Treat the meaning as a reflective prompt—what it “means” depends on context and personal interpretation.

Cultural note: these meanings come from numerology/“angel number” traditions and vary by source. Treat as reflective prompts, not facts or predictions.
                  </div>
                </div>

                <div class="subFooter" id="tagline">Inspired by a real Angel.</div>
                <div class="subFooter">Local-only. No accounts. No cloud.</div>
              </div>
            </div>

            <div class="btnDock">
              <div class="btnStack">
                <div class="btn btnPrimary" id="btnAddToCalendar">Add to Calendar</div>
                <div class="btn" id="btnViewCalendar">View Calendar</div>
                <div class="btn" id="btnExportAll">Export</div>
                <div class="btn btnDanger" id="btnExit">Exit</div>
              </div>

              <div class="tinyFooterRow">
                <div id="footerLeft">v1.1A2</div>
                <div id="footerRight">developed by Keyth Jyles</div>
              </div>
            </div>
          </section>

          <!-- Panel 1: Calendar -->
          <section class="panel" id="panelCalendar" aria-label="Calendar">
            <div class="calHeader">
              <div class="calTitle">Calendar</div>
              <div class="calControls">
                <div class="chipBtn" id="btnToday">Today</div>
                <div class="chipBtn" id="btnBackToIdentify">Back</div>
              </div>
            </div>

            <div class="monthRow">
              <select class="monthSelect" id="monthSelect" aria-label="Month"></select>
            </div>

            <div class="dow">
              <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>

            <div class="grid" id="calGrid" aria-label="Calendar grid"></div>

            <div class="calHint">Tap a highlighted day to view entries.</div>

            <div class="btnDock">
              <div class="btnStack">
                <div class="btn" id="btnCalBackHome">Back</div>
                <div class="btn btnDanger" id="btnCalExit">Exit</div>
              </div>

              <div class="tinyFooterRow">
                <div>v1.1A2</div>
                <div></div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Shade -->
  <div class="modalShade" id="modalShade" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="modalBox">
      <div class="modalX" id="modalX" aria-label="Close">×</div>
      <div class="modalInner" id="modalInner"></div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      /* =========================
         Version / Constants
      ========================== */
      const APP_NAME = "Angel Numbers Tracker";
      const APP_VERSION = "v1.1A2";
      const LS_KEY = "angel_numbers_tracker_records_v1";
      const SW_CACHE = "angel-numbers-cache-v1.1A2";

      /* =========================
         Basic Helpers
      ========================== */
      const $ = (id)=>document.getElementById(id);

      function nowISO(){
        return new Date().toISOString();
      }
      function toLocalDateParts(d){
        const y = d.getFullYear();
        const m = d.getMonth()+1;
        const day = d.getDate();
        const pad = (n)=>String(n).padStart(2,"0");
        return { y, m, day, key:`${y}-${pad(m)}-${pad(day)}` };
      }
      function fmtTimeLocal(iso){
        const d = new Date(iso);
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${hh}:${mm}`;
      }
      function escapeHtml(s){
        return String(s||"").replace(/[&<>"']/g,(c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
      }

      /* =========================
         Storage
      ========================== */
      function loadRecords(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(!raw) return [];
          const arr = JSON.parse(raw);
          if(!Array.isArray(arr)) return [];
          return arr.filter(r=>r && typeof r==="object");
        }catch(_e){
          return [];
        }
      }
      function saveRecords(recs){
        localStorage.setItem(LS_KEY, JSON.stringify(recs));
      }

      let records = loadRecords();

      /* =========================
         Meanings / Patterns
      ========================== */

      function digitsOnly(s){
        return String(s||"").replace(/\D+/g,"").slice(0, 32);
      }

      function isAllSame(str){
        return str.length>0 && str.split("").every(ch=>ch===str[0]);
      }

      function isSequentialUp(str){
        if(str.length<3) return false;
        for(let i=1;i<str.length;i++){
          const a = Number(str[i-1]);
          const b = Number(str[i]);
          if(Number.isNaN(a)||Number.isNaN(b)) return false;
          if((a+1)%10 !== b) return false;
        }
        return true;
      }

      function isSequentialDown(str){
        if(str.length<3) return false;
        for(let i=1;i<str.length;i++){
          const a = Number(str[i-1]);
          const b = Number(str[i]);
          if(Number.isNaN(a)||Number.isNaN(b)) return false;
          if((a+9)%10 !== b) return false;
        }
        return true;
      }

      function isMirror(str){
        if(str.length<4) return false;
        const half = Math.floor(str.length/2);
        const left = str.slice(0, half);
        const right = str.slice(str.length-half);
        return left === right.split("").reverse().join("");
      }

      function isDoubleBlock(str){
        if(str.length!==4) return false;
        return (str[0]===str[1] && str[2]===str[3] && str[0]!==str[2]);
      }

      function isSandwich(str){
        if(str.length<3) return false;
        return str[0]===str[str.length-1] && str[0]!==str[1];
      }

      function patternLabel(numStr){
        if(!numStr) return "—";
        if(isAllSame(numStr)){
          return `Repeating ${numStr[0]}s`;
        }
        if(isSequentialUp(numStr)) return "Sequential up";
        if(isSequentialDown(numStr)) return "Sequential down";
        if(isDoubleBlock(numStr)) return "Double-block";
        if(isMirror(numStr)) return "Mirror";
        if(isSandwich(numStr)) return "Sandwich";
        return "Mixed pattern";
      }

      const digitThemes = {
        0: "0 is often linked with resets, potential, and the idea of returning to center.",
        1: "1 is often linked with new beginnings, initiative, clarity, and taking the first step.",
        2: "2 is often linked with balance, relationships, patience, and cooperation.",
        3: "3 is often linked with creativity, expression, growth, and encouragement to communicate.",
        4: "4 is often linked with stability, foundations, structure, and steady progress.",
        5: "5 is often linked with change, adaptability, movement, and a call to embrace transition.",
        6: "6 is often linked with responsibility, home, care, and restoring harmony.",
        7: "7 is often linked with reflection, insight, spiritual study, and trust in inner guidance.",
        8: "8 is often linked with strength, power, abundance, and long-range results.",
        9: "9 is often linked with completion, compassion, release, and closing a chapter."
      };

      const presetMeanings = {
        "11":"Alignment and heightened awareness—notice what you’re thinking and choose deliberately.",
        "22":"Build it for real—patience, structure, and practical steps.",
        "33":"Creative expansion—express, connect, and grow through communication.",
        "44":"Foundations and protection—tighten routines, systems, and stability.",
        "55":"Change and movement—embrace transition, adapt, and move with it.",
        "66":"Home and care—restore balance, responsibility, and support.",
        "77":"Deep insight—reflection, learning, and trust your inner signals.",
        "88":"Strength and results—discipline, power, and long-range outcomes.",
        "99":"Completion and release—wrap up, forgive, let go, and step forward.",
        "111":"New cycle—focus intentions and act on the next step.",
        "222":"Balance and timing—cooperate, wait, and keep steady.",
        "333":"Expression and creativity—share truth, create, connect.",
        "444":"Stability and structure—secure the foundation and keep going.",
        "555":"Major change—adapt quickly, trust the shift, move forward.",
        "666":"Re-center—care for home, mind, body, obligations.",
        "777":"Insight and guidance—study, reflect, trust the quiet signal.",
        "888":"Abundance and power—results, momentum, disciplined effort.",
        "999":"Endings and renewal—finish the chapter and begin again.",
        "1010":"Awareness and choice—notice the moment and act intentionally.",
        "1212":"A mirrored prompt—balance your inner/outer, keep faith with action."
      };

      function digitSum(nStr){
        let sum = 0;
        for(const ch of nStr) sum += Number(ch)||0;
        return sum;
      }
      function reduceToDigit(n){
        while(n>9){
          let s=0;
          for(const ch of String(n)) s += Number(ch)||0;
          n = s;
        }
        return n;
      }

      function buildMeaning(numStr){
        if(!numStr) return {
          title:"—",
          pattern:"—",
          main:"Enter a number above to see its commonly shared meaning.",
          meta:"",
          source:""
        };

        const pat = patternLabel(numStr);
        const unique = Array.from(new Set(numStr.split("")));
        const sum = digitSum(numStr);
        const root = reduceToDigit(sum);

        const preset = presetMeanings[numStr] || null;

        let main = "";
        let source = "";
        if(preset){
          main = preset;
          source = "Direct map: preset meaning";
        }else{
          // derive from pattern + digit lenses
          if(isAllSame(numStr)){
            const d = Number(numStr[0]);
            main = `Emphasis pattern (${numStr}): ${digitThemes[d] || ""}`.trim();
            source = "Direct map: not in the preset list; derived from pattern + digit lenses.";
          }else{
            // pick most frequent digit
            const counts = {};
            for(const ch of numStr) counts[ch]=(counts[ch]||0)+1;
            let best = numStr[0], bestC = counts[best]||1;
            for(const k in counts){
              if(counts[k]>bestC){ best=k; bestC=counts[k]; }
            }
            const d = Number(best);
            main = (digitThemes[d] || "A general interpretation is heightened awareness: notice your thoughts, environment, and choices—then act deliberately.");
            source = "Direct map: not in the preset list; derived from pattern + digit lenses.";
          }
        }

        const meta =
`Digits: ${numStr.split("").join(" • ")}
Unique digits: ${unique.join(", ")}
${source}
Digit-sum lens (${sum} → ${root}): ${digitThemes[root] || ""}

Pattern method: repeating / sequential / double-block / mirror / sandwich / mixed.`;

        return {
          title:numStr,
          pattern:pat,
          main,
          meta
        };
      }

      /* =========================
         UI State / Navigation
      ========================== */
      let currentPanel = 0; // 0 Identify, 1 Calendar

      const panelStrip = $("panelStrip");

      function setPanel(idx){
        currentPanel = Math.max(0, Math.min(1, idx));
        panelStrip.style.transform = `translateX(${currentPanel===0 ? "0%" : "-50%"})`;
      }

      /* swipe left/right only if touch starts within 150px of edge */
      const EDGE_PX = 150;
      let touchStartX = 0;
      let touchStartY = 0;
      let touchStartTime = 0;
      let touchArmed = false;

      function onTouchStart(e){
        if(!e.touches || e.touches.length!==1) return;
        const t = e.touches[0];
        touchStartX = t.clientX;
        touchStartY = t.clientY;
        touchStartTime = Date.now();

        const w = window.innerWidth || document.documentElement.clientWidth;
        const nearLeft = touchStartX <= EDGE_PX;
        const nearRight = touchStartX >= (w - EDGE_PX);
        touchArmed = nearLeft || nearRight;
      }

      function onTouchMove(e){
        // no-op; we decide on end
      }

      function onTouchEnd(e){
        if(!touchArmed) return;
        touchArmed = false;

        const dt = Date.now() - touchStartTime;
        if(dt > 650) return;

        const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
        if(!t) return;

        const dx = t.clientX - touchStartX;
        const dy = t.clientY - touchStartY;

        // horizontal intent
        if(Math.abs(dx) < 40) return;
        if(Math.abs(dy) > 90) return;

        if(dx < -60){
          // swipe left
          setPanel(1);
          renderCalendar();
        }else if(dx > 60){
          // swipe right
          setPanel(0);
        }
      }

      document.addEventListener("touchstart", onTouchStart, {passive:true});
      document.addEventListener("touchmove", onTouchMove, {passive:true});
      document.addEventListener("touchend", onTouchEnd, {passive:true});

      /* =========================
         Identify Panel Behavior
      ========================== */
      const numInput = $("numInput");
      const bigNum = $("bigNum");
      const patternPill = $("patternPill");
      const meaningText = $("meaningText");
      const lensText = $("lensText");

      let currentMeaning = buildMeaning("");

      function updateIdentifyFromInput(){
        const raw = digitsOnly(numInput.value);
        if(numInput.value !== raw) numInput.value = raw;

        currentMeaning = buildMeaning(raw);

        bigNum.textContent = currentMeaning.title || "—";
        patternPill.textContent = `Pattern: ${currentMeaning.pattern || "—"}`;
        meaningText.textContent = currentMeaning.main || "";
        lensText.textContent =
`How to use: Treat the meaning as a reflective prompt—what it “means” depends on context and personal interpretation.

${currentMeaning.meta || ""}

Cultural note: these meanings come from numerology/“angel number” traditions and vary by source. Treat as reflective prompts, not facts or predictions.`;
      }

      numInput.addEventListener("input", updateIdentifyFromInput);

      // Prevent keyboard pop on load: do not focus.
      window.addEventListener("load", ()=>{
        updateIdentifyFromInput();
      }, {once:true});

      /* =========================
         Modal System
      ========================== */
      const modalShade = $("modalShade");
      const modalInner = $("modalInner");
      const modalX = $("modalX");

      let modalOnClose = null;

      function closeModal(){
        modalShade.classList.remove("show");
        modalShade.setAttribute("aria-hidden","true");
        modalInner.innerHTML = "";
        if(typeof modalOnClose === "function"){
          const fn = modalOnClose;
          modalOnClose = null;
          try{ fn(); }catch(_e){}
        }
      }

      function openModal(html, onClose){
        modalOnClose = (typeof onClose==="function") ? onClose : null;
        modalInner.innerHTML = html;
        modalShade.classList.add("show");
        modalShade.setAttribute("aria-hidden","false");
      }

      modalX.addEventListener("click", closeModal);
      modalShade.addEventListener("click", (e)=>{
        if(e.target === modalShade) closeModal();
      });

      /* =========================
         Add to Calendar Modal
      ========================== */
      function openAddModal(prefillNumber){
        const number = digitsOnly(prefillNumber || "");
        const html =
          `<div class="modalTitle">Add to Calendar</div>
           <div class="modalText">Add a sighting with optional notes.</div>

           <div class="modalFieldLabel">Number</div>
           <input class="modalInput" id="addNum" inputmode="numeric" autocomplete="off" spellcheck="false" value="${escapeHtml(number)}" />

           <div class="modalFieldLabel">Notes (optional)</div>
           <textarea class="modalTextarea" id="addNotes" placeholder="Where did you see it? What was happening?"></textarea>

           <div class="modalBtns2">
             <div class="modalBtn modalBtnPrimary" id="addDo">Add</div>
             <div class="modalBtn" id="addCancel">Cancel</div>
           </div>`;

        openModal(html);

        const addNum = $("addNum");
        const addNotes = $("addNotes");

        $("addCancel").addEventListener("click", closeModal);

        $("addDo").addEventListener("click", ()=>{
          const num = digitsOnly(addNum.value);
          const notes = String(addNotes.value || "").trim();
          if(!num){
            // keep popup style consistent (use same modal for errors)
            openModal(
              `<div class="modalTitle">Missing number</div>
               <div class="modalText">Please enter a number to add.</div>
               <div class="modalBtns2">
                 <div class="modalBtn modalBtnPrimary" id="okOnly">OK</div>
                 <div class="modalBtn" id="backToAdd">Back</div>
               </div>`,
              null
            );
            $("okOnly").addEventListener("click", closeModal);
            $("backToAdd").addEventListener("click", ()=>openAddModal(""));
            return;
          }
          const rec = {
            id: cryptoRandomId(),
            number: num,
            notes,
            createdAt: nowISO()
          };
          records.unshift(rec);
          saveRecords(records);
          closeModal();
          renderCalendar(); // refresh highlights
        });
      }

      function cryptoRandomId(){
        try{
          const a = new Uint8Array(12);
          crypto.getRandomValues(a);
          return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join("");
        }catch(_e){
          return String(Math.random()).slice(2) + String(Date.now());
        }
      }

      /* =========================
         Export (global)
      ========================== */
      function buildExportText(){
        const d = new Date();
        const stamp = d.toLocaleString();

        const lines = [];
        lines.push(`${APP_NAME} — Export Report`);
        lines.push(`App Version: ${APP_VERSION}`);
        lines.push(`Report: Full Export`);
        lines.push(`Generated: ${stamp}`);
        lines.push(`Range: All entries`);
        lines.push(`How this data was captured:`);
        lines.push(`- Sightings are entered manually into ${APP_NAME} on this device.`);
        lines.push(`- Data is stored locally on the phone (no cloud sync, no account).`);
        lines.push(`- Each record may include the number and optional notes.`);
        lines.push(`----------------------------------------------`);

        const sorted = [...records].sort((a,b)=>String(b.createdAt||"").localeCompare(String(a.createdAt||"")));
        for(const r of sorted){
          const ts = r.createdAt ? new Date(r.createdAt).toLocaleString() : "";
          lines.push(`${ts}`);
          lines.push(`Number: ${r.number || ""}`);
          if(r.notes) lines.push(`Notes: ${r.notes}`);
          lines.push("");
        }
        return lines.join("\n");
      }

      async function copyToClipboard(text){
        try{
          await navigator.clipboard.writeText(text);
          return true;
        }catch(_e){
          // fallback
          try{
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed";
            ta.style.left="-9999px";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand("copy");
            document.body.removeChild(ta);
            return !!ok;
          }catch(_e2){
            return false;
          }
        }
      }

      function openExportModal(){
        const html =
          `<div class="modalTitle">Export</div>
           <div class="modalText">Copy a full report to clipboard.</div>
           <div class="modalBtns2">
             <div class="modalBtn modalBtnPrimary" id="doCopy">Copy</div>
             <div class="modalBtn" id="cancelExport">Cancel</div>
           </div>`;
        openModal(html);

        $("cancelExport").addEventListener("click", closeModal);

        $("doCopy").addEventListener("click", async ()=>{
          const text = buildExportText();
          const ok = await copyToClipboard(text);
          if(ok){
            openModal(
              `<div class="modalTitle">Copied</div>
               <div class="modalText">Export report copied to clipboard.</div>
               <div class="modalBtns2">
                 <div class="modalBtn modalBtnPrimary" id="okCopy">OK</div>
                 <div class="modalBtn" id="closeCopy">Close</div>
               </div>`
            );
            $("okCopy").addEventListener("click", closeModal);
            $("closeCopy").addEventListener("click", closeModal);
          }else{
            openModal(
              `<div class="modalTitle">Copy failed</div>
               <div class="modalText">Clipboard access was blocked. You can try again.</div>
               <div class="modalBtns2">
                 <div class="modalBtn modalBtnPrimary" id="tryAgain">Try</div>
                 <div class="modalBtn" id="cancelFail">Cancel</div>
               </div>`
            );
            $("tryAgain").addEventListener("click", openExportModal);
            $("cancelFail").addEventListener("click", closeModal);
          }
        });
      }

      /* =========================
         Calendar
      ========================== */
      const monthSelect = $("monthSelect");
      const calGrid = $("calGrid");

      function monthKey(y, m){
        return `${y}-${String(m).padStart(2,"0")}`;
      }

      function buildMonthOptions(){
        // build +/- 24 months around now
        const now = new Date();
        const baseY = now.getFullYear();
        const baseM = now.getMonth()+1;

        monthSelect.innerHTML = "";
        const opts = [];
        for(let i=-24; i<=24; i++){
          const d = new Date(baseY, (baseM-1)+i, 1);
          const y = d.getFullYear();
          const m = d.getMonth()+1;
          const label = d.toLocaleString(undefined, { month:"long", year:"numeric" });
          opts.push({ y, m, key: monthKey(y,m), label });
        }
        for(const o of opts){
          const opt = document.createElement("option");
          opt.value = o.key;
          opt.textContent = o.label;
          monthSelect.appendChild(opt);
        }

        const curKey = monthKey(baseY, baseM);
        monthSelect.value = curKey;
      }

      function entriesByDayKey(){
        const map = new Map();
        for(const r of records){
          const dt = r.createdAt ? new Date(r.createdAt) : null;
          if(!dt || Number.isNaN(dt.getTime())) continue;
          const k = toLocalDateParts(dt).key;
          if(!map.has(k)) map.set(k, []);
          map.get(k).push(r);
        }
        // sort each day newest first
        for(const [k, arr] of map.entries()){
          arr.sort((a,b)=>String(b.createdAt||"").localeCompare(String(a.createdAt||"")));
          map.set(k, arr);
        }
        return map;
      }

      function renderCalendar(){
        if(currentPanel !== 1) return;

        const val = monthSelect.value;
        const [yy, mm] = val.split("-").map(Number);
        const y = yy, m = mm;

        const first = new Date(y, m-1, 1);
        const firstDow = first.getDay(); // 0 Sun
        const daysInMonth = new Date(y, m, 0).getDate();

        // previous month tail
        const prevDays = new Date(y, m-1, 0).getDate();

        // build 6 weeks (42 cells)
        const cells = [];
        for(let i=0;i<42;i++){
          const dayNum = i - firstDow + 1;
          let cellY=y, cellM=m, cellD=dayNum, isOther=false;

          if(dayNum <= 0){
            isOther = true;
            cellM = m-1;
            cellY = y;
            if(cellM<=0){ cellM=12; cellY=y-1; }
            cellD = prevDays + dayNum;
          }else if(dayNum > daysInMonth){
            isOther = true;
            cellM = m+1;
            cellY = y;
            if(cellM>=13){ cellM=1; cellY=y+1; }
            cellD = dayNum - daysInMonth;
          }

          const d = new Date(cellY, cellM-1, cellD);
          const key = toLocalDateParts(d).key;
          cells.push({ y:cellY, m:cellM, d:cellD, key, isOther });
        }

        const dayMap = entriesByDayKey();
        const todayKey = toLocalDateParts(new Date()).key;

        calGrid.innerHTML = "";
        for(const c of cells){
          const div = document.createElement("div");
          div.className = "day";
          div.textContent = String(c.d);

          if(c.isOther) div.classList.add("isOther");
          if(c.key === todayKey) div.classList.add("isToday");
          const has = dayMap.has(c.key) && dayMap.get(c.key).length>0;
          if(has) div.classList.add("hasEntries");

          div.addEventListener("click", ()=>{
            if(!has) return;
            openDayListModal(c.key, dayMap.get(c.key));
          });

          calGrid.appendChild(div);
        }
      }

      function openDayListModal(dayKey, dayEntries){
        const dayLabel = (()=>{
          const [y,m,d] = dayKey.split("-").map(Number);
          const dt = new Date(y, (m-1), d);
          return dt.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
        })();

        const rows = dayEntries.map(r=>{
          const t = fmtTimeLocal(r.createdAt);
          const note = r.notes ? escapeHtml(r.notes) : "";
          const noteLine = note ? `<div class="dayRowNote">${note}</div>` : `<div class="dayRowNote" style="opacity:.35">No notes</div>`;
          return `
            <div class="dayRow" data-id="${escapeHtml(r.id)}">
              <div class="dayRowLeft">
                <div class="dayRowNum">${escapeHtml(r.number || "")}</div>
                ${noteLine}
              </div>
              <div class="dayRowTime">${escapeHtml(t)}</div>
            </div>`;
        }).join("");

        const html =
          `<div class="modalTitle">Day List</div>
           <div class="modalText">${escapeHtml(dayLabel)}<br><span style="color:rgba(235,245,255,.45);font-weight:800">Click a number to view details.</span></div>
           <div class="dayListWrap">
             <div class="dayList" id="dayList">${rows}</div>
           </div>
           <div class="modalBtns2" style="margin-top:14px">
             <div class="modalBtn modalBtnPrimary" id="dayOk">OK</div>
             <div class="modalBtn" id="dayClose">Close</div>
           </div>`;

        openModal(html);

        $("dayOk").addEventListener("click", closeModal);
        $("dayClose").addEventListener("click", closeModal);

        const list = $("dayList");
        list.addEventListener("click", (e)=>{
          const row = e.target.closest(".dayRow");
          if(!row) return;
          const id = row.getAttribute("data-id");
          const rec = records.find(r=>r.id===id);
          if(!rec) return;
          openEntryDetailModal(rec);
        });
      }

      function openEntryDetailModal(rec){
        const dt = rec.createdAt ? new Date(rec.createdAt) : new Date();
        const stamp = dt.toLocaleString();
        const note = rec.notes ? escapeHtml(rec.notes) : "";

        const html =
          `<div class="modalTitle">Entry</div>
           <div class="modalText">${escapeHtml(stamp)}</div>

           <div class="modalFieldLabel">Number</div>
           <div style="font-size:44px;font-weight:950;letter-spacing:.6px;color:rgba(235,245,255,.92)">${escapeHtml(rec.number || "")}</div>

           <div class="modalFieldLabel">Notes</div>
           <textarea class="modalTextarea" id="editNotes" placeholder="Notes (optional)">${note}</textarea>

           <div class="modalBtns2">
             <div class="modalBtn modalBtnPrimary" id="saveEntry">Save</div>
             <div class="modalBtn" id="deleteEntry">Delete</div>
           </div>
           <div class="modalBtns2" style="margin-top:12px">
             <div class="modalBtn" id="closeEntry">Close</div>
             <div class="modalBtn" id="noop2" style="opacity:.35"> </div>
           </div>`;

        openModal(html);

        $("closeEntry").addEventListener("click", closeModal);

        $("saveEntry").addEventListener("click", ()=>{
          const notes = String($("editNotes").value || "").trim();
          const idx = records.findIndex(r=>r.id===rec.id);
          if(idx>=0){
            records[idx].notes = notes;
            saveRecords(records);
          }
          closeModal();
          renderCalendar();
        });

        $("deleteEntry").addEventListener("click", ()=>{
          openModal(
            `<div class="modalTitle">Delete entry?</div>
             <div class="modalText">This will remove the entry from the in-app calendar.</div>
             <div class="modalBtns2">
               <div class="modalBtn modalBtnPrimary" id="confirmDel">Delete</div>
               <div class="modalBtn" id="cancelDel">Cancel</div>
             </div>`
          );
          $("cancelDel").addEventListener("click", closeModal);
          $("confirmDel").addEventListener("click", ()=>{
            records = records.filter(r=>r.id!==rec.id);
            saveRecords(records);
            closeModal();
            renderCalendar();
          });
        });
      }

      /* =========================
         Buttons / Actions
      ========================== */
      $("btnAddToCalendar").addEventListener("click", ()=>{
        const n = digitsOnly(numInput.value);
        openAddModal(n);
      });

      $("btnViewCalendar").addEventListener("click", ()=>{
        setPanel(1);
        renderCalendar();
      });

      $("btnExportAll").addEventListener("click", ()=>{
        openExportModal();
      });

      $("btnBackToIdentify").addEventListener("click", ()=>{
        setPanel(0);
      });

      $("btnToday").addEventListener("click", ()=>{
        const d = new Date();
        const key = monthKey(d.getFullYear(), d.getMonth()+1);
        monthSelect.value = key;
        renderCalendar();
      });

      $("btnCalBackHome").addEventListener("click", ()=>{
        setPanel(0);
      });

      /* Exit handler (best-effort for PWA) */
      function exitApp(){
        try{
          window.close();
          setTimeout(()=>{ alert("If this tab did not close, you can close it manually."); }, 350);
        }catch(_e){
          alert("You can close this tab to exit.");
        }
      }
      $("btnExit").addEventListener("click", exitApp);
      $("btnCalExit").addEventListener("click", exitApp);

      /* =========================
         Month select
      ========================== */
      buildMonthOptions();
      monthSelect.addEventListener("change", renderCalendar);

      /* =========================
         Version triple-tap heart
      ========================== */
      const versionTop = $("versionTop");
      let tapCount = 0;
      let tapTimer = null;

      function resetTap(){
        tapCount = 0;
        if(tapTimer){ clearTimeout(tapTimer); tapTimer=null; }
      }

      function onVersionTap(){
        tapCount++;
        if(tapTimer) clearTimeout(tapTimer);
        tapTimer = setTimeout(resetTap, 520);

        if(tapCount >= 3){
          resetTap();
          openModal(
            `<div class="modalTitle" style="text-align:center"> </div>
             <div class="heartBig">❤</div>
             <div class="heartMsg">The Angels love you Timmy.</div>
             <div class="modalBtns2">
               <div class="modalBtn modalBtnPrimary" id="heartOk">OK</div>
               <div class="modalBtn" id="heartClose">Close</div>
             </div>`
          );
          $("heartOk").addEventListener("click", closeModal);
          $("heartClose").addEventListener("click", closeModal);
        }
      }

      versionTop.addEventListener("click", onVersionTap);

      /* =========================
         Service Worker (offline)
      ========================== */
      function registerServiceWorker(){
        if(!("serviceWorker" in navigator)) return;

        // Minimal SW: cache this page shell. Single-file app, so caching root is enough.
        const swCode = `
          const CACHE = ${JSON.stringify(SW_CACHE)};
          self.addEventListener('install', (e)=>{
            e.waitUntil((async()=>{
              const cache = await caches.open(CACHE);
              try{
                await cache.addAll(['./']);
              }catch(_e){}
              self.skipWaiting();
            })());
          });
          self.addEventListener('activate', (e)=>{
            e.waitUntil((async()=>{
              const keys = await caches.keys();
              await Promise.all(keys.map(k => (k===CACHE) ? null : caches.delete(k)));
              self.clients.claim();
            })());
          });
          self.addEventListener('fetch', (e)=>{
            const req = e.request;
            const url = new URL(req.url);
            if(req.method !== 'GET') return;
            if(url.origin !== location.origin) return;
            e.respondWith((async()=>{
              const cache = await caches.open(CACHE);
              const cached = await cache.match(req, {ignoreSearch:true});
              if(cached) return cached;
              try{
                const fresh = await fetch(req);
                try{ cache.put(req, fresh.clone()); }catch(_e){}
                return fresh;
              }catch(_e){
                const fallback = await cache.match('./');
                return fallback || new Response('Offline', {status:503, headers:{'Content-Type':'text/plain'}});
              }
            })());
          });
        `;

        try{
          const blob = new Blob([swCode], {type:"text/javascript"});
          const url = URL.createObjectURL(blob);
          navigator.serviceWorker.register(url).catch(()=>{});
        }catch(_e){}
      }

      /* =========================
         Manifest (dynamic)
      ========================== */
      function buildManifest(){
        const manifest = {
          name: APP_NAME,
          short_name: "Angel Numbers",
          start_url: "./",
          display: "standalone",
          background_color: "#0b1324",
          theme_color: "#0b1324",
          icons: [
            {
              src: "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" viewBox="0 0 192 192">
                  <defs>
                    <linearGradient id="g" x1="0" x2="1" y1="0" y2="0">
                      <stop offset="0" stop-color="#b478ff"/>
                      <stop offset="1" stop-color="#4690ff"/>
                    </linearGradient>
                  </defs>
                  <rect width="192" height="192" rx="44" fill="#0b1324"/>
                  <rect x="14" y="14" width="164" height="164" rx="40" fill="rgba(255,255,255,.06)" stroke="rgba(235,245,255,.14)"/>
                  <path d="M96 36c26 0 46 20 46 46" stroke="rgba(235,245,255,.75)" stroke-width="10" stroke-linecap="round"/>
                  <path d="M54 70c-24 10-34 28-34 48 0 30 26 54 60 54 7 0 14-1 20-4" stroke="#4690ff" stroke-width="10" stroke-linecap="round"/>
                  <path d="M138 70c24 10 34 28 34 48 0 30-26 54-60 54-7 0-14-1-20-4" stroke="#b478ff" stroke-width="10" stroke-linecap="round"/>
                  <path d="M60 112c20 0 26 30 36 30s16-30 36-30" stroke="rgba(235,245,255,.70)" stroke-width="9" stroke-linecap="round"/>
                  <path d="M96 142v24" stroke="rgba(235,245,255,.55)" stroke-width="9" stroke-linecap="round"/>
                  <text x="96" y="108" text-anchor="middle" font-size="18" font-family="system-ui,Segoe UI,Roboto,Arial" fill="url(#g)" font-weight="800">ANGEL</text>
                </svg>
              `),
              sizes: "192x192",
              type: "image/svg+xml"
            }
          ]
        };

        const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
        const url = URL.createObjectURL(blob);
        $("manifestLink").setAttribute("href", url);
      }

      buildManifest();
      registerServiceWorker();

      /* =========================
         Initialize
      ========================== */
      // Set initial panel and render calendar only when opened
      setPanel(0);

      // Keep version text consistent
      $("versionTop").textContent = APP_VERSION;
      $("footerLeft").textContent = APP_VERSION;

    })();
  </script>

  <!--
  Version Detail Notes (EOF)
  App: Angel Numbers Tracker
  Version: v1.1A2
  Notes:
  - Swipe navigation only triggers when touch starts within 150px of left/right screen edge.
  - Identify screen: no autofocus; internal meaning box scrolls with right-side scrollbar; bottom buttons stay visible.
  - Calendar: month view with day highlights; tapping highlighted day opens Day List popup; tapping entry opens Entry detail popup (edit notes/delete).
  - Add popup: number + notes + Add/Cancel (no copy/export; no “in app only” wording).
  - Export: available from Identify only (copies full report to clipboard).
  -->
</body>
   </html>
