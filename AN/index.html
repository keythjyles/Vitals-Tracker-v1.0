<!-- Angel Numbers Tracker v1.0B10 -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Angel Numbers Tracker</title>

  <link rel="manifest" id="manifestLink" href="#" />

  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;
      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --text:rgba(235,245,255,.86);
      --muted:rgba(235,245,255,.58);
      --muted2:rgba(235,245,255,.42);

      /* Accent border (blue) */
      --accent:#2b4e7a;

      --shadow:0 10px 28px rgba(0,0,0,.35);
      --radius:26px;
      --radius2:18px;

      --btnBg:rgba(255,255,255,.06);
      --btnBg2:rgba(255,255,255,.09);
      --btnStroke:rgba(255,255,255,.18);

      --pad:16px;
      --gap:12px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(60,110,190,.28), rgba(0,0,0,0) 55%),
        radial-gradient(1200px 700px at 85% 0%, rgba(110,60,190,.22), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    .app{
      height:100dvh;
      display:flex;
      flex-direction:column;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
      gap:12px;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 6px 0 6px;
      flex:0 0 auto;
    }
    .logo{
      width:44px; height:44px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .titlewrap{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      gap:4px;
      min-width:0;
    }
    .title{
      font-size:28px;
      font-weight:800;
      letter-spacing:.2px;
      background: linear-gradient(90deg, rgba(190,120,255,.95), rgba(80,190,255,.95));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .spacer{ flex:1; }
    .pill{
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      user-select:none;
    }

    /* Consistent accent border for ALL panels */
    .panel{
      flex:1 1 auto;
      background:var(--panel);
      border-radius:var(--radius);
      border:2px solid var(--accent);
      box-shadow: var(--shadow), inset 0 0 0 1px rgba(255,255,255,.04);
      overflow:hidden;
      position:relative;
      min-height:0;
    }

    .panelInner{
      height:100%;
      padding: var(--pad);
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      min-height:0;
      overflow:hidden;
    }

    .pullHint{
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      font-size:12px;
      color:var(--muted);
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      padding:7px 10px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease;
    }
    .pullHint.show{ opacity:1; }

    .buttonsRow{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      flex:0 0 auto;
    }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      color:var(--text);
      background:var(--btnBg);
      border:1px solid var(--btnStroke);
      border-radius:999px;
      padding:14px 18px;
      font-weight:700;
      letter-spacing:.2px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      min-width: 108px;
    }
    .btn:active{ transform: translateY(1px); background: var(--btnBg2); }
    .btnWide{ flex:1; min-width:0; }
    .btnPrimary{
      background: linear-gradient(180deg, rgba(60,130,255,.82), rgba(40,100,220,.72));
      border:1px solid rgba(120,175,255,.55);
    }
    .btnGhost{ background: rgba(255,255,255,.04); }

    .label{
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
    }

    .fieldRow{ display:flex; gap:10px; align-items:center; }

    input[type="text"], textarea, select{
      width:100%;
      border-radius:18px;
      padding:14px 14px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.18);
      color:var(--text);
      outline:none;
      font-size:18px;
    }
    textarea{ min-height:110px; resize:none; }

    .smallInput{ font-size:16px; padding:12px 12px; border-radius:16px; }
    .searchBtn{ width:120px; }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .scrollY{
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      min-height:0;
    }

    /* Cards */
    .card{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      padding:14px 14px 12px 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      user-select:none;
      touch-action: pan-y;
    }
    .card:active{ background: rgba(255,255,255,.07); }

    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .cardTime{
      font-size:13px;
      color:var(--muted2);
      font-weight:650;
    }
    .cardNum{
      font-size:40px;
      font-weight:900;
      letter-spacing:1px;
      line-height:1;
      margin-top:4px;
    }
    .cardPattern{
      font-size:16px;
      font-weight:800;
      color:var(--muted);
      margin-top:6px;
      white-space:nowrap;
    }
    .cardBody{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      line-height:1.25;
    }
    .kv{ display:flex; gap:8px; flex-wrap:wrap; align-items:baseline; }
    .k{ font-size:13px; color:var(--muted2); font-weight:800; }
    .v{ font-size:15px; color:var(--text); font-weight:650; }

    /* Modal */
    .modalMask{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px 14px;
      z-index:50;
    }
    .modalMask.show{ display:flex; }
    .modal{
      width:min(720px, 100%);
      max-height: calc(100dvh - 40px);
      background: rgba(10,18,36,.96);
      border-radius: 28px;
      border:2px solid var(--accent);
      box-shadow: var(--shadow), inset 0 0 0 1px rgba(255,255,255,.04);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 14px 10px 14px;
      flex:0 0 auto;
    }
    .modalTitle{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .modalTitle .h{
      font-size:16px;
      font-weight:900;
      letter-spacing:.3px;
      color:var(--text);
      opacity:.95;
    }
    .modalTitle .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:650;
    }
    .xBtn{
      width:52px; height:52px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-size:26px;
      font-weight:900;
      cursor:pointer;
    }
    .xBtn:active{ transform: translateY(1px); background: rgba(255,255,255,.08); }

    .modalBody{
      padding: 0 14px 12px 14px;
      min-height:0;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Angel card (compact) */
    .viewGrid{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 6px 2px 2px 2px;
    }
    .viewRow{
      display:flex;
      flex-direction:column;
      gap:5px;
    }
    .viewKey{
      font-size:12px;
      color:var(--muted2);
      font-weight:900;
      letter-spacing:.2px;
    }
    .viewVal{
      font-size:16px;
      font-weight:650;
      line-height:1.25;
      color:var(--text);
      opacity:.98;
      word-break:break-word;
    }
    .miniNotice{
      font-size:12px;
      color:var(--muted2);
      line-height:1.25;
      margin-top:2px;
    }

    .stickyFooter{
      padding:12px 14px 14px 14px;
      flex:0 0 auto;
      display:flex;
      gap:10px;
      background: linear-gradient(180deg, rgba(10,18,36,0), rgba(10,18,36,.96) 36%);
    }

    .screen{ height:100%; min-height:0; display:none; }
    .screen.show{ display:block; }

    .homeBlock{ display:flex; flex-direction:column; gap:10px; }
    .homeLine{ font-size:14px; color:var(--muted); line-height:1.25; }

    /* Select arrow */
    select{
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.6) 50%),
        linear-gradient(135deg, rgba(255,255,255,.6) 50%, transparent 50%);
      background-position:
        calc(100% - 22px) calc(50% - 3px),
        calc(100% - 16px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="logo" aria-hidden="true">
        <svg width="34" height="34" viewBox="0 0 64 64" fill="none">
          <path d="M22 30c-7-7-14-4-14 6 0 9 7 16 18 20-2-7-2-16-4-26Z" fill="rgba(120,190,255,.55)"/>
          <path d="M42 30c7-7 14-4 14 6 0 9-7 16-18 20 2-7 2-16 4-26Z" fill="rgba(190,120,255,.50)"/>
          <path d="M24 39c2 9 7 15 8 15s6-6 8-15c-3 2-6 3-8 3s-5-1-8-3Z" fill="rgba(235,245,255,.75)"/>
          <ellipse cx="32" cy="14.5" rx="12" ry="6" stroke="rgba(235,245,255,.72)" stroke-width="3"/>
        </svg>
      </div>
      <div class="titlewrap">
        <div class="title">Angel Numbers Tracker</div>
        <div class="subtitle" id="subtitle">Offline • Local-only • v1.0B10</div>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="dbPill">DB: OK</div>
    </div>

    <div class="panel" id="panel">
      <div class="pullHint" id="pullHint">Pull down to check update</div>

      <!-- HOME -->
      <div class="panelInner screen show" id="screenHome">
        <div class="homeBlock">
          <div class="homeLine"><strong>Inspired by a real Angel.</strong></div>
          <div class="homeLine">Pull down on this screen to refresh and apply any installed update.</div>
          <div class="homeLine" id="homeStatus" style="color:var(--muted2); font-weight:800;"></div>
        </div>

        <div class="buttonsRow" style="margin-top:6px;">
          <button class="btn btnWide btnPrimary" id="btnGoAdd">ADD</button>
          <button class="btn btnWide" id="btnGoLog">LOG</button>
        </div>

        <div class="buttonsRow">
          <button class="btn btnWide btnGhost" id="btnBackup">Backup</button>
          <button class="btn btnWide btnGhost" id="btnRestore">Restore</button>
        </div>

        <div style="flex:1 1 auto;"></div>

        <div class="buttonsRow">
          <button class="btn btnWide" id="btnInstall">Install</button>
          <button class="btn btnWide" id="btnUninstall">Uninstall</button>
          <button class="btn btnWide" id="btnExit" style="border-color:rgba(255,255,255,.22);">Exit</button>
        </div>
      </div>

      <!-- ADD / EDIT -->
      <div class="panelInner screen" id="screenAdd">
        <div class="buttonsRow">
          <button class="btn btnWide btnGhost" id="btnAddBack">Back</button>
          <button class="btn btnWide btnPrimary" id="btnSave">Save</button>
        </div>

        <div class="label" id="editModeLabel">New entry</div>

        <div class="scrollY" style="padding-right:2px;">
          <div style="display:flex; flex-direction:column; gap:12px;">

            <!-- FIX: Date/Time not editable on ADD; only show on EDIT -->
            <div id="dtWrap" class="hidden">
              <div class="label">Date/Time</div>
              <select id="dtSelect"></select>
            </div>

            <div>
              <div class="label">Number</div>
              <input type="text" id="numInput" placeholder="e.g., 111, 1212, 777" inputmode="numeric" />
            </div>

            <div>
              <div class="label">Pattern</div>
              <div class="card" style="margin-top:8px;">
                <div class="kv">
                  <div class="k">Pattern:</div>
                  <div class="v" id="patternText">—</div>
                </div>
                <div class="kv" style="margin-top:6px;">
                  <div class="v" id="meaningText" style="color:var(--muted); font-weight:650;">Enter a number to see an interpretation.</div>
                </div>
                <div class="miniNotice">
                  Cultural note: these meanings come from numerology/"angel number" traditions and vary by source. Treat as reflective prompts, not facts or predictions.
                </div>
              </div>
            </div>

            <div>
              <div class="label">Notes (optional)</div>
              <textarea id="notesInput" placeholder="Where you saw it, what was happening, or your thoughts..."></textarea>
            </div>

            <div class="buttonsRow">
              <button class="btn btnWide" id="btnDelete" style="border-color:rgba(255,255,255,.14); color:rgba(255,245,245,.86);">Delete</button>
              <button class="btn btnWide btnGhost" id="btnViewCard">View Card</button>
            </div>

          </div>
        </div>
      </div>

      <!-- LOG -->
      <div class="panelInner screen" id="screenLog">
        <div class="buttonsRow">
          <button class="btn btnWide btnGhost" id="btnExport">Export</button>
          <button class="btn btnWide btnPrimary" id="btnLogAdd">ADD</button>
          <button class="btn btnWide btnGhost" id="btnLogBack">Back</button>
        </div>

        <div class="label">Search</div>
        <div class="fieldRow">
          <input type="text" id="searchInput" class="smallInput" placeholder="Try: 111, mirror, reset, notes..." />
          <button class="btn searchBtn" id="btnSearch">Search</button>
        </div>

        <div class="twoCol">
          <div>
            <div class="label">From</div>
            <select id="fromSelect"></select>
          </div>
          <div>
            <div class="label">To</div>
            <select id="toSelect"></select>
          </div>
        </div>

        <div class="scrollY" id="logScroll" style="margin-top:4px; padding-right:2px;">
          <div id="logList" style="display:flex; flex-direction:column; gap:12px; padding-bottom:6px;"></div>
          <div class="label hidden" id="emptyLabel" style="text-align:center; padding:18px 0; color:var(--muted2);">
            No entries yet.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalMask" id="modalMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div class="modalTitle">
          <div class="h" id="modalH">Angel Number Card</div>
          <div class="sub" id="modalSub">Angel Numbers Tracker</div>
        </div>
        <button class="xBtn" id="modalX" aria-label="Close">×</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="stickyFooter" id="modalFooter"></div>
    </div>
  </div>

<script>
/* ===========================
   Angel Numbers Tracker v1.0B10
   =========================== */

const APP_VERSION = "v1.0B10";
const DB_NAME = "angel_numbers_tracker_db";
const DB_VER = 1;
const STORE = "records";
const LEGACY_KEY = "angel_numbers_records_v1";
const THEME_COLOR = "#0b1324";

const els = {
  subtitle: document.getElementById("subtitle"),
  dbPill: document.getElementById("dbPill"),

  screenHome: document.getElementById("screenHome"),
  screenAdd: document.getElementById("screenAdd"),
  screenLog: document.getElementById("screenLog"),

  panel: document.getElementById("panel"),
  pullHint: document.getElementById("pullHint"),
  homeStatus: document.getElementById("homeStatus"),

  btnGoAdd: document.getElementById("btnGoAdd"),
  btnGoLog: document.getElementById("btnGoLog"),
  btnAddBack: document.getElementById("btnAddBack"),
  btnSave: document.getElementById("btnSave"),
  btnDelete: document.getElementById("btnDelete"),
  btnViewCard: document.getElementById("btnViewCard"),

  dtWrap: document.getElementById("dtWrap"),
  dtSelect: document.getElementById("dtSelect"),

  numInput: document.getElementById("numInput"),
  notesInput: document.getElementById("notesInput"),

  editModeLabel: document.getElementById("editModeLabel"),
  patternText: document.getElementById("patternText"),
  meaningText: document.getElementById("meaningText"),

  btnLogBack: document.getElementById("btnLogBack"),
  btnLogAdd: document.getElementById("btnLogAdd"),
  btnExport: document.getElementById("btnExport"),
  btnSearch: document.getElementById("btnSearch"),
  searchInput: document.getElementById("searchInput"),
  fromSelect: document.getElementById("fromSelect"),
  toSelect: document.getElementById("toSelect"),

  logList: document.getElementById("logList"),
  logScroll: document.getElementById("logScroll"),
  emptyLabel: document.getElementById("emptyLabel"),

  btnBackup: document.getElementById("btnBackup"),
  btnRestore: document.getElementById("btnRestore"),
  btnInstall: document.getElementById("btnInstall"),
  btnUninstall: document.getElementById("btnUninstall"),
  btnExit: document.getElementById("btnExit"),

  modalMask: document.getElementById("modalMask"),
  modalBody: document.getElementById("modalBody"),
  modalFooter: document.getElementById("modalFooter"),
  modalX: document.getElementById("modalX"),
  modalH: document.getElementById("modalH"),
  modalSub: document.getElementById("modalSub"),
};

let db = null;
let allRecords = [];
let editingId = null;

/* Utilities */
function nowISO(){ return new Date().toISOString(); }
function fmtDT(d){
  try{
    const dt = (d instanceof Date) ? d : new Date(d);
    return dt.toLocaleString(undefined, { year:"numeric", month:"2-digit", day:"2-digit", hour:"numeric", minute:"2-digit" });
  }catch(e){ return String(d); }
}
function safeText(s){ return (s ?? "").toString(); }
function escapeHtml(s){
  return safeText(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
function setScreen(which){
  [els.screenHome, els.screenAdd, els.screenLog].forEach(s => s.classList.remove("show"));
  which.classList.add("show");
}
function toastHome(msg){
  els.homeStatus.textContent = msg;
  if(msg) setTimeout(()=>{ if(els.homeStatus.textContent === msg) els.homeStatus.textContent=""; }, 2200);
}

/* Pattern + meaning */
function reduceDigit(n){
  let x = Math.abs(parseInt(n,10) || 0);
  while(x > 9){
    x = x.toString().split("").reduce((a,b)=>a + parseInt(b,10), 0);
  }
  return x;
}
function analyzeNumber(raw){
  const num = safeText(raw).replace(/\s+/g,"").replace(/[^\d]/g,"");
  if(!num) return { clean:"", pattern:"—", meaning:"Enter a number to see an interpretation." };

  const digits = num.split("").map(x=>parseInt(x,10));
  const len = digits.length;

  const isAllSame = digits.every(d => d === digits[0]) && len >= 3;
  const isPalindrome = (num === num.split("").reverse().join("")) && len >= 3;
  const isSequentialInc = len >= 3 && digits.every((d,i)=> i===0 || digits[i] === (digits[i-1]+1)%10);
  const isSequentialDec = len >= 3 && digits.every((d,i)=> i===0 || digits[i] === (digits[i-1]+9)%10);

  let pattern = "Mixed pattern";
  if(isAllSame) pattern = `Repeating ${digits[0]}s`;
  else if(isPalindrome) pattern = "Mirror (palindrome)";
  else if(isSequentialInc) pattern = "Ascending sequence";
  else if(isSequentialDec) pattern = "Descending sequence";
  else if(len===4 && digits[0]===digits[1] && digits[2]===digits[3] && digits[0]!==digits[2]) pattern = "Double pattern";

  const digitSum = digits.reduce((a,b)=>a+b,0);
  const reduced = reduceDigit(digitSum);
  const lens = `Digit-sum lens (${digitSum} → ${reduced}): ${reduced}`;

  let base = "";
  if(pattern.startsWith("Repeating")){
    base = `Emphasis pattern (${num}): ${digits[0]}`;
  }else if(pattern.includes("Mirror")){
    base = "Reflection and alignment. Consider what’s being mirrored back—choices, habits, or timing.";
  }else if(pattern.includes("Ascending")){
    base = "Momentum and progression. A step-by-step signal: continue, iterate, and keep moving forward.";
  }else if(pattern.includes("Descending")){
    base = "Decompression and reset. A signal to slow down, simplify, and release what no longer fits.";
  }else if(pattern.includes("Double")){
    base = "Reinforced signal (repeated block). Two-part emphasis: a theme, then the same theme again.";
  }else{
    base = "A general interpretation is heightened awareness: notice your thoughts, environment, and choices—then act deliberately.";
  }

  const meanings = {
    1:"initiative, clarity, leadership, beginnings",
    2:"balance, partnership, patience, cooperation",
    3:"creativity, expression, growth, encouragement",
    4:"structure, foundation, discipline, stability",
    5:"change, adaptation, movement, freedom",
    6:"care, responsibility, home, support",
    7:"insight, inner wisdom, spiritual inquiry, reflection",
    8:"strength, power, resourcefulness, material mastery",
    9:"closure, compassion, integration, completing a cycle with grace",
    0:"potential, openness, reset, the space before form",
  };
  const lensLine = `${lens}: ${reduced} is often linked with ${meanings[reduced] || "reflection"}.`;

  const meaning = `${base}\n${lensLine}`;
  return { clean:num, pattern, meaning };
}

/* IndexedDB */
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = ()=>{
      const dbx = req.result;
      if(!dbx.objectStoreNames.contains(STORE)){
        const st = dbx.createObjectStore(STORE, { keyPath:"id" });
        st.createIndex("ts","ts",{ unique:false });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
function tx(mode="readonly"){
  return db.transaction(STORE, mode).objectStore(STORE);
}
function idbGetAll(){
  return new Promise((resolve,reject)=>{
    const req = tx("readonly").getAll();
    req.onsuccess = ()=> resolve(req.result || []);
    req.onerror = ()=> reject(req.error);
  });
}
function idbPut(rec){
  return new Promise((resolve,reject)=>{
    const req = tx("readwrite").put(rec);
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}
function idbDelete(id){
  return new Promise((resolve,reject)=>{
    const req = tx("readwrite").delete(id);
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}

/* Render */
async function loadAll(){
  allRecords = await idbGetAll();
  allRecords.sort((a,b)=> (b.ts||"").localeCompare(a.ts||""));
  renderDateFilters();
  renderLog();
}
function renderDateFilters(){
  const dates = allRecords.map(r => r.ts).filter(Boolean).sort();
  const uniq = [...new Set(dates.map(d => d.slice(0,10)))];
  const dateOpts = ['<option value="">(any)</option>'].concat(uniq.map(d => `<option value="${d}">${d}</option>`));
  els.fromSelect.innerHTML = dateOpts.join("");
  els.toSelect.innerHTML = dateOpts.join("");
}
function withinDateRange(ts, fromDay, toDay){
  if(!ts) return true;
  const day = ts.slice(0,10);
  if(fromDay && day < fromDay) return false;
  if(toDay && day > toDay) return false;
  return true;
}
function renderLog(){
  const q = safeText(els.searchInput.value).trim().toLowerCase();
  const fromDay = els.fromSelect.value || "";
  const toDay = els.toSelect.value || "";
  const filtered = allRecords.filter(r=>{
    if(!withinDateRange(r.ts, fromDay, toDay)) return false;
    if(!q) return true;
    const hay = [r.num, r.pattern, r.meaning, r.notes].map(x => safeText(x).toLowerCase()).join(" ");
    return hay.includes(q);
  });

  els.logList.innerHTML = filtered.map(r=>{
    const dt = fmtDT(r.ts);
    return `
      <div class="card" data-id="${escapeHtml(r.id)}">
        <div class="cardTop">
          <div style="min-width:0;">
            <div class="cardTime">${escapeHtml(dt)}</div>
            <div class="cardNum">${escapeHtml(r.num || "")}</div>
          </div>
          <div class="cardPattern">${escapeHtml(r.pattern || "")}</div>
        </div>
        <div class="cardBody">
          ${r.notes ? `<div class="kv"><div class="k">Notes:</div><div class="v">${escapeHtml(r.notes)}</div></div>` : ``}
          ${r.meaning ? `<div class="kv"><div class="k">Meaning:</div><div class="v">${escapeHtml(r.meaning)}</div></div>` : ``}
        </div>
      </div>
    `;
  }).join("");

  els.emptyLabel.classList.toggle("hidden", filtered.length !== 0);

  [...els.logList.querySelectorAll(".card")].forEach(card=>{
    card.addEventListener("click", ()=>{
      const id = card.getAttribute("data-id");
      openCardModal(id);
    }, { passive:true });
  });
}

/* Modal */
function modalOpen(title, sub, bodyHtml, footerHtml){
  els.modalH.textContent = title;
  els.modalSub.textContent = sub;
  els.modalBody.innerHTML = bodyHtml;
  els.modalFooter.innerHTML = footerHtml || "";
  els.modalMask.classList.add("show");
  els.modalMask.setAttribute("aria-hidden","false");
  els.modalBody.scrollTop = 0;
}
function modalClose(){
  els.modalMask.classList.remove("show");
  els.modalMask.setAttribute("aria-hidden","true");
  els.modalBody.innerHTML = "";
  els.modalFooter.innerHTML = "";
}
els.modalX.addEventListener("click", modalClose);
els.modalMask.addEventListener("click", (e)=>{ if(e.target === els.modalMask) modalClose(); });

function recordToText(r){
  return [
    `Angel Numbers Tracker`,
    `App Version: ${APP_VERSION}`,
    `------------------------------`,
    `Date/Time: ${fmtDT(r.ts)}`,
    `Number: ${r.num || ""}`,
    `Pattern: ${r.pattern || ""}`,
    `Meaning: ${r.meaning || ""}`,
    `Notes: ${r.notes || ""}`,
  ].join("\n");
}
async function copyText(t){
  try{
    await navigator.clipboard.writeText(t);
    toastHome("Copied.");
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    toastHome("Copied.");
  }
}
function downloadText(filename, text){
  const blob = new Blob([text], { type:"text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
function exportSingle(r){
  downloadText(`angel-number-${(r.num||"entry")}-${r.ts?.slice(0,10)||"date"}.txt`, recordToText(r));
}
function openCardModal(id){
  const r = allRecords.find(x=>x.id===id);
  if(!r) return;
  const dt = fmtDT(r.ts);

  const body = `
    <div class="viewGrid">
      <div class="viewRow">
        <div class="viewKey">Number</div>
        <div class="viewVal" style="font-size:22px; font-weight:900; letter-spacing:.6px;">${escapeHtml(r.num || "")}</div>
      </div>
      ${r.notes ? `
        <div class="viewRow">
          <div class="viewKey">Notes</div>
          <div class="viewVal">${escapeHtml(r.notes)}</div>
        </div>
      ` : ``}
      <div class="viewRow">
        <div class="viewKey">Pattern</div>
        <div class="viewVal">${escapeHtml(r.pattern || "")}</div>
      </div>
      <div class="viewRow">
        <div class="viewKey">Meaning</div>
        <div class="viewVal" style="white-space:pre-wrap;">${escapeHtml(r.meaning || "")}</div>
      </div>
      <div class="miniNotice">Stored locally on this device. Timestamp: ${escapeHtml(dt)}</div>
    </div>
  `;

  const footer = `
    <button class="btn btnWide" id="mCopy">Copy</button>
    <button class="btn btnWide" id="mExport">Export</button>
    <button class="btn btnWide btnPrimary" id="mEdit">Edit</button>
  `;

  modalOpen("Angel Number Card", "Angel Numbers Tracker", body, footer);
  document.getElementById("mCopy").onclick = ()=> copyText(recordToText(r));
  document.getElementById("mExport").onclick = ()=> exportSingle(r);
  document.getElementById("mEdit").onclick = ()=> { modalClose(); startEdit(r.id); };
}

/* Add/Edit flow */
function updateAnalysis(){
  const a = analyzeNumber(els.numInput.value);
  els.patternText.textContent = a.pattern;
  els.meaningText.textContent = a.meaning;
}
function resetFormForAdd(){
  editingId = null;
  els.editModeLabel.textContent = "New entry";
  els.btnDelete.style.opacity = .45;
  els.btnDelete.disabled = true;

  // FIX: hide Date/Time control on ADD
  els.dtWrap.classList.add("hidden");

  els.numInput.value = "";
  els.notesInput.value = "";
  updateAnalysis();

  // Focus number field for add
  setTimeout(()=> els.numInput.focus({ preventScroll:true }), 60);
}
function ensureDtOptionsAndSet(valueISO){
  // Build a small list centered around record time for editing
  const base = valueISO ? new Date(valueISO) : new Date();
  const opts = [];
  for(let i=15;i>=0;i--){
    const d = new Date(base.getTime() - i*60*1000);
    opts.push({ v:d.toISOString(), label: fmtDT(d) });
  }
  for(let i=1;i<=15;i++){
    const d = new Date(base.getTime() + i*60*1000);
    opts.push({ v:d.toISOString(), label: fmtDT(d) });
  }
  // include exact value first if not already in window
  const exists = opts.some(o => o.v === valueISO);
  if(!exists && valueISO){
    opts.unshift({ v:valueISO, label: fmtDT(valueISO) });
  }
  els.dtSelect.innerHTML = opts.map(o => `<option value="${o.v}">${escapeHtml(o.label)}</option>`).join("");
  if(valueISO) els.dtSelect.value = valueISO;
}
function startNew(){
  resetFormForAdd();
  setScreen(els.screenAdd);
}
function startEdit(id){
  const r = allRecords.find(x=>x.id===id);
  if(!r) return;
  editingId = id;
  els.editModeLabel.textContent = "Editing entry";
  els.btnDelete.style.opacity = 1;
  els.btnDelete.disabled = false;

  // FIX: Date/Time editable ONLY on EDIT
  els.dtWrap.classList.remove("hidden");
  ensureDtOptionsAndSet(r.ts || nowISO());

  els.numInput.value = r.num || "";
  els.notesInput.value = r.notes || "";
  updateAnalysis();

  setScreen(els.screenAdd);
}
async function saveForm(){
  const a = analyzeNumber(els.numInput.value);
  if(!a.clean){
    toastHome("Enter a number first.");
    return;
  }

  const rec = {
    id: editingId || uid(),
    // FIX: on ADD, timestamp is NOW and not editable; on EDIT, timestamp is from select
    ts: editingId ? (els.dtSelect.value || nowISO()) : nowISO(),
    num: a.clean,
    pattern: a.pattern,
    meaning: a.meaning,
    notes: safeText(els.notesInput.value).trim(),
    updatedAt: nowISO(),
  };

  await idbPut(rec);
  await loadAll();
  setScreen(els.screenLog);
  els.logScroll.scrollTop = 0;
}
async function deleteCurrent(){
  if(!editingId) return;
  const id = editingId;
  modalOpen("Delete entry", "Confirm", `
    <div class="viewGrid">
      <div class="viewVal">Delete this entry permanently?</div>
    </div>
  `, `
    <button class="btn btnWide" id="dCancel">Cancel</button>
    <button class="btn btnWide btnPrimary" id="dYes">Delete</button>
  `);
  document.getElementById("dCancel").onclick = modalClose;
  document.getElementById("dYes").onclick = async ()=>{
    modalClose();
    await idbDelete(id);
    editingId = null;
    await loadAll();
    setScreen(els.screenLog);
  };
}

/* Export */
function buildExportReport(records, rangeLabel){
  const now = new Date();
  const header = [
    `Angel Numbers Tracker — Export Report`,
    `App Version: ${APP_VERSION}`,
    `Report: Log Export`,
    `Generated: ${now.toLocaleString()}`,
    `Range: ${rangeLabel}`,
    `How this data was captured:`,
    `- Sightings are entered manually into Angel Numbers Tracker on this device.`,
    `- Data is stored locally on the phone (no cloud sync, no account).`,
    `- Each record may include the number, pattern type, a cultural/numerology meaning, and optional notes.`,
    `This report reflects the Log screen filters (Search + optional From/To dates).`,
    `------------------------------`
  ].join("\n");

  const blocks = records.map(r=>{
    return [
      fmtDT(r.ts),
      `Number: ${r.num || ""}`,
      `Pattern: ${r.pattern || ""}`,
      `Meaning: ${r.meaning || ""}`,
      `Notes: ${r.notes || ""}`,
      ``
    ].join("\n");
  }).join("\n");

  return header + "\n" + blocks;
}
function exportFiltered(){
  const q = safeText(els.searchInput.value).trim().toLowerCase();
  const fromDay = els.fromSelect.value || "";
  const toDay = els.toSelect.value || "";
  const filtered = allRecords.filter(r=>{
    if(!withinDateRange(r.ts, fromDay, toDay)) return false;
    if(!q) return true;
    const hay = [r.num, r.pattern, r.meaning, r.notes].map(x => safeText(x).toLowerCase()).join(" ");
    return hay.includes(q);
  });

  const rangeLabel = (!q && !fromDay && !toDay)
    ? "All log entries (filtered by search/date if set)"
    : `Filtered — Search="${q||"(none)"}", From="${fromDay||"(any)"}", To="${toDay||"(any)"}"`;

  const report = buildExportReport(filtered, rangeLabel);

  modalOpen("Export", "Choose output", `
    <div class="viewGrid">
      <div class="viewVal">Entries: <strong>${filtered.length}</strong></div>
      <div class="miniNotice">Exports match the current Log filters.</div>
    </div>
  `, `
    <button class="btn btnWide" id="eCopy">Copy</button>
    <button class="btn btnWide btnPrimary" id="eFile">Export</button>
  `);

  document.getElementById("eCopy").onclick = ()=> copyText(report);
  document.getElementById("eFile").onclick = ()=> downloadText(`angel-numbers-export-${new Date().toISOString().slice(0,10)}.txt`, report);
}

/* Backup/Restore */
function backupJSON(){
  const payload = { app:"Angel Numbers Tracker", version:APP_VERSION, exportedAt:nowISO(), records:allRecords };
  downloadText(`angel-numbers-backup-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload,null,2));
}
function restoreJSONFlow(){
  modalOpen("Restore", "Paste backup JSON", `
    <div class="viewGrid">
      <div class="miniNotice">Paste the full JSON backup. This will merge entries by ID.</div>
      <textarea id="restoreBox" style="min-height:220px;"></textarea>
    </div>
  `, `
    <button class="btn btnWide" id="rCancel">Cancel</button>
    <button class="btn btnWide btnPrimary" id="rApply">Restore</button>
  `);
  document.getElementById("rCancel").onclick = modalClose;
  document.getElementById("rApply").onclick = async ()=>{
    const raw = document.getElementById("restoreBox").value.trim();
    try{
      const obj = JSON.parse(raw);
      const recs = Array.isArray(obj.records) ? obj.records : [];
      for(const r of recs){
        if(r && r.id){
          await idbPut({
            id: safeText(r.id),
            ts: safeText(r.ts || nowISO()),
            num: safeText(r.num || ""),
            pattern: safeText(r.pattern || ""),
            meaning: safeText(r.meaning || ""),
            notes: safeText(r.notes || ""),
            updatedAt: nowISO(),
          });
        }
      }
      modalClose();
      await loadAll();
      toastHome("Restore complete.");
    }catch(e){
      toastHome("Invalid JSON.");
    }
  };
}

/* Pull-to-refresh on HOME */
let pullStartY = null, pullActive = false, pullDist = 0;
function attachPullToRefresh(){
  const home = els.screenHome;
  home.addEventListener("pointerdown", (e)=>{
    pullStartY = e.clientY;
    pullActive = true;
    pullDist = 0;
  }, { passive:true });

  home.addEventListener("pointermove", (e)=>{
    if(!pullActive || pullStartY == null) return;
    pullDist = e.clientY - pullStartY;
    if(pullDist > 10){
      els.pullHint.classList.add("show");
      els.pullHint.textContent = (pullDist > 80) ? "Release to refresh/apply update" : "Pull down to check update";
    }
  }, { passive:true });

  home.addEventListener("pointerup", async ()=>{
    if(!pullActive) return;
    els.pullHint.classList.remove("show");
    const did = pullDist > 80;
    pullActive = false; pullStartY = null; pullDist = 0;
    if(did) await checkForUpdateAndReload();
  }, { passive:true });

  home.addEventListener("pointercancel", ()=>{
    pullActive = false; pullStartY = null; pullDist = 0;
    els.pullHint.classList.remove("show");
  }, { passive:true });
}
async function checkForUpdateAndReload(){
  toastHome("Checking for update…");
  try{
    if("serviceWorker" in navigator){
      const reg = await navigator.serviceWorker.getRegistration();
      if(reg) await reg.update();
    }
  }catch(e){}
  toastHome("Refreshing…");
  setTimeout(()=> location.reload(), 250);
}

/* Manifest + SW */
function buildManifest(){
  const manifest = {
    name:"Angel Numbers Tracker",
    short_name:"Angel Numbers",
    start_url:"./",
    display:"standalone",
    background_color:THEME_COLOR,
    theme_color:THEME_COLOR,
    icons:[
      { src:"data:image/svg+xml,"+encodeURIComponent(iconSVG()), sizes:"192x192", type:"image/svg+xml" },
      { src:"data:image/svg+xml,"+encodeURIComponent(iconSVG()), sizes:"512x512", type:"image/svg+xml" }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], { type:"application/manifest+json" });
  const url = URL.createObjectURL(blob);
  document.getElementById("manifestLink").setAttribute("href", url);
}
function iconSVG(){
  return `
    <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 64 64">
      <rect x="0" y="0" width="64" height="64" rx="14" fill="#0b1324"/>
      <ellipse cx="32" cy="14.5" rx="12" ry="6" fill="none" stroke="rgba(235,245,255,.78)" stroke-width="3"/>
      <path d="M22 30c-7-7-14-4-14 6 0 9 7 16 18 20-2-7-2-16-4-26Z" fill="rgba(120,190,255,.70)"/>
      <path d="M42 30c7-7 14-4 14 6 0 9-7 16-18 20 2-7 2-16 4-26Z" fill="rgba(190,120,255,.66)"/>
      <path d="M24 39c2 9 7 15 8 15s6-6 8-15c-3 2-6 3-8 3s-5-1-8-3Z" fill="rgba(235,245,255,.80)"/>
    </svg>
  `.trim();
}
async function registerSW(){
  if(!("serviceWorker" in navigator)) return;
  const swCode = `
    const CACHE_NAME = "angel-numbers-tracker-${APP_VERSION}";
    self.addEventListener("install", (e)=>{
      self.skipWaiting();
      e.waitUntil((async()=>{
        const cache = await caches.open(CACHE_NAME);
        try{ await cache.addAll(["./"]); }catch(_){}
      })());
    });
    self.addEventListener("activate", (e)=>{
      e.waitUntil((async()=>{
        const keys = await caches.keys();
        await Promise.all(keys.map(k => (k.startsWith("angel-numbers-tracker-") && k !== CACHE_NAME) ? caches.delete(k) : Promise.resolve()));
        await self.clients.claim();
      })());
    });
    self.addEventListener("fetch", (e)=>{
      e.respondWith((async()=>{
        const cached = await caches.match(e.request, { ignoreSearch:true });
        if(cached) return cached;
        try{
          const res = await fetch(e.request);
          const cache = await caches.open(CACHE_NAME);
          cache.put(e.request, res.clone());
          return res;
        }catch(err){
          return cached || new Response("Offline", { status:503 });
        }
      })());
    });
  `.trim();
  const blob = new Blob([swCode], { type:"text/javascript" });
  const swUrl = URL.createObjectURL(blob);
  try{ await navigator.serviceWorker.register(swUrl); }catch(e){}
}

/* Install/Uninstall/Exit */
let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e)=>{ e.preventDefault(); deferredPrompt = e; });

async function doInstall(){
  if(deferredPrompt){
    deferredPrompt.prompt();
    try{ await deferredPrompt.userChoice; }catch(e){}
    deferredPrompt = null;
    toastHome("Install prompt shown.");
  }else{
    toastHome("If installed already, open from home screen.");
  }
}
async function doUninstall(){
  modalOpen("Uninstall", "PWA removal", `
    <div class="viewGrid">
      <div class="viewVal">To uninstall:</div>
      <div class="miniNotice">Android: long-press the app icon → Uninstall, or Settings → Apps → Angel Numbers Tracker → Uninstall.</div>
      <div class="miniNotice">Uninstall may remove local data.</div>
    </div>
  `, `<button class="btn btnWide btnPrimary" id="uOk">OK</button>`);
  document.getElementById("uOk").onclick = modalClose;
}
function doExit(){
  try{
    window.close();
    setTimeout(()=>{ alert("If this did not close, use your device back/home button."); }, 200);
  }catch(e){
    alert("Use your device back/home button.");
  }
}

/* Wire events */
els.btnGoAdd.addEventListener("click", startNew);
els.btnGoLog.addEventListener("click", ()=>{ setScreen(els.screenLog); renderLog(); });

els.btnAddBack.addEventListener("click", ()=> setScreen(els.screenHome));
els.btnLogBack.addEventListener("click", ()=> setScreen(els.screenHome));
els.btnLogAdd.addEventListener("click", startNew);

els.btnSave.addEventListener("click", saveForm);
els.btnDelete.addEventListener("click", deleteCurrent);
els.btnViewCard.addEventListener("click", ()=>{
  const a = analyzeNumber(els.numInput.value);
  const temp = {
    id:"preview",
    ts: editingId ? (els.dtSelect.value || nowISO()) : nowISO(),
    num:a.clean || "",
    pattern:a.pattern,
    meaning:a.meaning,
    notes:safeText(els.notesInput.value).trim()
  };
  const dt = fmtDT(temp.ts);
  const body = `
    <div class="viewGrid">
      <div class="viewRow">
        <div class="viewKey">Number</div>
        <div class="viewVal" style="font-size:22px; font-weight:900; letter-spacing:.6px;">${escapeHtml(temp.num || "")}</div>
      </div>
      ${temp.notes ? `
        <div class="viewRow">
          <div class="viewKey">Notes</div>
          <div class="viewVal">${escapeHtml(temp.notes)}</div>
        </div>
      ` : ``}
      <div class="viewRow">
        <div class="viewKey">Pattern</div>
        <div class="viewVal">${escapeHtml(temp.pattern || "")}</div>
      </div>
      <div class="viewRow">
        <div class="viewKey">Meaning</div>
        <div class="viewVal" style="white-space:pre-wrap;">${escapeHtml(temp.meaning || "")}</div>
      </div>
      <div class="miniNotice">Preview. Timestamp: ${escapeHtml(dt)}</div>
    </div>
  `;
  modalOpen("Angel Number Card", "Angel Numbers Tracker", body, `
    <button class="btn btnWide" id="pCopy">Copy</button>
    <button class="btn btnWide btnPrimary" id="pClose">Close</button>
  `);
  document.getElementById("pCopy").onclick = ()=> copyText(recordToText(temp));
  document.getElementById("pClose").onclick = modalClose;
});

els.btnSearch.addEventListener("click", renderLog);
els.searchInput.addEventListener("input", renderLog);
els.fromSelect.addEventListener("change", renderLog);
els.toSelect.addEventListener("change", renderLog);

els.btnExport.addEventListener("click", exportFiltered);
els.btnBackup.addEventListener("click", backupJSON);
els.btnRestore.addEventListener("click", restoreJSONFlow);
els.btnInstall.addEventListener("click", doInstall);
els.btnUninstall.addEventListener("click", doUninstall);
els.btnExit.addEventListener("click", doExit);

els.numInput.addEventListener("input", updateAnalysis);

/* Init */
(async function init(){
  els.subtitle.textContent = `Offline • Local-only • ${APP_VERSION}`;
  buildManifest();
  await registerSW();

  try{
    db = await openDB();
    els.dbPill.textContent = "DB: OK";
  }catch(e){
    els.dbPill.textContent = "DB: ERR";
    return;
  }

  // Legacy import (optional)
  try{
    const legacy = localStorage.getItem(LEGACY_KEY);
    if(legacy){
      const arr = JSON.parse(legacy);
      if(Array.isArray(arr) && arr.length){
        for(const r of arr){
          if(r && r.id){
            await idbPut({
              id: safeText(r.id),
              ts: safeText(r.ts || nowISO()),
              num: safeText(r.num || ""),
              pattern: safeText(r.pattern || ""),
              meaning: safeText(r.meaning || ""),
              notes: safeText(r.notes || ""),
              updatedAt: nowISO(),
            });
          }
        }
      }
      localStorage.removeItem(LEGACY_KEY);
    }
  }catch(e){}

  await loadAll();
  resetFormForAdd();
  attachPullToRefresh();
  toastHome("Ready.");
})();
</script>

<!--
Version Detail Notes
App Version: v1.0B10
Base: v1.0B9
Changes (requested):
- Date/Time is NOT editable on ADD screen: removed from add UI; timestamp defaults to NOW.
- Date/Time is editable ONLY when editing an existing entry: dt select appears in Edit mode only.
- Kept prior fixes: log list scrollable, modal scrollable, compact Angel Card spacing, consistent accent border, pull-to-refresh on Home.
No other behavior changes intended.
-->
</html>
