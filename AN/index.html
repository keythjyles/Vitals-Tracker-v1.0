<!-- Angel Numbers Tracker v1.0B4 -->
<!--
Version Detail Notes
App Version (internal): v1.0B4
Home display label (visual only): v1.333  (DO NOT CHANGE unless user instructs)
Base: v1.0B3 (continuation; rebuilt here from last shared A-series code + requested B-series changes)
Focus (B): Calendar + interaction polish.

Changes in v1.0B4 (requested):
- Remove Charts entirely; replace with Calendar (rename all buttons/labels/references).
- Home main button text: "ADD Angel Number".
- Add Home line: "Inspired by a real Angel."
- Add animated swipe navigation (right swipe cycles: Home -> Calendar -> Log -> Home; incoming panel slides in opposite swipe direction).
  - Prevent accidental taps during swipe; brief interaction lock after swipe.
- Implement Month Calendar that fits the visible screen:
  - Only highlight days with data; no "No sightings" labels.
  - Tap a highlighted day -> day popup listing that day’s entries.
  - Tap a day entry -> Angel Number Card popup (shows all record data; copy/export/save/edit).
- Make Date/Time editable on edit screen (entertainment use).
- Fix popups so they all match (delete confirmation + version popup + heart popup use same modal styling).
- Ensure Log panel scroll works (panel content scrollable).
- Add Easter egg: tap 5 times on the v1.333 label -> animated heart + message "The Angels love you Timmy!" (closable X).
- Keep quadruple-tap logo -> version popup, but formatted like other popups.
- Add removable test data for a couple months (seeded only if no saved records). Easy removal via TEST_DATA_ENABLED flag.
- Include EOF commented block for future edits.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Angel Numbers Tracker</title>

  <link rel="manifest" id="manifestLink" href="#" />

  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;
      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --text:rgba(235,245,255,.86);
      --muted:rgba(235,245,255,.58);
      --muted2:rgba(235,245,255,.42);
      --accent:#2b4e7a;
      --shadow:0 14px 40px rgba(0,0,0,.38);
      --radius:26px;
      --btnH:56px;
      --pad:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 0%, rgba(47,120,255,.22), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(155,120,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex;
      justify-content:center;
      padding: max(14px, env(safe-area-inset-top)) 12px max(14px, env(safe-area-inset-bottom));
      overflow:hidden;
    }

    .app{
      width:min(520px, 100%);
      height: 100%;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:hidden;
    }

    .logoTitle{
      margin:10px 6px 0;
      display:flex;
      justify-content:center;
      align-items:center;
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .logoTitle svg{
      width:min(520px, 100%);
      height:auto;
      display:block;
    }

    .screenArea{
      position:relative;
      flex:1;
      overflow:hidden;
      border-radius: var(--radius);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
      backdrop-filter: blur(10px);

      position:absolute;
      inset:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Unified accent border for all panels/modals */
    .accentFrame{ position:relative; }
    .accentFrame::before{
      content:"";
      position:absolute;
      inset:-3px;
      border:3px solid var(--accent);
      border-radius: calc(var(--radius) + 3px);
      pointer-events:none;
      z-index:0;
    }
    .accentFrame > *{ position:relative; z-index:1; }

    .hidden{ display:none !important; }

    .btn{
      height:var(--btnH);
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color:rgba(235,245,255,.78);
      font-weight:650;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 18px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-size:18px;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(47,120,255,.92), rgba(47,120,255,.72));
      border-color: rgba(120,170,255,.55);
      color: rgba(235,245,255,.90);
    }

    .btn.danger{
      background: linear-gradient(180deg, rgba(255,80,80,.18), rgba(255,80,80,.10));
      border-color: rgba(255,120,120,.42);
      color: rgba(255,225,225,.92);
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
    }

    .btn.small{
      height:44px;
      font-size:16px;
      padding:0 14px;
      font-weight:650;
      white-space:nowrap;
    }

    .btn:disabled{
      opacity:.55;
      filter:saturate(.85);
      transform:none !important;
      pointer-events:none;
    }

    .row{ display:flex; gap:12px; }
    .row.center{ align-items:center; }
    .grow{ flex:1; }

    .label{
      font-size:16px;
      color:var(--muted);
      font-weight:650;
      margin: 12px 4px 8px;
    }
    .subtle{
      font-size:14px;
      color:var(--muted2);
      margin: 6px 4px 0;
    }

    .field{
      border:2px solid var(--strokeBold);
      background: rgba(255,255,255,.06);
      color: rgba(235,245,255,.86);
      border-radius: 18px;
      height:54px;
      padding: 0 14px;
      font-size:18px;
      outline:none;
      width:100%;
    }
    .field::placeholder{ color: rgba(235,245,255,.35); }
    .field:focus{
      border-color: rgba(90,150,255,.78);
      box-shadow: 0 0 0 4px rgba(47,120,255,.16);
    }
    textarea.field{
      height:84px;
      padding: 12px 14px;
      resize:none;
      line-height:1.25;
    }
    input[type="date"].field,
    input[type="datetime-local"].field,
    input[type="month"].field{
      font-size:16px;
      padding-right: 10px;
    }

    .homeMain{
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-top:8px;
    }
    .homeMain > .btn:not(.small){
      font-size:26px;
      font-weight:750;
      letter-spacing:.3px;
    }

    .homeFooterRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
      flex-wrap:nowrap;
    }

    .footerTiny{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: rgba(235,245,255,.38);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .timeLine{
      margin: 4px 4px 14px;
      color: rgba(235,245,255,.82);
      font-weight:750;
      letter-spacing:.3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.05;
      font-size: clamp(18px, 6.4vw, 44px);
    }

    .meaningCard{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: 22px;
      padding: 12px 12px 10px;
      margin-top: 10px;
    }
    .meaningTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .numBig{
      font-size:26px;
      font-weight:900;
      letter-spacing:.3px;
      white-space:nowrap;
    }
    .patternPill{
      font-size:13px;
      color: rgba(235,245,255,.70);
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight:750;
      white-space:nowrap;
    }
    .meaningText{
      color: rgba(235,245,255,.74);
      font-size:15px;
      line-height:1.18;
      white-space: pre-wrap;
    }
    .disclaimer{
      margin-top:8px;
      color: rgba(235,245,255,.44);
      font-size:12px;
      line-height:1.25;
    }

    .panelButtons{
      display:flex;
      gap:12px;
      margin-top: 12px;
      flex-wrap:wrap;
    }

    #log .label{ margin: 8px 4px 6px; }
    #log .filters{ margin-top: 8px; gap: 10px; }
    #log .dateField{ gap: 6px; }
    #log > .row.center{ margin-bottom: 4px; }

    .entry{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: 22px;
      padding: 10px 10px 9px;
      margin-top: 6px;
      touch-action: manipulation;
    }
    .entry.pressed{
      background: rgba(47,120,255,.14);
      border-color: rgba(90,150,255,.55);
    }
    .entry:active{ transform: translateY(1px); }

    .entryTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom: 2px;
    }
    .entryTime{
      font-size:13px;
      color: rgba(235,245,255,.46);
      white-space:nowrap;
    }
    .entryMain{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
    }
    .entryNumber{
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .entryPattern{
      font-size:14px;
      color: rgba(235,245,255,.68);
      font-weight:800;
      white-space:nowrap;
    }
    .entryLine{
      margin-top: 6px;
      color: rgba(235,245,255,.62);
      font-size:15px;
      line-height:1.12;
    }
    .entryLine b{ color: rgba(235,245,255,.70); }

    .filters{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top:10px;
    }
    .dateField{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .dateField .miniLabel{
      margin: 0 4px;
      color: var(--muted);
      font-weight:650;
      font-size:14px;
    }

    .searchRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .searchRow .field{
      flex: 1 1 auto;
      min-width: 0;
    }
    .searchRow .btn.small{
      flex: 0 0 auto;
      height:54px;
      font-size:16px;
      padding: 0 16px;
      border-radius: 18px;
    }

    .editPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color: rgba(235,245,255,.70);
      font-weight:700;
      letter-spacing:.2px;
      margin: 0 4px 10px;
      width: fit-content;
    }

    /* Modal (unified) */
    .modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: max(16px, env(safe-area-inset-top)) 14px max(16px, env(safe-area-inset-bottom));
      background: rgba(0,0,0,.56);
      z-index: 9998;
    }
    .modalCard{
      width:min(520px, 100%);
      border-radius: 26px;
      border: 3px solid var(--accent);
      background: linear-gradient(180deg, rgba(12,21,40,.96), rgba(8,16,31,.96));
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 18px;
      backdrop-filter: blur(10px);
      max-height: calc(100vh - 60px);
      overflow:auto;
    }
    .modalTitle{
      font-weight: 900;
      letter-spacing: .2px;
      color: rgba(235,245,255,.92);
      font-size: clamp(22px, 6.5vw, 34px);
      line-height: 1.05;
      margin: 4px 2px 14px;
    }
    .modalSub{
      color: rgba(235,245,255,.66);
      font-size: 14px;
      margin: 0 2px 14px;
      white-space: pre-wrap;
      line-height: 1.28;
    }
    .modalBtns{
      display:flex;
      gap:12px;
      margin-top: 6px;
      flex-wrap:wrap;
    }
    .modalBtns .btn{
      flex:1;
      height: 54px;
      font-size: 18px;
      font-weight: 800;
      min-width: 140px;
    }

    /* Close X (top-right) */
    .xCloseRow{
      display:flex;
      justify-content:flex-end;
      margin: -6px -6px 6px;
    }
    .xBtn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color: rgba(235,245,255,.82);
      font-weight: 900;
      font-size: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .xBtn:active{ transform: translateY(1px); }

    /* Calendar */
    .calTop{
      display:flex;
      gap:12px;
      align-items:center;
      margin-top: 10px;
    }
    .calTop .field{ height:52px; border-radius: 18px; }
    .calTop .btn.small{ height:52px; border-radius: 18px; }

    .calGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      width:100%;
    }
    .calDow{
      text-align:center;
      font-size: 12px;
      color: rgba(235,245,255,.54);
      font-weight: 800;
      letter-spacing:.2px;
      padding: 2px 0 4px;
      user-select:none;
    }

    .calCell{
      border:1px solid rgba(235,245,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      min-height: 56px;
      padding: 8px 8px 6px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:6px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .calCell .dnum{
      font-weight: 900;
      font-size: 14px;
      color: rgba(235,245,255,.76);
      line-height: 1;
    }
    .calCell .mini{
      font-size: 11px;
      color: rgba(235,245,255,.60);
      line-height: 1.05;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .calCell.hasData{
      border-color: rgba(90,150,255,.45);
      background: rgba(47,120,255,.12);
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
    }
    .calCell.hasData:active{ transform: translateY(1px); }

    .calCell.outMonth{
      opacity:.42;
    }

    .calHint{
      margin-top:10px;
      font-size: 13px;
      color: rgba(235,245,255,.44);
    }

    /* Screen animations (opposite swipe direction) */
    .animWrap{
      position:relative;
      height:100%;
      overflow:hidden;
      border-radius: var(--radius);
    }
    .screenAnim{
      position:absolute;
      inset:0;
      will-change: transform, opacity;
    }
    .slideInFromLeft{ transform: translateX(-100%); }
    .slideOutToRight{ transform: translateX(0%); }
    .animGoIn{ transition: transform 280ms cubic-bezier(.2,.9,.2,1); transform: translateX(0%); }
    .animGoOut{ transition: transform 280ms cubic-bezier(.2,.9,.2,1); transform: translateX(110%); }

    /* Interaction lock overlay during/after swipes */
    .touchLock{
      position:fixed;
      inset:0;
      z-index: 9997;
      background: transparent;
      pointer-events:none;
    }
    .touchLock.on{ pointer-events:auto; }

    /* Heart modal animation */
    .heartWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 2px;
    }
    .heartSvg{
      width: 140px;
      height: 140px;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.55));
      transform: scale(.86);
      opacity: .0;
      animation: popHeart 380ms cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes popHeart{
      0%{ transform: scale(.78); opacity: 0; }
      70%{ transform: scale(1.06); opacity: 1; }
      100%{ transform: scale(1.00); opacity: 1; }
    }

    /* Prevent double-tap zoom issues on some devices */
    button, .calCell, .footerTiny, .logoTitle { touch-action: manipulation; }
  </style>
</head>

<body>
  <div class="touchLock" id="touchLock"></div>

  <div class="app" id="appRoot">

    <div class="logoTitle" aria-label="Angel Numbers Tracker">
      <svg viewBox="0 0 900 140" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Angel Numbers Tracker">
        <defs>
          <linearGradient id="angG" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%" stop-color="#8a6bff"/>
            <stop offset="55%" stop-color="#4fa3ff"/>
            <stop offset="100%" stop-color="#2f78ff"/>
          </linearGradient>
          <filter id="angS" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="rgba(0,0,0,.35)"/>
          </filter>
        </defs>

        <!-- Icon block (wings + halo) -->
        <g transform="translate(46 24)" filter="url(#angS)">
          <rect x="0" y="0" width="92" height="92" rx="26" fill="rgba(255,255,255,.06)" stroke="rgba(235,245,255,.22)" stroke-width="2"/>

          <!-- Halo -->
          <ellipse cx="46" cy="24" rx="20" ry="8" fill="none" stroke="rgba(235,245,255,.88)" stroke-width="4" opacity=".92"/>

          <!-- Wings -->
          <path d="M46 50
                   C34 42, 22 44, 16 54
                   C24 58, 32 66, 38 76
                   C40 66, 43 58, 46 50Z"
                fill="none" stroke="url(#angG)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>

          <path d="M46 50
                   C58 42, 70 44, 76 54
                   C68 58, 60 66, 54 76
                   C52 66, 49 58, 46 50Z"
                fill="none" stroke="url(#angG)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>

          <!-- Spark -->
          <path d="M46 34 L46 42" stroke="rgba(235,245,255,.82)" stroke-width="4" stroke-linecap="round"/>
          <path d="M42 38 L50 38" stroke="rgba(235,245,255,.82)" stroke-width="4" stroke-linecap="round"/>
        </g>

        <text x="160" y="92"
              font-family="system-ui,Segoe UI,Roboto,Helvetica,Arial"
              font-size="66"
              font-weight="860"
              fill="url(#angG)"
              letter-spacing=".6"
              filter="url(#angS)">Angel Numbers Tracker</text>
      </svg>
    </div>

    <div class="screenArea" id="screenArea">

      <div id="home" class="card accentFrame">
        <div class="homeMain">
          <button id="btnGoAdd" class="btn primary">ADD Angel Number</button>
          <button id="btnGoLog" class="btn">Log</button>
          <button id="btnGoCalendar" class="btn">Calendar</button>

          <div class="homeFooterRow">
            <button id="btnInstall" class="btn small">Install</button>
            <button id="btnClearAll" class="btn small">Clear Data</button>
            <div class="grow"></div>
            <button id="btnExitHome" class="btn small danger">Exit</button>
          </div>

          <div class="subtle">Inspired by a real Angel.</div>
          <div class="subtle">Local-only. No accounts. No cloud.</div>

          <div class="footerTiny">
            <div id="homeVerLabel" aria-label="Version label">v1.333</div>
            <div>developed by Keyth Jyles</div>
          </div>
        </div>
      </div>

      <div id="add" class="card accentFrame hidden">
        <div id="editPill" class="editPill hidden">Editing entry</div>

        <div id="timeLine" class="timeLine">--:--:-- --, --/--/----</div>

        <div class="label">Date/Time</div>
        <input id="dtEdit" class="field" type="datetime-local" />

        <div class="label">Number</div>
        <input id="anum" class="field" inputmode="numeric" placeholder="e.g., 111, 1212, 777" />

        <div id="meaningCard" class="meaningCard">
          <div class="meaningTop">
            <div id="numBig" class="numBig">—</div>
            <div id="patternPill" class="patternPill">Pattern: —</div>
          </div>
          <div id="meaningText" class="meaningText">Enter a number to see its commonly shared meaning.</div>
          <div class="disclaimer">
            Cultural note: these meanings come from numerology/“angel number” traditions and vary by source.
            Treat as reflective prompts, not facts or predictions.
          </div>
        </div>

        <div class="label">Notes <span style="color:var(--muted2); font-weight:650;">(optional)</span></div>
        <textarea id="notes" class="field" placeholder="Where did you see it? What were you thinking/feeling?"></textarea>

        <div class="panelButtons">
          <button id="btnSave" class="btn primary grow">Save</button>
          <button id="btnDelete" class="btn grow hidden">Delete</button>
          <button id="btnBackFromAdd" class="btn grow">Back</button>
        </div>
      </div>

      <div id="log" class="card accentFrame hidden">
        <div class="row center">
          <button id="btnExportLog" class="btn small">Export</button>
          <button id="btnAddFromLog" class="btn small">ADD</button>
          <div class="grow"></div>
          <button id="btnBackFromLog" class="btn small">Back</button>
        </div>

        <div class="label">Search</div>
        <div class="searchRow">
          <input id="search" class="field" placeholder="Try: 111, mirror, reset, new start..." />
          <button id="btnRunSearch" class="btn small">Search</button>
        </div>

        <div class="filters">
          <div class="dateField">
            <div class="miniLabel">From</div>
            <input id="fromDate" class="field" type="date" />
          </div>
          <div class="dateField">
            <div class="miniLabel">To</div>
            <input id="toDate" class="field" type="date" />
          </div>
        </div>

        <div id="logList"></div>
      </div>

      <div id="calendar" class="card accentFrame hidden">
        <div class="row center">
          <button id="btnExportMonth" class="btn small">Export</button>
          <div class="grow"></div>
          <button id="btnBackFromCalendar" class="btn small">Back</button>
        </div>

        <div class="calTop">
          <input id="calMonth" class="field" type="month" />
          <button id="btnCalToday" class="btn small">Today</button>
        </div>

        <div class="calGrid" id="calDowRow"></div>
        <div class="calGrid" id="calGrid"></div>
        <div class="calHint">Tap a highlighted day to view entries.</div>
      </div>

    </div>
  </div>

  <!-- Edit prompt modal -->
  <div id="editModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
    <div class="modalCard">
      <div class="modalTitle" id="editModalTitle">Open this entry?</div>
      <div class="modalSub" id="editModalSub">Press Open to view the Angel Number Card.</div>
      <div class="modalBtns">
        <button id="btnEditCancel" class="btn">Cancel</button>
        <button id="btnEditConfirm" class="btn primary">Open</button>
      </div>
    </div>
  </div>

  <!-- Confirm modal (delete/clear/etc.) -->
  <div id="confirmModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modalCard">
      <div class="modalTitle" id="confirmTitle">Confirm</div>
      <div class="modalSub" id="confirmSub">—</div>
      <div class="modalBtns">
        <button id="btnConfirmCancel" class="btn">Cancel</button>
        <button id="btnConfirmOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Export modal -->
  <div id="exportModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle">
    <div class="modalCard">
      <div class="modalTitle" id="exportModalTitle">Export ready</div>
      <div class="modalSub" id="exportModalSub">
Export report was copied to your clipboard.

You can paste it into any messaging app, email, Notes, or any app that accepts text.

Optional:
- Share sends the report to another app.
- Save creates a .txt file on your device.
      </div>
      <div class="modalBtns" style="flex-wrap:nowrap;">
        <button id="btnExportClose" class="btn" style="min-width:0; flex:1 1 0; font-size:16px; height:52px;">Close</button>
        <button id="btnExportShare" class="btn" style="min-width:0; flex:1 1 0; font-size:16px; height:52px;">Share</button>
        <button id="btnExportSave" class="btn primary" style="min-width:0; flex:1 1 0; font-size:16px; height:52px;">Save .txt</button>
      </div>
    </div>
  </div>

  <!-- Angel Number Card modal -->
  <div id="cardModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="cardTitle">
    <div class="modalCard">
      <div class="xCloseRow">
        <button class="xBtn" id="btnCardX" aria-label="Close">×</button>
      </div>
      <div class="modalTitle" id="cardTitle">Angel Number Card</div>
      <div class="modalSub" id="cardBody">—</div>
      <div class="modalBtns">
        <button id="btnCardCopy" class="btn">Copy</button>
        <button id="btnCardExport" class="btn">Export</button>
        <button id="btnCardEdit" class="btn primary">Edit</button>
      </div>
    </div>
  </div>

  <!-- Day modal (list entries for a day) -->
  <div id="dayModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="dayTitle">
    <div class="modalCard">
      <div class="xCloseRow">
        <button class="xBtn" id="btnDayX" aria-label="Close">×</button>
      </div>
      <div class="modalTitle" id="dayTitle">—</div>
      <div class="modalSub" id="dayBody">—</div>
      <div class="modalBtns">
        <button id="btnDayExport" class="btn primary">Export</button>
        <button id="btnDayClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Version modal -->
  <div id="versionModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="verTitle">
    <div class="modalCard">
      <div class="xCloseRow">
        <button class="xBtn" id="btnVerX" aria-label="Close">×</button>
      </div>
      <div class="modalTitle" id="verTitle">Version</div>
      <div class="modalSub" id="verBody">—</div>
      <div class="modalBtns">
        <button id="btnVerClose" class="btn primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Heart modal -->
  <div id="heartModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="heartTitle">
    <div class="modalCard">
      <div class="xCloseRow">
        <button class="xBtn" id="btnHeartX" aria-label="Close">×</button>
      </div>
      <div class="modalTitle" id="heartTitle">A message</div>
      <div class="heartWrap" aria-hidden="true">
        <svg class="heartSvg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="hg" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#ff6aa6"/>
              <stop offset="55%" stop-color="#b56bff"/>
              <stop offset="100%" stop-color="#4fa3ff"/>
            </linearGradient>
          </defs>
          <path d="M60 104
                   C60 104, 18 78, 18 46
                   C18 30, 30 20, 44 20
                   C52 20, 57 24, 60 28
                   C63 24, 68 20, 76 20
                   C90 20, 102 30, 102 46
                   C102 78, 60 104, 60 104Z"
                fill="url(#hg)" stroke="rgba(235,245,255,.85)" stroke-width="3" />
        </svg>
      </div>
      <div class="modalSub" id="heartBody" style="font-size:16px; color: rgba(235,245,255,.82);">
        The Angels love you Timmy!
      </div>
      <div class="modalBtns">
        <button id="btnHeartClose" class="btn primary">Close</button>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const APP_VERSION = "v1.0B4";                // actual version tracked in code
  const HOME_VERSION_LABEL = "v1.333";         // visual-only label on home; do not change unless instructed
  const STORAGE_KEY = "angel_numbers_records_v1";
  const DAY_MS = 24*60*60*1000;

  // Test data (seed only if no saved records). Remove by setting false.
  const TEST_DATA_ENABLED = true;

  const $ = (id) => document.getElementById(id);

  /* =========================
     Meanings (cultural / numerology)
     ========================= */

  const DIGIT_MEANING = {
    "0": "0 is often linked with wholeness, source, and fresh cycles—an invitation to reset and widen perspective.",
    "1": "1 is often linked with new beginnings, initiative, focus, and the power of attention.",
    "2": "2 is often linked with balance, partnership, patience, and alignment through cooperation.",
    "3": "3 is often linked with creativity, expression, growth, and encouragement to communicate.",
    "4": "4 is often linked with stability, foundations, discipline, and building what lasts.",
    "5": "5 is often linked with change, adaptability, movement, and a call to embrace transition.",
    "6": "6 is often linked with care, responsibility, home, and recalibrating priorities toward wellbeing.",
    "7": "7 is often linked with insight, inner wisdom, spiritual inquiry, and learning through reflection.",
    "8": "8 is often linked with strength, momentum, material mastery, and confident stewardship of resources.",
    "9": "9 is often linked with closure, compassion, integration, and completing a cycle with grace."
  };

  const ANGEL_MAP = {
    "000": "Reset and re-center. A ‘clean slate’ moment—expand perspective and begin again.",
    "111": "Focus and intention. A reminder to notice your thoughts and aim them deliberately.",
    "222": "Balance and alignment. Patience—let partnerships and decisions settle into place.",
    "333": "Creativity and support. Express yourself; keep building and communicating clearly.",
    "444": "Foundations and stability. Stay disciplined; the work you’re doing is structural.",
    "555": "Change and movement. A shift is underway—adapt, release the old, step forward.",
    "666": "Recalibration. Check priorities; return to what’s healthy and truly important.",
    "777": "Insight and learning. Trust your inner guidance; deepen study and reflection.",
    "888": "Momentum and abundance. Good stewardship; practical progress and strong energy.",
    "999": "Completion. Close a chapter; integrate lessons; make room for what’s next.",

    "1010": "Fresh cycle + alignment. A restart with a clear direction—stay awake and intentional.",
    "1111": "Gateway / heightened awareness. Focus your intent; clarify what you’re building.",
    "1212": "Realignment and growth. Keep moving—small consistent steps bring a new level.",
    "1234": "Step-by-step progress. Keep it simple; the path is sequential and workable.",
    "1313": "Transform through creativity. Express and restructure; iterate without fear.",
    "1414": "Grounded change. Build stability while adjusting—practical updates, not chaos.",
    "1515": "Change with intention. Choose the transition you want; don’t drift into it.",
    "1616": "Perspective shift. Let go of noise; rebuild from values and calm attention.",
    "1717": "Confidence through insight. Trust what you’ve learned; make the next move.",
    "1818": "Momentum + mastery. Strong forward push—be disciplined with resources.",
    "1919": "Closure into renewal. Finish clean; then start the next cycle with clarity.",

    "2020": "Balance and reflection. Look at both sides; correct course gently.",
    "2121": "Alignment in partnership. Coordination and timing—let pieces meet in the middle.",
    "2222": "Deep alignment. Commit to balance; trust the process over the impulse."
  };

  /* =========================
     Storage
     ========================= */

  function loadRecords(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return [];
      return arr
        .filter(r => r && typeof r.ts === "number")
        .map(r => ({
          ts: r.ts,
          number: (r.number ?? "").toString(),
          pattern: (r.pattern ?? "").toString(),
          meaning: (r.meaning ?? "").toString(),
          notes: (r.notes ?? "").toString()
        }))
        .sort((a,b)=> b.ts - a.ts);
    }catch{
      return [];
    }
  }

  function saveRecords(recs){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(recs));
  }

  /* =========================
     Utilities
     ========================= */

  function fmtDateTime(ts){
    const d = new Date(ts);
    const parts = new Intl.DateTimeFormat(undefined, {
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).formatToParts(d);
    const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
    const mm = map.month, dd = map.day, yy = map.year;
    const hh = map.hour, mi = map.minute, ss = map.second;
    const dp = map.dayPeriod ? ` ${map.dayPeriod}` : "";
    return `${mm}/${dd}/${yy}, ${hh}:${mi}:${ss}${dp}`;
  }

  function fmtTimeCommaDate(ts){
    const d = new Date(ts);
    const time = new Intl.DateTimeFormat(undefined, {
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).format(d);
    const date = new Intl.DateTimeFormat(undefined, {
      month:"2-digit", day:"2-digit", year:"numeric"
    }).format(d);
    return `${time}, ${date}`;
  }

  function startOfDay(ts){
    const d = new Date(ts);
    d.setHours(0,0,0,0);
    return d.getTime();
  }

  function clampEndOfDay(ts){
    const d = new Date(ts);
    d.setHours(23,59,59,999);
    return d.getTime();
  }

  function parseDateField(v){
    if(!v) return null;
    const [y,m,d] = v.split("-").map(Number);
    if(!y || !m || !d) return null;
    return new Date(y, m-1, d, 0, 0, 0, 0).getTime();
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toLocalDatetimeValue(ts){
    const d = new Date(ts);
    const pad = (n)=> String(n).padStart(2,"0");
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth()+1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  function fromLocalDatetimeValue(v){
    if(!v) return null;
    const d = new Date(v);
    const ts = d.getTime();
    return Number.isFinite(ts) ? ts : null;
  }

  function normalizeNumberInput(raw){
    const s = String(raw ?? "").trim();
    return s.replace(/[^\d]/g, "");
  }

  /* =========================
     Pattern detection + meaning
     ========================= */

  function isAllSame(s){
    if(!s || s.length < 2) return false;
    return s.split("").every(ch => ch === s[0]);
  }
  function isPalindrome(s){
    if(!s || s.length < 3) return false;
    const rev = s.split("").reverse().join("");
    return rev === s;
  }
  function isRepeatedHalf(s){
    if(!s || s.length < 4) return false;
    if(s.length % 2 !== 0) return false;
    const half = s.slice(0, s.length/2);
    return half + half === s;
  }
  function isAscendingSeq(s){
    if(!s || s.length < 3) return false;
    for(let i=1;i<s.length;i++){
      const a = s.charCodeAt(i-1) - 48;
      const b = s.charCodeAt(i) - 48;
      if(b !== a + 1) return false;
    }
    return true;
  }
  function isDescendingSeq(s){
    if(!s || s.length < 3) return false;
    for(let i=1;i<s.length;i++){
      const a = s.charCodeAt(i-1) - 48;
      const b = s.charCodeAt(i) - 48;
      if(b !== a - 1) return false;
    }
    return true;
  }

  function detectPattern(s){
    if(!s) return "—";
    if(isAllSame(s)) return `Repeating ${s[0]}s`;
    if(isAscendingSeq(s)) return "Sequential (up)";
    if(isDescendingSeq(s)) return "Sequential (down)";
    if(isRepeatedHalf(s)) return "Double pattern";
    if(isPalindrome(s)) return "Mirror (palindrome)";
    if(s.length === 3 && s[0] === s[2] && s[0] !== s[1]) return "Sandwich pattern";
    return "Mixed pattern";
  }

  function digitSummary(s){
    if(isAllSame(s)) return DIGIT_MEANING[s[0]] || "";
    const counts = {};
    for(const ch of s){ counts[ch] = (counts[ch]||0) + 1; }
    let best = null, bestN = 0;
    for(const [k,v] of Object.entries(counts)){
      if(v > bestN){ bestN = v; best = k; }
    }
    if(best && bestN >= Math.max(2, Math.ceil(s.length * 0.6))){
      return DIGIT_MEANING[best] || "";
    }
    const sum = s.split("").reduce((a,ch)=>a + (ch.charCodeAt(0)-48), 0);
    const root = ((sum - 1) % 9) + 1;
    const rootLine = DIGIT_MEANING[String(root)] || "";
    return rootLine ? `Digit-sum lens (${sum} → ${root}): ${rootLine}` : "";
  }

  function deriveMeaning(s, pattern){
    if(!s) return {pattern:"—", meaning:"Enter a number to see its commonly shared meaning."};

    if(ANGEL_MAP[s]){
      return {pattern, meaning: ANGEL_MAP[s]};
    }

    if(isAllSame(s) && s.length >= 2){
      const d = s[0];
      const base = DIGIT_MEANING[d] || "A repeating pattern—often treated as a heightened emphasis.";
      return {pattern, meaning: `Emphasis pattern (${s}): ${base}`};
    }

    if(pattern === "Sequential (up)"){
      return {pattern, meaning: "Step-by-step progress. Keep it simple, keep moving, and let momentum build."};
    }
    if(pattern === "Sequential (down)"){
      return {pattern, meaning: "Release and simplify. Let go of what’s extra and return to essentials."};
    }

    if(pattern === "Double pattern"){
      const half = s.slice(0, s.length/2);
      const lens = digitSummary(half);
      return {pattern, meaning: `Reinforced signal (repeated block ${half}): a theme repeating until you notice it.\n${lens}`.trim()};
    }

    if(pattern === "Mirror (palindrome)"){
      const lens = digitSummary(s);
      return {pattern, meaning: `Reflection and alignment. Consider what’s being mirrored back—choices, habits, or timing.\n${lens}`.trim()};
    }

    const lens = digitSummary(s);
    const fallback = "A general interpretation is heightened awareness: notice your thoughts, environment, and choices—then act deliberately.";
    return {pattern, meaning: lens ? `${fallback}\n${lens}` : fallback};
  }

  /* =========================
     Screens + animation + swipe nav
     ========================= */

  const screens = ["home","log","calendar","add"]; // add is excluded from swipe cycle
  const swipeCycle = ["home","calendar","log"];    // per spec: right swipe Home->Calendar->Log->Home
  let currentScreen = "home";
  let returnScreen = "home";
  let animating = false;

  function lockTouches(ms=360){
    const el = $("touchLock");
    el.classList.add("on");
    setTimeout(()=> el.classList.remove("on"), ms);
  }

  function focusTopOfPanel(screen){
    try{ $("screenArea").scrollTop = 0; }catch{}
    try{ window.scrollTo({top:0,left:0,behavior:"auto"}); }catch{}
    if(screen === "add"){
      // Don't auto-focus number field during edit (prevents keyboard pop)
      if(editTs == null){
        setTimeout(() => { try{ $("anum").focus({preventScroll:true}); }catch{} }, 0);
      }else{
        setTimeout(() => { try{ document.activeElement?.blur(); }catch{} }, 0);
      }
    }else{
      try{ document.activeElement?.blur(); }catch{}
    }
  }

  function showInstant(screen){
    for(const s of ["home","add","log","calendar"]){
      $(s).classList.toggle("hidden", s !== screen);
    }
    currentScreen = screen;

    if(screen === "log") renderLog();
    if(screen === "calendar") { initMonthDefaultIfNeeded(); renderCalendar(); }
    if(screen === "add") { tickTime(); adjustTimeFont(); updateMeaningUI(); }

    focusTopOfPanel(screen);
  }

  function animateTo(nextScreen, swipeDir /* "right" or "left" */){
    if(animating) return;
    if(nextScreen === currentScreen) return;

    // Only animate among the swipe-enabled panels (home/log/calendar)
    const canAnim = swipeCycle.includes(currentScreen) && swipeCycle.includes(nextScreen);
    if(!canAnim){
      showInstant(nextScreen);
      return;
    }

    animating = true;
    lockTouches(520);

    const area = $("screenArea");

    const fromEl = $(currentScreen);
    const toEl = $(nextScreen);

    // Prepare
    toEl.classList.remove("hidden");

    fromEl.classList.add("screenAnim");
    toEl.classList.add("screenAnim");

    // Opposite swipe direction requirement:
    // - Swiping right => incoming from LEFT; outgoing to RIGHT
    // We'll treat "right" exactly as specified.
    if(swipeDir === "right"){
      toEl.classList.add("slideInFromLeft");
      // Kick transitions next frame
      requestAnimationFrame(() => {
        toEl.classList.add("animGoIn");
        fromEl.classList.add("animGoOut"); // moves to right
      });
    }else{
      // left swipe: incoming from RIGHT; outgoing to LEFT (not requested, but safe mirror)
      // Implement by using left as reverse: incoming starts +100, outgoing goes -110
      toEl.style.transform = "translateX(100%)";
      requestAnimationFrame(() => {
        toEl.style.transition = "transform 280ms cubic-bezier(.2,.9,.2,1)";
        fromEl.style.transition = "transform 280ms cubic-bezier(.2,.9,.2,1)";
        toEl.style.transform = "translateX(0%)";
        fromEl.style.transform = "translateX(-110%)";
      });
    }

    // After animation cleanup
    setTimeout(() => {
      // Reset styles/classes
      fromEl.classList.add("hidden");

      for(const el of [fromEl, toEl]){
        el.classList.remove("screenAnim","slideInFromLeft","slideOutToRight","animGoIn","animGoOut");
        el.style.transition = "";
        el.style.transform = "";
      }

      currentScreen = nextScreen;
      animating = false;

      // Screen-specific refresh
      if(currentScreen === "log") renderLog();
      if(currentScreen === "calendar") { initMonthDefaultIfNeeded(); renderCalendar(); }

      focusTopOfPanel(currentScreen);
    }, 310);
  }

  function nextInCycleRight(){
    const i = swipeCycle.indexOf(currentScreen);
    if(i < 0) return null;
    return swipeCycle[(i+1) % swipeCycle.length];
  }
  function nextInCycleLeft(){
    const i = swipeCycle.indexOf(currentScreen);
    if(i < 0) return null;
    return swipeCycle[(i-1+swipeCycle.length) % swipeCycle.length];
  }

  // Swipe handling (prevent accidental taps underneath)
  const swipe = { active:false, x0:0, y0:0, moved:false, startedOn:null, ts0:0 };

  function attachSwipes(){
    const root = $("screenArea");

    function onStart(ev){
      if(animating) return;
      if(!(ev.touches && ev.touches.length === 1)) return;
      if(!swipeCycle.includes(currentScreen)) return;

      swipe.active = true;
      swipe.moved = false;
      swipe.ts0 = Date.now();
      swipe.x0 = ev.touches[0].clientX;
      swipe.y0 = ev.touches[0].clientY;
      swipe.startedOn = ev.target;

      // Do not block immediately; only once we determine it is a swipe
    }

    function onMove(ev){
      if(!swipe.active) return;
      if(!(ev.touches && ev.touches.length === 1)) return;

      const x = ev.touches[0].clientX;
      const y = ev.touches[0].clientY;
      const dx = x - swipe.x0;
      const dy = y - swipe.y0;

      if(!swipe.moved){
        // Decide if this is horizontal intent
        if(Math.abs(dx) > 14 && Math.abs(dy) < 18){
          swipe.moved = true;
          // Once we commit to swipe, block underlying controls
          lockTouches(220);
        }else if(Math.abs(dy) > 18 && Math.abs(dy) > Math.abs(dx) + 10){
          // Vertical scroll intent: cancel swipe
          swipe.active = false;
          return;
        }
      }

      if(swipe.moved){
        // Prevent scroll and clicks while swiping
        ev.preventDefault();
      }
    }

    function onEnd(ev){
      if(!swipe.active) return;
      swipe.active = false;

      if(!swipe.moved) return;

      const touch = (ev.changedTouches && ev.changedTouches[0]) ? ev.changedTouches[0] : null;
      if(!touch) return;

      const dx = touch.clientX - swipe.x0;
      const dy = touch.clientY - swipe.y0;

      // Thresholds
      if(Math.abs(dx) < 58 || Math.abs(dy) > 48) return;

      if(dx > 0){
        // Right swipe: required behavior (incoming from left)
        const nxt = nextInCycleRight();
        if(nxt) animateTo(nxt, "right");
      }else{
        // Left swipe: optional mirror
        const prv = nextInCycleLeft();
        if(prv) animateTo(prv, "left");
      }
    }

    root.addEventListener("touchstart", onStart, {passive:true});
    root.addEventListener("touchmove", onMove, {passive:false});
    root.addEventListener("touchend", onEnd, {passive:true});
    root.addEventListener("touchcancel", () => { swipe.active=false; swipe.moved=false; }, {passive:true});
  }

  /* =========================
     Add/Edit flow
     ========================= */

  let timeTimer = null;
  let editTs = null; // ts of record being edited
  let editOriginalTs = null; // keep original to locate record even if ts changes

  function clearAddForm(){
    $("anum").value = "";
    $("notes").value = "";
    $("dtEdit").value = toLocalDatetimeValue(Date.now());
    updateMeaningUI();
  }

  function enterAddNew(from="home"){
    editTs = null;
    editOriginalTs = null;
    returnScreen = from;

    $("editPill").classList.add("hidden");
    $("btnDelete").classList.add("hidden");

    clearAddForm();
    showInstant("add");
  }

  function enterAddEdit(ts){
    const recs = loadRecords();
    const r = recs.find(x => x.ts === ts);
    if(!r){
      enterAddNew("log");
      return;
    }

    editTs = ts;
    editOriginalTs = ts;
    returnScreen = "log";

    $("editPill").classList.remove("hidden");
    $("btnDelete").classList.remove("hidden");

    $("anum").value = r.number || "";
    $("notes").value = (r.notes || "").toString();
    $("dtEdit").value = toLocalDatetimeValue(r.ts);

    updateMeaningUI(r.pattern || "", r.meaning || "");
    showInstant("add");
  }

  function tickTime(){
    const line = $("timeLine");
    const ts = (editTs != null) ? editTs : Date.now();
    line.textContent = fmtTimeCommaDate(ts);
    adjustTimeFont();
    if(timeTimer) clearTimeout(timeTimer);
    timeTimer = setTimeout(tickTime, 900);
  }

  function adjustTimeFont(){
    const el = $("timeLine");
    const parent = el?.parentElement;
    if(!el || !parent) return;

    el.style.fontSize = "";
    const maxW = parent.clientWidth - 8;

    let fs = parseFloat(getComputedStyle(el).fontSize) || 28;
    let guard = 0;
    while(el.scrollWidth > maxW && fs > 16 && guard < 30){
      fs -= 1;
      el.style.fontSize = fs + "px";
      guard++;
    }
  }

  function updateMeaningUI(forcedPattern="", forcedMeaning=""){
    const raw = $("anum").value;
    const n = normalizeNumberInput(raw);

    const pattern = forcedPattern || detectPattern(n);
    const out = forcedMeaning ? {pattern, meaning: forcedMeaning} : deriveMeaning(n, pattern);

    $("numBig").textContent = n ? n : "—";
    $("patternPill").textContent = `Pattern: ${out.pattern || pattern || "—"}`;
    $("meaningText").textContent = out.meaning || "—";
  }

  $("anum").addEventListener("input", () => updateMeaningUI());

  function validateAnyInput(number, notes){
    return !!(String(number||"").trim() || String(notes||"").trim());
  }

  /* =========================
     Log filtering + render
     ========================= */

  function recordMatches(rec, q){
    if(!q) return true;
    const s = q.toLowerCase().trim();
    if(!s) return true;

    const num = (rec.number || "").toLowerCase();
    const pat = (rec.pattern || "").toLowerCase();
    const meaning = (rec.meaning || "").toLowerCase();
    const notes = (rec.notes || "").toLowerCase();
    const dt = fmtDateTime(rec.ts).toLowerCase();

    return num.includes(s) || pat.includes(s) || meaning.includes(s) || notes.includes(s) || dt.includes(s);
  }

  function filteredRecords({fromId,toId,searchId}){
    const recs = loadRecords();

    const q = (searchId ? $(searchId).value : "").trim();

    const fromV = fromId ? $(fromId).value : "";
    const toV   = toId ? $(toId).value : "";

    const fromTs = parseDateField(fromV);
    const toMid  = parseDateField(toV);
    const toTs   = toMid != null ? clampEndOfDay(toMid) : null;

    return recs.filter(r => {
      if(fromTs != null && r.ts < fromTs) return false;
      if(toTs != null && r.ts > toTs) return false;
      return recordMatches(r, q);
    });
  }

  function renderLog(){
    const list = $("logList");
    const recs = filteredRecords({fromId:"fromDate", toId:"toDate", searchId:"search"});

    list.innerHTML = "";
    if(recs.length === 0){
      const empty = document.createElement("div");
      empty.className = "subtle";
      empty.style.marginTop = "10px";
      empty.textContent = "No matching records.";
      list.appendChild(empty);
      return;
    }

    for(const r of recs){
      const e = document.createElement("div");
      e.className = "entry";
      e.tabIndex = 0;
      e.setAttribute("role","button");
      e.setAttribute("aria-label","Open entry");
      e.dataset.ts = String(r.ts);

      const top = document.createElement("div");
      top.className = "entryTop";

      const t = document.createElement("div");
      t.className = "entryTime";
      t.textContent = fmtDateTime(r.ts);

      top.appendChild(t);
      e.appendChild(top);

      const main = document.createElement("div");
      main.className = "entryMain";

      const n = document.createElement("div");
      n.className = "entryNumber";
      n.textContent = r.number ? r.number : "—";

      const p = document.createElement("div");
      p.className = "entryPattern";
      p.textContent = r.pattern ? r.pattern : "—";

      main.appendChild(n);
      main.appendChild(p);
      e.appendChild(main);

      const meaning = (r.meaning && r.meaning.trim()) ? r.meaning.trim() : "None";
      const notes = (r.notes && r.notes.trim()) ? r.notes.trim() : "None";

      const l2 = document.createElement("div");
      l2.className = "entryLine";
      l2.innerHTML = `<b>Meaning:</b> ${escapeHtml(meaning)}`;
      e.appendChild(l2);

      const l3 = document.createElement("div");
      l3.className = "entryLine";
      l3.innerHTML = `<b>Notes:</b> ${escapeHtml(notes)}`;
      e.appendChild(l3);

      list.appendChild(e);
    }
  }

  /* =========================
     Unified confirm modal (matches style)
     ========================= */

  let confirmState = null;

  function openConfirm({title, message, okText="OK", cancelText="Cancel", danger=false, onOk}){
    confirmState = { onOk };
    $("confirmTitle").textContent = title || "Confirm";
    $("confirmSub").textContent = message || "—";

    $("btnConfirmOk").textContent = okText;
    $("btnConfirmCancel").textContent = cancelText;

    $("btnConfirmOk").classList.toggle("danger", !!danger);
    // ensure primary look even if danger
    if(danger){
      $("btnConfirmOk").classList.remove("primary");
      $("btnConfirmOk").classList.add("danger");
    }else{
      $("btnConfirmOk").classList.remove("danger");
      $("btnConfirmOk").classList.add("primary");
    }

    $("confirmModal").classList.remove("hidden");
    lockTouches(220);
    setTimeout(()=>{ try{ $("btnConfirmCancel").focus({preventScroll:true}); }catch{} }, 0);
  }

  function closeConfirm(){
    confirmState = null;
    $("confirmModal").classList.add("hidden");
  }

  $("btnConfirmCancel").addEventListener("click", (e)=>{ e.preventDefault(); closeConfirm(); });
  $("btnConfirmOk").addEventListener("click", (e)=>{
    e.preventDefault();
    const fn = confirmState?.onOk;
    closeConfirm();
    try{ fn && fn(); }catch{}
  });

  $("confirmModal").addEventListener("click", (e) => {
    if(e.target === $("confirmModal")) closeConfirm();
  });

  document.addEventListener("keydown", (e)=>{
    if(!$("confirmModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeConfirm(); }
    }
  });

  /* =========================
     Angel Number Card modal
     ========================= */

  let cardTs = null;

  function buildCardText(rec){
    const lines = [
      "Angel Number Card",
      `Date/Time: ${fmtDateTime(rec.ts)}`,
      `Number: ${rec.number || "—"}`,
      `Pattern: ${rec.pattern || "—"}`,
      `Meaning: ${rec.meaning?.trim() ? rec.meaning.trim() : "None"}`,
      `Notes: ${rec.notes?.trim() ? rec.notes.trim() : "None"}`
    ];
    return lines.join("\n");
  }

  function openCard(ts){
    const recs = loadRecords();
    const r = recs.find(x => x.ts === ts);
    if(!r) return;

    cardTs = ts;
    $("cardBody").textContent = buildCardText(r);
    $("cardModal").classList.remove("hidden");
    lockTouches(220);
  }

  function closeCard(){
    cardTs = null;
    $("cardModal").classList.add("hidden");
  }

  $("btnCardX").addEventListener("click", (e)=>{ e.preventDefault(); closeCard(); });
  $("btnCardCopy").addEventListener("click", async (e)=>{
    e.preventDefault();
    if(cardTs == null) return;
    const recs = loadRecords();
    const r = recs.find(x => x.ts === cardTs);
    if(!r) return;
    const text = buildCardText(r);
    try{ await copyToClipboard(text); alert("Copied."); }catch{ alert("Copy failed."); }
  });
  $("btnCardExport").addEventListener("click", (e)=>{
    e.preventDefault();
    if(cardTs == null) return;
    const recs = loadRecords();
    const r = recs.find(x => x.ts === cardTs);
    if(!r) return;

    exportReport(
      [r],
      {
        title: "Angel Number Card Export",
        rangeLabel: fmtDateTime(r.ts),
        notes: "This export contains a single Angel Number Card (full record)."
      },
      "angel_number_card"
    );
  });
  $("btnCardEdit").addEventListener("click", (e)=>{
    e.preventDefault();
    if(cardTs == null) return;
    closeCard();
    enterAddEdit(cardTs);
  });

  $("cardModal").addEventListener("click", (e)=>{
    if(e.target === $("cardModal")) closeCard();
  });

  document.addEventListener("keydown", (e)=>{
    if(!$("cardModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeCard(); }
    }
  });

  /* =========================
     Day modal (list entries for date)
     ========================= */

  let dayModalDate = null; // startOfDay ts

  function openDayModal(dayStartTs){
    const dayEnd = clampEndOfDay(dayStartTs);
    const all = loadRecords().slice().sort((a,b)=> a.ts - b.ts);
    const recs = all.filter(r => r.ts >= dayStartTs && r.ts <= dayEnd);

    if(recs.length === 0) return;

    dayModalDate = dayStartTs;
    const d = new Date(dayStartTs);
    const title = new Intl.DateTimeFormat(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" }).format(d);

    $("dayTitle").textContent = title;

    const lines = recs.map(r => {
      const time = new Intl.DateTimeFormat(undefined, { hour:"2-digit", minute:"2-digit" }).format(new Date(r.ts));
      const num = r.number || "—";
      const pat = r.pattern || "—";
      return `• ${time}  |  ${num}  |  ${pat}  |  tap to open`;
    });

    $("dayBody").textContent =
      `Entries: ${recs.length}\n\n` +
      lines.join("\n") +
      `\n\nTip: Tap anywhere on a line number in the list below to open the card.`;

    // Build clickable overlay list (so each line taps cleanly)
    // We will render actual clickable entry chips below the text for reliable taps.
    const chips = document.createElement("div");
    chips.style.marginTop = "12px";
    chips.innerHTML = "";
    for(const r of recs){
      const chip = document.createElement("div");
      chip.className = "entry";
      chip.style.marginTop = "8px";
      chip.dataset.ts = String(r.ts);
      chip.innerHTML = `
        <div class="entryTop"><div class="entryTime">${escapeHtml(fmtDateTime(r.ts))}</div></div>
        <div class="entryMain">
          <div class="entryNumber">${escapeHtml(r.number || "—")}</div>
          <div class="entryPattern">${escapeHtml(r.pattern || "—")}</div>
        </div>
        <div class="entryLine"><b>Notes:</b> ${escapeHtml(r.notes?.trim() ? r.notes.trim() : "None")}</div>
      `;
      chip.addEventListener("click", (e)=>{
        e.preventDefault();
        closeDayModal();
        openCard(r.ts);
      });
      chips.appendChild(chip);
    }

    // Replace dayBody with a container that includes text + chips
    const container = document.createElement("div");
    container.style.whiteSpace = "pre-wrap";
    container.style.color = "rgba(235,245,255,.66)";
    container.style.fontSize = "14px";
    container.style.lineHeight = "1.28";
    container.textContent = `Entries: ${recs.length}\n\n`;

    const holder = document.createElement("div");
    holder.appendChild(container);
    holder.appendChild(chips);

    $("dayBody").textContent = ""; // clear text
    $("dayBody").appendChild(holder);

    $("dayModal").classList.remove("hidden");
    lockTouches(220);
  }

  function closeDayModal(){
    dayModalDate = null;
    $("dayModal").classList.add("hidden");
    // restore dayBody to simple text node next time
    $("dayBody").textContent = "—";
  }

  $("btnDayX").addEventListener("click", (e)=>{ e.preventDefault(); closeDayModal(); });
  $("btnDayClose").addEventListener("click", (e)=>{ e.preventDefault(); closeDayModal(); });

  $("dayModal").addEventListener("click", (e)=>{
    if(e.target === $("dayModal")) closeDayModal();
  });

  document.addEventListener("keydown", (e)=>{
    if(!$("dayModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeDayModal(); }
    }
  });

  $("btnDayExport").addEventListener("click", (e)=>{
    e.preventDefault();
    if(dayModalDate == null) return;
    const a = dayModalDate;
    const b = clampEndOfDay(a);
    const recs = loadRecords().slice().reverse().filter(r => r.ts >= a && r.ts <= b);

    exportReport(
      recs,
      {
        title: "Day Export",
        rangeLabel: `${fmtDateTime(a)} to ${fmtDateTime(b)}`,
        notes: "This export contains all entries for the selected day."
      },
      "angel_numbers_day"
    );
  });

  /* =========================
     Log tap -> open card prompt modal (matches style)
     ========================= */

  let pendingOpenTs = null;
  let modalOpenedAt = 0;
  let enableOpenTimer = null;

  function openEditPrompt(ts){
    pendingOpenTs = ts;
    modalOpenedAt = Date.now();

    const btnOpen = $("btnEditConfirm");
    btnOpen.disabled = true;
    if(enableOpenTimer) clearTimeout(enableOpenTimer);
    enableOpenTimer = setTimeout(() => { btnOpen.disabled = false; }, 260);

    $("editModalSub").textContent = "Press Open to view the Angel Number Card.";
    $("editModal").classList.remove("hidden");
    lockTouches(220);

    setTimeout(() => {
      try{ $("btnEditCancel").focus({preventScroll:true}); }catch{}
    }, 0);
  }

  function closeEditPrompt(){
    pendingOpenTs = null;
    $("editModal").classList.add("hidden");
  }

  function confirmEditPrompt(){
    if($("btnEditConfirm").disabled) return;
    const ts = pendingOpenTs;
    closeEditPrompt();
    if(ts != null) openCard(ts);
  }

  $("btnEditCancel").addEventListener("click", (e) => { e.preventDefault(); closeEditPrompt(); });
  $("btnEditConfirm").addEventListener("click", (e) => { e.preventDefault(); confirmEditPrompt(); });

  $("editModal").addEventListener("click", (e) => {
    const justOpened = (Date.now() - modalOpenedAt) < 220;
    if(justOpened) { e.preventDefault(); e.stopPropagation(); return; }
    if(e.target === $("editModal")) closeEditPrompt();
  });

  document.addEventListener("keydown", (e) => {
    if($("editModal").classList.contains("hidden")) return;

    if(e.key === "Escape"){
      e.preventDefault();
      closeEditPrompt();
      return;
    }
    if(e.key === "Enter"){
      const ae = document.activeElement;
      if(ae && ae.id === "btnEditCancel"){
        e.preventDefault();
        closeEditPrompt();
      }else{
        e.preventDefault();
        confirmEditPrompt();
      }
    }
  });

  // Log tap handling (delegated)
  const logTap = { activeEl:null, activeTs:null, pointerId:null, tracking:false };

  function findEntryEl(target){
    if(!target) return null;
    const el = target.closest ? target.closest(".entry") : null;
    if(!el) return null;
    if(el.closest && el.closest("#logList") !== $("logList")) return null;
    return el;
  }

  function rectInside(el, clientX, clientY){
    const SLOP_PX = 14;
    const rect = el.getBoundingClientRect();
    return (
      clientX >= rect.left - SLOP_PX && clientX <= rect.right + SLOP_PX &&
      clientY >= rect.top  - SLOP_PX && clientY <= rect.bottom + SLOP_PX
    );
  }

  function clearLogPress(){
    if(logTap.activeEl) logTap.activeEl.classList.remove("pressed");
    logTap.activeEl = null;
    logTap.activeTs = null;
    logTap.pointerId = null;
    logTap.tracking = false;
  }

  $("logList").addEventListener("pointerdown", (ev) => {
    if($("log").classList.contains("hidden")) return;
    if(animating) return;
    if(ev.button != null && ev.button !== 0) return;

    const entry = findEntryEl(ev.target);
    if(!entry) return;

    const ts = Number(entry.dataset.ts);
    if(!Number.isFinite(ts)) return;

    clearLogPress();
    logTap.activeEl = entry;
    logTap.activeTs = ts;
    logTap.pointerId = ev.pointerId;
    logTap.tracking = true;

    entry.classList.add("pressed");
    try{ entry.setPointerCapture(ev.pointerId); }catch{}

    ev.preventDefault();
    ev.stopPropagation();
  });

  $("logList").addEventListener("pointermove", (ev) => {
    if(!logTap.tracking) return;
    if(logTap.pointerId != null && ev.pointerId !== logTap.pointerId) return;
    if(!logTap.activeEl) return;

    if(!rectInside(logTap.activeEl, ev.clientX, ev.clientY)){
      clearLogPress();
    }
  });

  $("logList").addEventListener("pointercancel", () => { clearLogPress(); });

  $("logList").addEventListener("pointerup", (ev) => {
    if(!logTap.tracking) return;
    if(logTap.pointerId != null && ev.pointerId !== logTap.pointerId) return;

    const entry = logTap.activeEl;
    const ts = logTap.activeTs;

    const inside = entry ? rectInside(entry, ev.clientX, ev.clientY) : false;
    clearLogPress();

    if(inside && ts != null){
      setTimeout(() => openEditPrompt(ts), 0);
    }

    ev.preventDefault();
    ev.stopPropagation();
  });

  $("logList").addEventListener("keydown", (ev) => {
    const entry = findEntryEl(ev.target);
    if(!entry) return;
    if(ev.key === "Enter" || ev.key === " "){
      const ts = Number(entry.dataset.ts);
      if(!Number.isFinite(ts)) return;
      ev.preventDefault();
      openEditPrompt(ts);
    }
  });

  /* =========================
     Export (clipboard/share/save) + header (formatting fixed)
     ========================= */

  let exportPayload = null;

  function isShareAvailable(){
    return !!(navigator.share && typeof navigator.share === "function");
  }

  async function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      return true;
    }
    return false;
  }

  function downloadText(text, filename){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function saveTextWithPicker(text, suggestedName){
    const canPick = typeof window.showSaveFilePicker === "function";
    if(!canPick) return false;

    const opts = {
      suggestedName: suggestedName || "angel_numbers_report.txt",
      types: [{ description: "Text", accept: {"text/plain": [".txt"]} }]
    };

    const handle = await window.showSaveFilePicker(opts);
    const writable = await handle.createWritable();
    await writable.write(new Blob([text], {type:"text/plain;charset=utf-8"}));
    await writable.close();
    return true;
  }

  function openExportModal(payload){
    exportPayload = payload;
    $("exportModal").classList.remove("hidden");
    lockTouches(220);

    $("btnExportClose").disabled = true;
    $("btnExportShare").disabled = true;
    $("btnExportSave").disabled  = true;

    setTimeout(() => {
      $("btnExportClose").disabled = false;
      $("btnExportShare").disabled = !isShareAvailable();
      $("btnExportSave").disabled  = false;
      try{ $("btnExportClose").focus({preventScroll:true}); }catch{}
    }, 260);
  }

  function closeExportModal(){
    exportPayload = null;
    $("exportModal").classList.add("hidden");
  }

  $("btnExportClose").addEventListener("click", (e)=>{ e.preventDefault(); closeExportModal(); });

  $("exportModal").addEventListener("click", (e)=>{
    if(e.target === $("exportModal")) closeExportModal();
  });

  document.addEventListener("keydown", (e)=>{
    if(!$("exportModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeExportModal(); }
    }
  });

  $("btnExportShare").addEventListener("click", async (e)=>{
    e.preventDefault();
    if(!exportPayload) return;
    if($("btnExportShare").disabled) return;

    if(!isShareAvailable()){
      alert("Share is not available on this device/browser.");
      return;
    }
    try{
      await navigator.share({
        title: "Angel Numbers Tracker Export",
        text: exportPayload.text
      });
    }catch{}
  });

  $("btnExportSave").addEventListener("click", async (e)=>{
    e.preventDefault();
    if(!exportPayload) return;
    if($("btnExportSave").disabled) return;

    try{
      const ok = await saveTextWithPicker(exportPayload.text, exportPayload.filename);
      if(ok){ alert("Saved."); return; }
    }catch{}

    downloadText(exportPayload.text, exportPayload.filename || "angel_numbers_report.txt");
  });

  function buildReportHeader({title, rangeLabel, notes}){
    const now = fmtDateTime(Date.now());
    // Ensure there is a clean blank line before the first record (fixes the "indented" look)
    const lines = [
      "Angel Numbers Tracker — Export Report",
      `App Version: ${APP_VERSION}`,
      `Report: ${title}`,
      `Generated: ${now}`,
      rangeLabel ? `Range: ${rangeLabel}` : "",
      "",
      "How this data was captured:",
      "- Sightings are entered manually into Angel Numbers Tracker on this device.",
      "- Data is stored locally on the phone (no cloud sync, no account).",
      "- Each record may include the number, pattern type, a cultural/numerology meaning, and optional notes.",
      "",
      notes ? notes : "",
      "",
      "------------------------------",
      "" // critical: blank line so first record starts flush at line start in many viewers
    ].filter(Boolean);
    return lines.join("\n");
  }

  function exportReport(recs, headerInfo, filenameBase){
    const header = buildReportHeader(headerInfo);

    const lines = recs.map(r => {
      const dt = fmtDateTime(r.ts);
      const num = `Number: ${r.number || "—"}`;
      const pat = `Pattern: ${r.pattern || "—"}`;
      const meaning = (r.meaning && r.meaning.trim()) ? r.meaning.trim() : "None";
      const notes = (r.notes && r.notes.trim()) ? r.notes.trim() : "None";
      return `${dt}\n${num}\n${pat}\nMeaning: ${meaning}\nNotes: ${notes}\n`;
    });

    const out = header + lines.join("\n");
    const ts = new Date();
    const y = ts.getFullYear();
    const m = String(ts.getMonth()+1).padStart(2,"0");
    const d = String(ts.getDate()).padStart(2,"0");
    const filename = `${filenameBase || "angel_numbers_report"}_${y}-${m}-${d}.txt`;

    (async () => {
      try{ await copyToClipboard(out); }catch{}
      openExportModal({ text: out, filename });
    })();
  }

  /* =========================
     Calendar (month view)
     ========================= */

  const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  function initMonthDefaultIfNeeded(){
    if($("calMonth").value) return;
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,"0");
    $("calMonth").value = `${y}-${m}`;
  }

  function monthValueToYMD(value){
    const m = /^(\d{4})-(\d{2})$/.exec(String(value || ""));
    if(!m) return null;
    const y = Number(m[1]);
    const mo = Number(m[2]);
    if(!y || !mo) return null;
    return { y, mo }; // mo 1-12
  }

  function buildDayIndexMap(recs){
    const map = new Map();
    for(const r of recs){
      const k = startOfDay(r.ts);
      const arr = map.get(k) || [];
      arr.push(r);
      map.set(k, arr);
    }
    // Sort each day's recs by time
    for(const [k, arr] of map.entries()){
      arr.sort((a,b)=> a.ts - b.ts);
      map.set(k, arr);
    }
    return map;
  }

  function renderCalendar(){
    const mv = monthValueToYMD($("calMonth").value);
    if(!mv) return;

    const {y, mo} = mv;
    const first = new Date(y, mo-1, 1);
    const last  = new Date(y, mo, 0); // last day of month
    const daysInMonth = last.getDate();

    const firstDow = first.getDay(); // 0 Sun
    const totalCells = 42; // 6 weeks

    // Build a date for the first cell (Sunday of the grid)
    const gridStart = new Date(y, mo-1, 1 - firstDow);
    gridStart.setHours(0,0,0,0);

    const all = loadRecords();
    const dayMap = buildDayIndexMap(all);

    // DOW header
    const dowRow = $("calDowRow");
    dowRow.innerHTML = "";
    for(const d of DOW){
      const el = document.createElement("div");
      el.className = "calDow";
      el.textContent = d;
      dowRow.appendChild(el);
    }

    const grid = $("calGrid");
    grid.innerHTML = "";

    for(let i=0;i<totalCells;i++){
      const d = new Date(gridStart.getTime() + i*DAY_MS);
      const dayStart = d.getTime();
      const inMonth = (d.getMonth() === (mo-1));

      const cell = document.createElement("div");
      cell.className = "calCell" + (inMonth ? "" : " outMonth");

      const dn = document.createElement("div");
      dn.className = "dnum";
      dn.textContent = String(d.getDate());

      cell.appendChild(dn);

      const recs = dayMap.get(dayStart) || [];
      if(recs.length > 0){
        cell.classList.add("hasData");

        // Show a small summary (first number + count)
        const mini = document.createElement("div");
        mini.className = "mini";
        const firstNum = recs[0].number || "—";
        mini.textContent = recs.length === 1 ? firstNum : `${firstNum} (+${recs.length-1})`;
        cell.appendChild(mini);

        cell.addEventListener("click", (e)=>{
          e.preventDefault();
          if(animating) return;
          openDayModal(dayStart);
        });
      }else{
        // No data: "If no data no label" => do not add any "No sightings" text.
        // Keep only date number, no click.
      }

      grid.appendChild(cell);
    }
  }

  /* =========================
     Clear Data + Install + Exit (Exit preserved)
     ========================= */

  let deferredPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    refreshInstallButton();
  });

  window.addEventListener("appinstalled", () => {
    deferredPrompt = null;
    refreshInstallButton();
  });

  function isStandalone(){
    return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
  }

  function refreshInstallButton(){
    $("btnInstall").textContent = isStandalone() ? "Uninstall" : "Install";
  }

  $("btnInstall").addEventListener("click", async () => {
    if(isStandalone()){
      alert(
        "Uninstall:\n\n" +
        "Android: press-and-hold the app icon → Uninstall.\n" +
        "Uninstall typically does NOT delete your saved data, but device/browser behavior can vary.\n\n" +
        "To delete data on purpose: use Clear Data (home screen)."
      );
      return;
    }
    if(deferredPrompt){
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch {}
      deferredPrompt = null;
      refreshInstallButton();
      return;
    }
    alert("Install is available when your browser offers it (menu → Install app).");
  });

  function clearAllData(){
    openConfirm({
      title: "Clear all data?",
      message:
        "This deletes everything stored on this phone for Angel Numbers Tracker.\n\n" +
        "This cannot be undone.",
      okText: "Clear",
      cancelText: "Cancel",
      danger: true,
      onOk: () => {
        try{ localStorage.removeItem(STORAGE_KEY); }catch{}
        $("fromDate").value = "";
        $("toDate").value = "";
        $("search").value = "";
        alert("All data cleared.");
        showInstant("home");
      }
    });
  }
  $("btnClearAll").addEventListener("click", clearAllData);

  /* KEEP THIS EXIT FUNCTION EXACTLY (known-good) */
  $("btnExitHome").addEventListener("click", () => {
    window.close();
    setTimeout(() => {
      alert("If it didn’t close: use your phone’s Back/Home.");
    }, 200);
  });

  /* =========================
     Buttons + Save/Delete + Search + Exports
     ========================= */

  $("btnGoAdd").addEventListener("click", () => enterAddNew("home"));
  $("btnGoLog").addEventListener("click", () => animateTo("log", "right"));
  $("btnGoCalendar").addEventListener("click", () => animateTo("calendar", "right"));

  $("btnBackFromAdd").addEventListener("click", () => { editTs=null; editOriginalTs=null; showInstant(returnScreen || "home"); });
  $("btnBackFromLog").addEventListener("click", () => animateTo("home", "right"));
  $("btnBackFromCalendar").addEventListener("click", () => animateTo("home", "right"));

  $("btnAddFromLog").addEventListener("click", () => enterAddNew("log"));

  $("dtEdit").addEventListener("change", () => {
    const ts = fromLocalDatetimeValue($("dtEdit").value);
    if(ts != null){
      if(editTs == null) {
        // New entry: reflect the chosen time line for display only
        // timeLine is always based on "editTs" for edits; for new, use Date.now().
      }else{
        // Editing: update editTs so timeLine reflects chosen time
        editTs = ts;
        tickTime();
      }
    }
  });

  $("btnSave").addEventListener("click", () => {
    const number = normalizeNumberInput($("anum").value);
    const notes = ($("notes").value || "").toString();

    if(!validateAnyInput(number, notes)){
      alert("Enter a number or a note.");
      return;
    }

    const tsWanted = fromLocalDatetimeValue($("dtEdit").value) ?? Date.now();

    const pattern = number ? detectPattern(number) : "—";
    const meaning = number ? deriveMeaning(number, pattern).meaning : "—";

    const recs = loadRecords();

    if(editOriginalTs == null){
      recs.unshift({ ts: tsWanted, number, pattern, meaning, notes });
    }else{
      const idx = recs.findIndex(r => r.ts === editOriginalTs);
      if(idx >= 0){
        recs[idx] = { ts: tsWanted, number, pattern, meaning, notes };
      }else{
        recs.unshift({ ts: tsWanted, number, pattern, meaning, notes });
      }
    }

    recs.sort((a,b)=> b.ts - a.ts);
    saveRecords(recs);

    $("fromDate").value = "";
    $("toDate").value = "";
    $("search").value = "";

    editTs = null;
    editOriginalTs = null;

    showInstant("log");
  });

  $("btnDelete").addEventListener("click", () => {
    if(editOriginalTs == null) return;

    openConfirm({
      title: "Delete this entry?",
      message: "This cannot be undone.",
      okText: "Delete",
      cancelText: "Cancel",
      danger: true,
      onOk: () => {
        const recs = loadRecords().filter(r => r.ts !== editOriginalTs);
        saveRecords(recs);

        editTs = null;
        editOriginalTs = null;

        showInstant("log");
      }
    });
  });

  function runSearch(){ renderLog(); }

  $("btnRunSearch").addEventListener("click", (e)=>{ e.preventDefault(); runSearch(); });
  $("search").addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      runSearch();
      try{ e.target.blur(); }catch{}
    }
  });

  ["fromDate","toDate"].forEach(id => {
    $(id).addEventListener("input", () => renderLog());
    $(id).addEventListener("change", () => renderLog());
  });

  $("calMonth").addEventListener("change", () => renderCalendar());
  $("btnCalToday").addEventListener("click", (e)=>{
    e.preventDefault();
    const now = new Date();
    $("calMonth").value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
    renderCalendar();
  });

  $("btnExportLog").addEventListener("click", () => {
    const recs = filteredRecords({fromId:"fromDate", toId:"toDate", searchId:"search"});
    const rangeLabel = (() => {
      const f = $("fromDate").value;
      const t = $("toDate").value;
      if(f && t) return `${f} to ${t}`;
      if(f) return `From ${f}`;
      if(t) return `Up to ${t}`;
      return "All log entries (filtered by search/date if set)";
    })();

    exportReport(
      recs,
      {
        title: "Log Export",
        rangeLabel,
        notes: "This report reflects the Log screen filters (Search + optional From/To dates)."
      },
      "angel_numbers_log_report"
    );
  });

  $("btnExportMonth").addEventListener("click", () => {
    const mv = monthValueToYMD($("calMonth").value);
    if(!mv) return;
    const {y, mo} = mv;
    const a = new Date(y, mo-1, 1, 0,0,0,0).getTime();
    const b = new Date(y, mo, 0, 23,59,59,999).getTime();
    const recs = loadRecords().slice().reverse().filter(r => r.ts >= a && r.ts <= b);

    exportReport(
      recs,
      {
        title: "Month Export",
        rangeLabel: `${y}-${String(mo).padStart(2,"0")}`,
        notes: "This export contains all entries within the selected month."
      },
      "angel_numbers_month"
    );
  });

  /* =========================
     Version modal + logo tap (quad) + home label tap (5)
     ========================= */

  function openVersionModal(){
    $("verBody").textContent =
      `Actual app version: ${APP_VERSION}\n` +
      `Home label (visual only): ${HOME_VERSION_LABEL}\n` +
      `Storage key: ${STORAGE_KEY}`;
    $("versionModal").classList.remove("hidden");
    lockTouches(220);
  }
  function closeVersionModal(){
    $("versionModal").classList.add("hidden");
  }
  $("btnVerX").addEventListener("click", (e)=>{ e.preventDefault(); closeVersionModal(); });
  $("btnVerClose").addEventListener("click", (e)=>{ e.preventDefault(); closeVersionModal(); });
  $("versionModal").addEventListener("click", (e)=>{ if(e.target === $("versionModal")) closeVersionModal(); });
  document.addEventListener("keydown", (e)=>{
    if(!$("versionModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeVersionModal(); }
    }
  });

  // Quad-tap logo
  let logoTapCount = 0;
  let logoTapTimer = null;

  document.querySelector(".logoTitle").addEventListener("click", (e)=>{
    if(animating) return;
    logoTapCount++;
    if(logoTapTimer) clearTimeout(logoTapTimer);
    logoTapTimer = setTimeout(()=>{ logoTapCount=0; }, 650);
    if(logoTapCount >= 4){
      logoTapCount = 0;
      openVersionModal();
    }
  });

  // Five taps on v1.333 label -> heart modal
  function openHeart(){
    $("heartModal").classList.remove("hidden");
    lockTouches(220);
  }
  function closeHeart(){
    $("heartModal").classList.add("hidden");
  }
  $("btnHeartX").addEventListener("click", (e)=>{ e.preventDefault(); closeHeart(); });
  $("btnHeartClose").addEventListener("click", (e)=>{ e.preventDefault(); closeHeart(); });
  $("heartModal").addEventListener("click", (e)=>{ if(e.target === $("heartModal")) closeHeart(); });
  document.addEventListener("keydown", (e)=>{
    if(!$("heartModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeHeart(); }
    }
  });

  let vTapCount = 0;
  let vTapTimer = null;
  $("homeVerLabel").textContent = HOME_VERSION_LABEL;
  $("homeVerLabel").addEventListener("click", (e)=>{
    if(animating) return;
    vTapCount++;
    if(vTapTimer) clearTimeout(vTapTimer);
    vTapTimer = setTimeout(()=>{ vTapCount = 0; }, 700);
    if(vTapCount >= 5){
      vTapCount = 0;
      openHeart();
    }
  });

  /* =========================
     Manifest + SW
     ========================= */

  function injectManifest(){
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#8a6bff"/>
      <stop offset="55%" stop-color="#2f78ff"/>
      <stop offset="100%" stop-color="#0b1324"/>
    </linearGradient>
  </defs>
  <rect width="512" height="512" rx="110" fill="url(#g)"/>
  <ellipse cx="256" cy="150" rx="110" ry="44" fill="none" stroke="rgba(235,245,255,.92)" stroke-width="26"/>
  <path d="M256 240
           C196 210, 140 220, 112 270
           C154 294, 190 330, 214 380
           C226 330, 240 285, 256 240Z"
        fill="none" stroke="rgba(235,245,255,.92)" stroke-width="22" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M256 240
           C316 210, 372 220, 400 270
           C358 294, 322 330, 298 380
           C286 330, 272 285, 256 240Z"
        fill="none" stroke="rgba(235,245,255,.92)" stroke-width="22" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;
    const encoded = encodeURIComponent(svg).replace(/'/g,"%27").replace(/"/g,"%22");
    const icon = `data:image/svg+xml;charset=utf-8,${encoded}`;

    const manifest = {
      name: "Angel Numbers Tracker",
      short_name: "AngelNums",
      start_url: ".",
      display: "standalone",
      background_color: "#0b1324",
      theme_color: "#0b1324",
      icons: [{ src: icon, sizes: "512x512", type: "image/svg+xml", purpose: "any" }]
    };

    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    $("manifestLink").setAttribute("href", url);
  }

  async function registerSW(){
    if(!("serviceWorker" in navigator)) return;
    const swCode =
`self.addEventListener('install', (e)=>{ self.skipWaiting(); });
self.addEventListener('activate', (e)=>{ e.waitUntil(self.clients.claim()); });
self.addEventListener('fetch', (e)=>{ });`;
    const blob = new Blob([swCode], {type:"text/javascript"});
    const swUrl = URL.createObjectURL(blob);
    try { await navigator.serviceWorker.register(swUrl); } catch {}
  }

  /* =========================
     Test data seeding (removable)
     ========================= */

  function seedTestDataIfEmpty(){
    if(!TEST_DATA_ENABLED) return;
    const existing = loadRecords();
    if(existing.length > 0) return;

    const now = new Date();
    const months = [
      { y: now.getFullYear(), m: now.getMonth() },       // current month (0-based)
      { y: new Date(now.getFullYear(), now.getMonth()-1, 1).getFullYear(),
        m: new Date(now.getFullYear(), now.getMonth()-1, 1).getMonth() } // previous month
    ];

    const sampleNums = ["111","222","333","444","555","777","888","999","1212","1010","2222","2424","99099","1234"];
    const out = [];

    function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }

    for(const mm of months){
      // Add ~10-14 days with data
      const daysToFill = randInt(10, 14);
      const usedDays = new Set();
      while(usedDays.size < daysToFill){
        usedDays.add(randInt(1, 27));
      }
      for(const day of usedDays){
        // 1-4 entries in that day
        const nEntries = randInt(1, 4);
        for(let i=0;i<nEntries;i++){
          const hr = randInt(8, 22);
          const mi = randInt(0, 59);
          const ts = new Date(mm.y, mm.m, day, hr, mi, 0, 0).getTime();

          const number = sampleNums[randInt(0, sampleNums.length-1)];
          const pattern = detectPattern(number);
          const meaning = deriveMeaning(number, pattern).meaning;

          out.push({
            ts,
            number,
            pattern,
            meaning,
            notes: (i === 0 ? "Test data (remove later)" : "")
          });
        }
      }
    }

    out.sort((a,b)=> b.ts - a.ts);
    saveRecords(out);
  }

  /* =========================
     Init
     ========================= */

  injectManifest();
  registerSW();
  refreshInstallButton();

  seedTestDataIfEmpty();

  $("fromDate").value = "";
  $("toDate").value = "";

  attachSwipes();
  showInstant("home");

  window.addEventListener("resize", () => {
    if(!$("add").classList.contains("hidden")) adjustTimeFont();
    if(!$("calendar").classList.contains("hidden")) renderCalendar();
  });

  // Navigation to panels (buttons)
  // Make button navigation consistent with the swipe cycle direction (right)
  $("btnGoLog").addEventListener("click", () => animateTo("log", "right"));
  $("btnGoCalendar").addEventListener("click", () => animateTo("calendar", "right"));

  // Enter add from calendar/day/card is handled elsewhere

})();
</script>

</body>
</html>

<!--
EOF Version Detail Notes (required)
App: Angel Numbers Tracker
Actual Version: v1.0B4
Home Label (visual only): v1.333 (do not change unless instructed)
Base: v1.0B3
Changes:
- Charts removed; Calendar month view added; day/card popups added.
- Popups unified; delete/clear confirmations use formatted modal.
- Date/time editable; swipes animated with interaction lock.
- 4x logo tap shows version; 5x home version-label tap shows heart + message.
- Test data seeding added (TEST_DATA_ENABLED flag).
-->
