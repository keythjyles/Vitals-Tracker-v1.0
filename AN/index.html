<!-- Angel Numbers Tracker v1.0B4 -->
<!--
Version Detail Notes
App Version: v1.0B4
Base: v1.0B3 (per user correction: last should have been B3; this is B4)
Focus: Calendar + navigation + UX polish

Changes (requested / implemented):
- Pull-to-refresh hidden update check (no button): drag down at top of Home/Log/Calendar.
- Panel navigation: swipe left/right between Home → Log → Calendar in a “wheel” loop.
  - Panel follows finger (direct tracking), snaps on release.
  - Prevent accidental taps during swipe; panels disabled briefly during/after swipe.
- Calendar: days with data are highlighted ONLY (no readings shown on calendar tiles).
  - Tap highlighted day → Day List popup (tight list of numbers).
  - Tap number → Angel Number Card popup (full record; copy/export/edit/delete).
- Angel Number Card label updated (Card title “Angel Number Card”).
- Edit screen: date/time editable.
- Log list: scrollable, tight vertical spacing, clickable cards.
- Consistent modal styling for ALL popups (including version popup + delete confirm).
- Consistent dark-blue border around every panel.
- Home:
  - Button label: “ADD Angel Number”.
  - Home visual label “v1.333” remains visual-only (NOT actual version).
  - Tap v1.333 label 5 times → heart image + message “The Angels love you Timmy!” (closable with X + animation).
  - Quadruple-tap the logo → formatted popup shows actual App Version (v1.0B4).
- Export report first-record indentation bug fixed (no leading spaces before first record).
- Added removable test seed data for a couple months (toggle at top of JS).
- EOF commented version block included (required).
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Angel Numbers Tracker</title>

  <link rel="manifest" id="manifestLink" href="#" />

  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;
      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --text:rgba(235,245,255,.86);
      --muted:rgba(235,245,255,.58);
      --muted2:rgba(235,245,255,.42);

      --accent:#2b4e7a;
      --accent2:#2a70ff;

      /* Dark-blue panel border (requested) */
      --panelBorder: rgba(35,80,150,.70);

      --shadow:0 20px 60px rgba(0,0,0,.55);
      --radius:28px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 50% 20%, rgba(38,84,160,.25), transparent 60%),
                  radial-gradient(900px 700px at 50% 85%, rgba(20,40,85,.35), transparent 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg0));
      color:var(--text);
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: none; /* we will manage touch for horizontal swipes; inner scrollers enable pan-y */
    }

    /* Header */
    .app{
      position:relative;
      height:100%;
      width:100%;
      display:flex;
      flex-direction:column;
      padding: 16px 14px 18px;
      gap: 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 8px 8px 0;
      user-select:none;
    }
    .logo{
      width:44px;
      height:44px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background: rgba(12,21,40,.55);
      border: 1px solid rgba(140,180,255,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .title{
      font-size: 38px;
      font-weight: 900;
      letter-spacing: -0.8px;
      line-height: 1;
      background: linear-gradient(90deg, rgba(180,140,255,.95), rgba(80,170,255,.95));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }

    /* Panels container (wheel swipe) */
    .viewport{
      position:relative;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
      border-radius: var(--radius);
      background: rgba(12,21,40,.20);
      border: 1px solid rgba(140,180,255,.16);
      box-shadow: var(--shadow);
    }

    .track{
      position:absolute;
      inset:0;
      display:flex;
      width:300%;
      height:100%;
      transform: translateX(0);
      will-change: transform;
    }

    .panel{
      width:100%;
      height:100%;
      padding: 16px;
      overflow:hidden;
      position:relative;

      /* Consistent panel border (requested) */
      border: 2px solid var(--panelBorder);
      border-radius: var(--radius);
      margin: 10px;
      background: linear-gradient(180deg, rgba(12,21,40,.62), rgba(12,21,40,.34));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }

    .panelInner{
      position:absolute;
      inset: 14px;
      display:flex;
      flex-direction:column;
      min-height:0;
      gap: 12px;
      overflow:hidden;
    }

    .btnRow{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .btn{
      border: 1px solid rgba(180,210,255,.20);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 18px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 20px;
      min-height: 50px;
      user-select:none;
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      background: linear-gradient(180deg, rgba(55,140,255,.95), rgba(35,95,210,.90));
      border-color: rgba(90,170,255,.60);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(140,60,70,.60), rgba(70,35,45,.52));
      border-color: rgba(255,130,150,.22);
    }
    .btnGhost{
      background: rgba(255,255,255,.05);
    }

    .bigStack{
      display:flex;
      flex-direction:column;
      gap: 14px;
      padding-top: 6px;
    }

    .bigBtn{
      width:100%;
      padding: 20px 18px;
      border-radius: 999px;
      font-size: 34px;
      font-weight: 950;
      border: 1px solid rgba(180,210,255,.16);
      background: rgba(255,255,255,.05);
      color: var(--text);
      letter-spacing: -0.4px;
      user-select:none;
      cursor:pointer;
    }
    .bigBtn.primary{
      background: linear-gradient(180deg, rgba(60,150,255,.95), rgba(35,95,210,.88));
      border-color: rgba(110,190,255,.55);
      color: rgba(255,255,255,.95);
    }
    .bigBtn:active{ transform: translateY(1px); }

    .homeMeta{
      margin-top:auto;
      padding-top: 8px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .2px;
    }
    .homeMeta .line{ margin: 6px 0; }
    .footerRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 10px;
      color: rgba(235,245,255,.42);
      font-weight: 900;
      letter-spacing: .2px;
      user-select:none;
    }
    .vLabel{
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(140,180,255,.14);
    }

    /* Form layout */
    .fieldLabel{
      font-size: 22px;
      font-weight: 950;
      color: rgba(235,245,255,.70);
      margin: 0;
    }
    .inputRow{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .input{
      width:100%;
      padding: 14px 16px;
      border-radius: 18px;
      border: 2px solid rgba(180,210,255,.24);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 22px;
      font-weight: 900;
      outline:none;
    }
    .select{
      width:100%;
      padding: 14px 16px;
      border-radius: 18px;
      border: 2px solid rgba(180,210,255,.20);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 20px;
      font-weight: 900;
      outline:none;
    }

    /* Scroll areas */
    .scrollArea{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding-right: 2px;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y; /* allow vertical scroll */
    }
    .scrollArea::-webkit-scrollbar{ width:10px; }
    .scrollArea::-webkit-scrollbar-thumb{
      background: rgba(180,210,255,.18);
      border-radius: 99px;
      border: 3px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }

    /* Record cards (tight vertically) */
    .card{
      border-radius: 22px;
      border: 1px solid rgba(180,210,255,.14);
      background: rgba(8,12,24,.35);
      padding: 12px 14px; /* tightened */
      margin: 10px 0;     /* tightened */
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      user-select:none;
      cursor:pointer;
    }
    .cardTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap: 10px;
    }
    .dt{
      font-size: 18px;
      font-weight: 900;
      color: rgba(235,245,255,.50);
      letter-spacing:.1px;
    }
    .num{
      font-size: 44px;
      font-weight: 950;
      letter-spacing:-1px;
      line-height: 1.02;
      margin-top: 6px;
    }
    .pat{
      font-size: 20px;
      font-weight: 950;
      color: rgba(235,245,255,.68);
      text-align:right;
      white-space:nowrap;
    }
    .meaning{
      margin-top: 8px;
      font-size: 20px;
      font-weight: 850;
      color: rgba(235,245,255,.62);
      line-height: 1.25;
    }
    .notes{
      margin-top: 8px;
      font-size: 20px;
      font-weight: 950;
      color: rgba(235,245,255,.70);
      line-height: 1.2;
    }
    .notes span{
      color: rgba(235,245,255,.52);
      font-weight: 900;
    }

    /* Calendar */
    .calHeader{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .calGrid{
      margin-top: 8px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }
    .dow{
      font-size: 18px;
      font-weight: 950;
      color: rgba(235,245,255,.55);
      text-align:center;
      margin-top: 2px;
    }
    .day{
      border-radius: 18px;
      border: 1px solid rgba(180,210,255,.10);
      background: rgba(255,255,255,.03);
      height: 64px;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding: 10px 10px;
      position:relative;
      user-select:none;
    }
    .day .d{
      font-weight: 950;
      font-size: 22px;
      color: rgba(235,245,255,.40);
    }
    .day.dim{
      opacity: .38;
    }
    .day.hasData{
      border-color: rgba(70,140,255,.52);
      background: rgba(45,95,190,.18);
      box-shadow: inset 0 0 0 1px rgba(120,190,255,.12);
      cursor:pointer;
    }
    .day.hasData .d{
      color: rgba(235,245,255,.86);
    }

    /* Modals (consistent) */
    .modalShade{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 10000;
    }
    .modalShade.show{ display:flex; }

    .modal{
      width: min(760px, 100%);
      max-height: min(88vh, 900px);
      overflow:hidden;
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(12,21,40,.90), rgba(8,12,24,.80));
      border: 2px solid rgba(70,140,255,.45);
      box-shadow: 0 28px 80px rgba(0,0,0,.70);
      position:relative;
    }
    .modalInner{
      padding: 18px 18px 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
      max-height: 88vh;
    }
    .modalTitle{
      font-size: 34px;
      font-weight: 950;
      letter-spacing: -0.6px;
      line-height: 1.05;
    }
    .modalClose{
      position:absolute;
      top: 12px;
      right: 12px;
      width: 54px;
      height: 54px;
      border-radius: 16px;
      border: 1px solid rgba(180,210,255,.20);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 28px;
      font-weight: 950;
      display:grid;
      place-items:center;
      user-select:none;
      cursor:pointer;
    }
    .modalClose:active{ transform: translateY(1px); }

    .modalScroll{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 2px;
      touch-action: pan-y;
    }

    /* Day list (tight clickable list) */
    .dayList{
      display:flex;
      flex-direction:column;
      gap: 8px;
      padding: 4px 2px;
    }
    .dayItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(180,210,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
    }
    .dayItem:active{ transform: translateY(1px); }
    .dayItem .n{
      font-size: 28px;
      font-weight: 950;
      letter-spacing: -0.4px;
      color: rgba(235,245,255,.90);
    }
    .dayItem .t{
      font-size: 16px;
      font-weight: 950;
      color: rgba(235,245,255,.55);
      white-space:nowrap;
      margin-left: 10px;
    }

    .modalActions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      padding-top: 6px;
    }
    .modalActions .btn{
      font-size: 18px;
      min-height: 46px;
      padding: 10px 14px;
    }

    /* Heart surprise */
    .heartWrap{
      display:flex;
      flex-direction:column;
      gap: 14px;
      align-items:center;
      justify-content:center;
      padding: 14px 6px 10px;
      text-align:center;
    }
    .heart{
      width: 190px;
      height: 190px;
      filter: drop-shadow(0 20px 45px rgba(0,0,0,.45));
      transform: scale(.90);
      opacity: 0;
      animation: popIn 520ms ease forwards;
    }
    .heartMsg{
      font-size: 30px;
      font-weight: 950;
      letter-spacing: -0.4px;
      color: rgba(235,245,255,.92);
      line-height: 1.12;
      opacity: 0;
      animation: fadeUp 480ms ease 140ms forwards;
    }
    @keyframes popIn{
      from{ transform: scale(.75); opacity:0; }
      to{ transform: scale(1); opacity:1; }
    }
    @keyframes fadeUp{
      from{ transform: translateY(6px); opacity:0; }
      to{ transform: translateY(0px); opacity:1; }
    }

    /* Pull-to-refresh UI + toast */
    .ptrBar{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 0px;
      z-index: 9999;
      pointer-events: none;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .ptrBarInner{
      height: 34px;
      padding: 0 14px;
      border-radius: 999px;
      background: rgba(8,16,31,.70);
      border: 1px solid rgba(120,160,220,.35);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      color: rgba(235,245,255,.86);
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap:10px;
      transform: translateY(-38px);
      transition: transform 160ms ease, opacity 160ms ease;
      opacity: 0;
    }
    .ptrBarInner.show{
      transform: translateY(10px);
      opacity: 1;
    }
    .ptrSpinner{
      width: 14px; height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(235,245,255,.28);
      border-top-color: rgba(235,245,255,.86);
      animation: ptrSpin 800ms linear infinite;
    }
    @keyframes ptrSpin{ to{ transform: rotate(360deg);} }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(8,16,31,.72);
      border: 1px solid rgba(120,160,220,.28);
      color: rgba(235,245,255,.86);
      font-weight: 900;
      font-size: 13px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease, transform 160ms ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* Interaction lock overlay (brief) */
    .tapShield{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0);
      display:none;
      z-index: 9000;
    }
    .tapShield.show{ display:block; }
  </style>
</head>

<body>
  <div class="ptrBar" id="ptrBar">
    <div class="ptrBarInner" id="ptrInner">
      <span class="ptrSpinner" aria-hidden="true"></span>
      <span id="ptrText">Checking for updates…</span>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <div class="app">
    <div class="brand">
      <div class="logo" id="logoTap" title="Angel Numbers Tracker">
        <!-- simple wings + halo -->
        <svg width="30" height="30" viewBox="0 0 64 64" fill="none" aria-hidden="true">
          <path d="M32 10c7 0 12-2 12-5s-5-5-12-5-12 2-12 5 5 5 12 5z" stroke="rgba(180,210,255,.85)" stroke-width="3" opacity=".85"/>
          <path d="M10 40c0-12 10-22 22-22" stroke="rgba(110,190,255,.95)" stroke-width="4" stroke-linecap="round"/>
          <path d="M54 40c0-12-10-22-22-22" stroke="rgba(140,160,255,.95)" stroke-width="4" stroke-linecap="round"/>
          <path d="M18 44c4 8 10 14 14 16" stroke="rgba(110,190,255,.75)" stroke-width="4" stroke-linecap="round"/>
          <path d="M46 44c-4 8-10 14-14 16" stroke="rgba(140,160,255,.75)" stroke-width="4" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="title">Angel Numbers Tracker</div>
    </div>

    <div class="viewport" id="viewport">
      <div class="tapShield" id="tapShield"></div>

      <div class="track" id="track">

        <!-- HOME PANEL (index 0) -->
        <section class="panel" data-panel="home">
          <div class="panelInner">
            <div class="bigStack">
              <button class="bigBtn primary" id="homeAdd">ADD Angel Number</button>
              <button class="bigBtn" id="homeLog">Log</button>
              <button class="bigBtn" id="homeCal">Calendar</button>

              <div class="btnRow" style="margin-top:6px;">
                <button class="btn btnGhost" id="btnUninstall">Uninstall</button>
                <button class="btn btnGhost" id="btnClearData">Clear Data</button>
                <button class="btn btnDanger" id="btnExit">Exit</button>
              </div>
            </div>

            <div class="homeMeta">
              <div class="line">Inspired by a real Angel.</div>
              <div class="line">Local-only. No accounts. No cloud.</div>

              <div class="footerRow">
                <div class="vLabel" id="vLabelTap">v1.333</div>
                <div>developed by Keyth Jyles</div>
              </div>
            </div>
          </div>
        </section>

        <!-- LOG PANEL (index 1) -->
        <section class="panel" data-panel="log">
          <div class="panelInner">
            <div class="btnRow">
              <button class="btn" id="logExport">Export</button>
              <button class="btn btnGhost" id="logAdd">ADD</button>
              <button class="btn" id="logBack">Back</button>
            </div>

            <div>
              <div class="fieldLabel">Search</div>
              <div class="inputRow">
                <input class="input" id="q" placeholder="Try: 111, mirror, reset, notes..." />
                <button class="btn" id="doSearch">Search</button>
              </div>

              <div class="inputRow" style="margin-top:10px;">
                <div style="flex:1 1 auto;">
                  <div class="fieldLabel" style="font-size:18px;margin-bottom:6px;">From</div>
                  <input class="select" id="fromDate" type="date" />
                </div>
                <div style="flex:1 1 auto;">
                  <div class="fieldLabel" style="font-size:18px;margin-bottom:6px;">To</div>
                  <input class="select" id="toDate" type="date" />
                </div>
              </div>
            </div>

            <!-- IMPORTANT: this must scroll -->
            <div class="scrollArea" id="logList" aria-label="Angel Number Log"></div>
          </div>
        </section>

        <!-- CALENDAR PANEL (index 2) -->
        <section class="panel" data-panel="calendar">
          <div class="panelInner">
            <div class="btnRow">
              <button class="btn" id="calExport">Export</button>
              <div style="flex:1 1 auto;"></div>
              <button class="btn" id="calBack">Back</button>
            </div>

            <div class="calHeader">
              <select class="select" id="monthPick" aria-label="Select month"></select>
              <button class="btn" id="calToday">Today</button>
            </div>

            <div class="inputRow" style="gap:10px;margin-top:-2px;">
              <div class="dow">Sun</div><div class="dow">Mon</div><div class="dow">Tue</div>
              <div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div>
            </div>

            <div class="scrollArea" id="calScroll">
              <div class="calGrid" id="calGrid"></div>
              <div style="margin-top:10px;color:rgba(235,245,255,.46);font-weight:900;">
                Tap a highlighted day to view entries.
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modalShade" id="modalShade">
    <div class="modal" id="modalBox" role="dialog" aria-modal="true">
      <div class="modalClose" id="modalClose">×</div>
      <div class="modalInner" id="modalInner"></div>
    </div>
  </div>

  <script>
    /***********************
     * App constants
     ***********************/
    const APP_VERSION = "v1.0B4";  // actual version (popup on logo 4-tap)
    const VISUAL_VERSION_LABEL = "v1.333"; // visual-only label on Home; do NOT change unless user says so
    const STORAGE_KEY = "angel_numbers_records_v1";
    const SEED_TEST_DATA = true; // set to false to remove seed behavior

    /***********************
     * Utilities
     ***********************/
    const $ = (id)=>document.getElementById(id);

    function nowISO(){ return new Date().toISOString(); }

    function pad2(n){ return String(n).padStart(2,"0"); }

    function toLocalDTInputValue(ms){
      const d = new Date(ms);
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      const hh = pad2(d.getHours());
      const mi = pad2(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function fromLocalDTInputValue(val){
      // val: "YYYY-MM-DDTHH:MM"
      const d = new Date(val);
      return d.getTime();
    }

    function fmtDateTime(ms){
      const d = new Date(ms);
      const m = d.getMonth()+1, day=d.getDate(), y=d.getFullYear();
      let hh = d.getHours();
      const mi = pad2(d.getMinutes());
      const ss = pad2(d.getSeconds());
      const ampm = hh>=12 ? "PM":"AM";
      hh = hh%12; if(hh===0) hh=12;
      return `${m}/${day}/${y}, ${hh}:${mi}:${ss} ${ampm}`;
    }

    function fmtTimeShort(ms){
      const d = new Date(ms);
      let hh = d.getHours();
      const mi = pad2(d.getMinutes());
      const ampm = hh>=12 ? "PM":"AM";
      hh = hh%12; if(hh===0) hh=12;
      return `${hh}:${mi} ${ampm}`;
    }

    function ymd(ms){
      const d = new Date(ms);
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function monthKeyFromDate(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    }

    function toast(msg, ms=1400){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(t._t);
      t._t = setTimeout(()=>t.classList.remove("show"), ms);
    }

    function copyText(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(text);
      }
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position="fixed";
      ta.style.left="-9999px";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      return Promise.resolve();
    }

    /***********************
     * Data model
     ***********************/
    // record:
    // { id, ts, number, pattern, meaning, digitSumText, notes }
    function loadRecords(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return [];
        return arr;
      }catch(e){
        return [];
      }
    }

    function saveRecords(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function uid(){
      return Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);
    }

    let records = loadRecords();

    /***********************
     * Seed test data (removable)
     ***********************/
    function maybeSeed(){
      if(!SEED_TEST_DATA) return;
      const flag = localStorage.getItem(STORAGE_KEY+"_seeded_vB4");
      if(flag) return;

      const base = new Date();
      base.setHours(20, 12, 10, 0);

      const samples = [
        { number:"101010", pattern:"Mixed pattern", meaning:"A general interpretation is heightened awareness: notice your thoughts, environment, and choices—then act deliberately.", digitSumText:"Digit-sum lens (3 → 3): 3 is often linked with creativity, expression, growth, and encouragement to communicate.", notes:"On my phone" },
        { number:"7777", pattern:"Repeating 7s", meaning:"Emphasis pattern (7777): 7 is often linked with insight, inner wisdom, spiritual inquiry, and learning through reflection.", digitSumText:"", notes:"Website" },
        { number:"2424", pattern:"Double pattern", meaning:"Reinforced signal (repeated block 24): a theme repeating until you notice it.", digitSumText:"Digit-sum lens (6 → 6): 6 is often linked with care, responsibility, home, and recalibrating priorities toward wellbeing.", notes:"Test notes" },
        { number:"99099", pattern:"Mirror (palindrome)", meaning:"Reflection and alignment. Consider what’s being mirrored back—choices, habits, or timing.", digitSumText:"9 is often linked with closure, compassion, integration, and completing a cycle with grace.", notes:"Watching TV" },
        { number:"111", pattern:"Repeating 1s", meaning:"Beginnings, intention, and focusing attention on what you want to build next.", digitSumText:"Digit-sum lens (3 → 3): creativity and expression.", notes:"" },
        { number:"1212", pattern:"Alternating pattern", meaning:"Balance and rhythm; align decisions with what feels steady and true.", digitSumText:"Digit-sum lens (6 → 6): care and responsibility.", notes:"" },
      ];

      // create a couple months of scattered events, plus one “bunch” day
      const seeded = [];
      const today = Date.now();

      function addAt(ms, s){
        seeded.push({
          id: uid(),
          ts: ms,
          number: s.number,
          pattern: s.pattern,
          meaning: s.meaning,
          digitSumText: s.digitSumText || "",
          notes: s.notes || ""
        });
      }

      // bunch day (heightened activity)
      const bunchDay = new Date();
      bunchDay.setMonth(bunchDay.getMonth()-1);
      bunchDay.setDate(27);
      bunchDay.setHours(21, 9, 30, 0);
      addAt(bunchDay.getTime(), samples[3]);
      addAt(bunchDay.getTime()+34*1000, samples[2]);
      addAt(bunchDay.getTime()+5*60*1000, samples[1]);
      addAt(bunchDay.getTime()+62*60*1000, samples[0]);

      // scatter across 2 months
      for(let i=0;i<18;i++){
        const d = new Date(today);
        d.setDate(d.getDate() - (i*3 + 2));
        d.setHours(18 + (i%4), 10 + (i%5)*7, 10 + (i%9), 0);
        addAt(d.getTime(), samples[i % samples.length]);
      }

      // merge with any existing records (don’t overwrite)
      records = loadRecords();
      records = records.concat(seeded);
      records.sort((a,b)=>b.ts-a.ts);
      saveRecords(records);
      localStorage.setItem(STORAGE_KEY+"_seeded_vB4","1");
    }

    maybeSeed();

    /***********************
     * Manifest (inline)
     ***********************/
    (function setupManifest(){
      const manifest = {
        name: "Angel Numbers Tracker",
        short_name: "Angel Numbers",
        start_url: "./",
        display: "standalone",
        background_color: "#0b1324",
        theme_color: "#0b1324",
        icons: [
          {
            src: "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
              <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" viewBox="0 0 192 192">
                <rect width="192" height="192" rx="44" fill="#0c1528"/>
                <circle cx="96" cy="48" r="22" fill="none" stroke="#b4d2ff" stroke-width="10" opacity=".85"/>
                <path d="M32 118c0-40 30-72 64-72" fill="none" stroke="#6ebeff" stroke-width="14" stroke-linecap="round"/>
                <path d="M160 118c0-40-30-72-64-72" fill="none" stroke="#8ca0ff" stroke-width="14" stroke-linecap="round"/>
                <path d="M56 132c12 22 26 36 40 42" fill="none" stroke="#6ebeff" stroke-width="14" stroke-linecap="round" opacity=".85"/>
                <path d="M136 132c-12 22-26 36-40 42" fill="none" stroke="#8ca0ff" stroke-width="14" stroke-linecap="round" opacity=".85"/>
              </svg>
            `),
            sizes: "192x192",
            type: "image/svg+xml"
          }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      $("manifestLink").setAttribute("href", url);
    })();

    /***********************
     * Service Worker (inline)
     * Note: true “force update every open” is constrained by browser SW rules.
     * We implement:
     * - SW claims clients immediately
     * - Hidden pull-to-refresh triggers reg.update + cache reload fetch + optional skipWaiting
     ***********************/
    (function setupServiceWorker(){
      if(!("serviceWorker" in navigator)) return;

      const SW_CODE = `
        const CACHE = "angel-numbers-cache-${APP_VERSION}";
        const CORE = [ "./" ];

        self.addEventListener("install", (event) => {
          self.skipWaiting();
          event.waitUntil(
            caches.open(CACHE).then(c => c.addAll(CORE)).catch(()=>{})
          );
        });

        self.addEventListener("activate", (event) => {
          event.waitUntil((async ()=>{
            try{
              const keys = await caches.keys();
              await Promise.all(keys.filter(k => k.startsWith("angel-numbers-cache-") && k !== CACHE).map(k => caches.delete(k)));
            }catch(e){}
            await self.clients.claim();
          })());
        });

        self.addEventListener("message", (event) => {
          if(event.data && event.data.type === "SKIP_WAITING") self.skipWaiting();
        });

        self.addEventListener("fetch", (event) => {
          const req = event.request;
          const url = new URL(req.url);

          // Only same-origin
          if(url.origin !== location.origin) return;

          // Network-first for navigation so updates show sooner.
          if(req.mode === "navigate"){
            event.respondWith((async ()=>{
              try{
                const fresh = await fetch(req, {cache:"no-store"});
                const c = await caches.open(CACHE);
                c.put("./", fresh.clone()).catch(()=>{});
                return fresh;
              }catch(e){
                const cached = await caches.match("./");
                return cached || new Response("Offline", {status:503});
              }
            })());
            return;
          }

          // Cache-first for everything else
          event.respondWith((async ()=>{
            const cached = await caches.match(req);
            if(cached) return cached;
            try{
              const fresh = await fetch(req);
              const c = await caches.open(CACHE);
              c.put(req, fresh.clone()).catch(()=>{});
              return fresh;
            }catch(e){
              return cached || new Response("", {status:504});
            }
          })());
        });
      `;

      const blob = new Blob([SW_CODE], {type:"text/javascript"});
      const swUrl = URL.createObjectURL(blob);

      navigator.serviceWorker.register(swUrl).catch(()=>{});
    })();

    /***********************
     * Pull-to-refresh hidden update gesture
     ***********************/
    const ptrInner = $("ptrInner");
    const ptrText = $("ptrText");

    async function checkForUpdates(){
      ptrInner.classList.add("show");
      ptrText.textContent = "Checking for updates…";

      try{
        if("serviceWorker" in navigator){
          const reg = await navigator.serviceWorker.getRegistration();
          if(reg) await reg.update().catch(()=>{});

          // best-effort: reload HTML without cache
          await fetch(location.href.split("#")[0], { cache: "reload" }).catch(()=>{});

          // activate waiting worker if present
          const reg2 = await navigator.serviceWorker.getRegistration();
          if(reg2 && reg2.waiting){
            reg2.waiting.postMessage({ type: "SKIP_WAITING" });
            toast("Updating…");
            // give it a moment then reload
            setTimeout(()=>location.reload(), 450);
          }else{
            toast("Update check complete");
          }
        }else{
          toast("Update check complete");
        }
      }catch(e){
        toast("Update check failed");
      }finally{
        ptrInner.classList.remove("show");
      }
    }

    (function setupPullToRefresh(){
      let tracking = false;
      let startY = 0;
      let pulled = 0;
      const THRESH = 70;

      function activeScrollTop(){
        // Allow pull-to-refresh when active panel’s scroll area is at top
        const activePanel = getActivePanelEl();
        if(!activePanel) return true;
        const sc = activePanel.querySelector(".scrollArea");
        if(!sc) return true;
        return (sc.scrollTop || 0) <= 0;
      }

      window.addEventListener("touchstart", (e)=>{
        if(e.touches.length !== 1) return;
        if(isSwiping) return;
        if(!activeScrollTop()) return;

        tracking = true;
        startY = e.touches[0].clientY;
        pulled = 0;
      }, {passive:true});

      window.addEventListener("touchmove", (e)=>{
        if(!tracking) return;
        if(isSwiping) return;

        const y = e.touches[0].clientY;
        pulled = Math.max(0, y - startY);

        if(pulled > 0){
          // prevent rubber band and prevent underlying taps
          e.preventDefault();

          if(pulled > 18){
            ptrInner.classList.add("show");
            ptrText.textContent = (pulled >= THRESH) ? "Release to check updates" : "Pull to check updates";
          }
        }
      }, {passive:false});

      window.addEventListener("touchend", async ()=>{
        if(!tracking) return;
        const fire = pulled >= THRESH;
        tracking = false;
        pulled = 0;

        if(fire) await checkForUpdates();
        else ptrInner.classList.remove("show");
      }, {passive:true});
    })();

    /***********************
     * Panel wheel swipe navigation
     ***********************/
    const viewport = $("viewport");
    const track = $("track");
    const tapShield = $("tapShield");

    let activeIndex = 0; // 0=Home, 1=Log, 2=Calendar
    let startX = 0;
    let startY = 0;
    let dragging = false;
    let dx = 0;
    let dy = 0;
    let isSwiping = false;
    let lastTouchTime = 0;

    function setShield(on){
      tapShield.classList.toggle("show", !!on);
    }

    function getActivePanelEl(){
      const panels = track.querySelectorAll(".panel");
      return panels[activeIndex] || null;
    }

    function applyTranslate(px, withTransition=false){
      if(withTransition){
        track.style.transition = "transform 220ms cubic-bezier(.2,.9,.2,1)";
      }else{
        track.style.transition = "none";
      }
      // base positions: -index*viewportWidth + dragPx
      const w = viewport.clientWidth;
      const base = -activeIndex * w;
      track.style.transform = `translateX(${base + px}px)`;
    }

    function snapTo(index){
      activeIndex = (index + 3) % 3;
      applyTranslate(0, true);
      // brief disable after swipe (requested)
      setShield(true);
      clearTimeout(snapTo._t);
      snapTo._t = setTimeout(()=>setShield(false), 260);
      setTimeout(()=>track.style.transition="none", 240);
    }

    // initialize position
    window.addEventListener("resize", ()=>applyTranslate(0,false));
    applyTranslate(0,false);

    viewport.addEventListener("touchstart", (e)=>{
      if(e.touches.length !== 1) return;

      // If starting inside a scroll area, allow vertical scroll; we only swipe if horizontal intent is clear
      dragging = true;
      isSwiping = false;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      dx = 0; dy = 0;
      lastTouchTime = Date.now();
    }, {passive:true});

    viewport.addEventListener("touchmove", (e)=>{
      if(!dragging) return;
      const x = e.touches[0].clientX;
      const y = e.touches[0].clientY;
      dx = x - startX;
      dy = y - startY;

      // Determine gesture: if horizontal dominates, swipe panels
      if(!isSwiping){
        const ax = Math.abs(dx), ay = Math.abs(dy);
        if(ax > 10 && ax > ay * 1.25){
          isSwiping = true;
          setShield(true); // prevent underlying taps while swiping
        }else if(ay > 10 && ay > ax * 1.25){
          // vertical scroll intent; don't hijack
          dragging = false;
          setShield(false);
          return;
        }else{
          return; // not enough info yet
        }
      }

      // Now swiping: follow finger exactly (requested)
      e.preventDefault();
      applyTranslate(dx, false);
    }, {passive:false});

    viewport.addEventListener("touchend", ()=>{
      if(!dragging && !isSwiping){
        dragging = false;
        setShield(false);
        return;
      }

      const w = viewport.clientWidth;
      const threshold = Math.max(70, w * 0.18);

      if(isSwiping){
        // Determine direction: swipe left = next panel to the right (index+1), swipe right = previous (index-1)
        if(dx <= -threshold){
          // finger moved left => bring next panel from right
          snapTo(activeIndex + 1);
        }else if(dx >= threshold){
          // finger moved right => bring prev panel from left
          snapTo(activeIndex - 1);
        }else{
          // snap back
          applyTranslate(0, true);
          setShield(true);
          clearTimeout(snapTo._t2);
          snapTo._t2 = setTimeout(()=>setShield(false), 210);
          setTimeout(()=>track.style.transition="none", 240);
        }
      }else{
        setShield(false);
      }

      dragging = false;
      isSwiping = false;
      dx = 0; dy = 0;
    }, {passive:true});

    /***********************
     * Modal system (single modal, consistent)
     ***********************/
    const modalShade = $("modalShade");
    const modalInner = $("modalInner");
    const modalClose = $("modalClose");

    // Track where modal was opened from (to ensure “back to source” behavior)
    let modalContext = { panelIndex: 0, sub: null };

    function openModal(html, ctx){
      if(ctx) modalContext = ctx;
      modalInner.innerHTML = html;
      modalShade.classList.add("show");
      setShield(true);
      setTimeout(()=>setShield(false), 140);
    }

    function closeModal(){
      modalShade.classList.remove("show");
      modalInner.innerHTML = "";
      // return to panel that opened it (requested)
      if(typeof modalContext.panelIndex === "number"){
        activeIndex = modalContext.panelIndex;
        applyTranslate(0, false);
      }
    }

    modalClose.addEventListener("click", closeModal);
    modalShade.addEventListener("click", (e)=>{ if(e.target === modalShade) closeModal(); });

    /***********************
     * Record helpers
     ***********************/
    function computePattern(numStr){
      const s = String(numStr || "").trim();
      if(!s) return "Unknown";
      if([...s].every(ch => ch === s[0])) return `Repeating ${s[0]}s`;
      const rev = s.split("").reverse().join("");
      if(s.length >= 3 && s === rev) return "Mirror (palindrome)";

      // double block (e.g., 2424)
      if(s.length % 2 === 0){
        const half = s.slice(0, s.length/2);
        if(half + half === s) return "Double pattern";
      }

      // alternating / mixed
      return "Mixed pattern";
    }

    function digitSumLens(numStr){
      const digits = String(numStr||"").replace(/\D/g,"").split("").map(d=>parseInt(d,10));
      if(!digits.length) return "";
      const sum = digits.reduce((a,b)=>a+b,0);
      const reduce = (n)=>{
        while(n>9){
          n = String(n).split("").reduce((a,b)=>a+parseInt(b,10),0);
        }
        return n;
      };
      const r = reduce(sum);
      const map = {
        1:"beginnings, initiative, and focus",
        2:"balance, partnership, and sensitivity",
        3:"creativity, expression, and encouragement to communicate",
        4:"stability, structure, and grounded effort",
        5:"change, adaptability, and movement",
        6:"care, responsibility, home, and recalibrating priorities toward wellbeing",
        7:"insight, inner wisdom, spiritual inquiry, and learning through reflection",
        8:"power, momentum, capability, and material mastery",
        9:"closure, compassion, integration, and completing a cycle with grace"
      };
      return `Digit-sum lens (${sum} → ${r}): ${r} is often linked with ${map[r] || "a personal theme"}.`;
    }

    function defaultMeaning(numStr){
      return "A general interpretation is heightened awareness: notice your thoughts, environment, and choices—then act deliberately.";
    }

    function normalizeRecord(r){
      return {
        id: r.id || uid(),
        ts: typeof r.ts === "number" ? r.ts : Date.now(),
        number: String(r.number||"").trim(),
        pattern: String(r.pattern||"").trim(),
        meaning: String(r.meaning||"").trim(),
        digitSumText: String(r.digitSumText||"").trim(),
        notes: String(r.notes||"").trim()
      };
    }

    function upsertRecord(rec){
      rec = normalizeRecord(rec);
      const idx = records.findIndex(x => x.id === rec.id);
      if(idx >= 0) records[idx] = rec;
      else records.unshift(rec);
      records.sort((a,b)=>b.ts-a.ts);
      saveRecords(records);
      renderAll();
    }

    function deleteRecord(id){
      records = records.filter(r => r.id !== id);
      saveRecords(records);
      renderAll();
    }

    /***********************
     * Rendering: Log + Calendar
     ***********************/
    function renderLog(){
      const list = $("logList");
      const query = ($("q").value || "").trim().toLowerCase();
      const from = $("fromDate").value ? new Date($("fromDate").value + "T00:00:00").getTime() : null;
      const to = $("toDate").value ? new Date($("toDate").value + "T23:59:59").getTime() : null;

      let arr = records.slice();

      if(from != null) arr = arr.filter(r => r.ts >= from);
      if(to != null) arr = arr.filter(r => r.ts <= to);

      if(query){
        arr = arr.filter(r => {
          const hay = [
            r.number, r.pattern, r.meaning, r.digitSumText, r.notes
          ].join(" ").toLowerCase();
          return hay.includes(query);
        });
      }

      if(!arr.length){
        list.innerHTML = `<div style="padding:18px 6px;color:rgba(235,245,255,.52);font-weight:900;">No entries.</div>`;
        return;
      }

      list.innerHTML = arr.map(r => `
        <div class="card" data-id="${r.id}">
          <div class="dt">${fmtDateTime(r.ts)}</div>
          <div class="cardTop">
            <div class="num">${escapeHTML(r.number)}</div>
            <div class="pat">${escapeHTML(r.pattern || computePattern(r.number))}</div>
          </div>
          <div class="meaning"><span style="color:rgba(235,245,255,.76);font-weight:950;">Meaning:</span> ${escapeHTML(r.meaning || defaultMeaning(r.number))}${r.digitSumText ? " " + escapeHTML(r.digitSumText) : ""}</div>
          <div class="notes"><span>Notes:</span> ${escapeHTML(r.notes || "")}</div>
        </div>
      `).join("");

      // click handlers
      list.querySelectorAll(".card").forEach(card=>{
        card.addEventListener("click", ()=>{
          if(tapShield.classList.contains("show")) return;
          const id = card.getAttribute("data-id");
          const rec = records.find(x=>x.id===id);
          if(rec) openRecordCard(rec, { panelIndex: 1, sub:"log" });
        });
      });
    }

    function buildCalendarMonthOptions(){
      // from earliest record to latest record, plus current month
      const months = new Set();
      const now = new Date();
      months.add(monthKeyFromDate(now));

      records.forEach(r=>{
        const d = new Date(r.ts);
        months.add(monthKeyFromDate(d));
      });

      const arr = [...months].sort();
      const sel = $("monthPick");
      sel.innerHTML = arr.map(m=>{
        const [y,mm] = m.split("-");
        const label = new Date(parseInt(y,10), parseInt(mm,10)-1, 1).toLocaleString(undefined, {month:"long", year:"numeric"});
        return `<option value="${m}">${escapeHTML(label)}</option>`;
      }).join("");

      // default to current month
      sel.value = monthKeyFromDate(new Date());
    }

    function renderCalendar(){
      buildCalendarMonthOptions();
      const sel = $("monthPick");
      const key = sel.value || monthKeyFromDate(new Date());
      const [Y, M] = key.split("-").map(x=>parseInt(x,10));
      const year = Y;
      const monthIndex = M-1;

      const first = new Date(year, monthIndex, 1);
      const startDow = first.getDay(); // 0..6
      const daysInMonth = new Date(year, monthIndex+1, 0).getDate();

      // build a 6-week grid (42)
      const cells = [];
      for(let i=0;i<42;i++){
        const dayNum = i - startDow + 1;
        const inMonth = dayNum >= 1 && dayNum <= daysInMonth;
        const date = new Date(year, monthIndex, dayNum);
        const keyYmd = ymd(date.getTime());
        const hasData = inMonth && records.some(r => ymd(r.ts) === keyYmd);

        cells.push({ inMonth, dayNum, hasData, ymd:keyYmd });
      }

      const grid = $("calGrid");
      grid.innerHTML = cells.map(c=>{
        const cls = ["day"];
        if(!c.inMonth) cls.push("dim");
        if(c.hasData) cls.push("hasData");
        return `<div class="${cls.join(" ")}" data-ymd="${c.ymd}" data-in="${c.inMonth ? "1":"0"}" data-has="${c.hasData ? "1":"0"}">
          <div class="d">${c.inMonth ? c.dayNum : ""}</div>
        </div>`;
      }).join("");

      // click highlighted days only
      grid.querySelectorAll(".day.hasData").forEach(el=>{
        el.addEventListener("click", ()=>{
          if(tapShield.classList.contains("show")) return;
          const day = el.getAttribute("data-ymd");
          openDayList(day, { panelIndex: 2, sub:"calendar" });
        });
      });
    }

    function renderAll(){
      // keep month pick stable if possible
      const prevMonth = $("monthPick").value || null;

      renderLog();

      // Calendar re-render: preserve selected month if possible
      buildCalendarMonthOptions();
      if(prevMonth){
        const opt = [...$("monthPick").options].find(o=>o.value===prevMonth);
        if(opt) $("monthPick").value = prevMonth;
      }
      renderCalendar();
    }

    function escapeHTML(s){
      return String(s ?? "").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    /***********************
     * Modal content: Card / Day list / Add/Edit / Confirm / Version / Heart
     ***********************/
    function recordCardHTML(r){
      const pat = r.pattern || computePattern(r.number);
      const meaning = r.meaning || defaultMeaning(r.number);
      const lens = r.digitSumText || digitSumLens(r.number);
      return `
        <div class="modalTitle">Angel Number Card</div>
        <div class="modalScroll">
          <div class="card" style="margin:10px 0 6px;cursor:default;">
            <div class="dt">${fmtDateTime(r.ts)}</div>
            <div class="cardTop">
              <div class="num">${escapeHTML(r.number)}</div>
              <div class="pat">${escapeHTML(pat)}</div>
            </div>
            <div class="meaning"><span style="color:rgba(235,245,255,.78);font-weight:950;">Meaning:</span> ${escapeHTML(meaning)} ${lens ? escapeHTML(lens) : ""}</div>
            <div class="notes"><span>Notes:</span> ${escapeHTML(r.notes || "")}</div>
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="cardCopy">Copy</button>
          <button class="btn" id="cardExport">Export</button>
          <button class="btn btnGhost" id="cardEdit">Edit</button>
          <button class="btn btnDanger" id="cardDelete">Delete</button>
          <button class="btn" id="cardClose">Close</button>
        </div>
      `;
    }

    function openRecordCard(r, ctx){
      openModal(recordCardHTML(r), ctx);

      $("cardClose").onclick = closeModal;

      $("cardCopy").onclick = async ()=>{
        const text = buildRecordText(r);
        await copyText(text);
        toast("Copied");
      };

      $("cardExport").onclick = ()=>{
        const text = buildRecordText(r);
        downloadText(`AngelNumber_${ymd(r.ts)}_${String(r.number).replace(/\D/g,"")||"record"}.txt`, text);
        toast("Saved");
      };

      $("cardEdit").onclick = ()=>{
        openEditModal(r, ctx);
      };

      $("cardDelete").onclick = ()=>{
        openConfirmModal(
          "Delete this record?",
          "This will permanently remove the Angel Number record from this device.",
          "Delete",
          ()=>{
            deleteRecord(r.id);
            closeModal();
            toast("Deleted");
          },
          ctx
        );
      };
    }

    function buildRecordText(r){
      const pat = r.pattern || computePattern(r.number);
      const meaning = r.meaning || defaultMeaning(r.number);
      const lens = r.digitSumText || digitSumLens(r.number);

      // Keep this easy to copy/export; also used by calendar list item export if needed
      return [
        `Angel Numbers Tracker — Angel Number Card`,
        `App Version: ${APP_VERSION}`,
        `------------------------------`,
        `${fmtDateTime(r.ts)}`,
        `Number: ${r.number}`,
        `Pattern: ${pat}`,
        `Meaning: ${meaning}`,
        lens ? lens : ``,
        `Notes: ${r.notes || ""}`
      ].filter(Boolean).join("\n");
    }

    function openDayList(dayYmd, ctx){
      const items = records
        .filter(r => ymd(r.ts) === dayYmd)
        .sort((a,b)=>a.ts-b.ts);

      const d = new Date(dayYmd + "T00:00:00");
      const title = d.toLocaleDateString(undefined, {weekday:"long", month:"long", day:"numeric", year:"numeric"});

      const html = `
        <div class="modalTitle">${escapeHTML(title)}</div>
        <div class="modalScroll">
          <div class="dayList">
            ${items.map(r=>`
              <div class="dayItem" data-id="${r.id}">
                <div class="n">${escapeHTML(r.number)}</div>
                <div class="t">${escapeHTML(fmtTimeShort(r.ts))}</div>
              </div>
            `).join("")}
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="dayClose">Close</button>
        </div>
      `;

      openModal(html, ctx);

      $("dayClose").onclick = closeModal;

      modalInner.querySelectorAll(".dayItem").forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-id");
          const rec = records.find(x=>x.id===id);
          if(rec) openRecordCard(rec, ctx);
        });
      });
    }

    function addEditHTML(r){
      const isEdit = !!r;
      const rec = r ? normalizeRecord(r) : normalizeRecord({ ts: Date.now(), number:"", pattern:"", meaning:"", digitSumText:"", notes:"" });
      const tsVal = toLocalDTInputValue(rec.ts);

      return `
        <div class="modalTitle">${isEdit ? "Edit Angel Number" : "Add Angel Number"}</div>

        <div class="modalScroll">
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div>
              <div class="fieldLabel">Date & Time</div>
              <input class="input" id="editDT" type="datetime-local" value="${escapeHTML(tsVal)}" />
            </div>

            <div>
              <div class="fieldLabel">Number</div>
              <input class="input" id="editNumber" inputmode="numeric" placeholder="e.g., 7777" value="${escapeHTML(rec.number)}" />
            </div>

            <div>
              <div class="fieldLabel">Pattern</div>
              <input class="input" id="editPattern" placeholder="e.g., Repeating 7s" value="${escapeHTML(rec.pattern)}" />
            </div>

            <div>
              <div class="fieldLabel">Meaning</div>
              <textarea class="input" id="editMeaning" rows="4" style="height:auto;min-height:120px;resize:vertical;">${escapeHTML(rec.meaning)}</textarea>
            </div>

            <div>
              <div class="fieldLabel">Digit-sum lens</div>
              <textarea class="input" id="editLens" rows="2" style="height:auto;min-height:84px;resize:vertical;">${escapeHTML(rec.digitSumText)}</textarea>
            </div>

            <div>
              <div class="fieldLabel">Notes</div>
              <textarea class="input" id="editNotes" rows="2" style="height:auto;min-height:84px;resize:vertical;">${escapeHTML(rec.notes)}</textarea>
            </div>
          </div>
        </div>

        <div class="modalActions">
          <button class="btn btnGhost" id="editAuto">Auto-fill</button>
          <button class="btn btnPrimary" id="editSave">Save</button>
          <button class="btn" id="editCancel">Cancel</button>
        </div>
      `;
    }

    function openAddModal(ctx){
      openModal(addEditHTML(null), ctx);

      $("editCancel").onclick = closeModal;

      $("editAuto").onclick = ()=>{
        const number = ($("editNumber").value || "").trim();
        if(!number){
          toast("Enter a number first");
          return;
        }
        $("editPattern").value = computePattern(number);
        if(!($("editMeaning").value||"").trim()) $("editMeaning").value = defaultMeaning(number);
        $("editLens").value = digitSumLens(number);
        toast("Auto-filled");
      };

      $("editSave").onclick = ()=>{
        const ts = fromLocalDTInputValue($("editDT").value);
        const number = ($("editNumber").value || "").trim();
        if(!number){
          toast("Number required");
          return;
        }
        const rec = {
          id: uid(),
          ts,
          number,
          pattern: ($("editPattern").value || "").trim() || computePattern(number),
          meaning: ($("editMeaning").value || "").trim() || defaultMeaning(number),
          digitSumText: ($("editLens").value || "").trim() || digitSumLens(number),
          notes: ($("editNotes").value || "").trim()
        };
        upsertRecord(rec);
        closeModal();
        toast("Saved");
      };
    }

    function openEditModal(r, ctx){
      openModal(addEditHTML(r), ctx);

      $("editCancel").onclick = ()=>openRecordCard(r, ctx);

      $("editAuto").onclick = ()=>{
        const number = ($("editNumber").value || "").trim();
        if(!number){
          toast("Enter a number first");
          return;
        }
        $("editPattern").value = computePattern(number);
        if(!($("editMeaning").value||"").trim()) $("editMeaning").value = defaultMeaning(number);
        $("editLens").value = digitSumLens(number);
        toast("Auto-filled");
      };

      $("editSave").onclick = ()=>{
        const ts = fromLocalDTInputValue($("editDT").value);
        const number = ($("editNumber").value || "").trim();
        if(!number){
          toast("Number required");
          return;
        }
        const updated = {
          id: r.id,
          ts,
          number,
          pattern: ($("editPattern").value || "").trim() || computePattern(number),
          meaning: ($("editMeaning").value || "").trim() || defaultMeaning(number),
          digitSumText: ($("editLens").value || "").trim() || digitSumLens(number),
          notes: ($("editNotes").value || "").trim()
        };
        upsertRecord(updated);
        // re-open card from same context
        const rec = records.find(x=>x.id===r.id) || updated;
        openRecordCard(rec, ctx);
        toast("Updated");
      };
    }

    function openConfirmModal(title, body, okLabel, onOk, ctx){
      const html = `
        <div class="modalTitle">${escapeHTML(title)}</div>
        <div class="modalScroll" style="color:rgba(235,245,255,.70);font-weight:900;line-height:1.25;">
          ${escapeHTML(body)}
        </div>
        <div class="modalActions">
          <button class="btn btnDanger" id="confirmOk">${escapeHTML(okLabel)}</button>
          <button class="btn" id="confirmCancel">Cancel</button>
        </div>
      `;
      openModal(html, ctx);
      $("confirmCancel").onclick = closeModal;
      $("confirmOk").onclick = ()=>onOk && onOk();
    }

    function openVersionModal(ctx){
      const html = `
        <div class="modalTitle">App Version</div>
        <div class="modalScroll" style="color:rgba(235,245,255,.74);font-weight:950;line-height:1.25;">
          <div class="card" style="cursor:default;margin:10px 0;">
            <div style="font-size:20px;font-weight:950;color:rgba(235,245,255,.60);">Actual app version</div>
            <div style="font-size:40px;font-weight:950;letter-spacing:-.8px;margin-top:6px;">${escapeHTML(APP_VERSION)}</div>
          </div>
          <div style="padding:4px 2px;color:rgba(235,245,255,.55);font-weight:900;">
            Note: The Home label “${escapeHTML(VISUAL_VERSION_LABEL)}” is visual-only.
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="verClose">Close</button>
        </div>
      `;
      openModal(html, ctx);
      $("verClose").onclick = closeModal;
    }

    function openHeartModal(ctx){
      const html = `
        <div class="modalTitle"> </div>
        <div class="modalScroll">
          <div class="heartWrap">
            <svg class="heart" viewBox="0 0 64 64" aria-hidden="true">
              <path d="M32 56S6 39 6 22c0-7 5-12 12-12 6 0 10 4 14 9 4-5 8-9 14-9 7 0 12 5 12 12 0 17-26 34-26 34z"
                fill="url(#g)"/>
              <defs>
                <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0" stop-color="rgba(120,190,255,.95)"/>
                  <stop offset="1" stop-color="rgba(80,120,255,.85)"/>
                </linearGradient>
              </defs>
            </svg>
            <div class="heartMsg">The Angels love you Timmy!</div>
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="heartClose">Close</button>
        </div>
      `;
      openModal(html, ctx);
      $("heartClose").onclick = closeModal;
    }

    /***********************
     * Export (Log Export)
     ***********************/
    function buildLogExportText(){
      const query = ($("q").value || "").trim();
      const from = $("fromDate").value;
      const to = $("toDate").value;

      const generated = new Date().toLocaleString();
      let arr = records.slice();

      const fromMs = from ? new Date(from + "T00:00:00").getTime() : null;
      const toMs = to ? new Date(to + "T23:59:59").getTime() : null;

      if(fromMs != null) arr = arr.filter(r => r.ts >= fromMs);
      if(toMs != null) arr = arr.filter(r => r.ts <= toMs);

      if(query){
        const q = query.toLowerCase();
        arr = arr.filter(r => {
          const hay = [r.number,r.pattern,r.meaning,r.digitSumText,r.notes].join(" ").toLowerCase();
          return hay.includes(q);
        });
      }

      const rangeLabel = (!from && !to) ? "All log entries (filtered by search/date if set)" : `From ${from||"…"} To ${to||"…"}`;
      const lines = [];

      lines.push("Angel Numbers Tracker — Export Report");
      lines.push(`App Version: ${APP_VERSION}`);
      lines.push("Report: Log Export");
      lines.push(`Generated: ${generated}`);
      lines.push(`Range: ${rangeLabel}`);
      lines.push("");
      lines.push("How this data was captured:");
      lines.push("- Sightings are entered manually into Angel Numbers Tracker on this device.");
      lines.push("- Data is stored locally on the phone (no cloud sync, no account).");
      lines.push("- Each record may include the number, pattern type, a cultural/numerology meaning, and optional notes.");
      lines.push("");
      lines.push("This report reflects the Log screen filters (Search + optional From/To dates).");
      lines.push("");
      lines.push("------------------------------");

      // IMPORTANT FIX: no leading whitespace before first record (and no indentation from bullets)
      arr.forEach(r=>{
        const pat = r.pattern || computePattern(r.number);
        const meaning = r.meaning || defaultMeaning(r.number);
        const lens = r.digitSumText || digitSumLens(r.number);

        lines.push(`${fmtDateTime(r.ts)}`);
        lines.push(`Number: ${r.number}`);
        lines.push(`Pattern: ${pat}`);
        lines.push(`Meaning: ${meaning}`);
        if(lens) lines.push(lens);
        lines.push(`Notes: ${r.notes || ""}`);
        lines.push("");
      });

      return lines.join("\n").trimEnd() + "\n";
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url), 400);
    }

    /***********************
     * Wire up UI actions
     ***********************/
    // Home buttons (use snapTo to keep consistent)
    $("homeAdd").addEventListener("click", ()=>openAddModal({panelIndex:0, sub:"home"}));
    $("homeLog").addEventListener("click", ()=>snapTo(1));
    $("homeCal").addEventListener("click", ()=>snapTo(2));

    // Log buttons
    $("logBack").addEventListener("click", ()=>snapTo(0));
    $("logAdd").addEventListener("click", ()=>openAddModal({panelIndex:1, sub:"log"}));
    $("doSearch").addEventListener("click", renderLog);
    $("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") renderLog(); });
    $("fromDate").addEventListener("change", renderLog);
    $("toDate").addEventListener("change", renderLog);

    $("logExport").addEventListener("click", async ()=>{
      const text = buildLogExportText();
      // show exactly as pasted: copy and also offer file
      await copyText(text).catch(()=>{});
      downloadText("AngelNumbers_LogExport.txt", text);
      toast("Exported");
    });

    // Calendar buttons
    $("calBack").addEventListener("click", ()=>snapTo(0));
    $("calToday").addEventListener("click", ()=>{
      const now = new Date();
      $("monthPick").value = monthKeyFromDate(now);
      renderCalendar();
      // scroll to top
      $("calScroll").scrollTop = 0;
    });

    $("monthPick").addEventListener("change", renderCalendar);

    $("calExport").addEventListener("click", async ()=>{
      const text = buildLogExportText();
      await copyText(text).catch(()=>{});
      downloadText("AngelNumbers_LogExport.txt", text);
      toast("Exported");
    });

    // Clear data (confirm popup should match edit popup styling)
    $("btnClearData").addEventListener("click", ()=>{
      openConfirmModal(
        "Clear all data?",
        "This will remove ALL Angel Numbers from this device.",
        "Clear Data",
        ()=>{
          records = [];
          saveRecords(records);
          localStorage.removeItem(STORAGE_KEY+"_seeded_vB4");
          closeModal();
          renderAll();
          toast("Cleared");
        },
        {panelIndex:0, sub:"home"}
      );
    });

    // Uninstall guidance (simple)
    $("btnUninstall").addEventListener("click", ()=>{
      const html = `
        <div class="modalTitle">Uninstall</div>
        <div class="modalScroll" style="color:rgba(235,245,255,.70);font-weight:900;line-height:1.25;">
          <div class="card" style="cursor:default;">
            <div style="font-size:20px;font-weight:950;color:rgba(235,245,255,.60);">Android / Chrome</div>
            <div style="margin-top:8px;">
              Open the app settings from your home screen icon, or uninstall like any other app.
              If you installed from Chrome, you can also remove it from Chrome → Settings → Site settings → Storage (varies by device).
            </div>
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="unClose">Close</button>
        </div>
      `;
      openModal(html, {panelIndex:0, sub:"home"});
      $("unClose").onclick = closeModal;
    });

    // Exit (best-effort)
    $("btnExit").addEventListener("click", ()=>{
      try{
        window.close();
        setTimeout(()=>alert("If the app did not close, use your device Back/Home button."), 350);
      }catch(e){
        alert("Use your device Back/Home button to exit.");
      }
    });

    /***********************
     * Secret taps
     ***********************/
    // Quadruple tap logo => version popup (formatted properly)
    (function logoTap(){
      let n=0;
      let t=0;
      $("logoTap").addEventListener("click", ()=>{
        const now = Date.now();
        if(now - t > 900) n = 0;
        t = now;
        n++;
        if(n >= 4){
          n = 0;
          openVersionModal({panelIndex: activeIndex, sub:"logo"});
        }
      });
    })();

    // Five taps on v1.333 label => heart modal (animated)
    (function vLabelTap(){
      let n=0;
      let t=0;
      const el = $("vLabelTap");
      el.textContent = VISUAL_VERSION_LABEL;

      el.addEventListener("click", ()=>{
        const now = Date.now();
        if(now - t > 900) n = 0;
        t = now;
        n++;
        if(n >= 5){
          n = 0;
          openHeartModal({panelIndex:0, sub:"home"});
        }
      });
    })();

    /***********************
     * Initial render
     ***********************/
    renderAll();

    /***********************
     * Ensure calendar/month options are usable after renderAll
     * (renderAll calls build options and renderCalendar)
     ***********************/

  </script>

  <!--
  Version Detail Notes (EOF)
  App Version: v1.0B4
  Base: v1.0B3 (per correction)
  Changes:
  - Pull-to-refresh hidden update check (no button).
  - Wheel-like swipe navigation between Home / Log / Calendar, finger-tracking and snap.
  - Calendar: highlight-only; tap day -> tight day list -> tap -> Angel Number Card.
  - Card title: "Angel Number Card"; full info included; copy/export/edit/delete.
  - Edit supports editable date/time.
  - Log list scroll fixed (scrollArea) + tight vertical layout.
  - Consistent modal formatting for all popups (version/delete/clear/day list/card/edit).
  - Dark-blue border around each panel.
  - Home: ADD label + Inspired line + v1.333 5-tap heart surprise.
  - Logo 4-tap shows actual version.
  - Export indentation bug fixed (first record not indented).
  - Seed test data for a couple months (toggle SEED_TEST_DATA).
  -->
</body>
</html>
