<!-- Angel Numbers Tracker v1.0B13 -->
<!--
Version Detail Notes
App Version (internal): v1.0B13
Home display label (visual only): v1.333  (DO NOT CHANGE unless user instructs)
Base: v1.0B12

Changes (requested):
1) Remove Log panel entirely.
2) Add new "Identify" panel (theme-matched) to quickly identify an Angel Number’s characteristics/meaning.
   - Home: replace Log button with Identify button (placed just below ADD).
   - Swipe rotation: Identify replaces Log in the left/right swipe cycle.
3) Identify panel:
   - Input field for a number.
   - Results area beneath showing pattern, meaning, and supporting lenses.
4) Keep EOF comment block.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Angel Numbers Tracker</title>
  <link rel="manifest" id="manifestLink" href="#" />

  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;
      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --text:rgba(235,245,255,.86);
      --muted:rgba(235,245,255,.58);
      --muted2:rgba(235,245,255,.42);

      /* DARK BLUE theme border */
      --accentBorder: rgba(43,78,122,.85);
      --accentGlow: rgba(43,78,122,.18);

      /* Subtle theme border for internal cards/lists */
      --themeLine: rgba(43,78,122,.55);
      --themeLineSoft: rgba(43,78,122,.28);

      --shadow:0 14px 40px rgba(0,0,0,.38);
      --radius:26px;
      --btnH:56px;
      --pad:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 0%, rgba(47,120,255,.22), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(155,120,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex;
      justify-content:center;
      padding: max(14px, env(safe-area-inset-top)) 12px max(14px, env(safe-area-inset-bottom));
      overflow:hidden;
    }

    .app{
      width:min(520px, 100%);
      height: 100%;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:hidden;
    }

    .logoTitle{
      margin:10px 6px 0;
      display:flex;
      justify-content:center;
      align-items:center;
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .logoTitle svg{
      width:min(520px, 100%);
      height:auto;
      display:block;
    }

    .screenArea{
      position:relative;
      flex:1;
      overflow:hidden;
      border-radius: var(--radius);
      touch-action: pan-y;
    }

    /* MAIN PANEL CARD — consistent dark-blue border */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:3px solid var(--accentBorder);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
      backdrop-filter: blur(10px);

      position:absolute;
      inset:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
      overscroll-behavior: contain;
    }

    .hidden{ display:none !important; }

    .btn{
      height:var(--btnH);
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color:rgba(235,245,255,.78);
      font-weight:650;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 18px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-size:18px;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(47,120,255,.92), rgba(47,120,255,.72));
      border-color: rgba(120,170,255,.55);
      color: rgba(235,245,255,.90);
    }

    .btn.danger{
      background: linear-gradient(180deg, rgba(255,80,80,.18), rgba(255,80,80,.10));
      border-color: rgba(255,120,120,.42);
      color: rgba(255,225,225,.92);
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
    }

    .btn.small{
      height:44px;
      font-size:16px;
      padding:0 14px;
      font-weight:650;
      white-space:nowrap;
    }

    .btn:disabled{
      opacity:.55;
      filter:saturate(.85);
      transform:none !important;
      pointer-events:none;
    }

    .row{ display:flex; gap:12px; }
    .row.center{ align-items:center; }
    .grow{ flex:1; }

    /* Tighten vertical space */
    .label{
      font-size:15px;
      color:var(--muted);
      font-weight:650;
      margin: 10px 4px 6px;
    }
    .subtle{
      font-size:14px;
      color:var(--muted2);
      margin: 6px 4px 0;
    }

    .field{
      border:2px solid var(--strokeBold);
      background: rgba(255,255,255,.06);
      color: rgba(235,245,255,.86);
      border-radius: 18px;
      height:54px;
      padding: 0 14px;
      font-size:18px;
      outline:none;
      width:100%;
    }
    .field::placeholder{ color: rgba(235,245,255,.35); }
    .field:focus{
      border-color: rgba(90,150,255,.78);
      box-shadow: 0 0 0 4px rgba(47,120,255,.16);
    }
    textarea.field{
      height:84px;
      padding: 12px 14px;
      resize:none;
      line-height:1.25;
    }
    input[type="date"].field,
    input[type="datetime-local"].field,
    input[type="month"].field{
      font-size:16px;
      padding-right: 10px;
    }

    .homeMain{
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-top:8px;
    }
    .homeMain > .btn:not(.small){
      font-size:26px;
      font-weight:750;
      letter-spacing:.3px;
    }

    .homeFooterRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
      flex-wrap:nowrap;
    }

    .footerTiny{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: rgba(235,245,255,.38);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .timeLine{
      margin: 4px 4px 10px;
      color: rgba(235,245,255,.82);
      font-weight:750;
      letter-spacing:.3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.05;
      font-size: clamp(18px, 6.4vw, 44px);
    }

    .meaningCard{
      border:1px solid var(--themeLine);
      background: rgba(255,255,255,.03);
      border-radius: 22px;
      padding: 12px 12px 10px;
      margin-top: 10px;
    }
    .meaningTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .numBig{
      font-size:26px;
      font-weight:900;
      letter-spacing:.3px;
      white-space:nowrap;
    }
    .patternPill{
      font-size:13px;
      color: rgba(235,245,255,.70);
      border: 1px solid var(--themeLineSoft);
      background: rgba(255,255,255,.03);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight:750;
      white-space:nowrap;
    }
    .meaningText{
      color: rgba(235,245,255,.74);
      font-size:15px;
      line-height:1.18;
      white-space: pre-wrap;
    }
    .disclaimer{
      margin-top:8px;
      color: rgba(235,245,255,.44);
      font-size:12px;
      line-height:1.25;
    }

    .panelButtons{
      display:flex;
      gap:12px;
      margin-top: 12px;
      flex-wrap:wrap;
    }

    /* ===== ADD/EDIT: make panel a flex layout with internal scroller + fixed footer buttons ===== */
    #add{
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap: 0;
      padding-bottom: 0;
    }
    #addScroll{
      flex: 1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 12px;
      touch-action: pan-y;
      overscroll-behavior: contain;
    }
    #addFooter{
      flex: 0 0 auto;
      padding-top: 12px;
      padding-bottom: calc(6px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(11,19,36,0), rgba(11,19,36,.70) 35%, rgba(11,19,36,.92));
      border-top: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
    }
    #addFooter .panelButtons{
      margin-top: 0;
    }

    /* ===== IDENTIFY: theme-matched quick meaning lookup ===== */
    #identify{
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap: 0;
      padding-bottom: 0;
    }
    #identifyScroll{
      flex: 1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      touch-action: pan-y;
      overscroll-behavior: contain;
    }
    .identifyTopRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom: 10px;
    }
    .identifyTopRow .btn.small{
      height:54px;
      border-radius: 18px;
      font-size:16px;
      padding: 0 16px;
    }
    .resultCard{
      border:1px solid var(--themeLine);
      background: rgba(255,255,255,.03);
      border-radius: 22px;
      padding: 12px 12px 10px;
      margin-top: 10px;
    }
    .resultHdr{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .resultNum{
      font-size:28px;
      font-weight:950;
      letter-spacing:.3px;
      white-space:nowrap;
    }
    .resultBody{
      color: rgba(235,245,255,.80);
      font-size:16px;
      line-height:1.30;
      white-space: pre-wrap;
    }
    .resultMeta{
      margin-top:10px;
      padding-top:10px;
      border-top: 1px solid rgba(255,255,255,.08);
      color: rgba(235,245,255,.68);
      font-size:14px;
      line-height:1.28;
      white-space: pre-wrap;
    }
    .metaLine{ margin-top:6px; }
    .metaLine b{ color: rgba(235,245,255,.78); }

    .editPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--themeLineSoft);
      background: rgba(255,255,255,.03);
      color: rgba(235,245,255,.70);
      font-weight:700;
      letter-spacing:.2px;
      margin: 0 4px 10px;
      width: fit-content;
    }

    /* Modal (unified) */
    .modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: max(16px, env(safe-area-inset-top)) 14px max(16px, env(safe-area-inset-bottom));
      background: rgba(0,0,0,.56);
      z-index: 9998;
      touch-action: none;
    }
    .modalCard{
      width:min(520px, 100%);
      border-radius: 26px;
      border: 3px solid var(--accentBorder);
      background: linear-gradient(180deg, rgba(12,21,40,.96), rgba(8,16,31,.96));
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 16px;
      backdrop-filter: blur(10px);
      max-height: calc(100vh - 60px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalTitle{
      font-weight: 900;
      letter-spacing: .2px;
      color: rgba(235,245,255,.92);
      font-size: clamp(22px, 6.5vw, 34px);
      line-height: 1.05;
      margin: 4px 2px 10px;
    }
    .modalSub{
      color: rgba(235,245,255,.72);
      font-size: 15px;
      margin: 0 2px 12px;
      white-space: pre-wrap;
      line-height: 1.28;
    }
    .modalBtns{
      display:flex;
      gap:12px;
      margin-top: 6px;
      flex-wrap:wrap;
    }
    .modalBtns .btn{
      flex:1;
      height: 54px;
      font-size: 18px;
      font-weight: 800;
      min-width: 140px;
    }

    /* Close X (top-right) */
    .xCloseRow{
      display:flex;
      justify-content:flex-end;
      margin: -6px -6px 6px;
    }
    .xBtn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color: rgba(235,245,255,.82);
      font-weight: 900;
      font-size: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* Card modal: logo to top + bigger body text + sticky buttons */
    #cardModal .modalCard{
      display:flex;
      flex-direction:column;
      max-height: calc(100vh - 56px);
      padding: 14px;
      overflow:hidden;
    }
    #cardModal .cardTopScroll{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;
      touch-action: pan-y;
      overscroll-behavior: contain;
    }
    #cardModal .modalTitle{
      margin: 6px 2px 8px;
      font-size: clamp(22px, 6.4vw, 34px);
    }
    #cardModal #cardBody{
      font-size: 16px;
      line-height: 1.34;
      margin: 0 2px 10px;
      color: rgba(235,245,255,.84);
    }
    #cardModal .modalBtns{
      flex: 0 0 auto;
      position: sticky;
      bottom: 0;
      z-index: 5;
      padding-top: 10px;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
      margin-top: 0;
      background: linear-gradient(180deg, rgba(11,19,36,0), rgba(11,19,36,.76) 35%, rgba(11,19,36,.94));
      border-top: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
    }
    #cardModal .modalBtns .btn{
      height: 50px;
      font-size: 17px;
      min-width: 110px;
    }

    /* Card modal logo row (small) */
    .cardLogoRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 2px 0 8px;
      user-select:none;
    }
    .cardLogoIcon{
      width:44px;
      height:44px;
      border-radius: 14px;
      border: 1px solid var(--themeLineSoft);
      background: rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
    }
    .cardLogoText{
      font-weight: 850;
      letter-spacing:.2px;
      color: rgba(235,245,255,.72);
      font-size: 16px;
      line-height: 1.1;
    }

    /* Calendar */
    .calTop{
      display:flex;
      gap:12px;
      align-items:center;
      margin-top: 10px;
    }
    .calTop .field{ height:52px; border-radius: 18px; }
    .calTop .btn.small{ height:52px; border-radius: 18px; }

    .calGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      width:100%;
    }
    .calDow{
      text-align:center;
      font-size: 12px;
      color: rgba(235,245,255,.54);
      font-weight: 800;
      letter-spacing:.2px;
      padding: 2px 0 4px;
      user-select:none;
    }

    .calCell{
      border:1px solid rgba(235,245,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      min-height: 56px;
      padding: 8px 8px 6px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:6px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .calCell .dnum{
      font-weight: 900;
      font-size: 14px;
      color: rgba(235,245,255,.76);
      line-height: 1;
    }
    .calCell.hasData{
      border-color: rgba(90,150,255,.45);
      background: rgba(43,78,122,.22);
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
    }
    .calCell.outMonth{
      opacity:.42;
    }

    .calHint{
      margin-top:10px;
      font-size: 13px;
      color: rgba(235,245,255,.44);
    }

    /* Day popup list */
    .dayHint{
      margin: 2px 2px 8px;
      color: rgba(235,245,255,.52);
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .1px;
    }
    .dayList{
      margin-top: 0;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .dayItem{
      border:1px solid var(--themeLine);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      padding: 8px 10px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .dayItem:active{ transform: translateY(1px); }
    .dayNum{
      font-size: 22px;
      font-weight: 950;
      letter-spacing:.3px;
      color: rgba(79,163,255,.92);
      white-space:nowrap;
      text-decoration: underline;
      text-underline-offset: 3px;
      text-decoration-thickness: 2px;
    }
    .dayMeta{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:1px;
      min-width: 0;
    }
    .dayTime{
      font-size:12px;
      color: rgba(235,245,255,.46);
      white-space:nowrap;
    }
    .dayPat{
      font-size:12px;
      color: rgba(235,245,255,.62);
      font-weight:800;
      white-space:nowrap;
    }

    .touchLock{
      position:fixed;
      inset:0;
      z-index: 9997;
      background: transparent;
      pointer-events:none;
    }
    .touchLock.on{ pointer-events:auto; }

    .ptr{
      position: sticky;
      top: 0;
      z-index: 5;
      margin: -10px 0 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      height: 28px;
      color: rgba(235,245,255,.55);
      font-size: 12px;
      font-weight: 750;
      letter-spacing: .2px;
      user-select:none;
      pointer-events:none;
      opacity: 0;
      transform: translateY(-6px);
      transition: opacity 160ms ease, transform 160ms ease;
    }
    .ptr.on{
      opacity: 1;
      transform: translateY(0);
    }

    .heartWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 2px;
    }
    .heartSvg{
      width: 140px;
      height: 140px;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.55));
      transform: scale(.86);
      opacity: .0;
      animation: popHeart 380ms cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes popHeart{
      0%{ transform: scale(.78); opacity: 0; }
      70%{ transform: scale(1.06); opacity: 1; }
      100%{ transform: scale(1.00); opacity: 1; }
    }

    .accentFrame{ position:relative; }
  </style>
</head>

<body>
  <div class="touchLock" id="touchLock"></div>

  <div class="app" id="appRoot">
    <div class="logoTitle" aria-label="Angel Numbers Tracker">
      <svg viewBox="0 0 900 140" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Angel Numbers Tracker">
        <defs>
          <linearGradient id="angG" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%" stop-color="#8a6bff"/>
            <stop offset="55%" stop-color="#4fa3ff"/>
            <stop offset="100%" stop-color="#2f78ff"/>
          </linearGradient>
          <filter id="angS" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="rgba(0,0,0,.35)"/>
          </filter>
        </defs>

        <g transform="translate(46 24)" filter="url(#angS)">
          <rect x="0" y="0" width="92" height="92" rx="26" fill="rgba(255,255,255,.06)" stroke="rgba(235,245,255,.22)" stroke-width="2"/>
          <ellipse cx="46" cy="24" rx="20" ry="8" fill="none" stroke="rgba(235,245,255,.88)" stroke-width="4" opacity=".92"/>

          <path d="M46 50
                   C34 42, 22 44, 16 54
                   C24 58, 32 66, 38 76
                   C40 66, 43 58, 46 50Z"
                fill="none" stroke="url(#angG)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>

          <path d="M46 50
                   C58 42, 70 44, 76 54
                   C68 58, 60 66, 54 76
                   C52 66, 49 58, 46 50Z"
                fill="none" stroke="url(#angG)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>

          <path d="M46 34 L46 42" stroke="rgba(235,245,255,.82)" stroke-width="4" stroke-linecap="round"/>
          <path d="42 38 L50 38" stroke="rgba(235,245,255,.82)" stroke-width="4" stroke-linecap="round"/>
        </g>

        <text x="160" y="92"
              font-family="system-ui,Segoe UI,Roboto,Helvetica,Arial"
              font-size="66"
              font-weight="860"
              fill="url(#angG)"
              letter-spacing=".6"
              filter="url(#angS)">Angel Numbers Tracker</text>
      </svg>
    </div>

    <div class="screenArea" id="screenArea">

      <div id="home" class="card accentFrame">
        <div id="ptrHome" class="ptr">Pull down to refresh</div>

        <div class="homeMain">
          <button id="btnGoAdd" class="btn primary">ADD Angel Number</button>
          <button id="btnGoIdentify" class="btn">Identify</button>
          <button id="btnGoCalendar" class="btn">Calendar</button>

          <div class="homeFooterRow">
            <button id="btnInstall" class="btn small">Install</button>
            <button id="btnClearAll" class="btn small">Clear Data</button>
            <div class="grow"></div>
            <button id="btnExitHome" class="btn small danger">Exit</button>
          </div>

          <div class="subtle">Inspired by a real Angel.</div>
          <div class="subtle">Local-only. No accounts. No cloud.</div>

          <div class="footerTiny">
            <div id="homeVerLabel" aria-label="Version label">v1.333</div>
            <div>developed by Keyth Jyles</div>
          </div>
        </div>
      </div>

      <!-- ADD/EDIT -->
      <div id="add" class="card accentFrame hidden">
        <div id="addScroll">
          <div id="editPill" class="editPill hidden">Editing entry</div>

          <div id="timeLine" class="timeLine">--:--:-- --, --/--/----</div>

          <!-- Date/Time edit controls: shown ONLY when editing -->
          <div id="dtEditWrap" class="hidden">
            <div class="label">Date/Time</div>
            <input id="dtEdit" class="field" type="datetime-local" />
          </div>

          <div class="label">Number</div>
          <input id="anum" class="field" inputmode="numeric" placeholder="e.g., 111, 1212, 777" />

          <div id="meaningCard" class="meaningCard">
            <div class="meaningTop">
              <div id="numBig" class="numBig">—</div>
              <div id="patternPill" class="patternPill">Pattern: —</div>
            </div>
            <div id="meaningText" class="meaningText">Enter a number to see its commonly shared meaning.</div>
            <div class="disclaimer">
              Cultural note: these meanings come from numerology/“angel number” traditions and vary by source.
              Treat as reflective prompts, not facts or predictions.
            </div>
          </div>

          <div class="label">Notes <span style="color:var(--muted2); font-weight:650;">(optional)</span></div>
          <textarea id="notes" class="field" placeholder="Where did you see it? What were you thinking/feeling?"></textarea>
        </div>

        <div id="addFooter">
          <div class="panelButtons">
            <button id="btnSave" class="btn primary grow">Save</button>
            <button id="btnDelete" class="btn grow hidden">Delete</button>
            <button id="btnBackFromAdd" class="btn grow">Back</button>
          </div>
        </div>
      </div>

      <!-- IDENTIFY -->
      <div id="identify" class="card accentFrame hidden">
        <div id="identifyScroll">
          <div class="row center">
            <button id="btnIdentifyClear" class="btn small">Clear</button>
            <div class="grow"></div>
            <button id="btnBackFromIdentify" class="btn small">Back</button>
          </div>

          <div class="label">Identify Angel Number Meaning</div>

          <div class="identifyTopRow">
            <input id="idNum" class="field" inputmode="numeric" placeholder="Enter a number (e.g., 1111, 1212, 1234)" />
            <button id="btnIdentify" class="btn small">Identify</button>
          </div>

          <div id="idResultCard" class="resultCard">
            <div class="resultHdr">
              <div id="idResultNum" class="resultNum">—</div>
              <div id="idPatternPill" class="patternPill">Pattern: —</div>
            </div>

            <div id="idMeaning" class="resultBody">
              Enter a number above, then tap Identify (or just type) to see its commonly shared meaning.
            </div>

            <div id="idMeta" class="resultMeta">
              <div class="metaLine"><b>How to use:</b> Treat the meaning as a reflective prompt—what it “means” depends on context and personal interpretation.</div>
            </div>

            <div class="disclaimer" style="margin-top:10px;">
              Cultural note: these meanings come from numerology/“angel number” traditions and vary by source.
              Treat as reflective prompts, not facts or predictions.
            </div>
          </div>
        </div>
      </div>

      <!-- CALENDAR -->
      <div id="calendar" class="card accentFrame hidden">
        <div class="row center">
          <button id="btnExportMonth" class="btn small">Export</button>
          <div class="grow"></div>
          <button id="btnBackFromCalendar" class="btn small">Back</button>
        </div>

        <div class="calTop">
          <input id="calMonth" class="field" type="month" />
          <button id="btnCalToday" class="btn small">Today</button>
        </div>

        <div class="calGrid" id="calDowRow"></div>
        <div class="calGrid" id="calGrid"></div>
        <div class="calHint">Tap a highlighted day to view entries.</div>
      </div>

    </div>
  </div>

  <!-- Confirm modal -->
  <div id="confirmModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modalCard">
      <div class="modalTitle" id="confirmTitle">Confirm</div>
      <div class="modalSub" id="confirmSub">—</div>
      <div class="modalBtns">
        <button id="btnConfirmCancel" class="btn">Cancel</button>
        <button id="btnConfirmOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Export modal -->
  <div id="exportModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle">
    <div class="modalCard">
      <div class="modalTitle" id="exportModalTitle">Export ready</div>
      <div class="modalSub" id="exportModalSub">
Export report was copied to your clipboard.  You can paste it into any messaging app, email, Notes, or any app that accepts text.  Optional:

Share sends the report to another app.

Save creates a .txt file on your device.
      </div>
      <div class="modalBtns" style="flex-wrap:nowrap;">
        <button id="btnExportClose" class="btn" style="min-width:0; flex:1 1 0; font-size:16px; height:52px;">Close</button>
        <button id="btnExportShare" class="btn" style="min-width:0; flex:1 1 0; font-size:16px; height:52px;">Share</button>
        <button id="btnExportSave" class="btn primary" style="min-width:0; flex:1 1 0; font-size:16px; height:52px;">Save .txt</button>
      </div>
    </div>
  </div>

  <!-- Angel Number Card modal -->
  <div id="cardModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="cardTitle">
    <div class="modalCard">
      <div class="xCloseRow">
        <button class="xBtn" id="btnCardX" aria-label="Close">×</button>
      </div>

      <div class="cardTopScroll">
        <!-- Logo row at top -->
        <div class="cardLogoRow">
          <div class="cardLogoIcon" aria-hidden="true">
            <svg width="28" height="28" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="cg" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="#8a6bff"/>
                  <stop offset="55%" stop-color="#4fa3ff"/>
                  <stop offset="100%" stop-color="#2f78ff"/>
                </linearGradient>
              </defs>
              <ellipse cx="32" cy="16" rx="14" ry="6" fill="none" stroke="rgba(235,245,255,.88)" stroke-width="4"/>
              <path d="M32 30 C24 26, 16 27, 12 34 C18 36, 22 41, 26 49 C27 42, 29 36, 32 30Z"
                    fill="none" stroke="url(#cg)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M32 30 C40 26, 48 27, 52 34 C46 36, 42 41, 38 49 C37 42, 35 36, 32 30Z"
                    fill="none" stroke="url(#cg)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="cardLogoText">Angel Numbers Tracker</div>
        </div>

        <div class="modalTitle" id="cardTitle">Angel Number Card</div>
        <div class="modalSub" id="cardBody">—</div>
      </div>

      <div class="modalBtns">
        <button id="btnCardCopy" class="btn">Copy</button>
        <button id="btnCardExport" class="btn">Export</button>
        <button id="btnCardEdit" class="btn primary">Edit</button>
      </div>
    </div>
  </div>

  <!-- Day modal (NO X BUTTON; Close button only) -->
  <div id="dayModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="dayTitle">
    <div class="modalCard">
      <div class="modalTitle" id="dayTitle">—</div>
      <div class="modalSub" id="dayBody">—</div>
      <div class="modalBtns">
        <button id="btnDayExport" class="btn primary">Export</button>
        <button id="btnDayClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Version modal -->
  <div id="versionModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="verTitle">
    <div class="modalCard">
      <div class="xCloseRow">
        <button class="xBtn" id="btnVerX" aria-label="Close">×</button>
      </div>
      <div class="modalTitle" id="verTitle">Version</div>
      <div class="modalSub" id="verBody">—</div>
      <div class="modalBtns">
        <button id="btnVerClose" class="btn primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Heart modal -->
  <div id="heartModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="heartTitle">
    <div class="modalCard">
      <div class="xCloseRow">
        <button class="xBtn" id="btnHeartX" aria-label="Close">×</button>
      </div>
      <div class="modalTitle" id="heartTitle">A message</div>
      <div class="heartWrap" aria-hidden="true">
        <svg class="heartSvg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="hg" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#ff6aa6"/>
              <stop offset="55%" stop-color="#b56bff"/>
              <stop offset="100%" stop-color="#4fa3ff"/>
            </linearGradient>
          </defs>
          <path d="M60 104
                   C60 104, 18 78, 18 46
                   C18 30, 30 20, 44 20
                   C52 20, 57 24, 60 28
                   C63 24, 68 20, 76 20
                   C90 20, 102 30, 102 46
                   C102 78, 60 104, 60 104Z"
                fill="url(#hg)" stroke="rgba(235,245,255,.85)" stroke-width="3" />
        </svg>
      </div>
      <div class="modalSub" id="heartBody" style="font-size:16px; color: rgba(235,245,255,.82);">
        The Angels love you Timmy!
      </div>
      <div class="modalBtns">
        <button id="btnHeartClose" class="btn primary">Close</button>
      </div>
    </div>
  </div>

  <script>
(() => {
  "use strict";

  const APP_VERSION = "v1.0B13";
  const HOME_VERSION_LABEL = "v1.333";
  const STORAGE_KEY = "angel_numbers_records_v1";
  const DAY_MS = 24*60*60*1000;

  const TEST_DATA_ENABLED = true;

  const $ = (id) => document.getElementById(id);

  /* ===== Meanings ===== */

  const DIGIT_MEANING = {
    "0": "0 is often linked with wholeness, source, and fresh cycles—an invitation to reset and widen perspective.",
    "1": "1 is often linked with new beginnings, initiative, focus, and the power of attention.",
    "2": "2 is often linked with balance, partnership, patience, and alignment through cooperation.",
    "3": "3 is often linked with creativity, expression, growth, and encouragement to communicate.",
    "4": "4 is often linked with stability, foundations, discipline, and building what lasts.",
    "5": "5 is often linked with change, adaptability, movement, and a call to embrace transition.",
    "6": "6 is often linked with care, responsibility, home, and recalibrating priorities toward wellbeing.",
    "7": "7 is often linked with insight, inner wisdom, spiritual inquiry, and learning through reflection.",
    "8": "8 is often linked with strength, momentum, material mastery, and confident stewardship of resources.",
    "9": "9 is often linked with closure, compassion, integration, and completing a cycle with grace."
  };

  const ANGEL_MAP = {
    "000": "Reset and re-center. A ‘clean slate’ moment—expand perspective and begin again.",
    "111": "Focus and intention. A reminder to notice your thoughts and aim them deliberately.",
    "222": "Balance and alignment. Patience—let partnerships and decisions settle into place.",
    "333": "Creativity and support. Express yourself; keep building and communicating clearly.",
    "444": "Foundations and stability. Stay disciplined; the work you’re doing is structural.",
    "555": "Change and movement. A shift is underway—adapt, release the old, step forward.",
    "666": "Recalibration. Check priorities; return to what’s healthy and truly important.",
    "777": "Insight and learning. Trust your inner guidance; deepen study and reflection.",
    "888": "Momentum and abundance. Good stewardship; practical progress and strong energy.",
    "999": "Completion. Close a chapter; integrate lessons; make room for what’s next.",
    "1010": "Fresh cycle + alignment. A restart with a clear direction—stay awake and intentional.",
    "1111": "Gateway / heightened awareness. Focus your intent; clarify what you’re building.",
    "1212": "Realignment and growth. Keep moving—small consistent steps bring a new level.",
    "1234": "Step-by-step progress. Keep it simple; the path is sequential and workable.",
    "1414": "Grounded change. Build stability while adjusting—practical updates, not chaos.",
    "1515": "Change with intention. Choose the transition you want; don’t drift into it.",
    "2020": "Balance and reflection. Look at both sides; correct course gently.",
    "2222": "Deep alignment. Commit to balance; trust the process over the impulse.",
    "2424": "Reinforced signal (repeated block 24): a theme repeating until you notice it."
  };

  /* ===== Storage ===== */

  function loadRecords(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return [];
      return arr
        .filter(r => r && typeof r.ts === "number")
        .map(r => ({
          ts: r.ts,
          number: (r.number ?? "").toString(),
          pattern: (r.pattern ?? "").toString(),
          meaning: (r.meaning ?? "").toString(),
          notes: (r.notes ?? "").toString()
        }))
        .sort((a,b)=> b.ts - a.ts);
    }catch{
      return [];
    }
  }

  function saveRecords(recs){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(recs));
  }

  /* ===== Utilities ===== */

  function fmtDateTime(ts){
    const d = new Date(ts);
    const parts = new Intl.DateTimeFormat(undefined, {
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).formatToParts(d);
    const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
    const mm = map.month, dd = map.day, yy = map.year;
    const hh = map.hour, mi = map.minute, ss = map.second;
    const dp = map.dayPeriod ? ` ${map.dayPeriod}` : "";
    return `${mm}/${dd}/${yy}, ${hh}:${mi}:${ss}${dp}`;
  }

  function fmtTimeOnly(ts){
    return new Intl.DateTimeFormat(undefined, { hour:"2-digit", minute:"2-digit" }).format(new Date(ts));
  }

  function fmtTimeCommaDate(ts){
    const d = new Date(ts);
    const time = new Intl.DateTimeFormat(undefined, {
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).format(d);
    const date = new Intl.DateTimeFormat(undefined, {
      month:"2-digit", day:"2-digit", year:"numeric"
    }).format(d);
    return `${time}, ${date}`;
  }

  function startOfDay(ts){
    const d = new Date(ts);
    d.setHours(0,0,0,0);
    return d.getTime();
  }

  function clampEndOfDay(ts){
    const d = new Date(ts);
    d.setHours(23,59,59,999);
    return d.getTime();
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toLocalDatetimeValue(ts){
    const d = new Date(ts);
    const pad = (n)=> String(n).padStart(2,"0");
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth()+1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  function fromLocalDatetimeValue(v){
    if(!v) return null;
    const d = new Date(v);
    const ts = d.getTime();
    return Number.isFinite(ts) ? ts : null;
  }

  function normalizeNumberInput(raw){
    const s = String(raw ?? "").trim();
    return s.replace(/[^\d]/g, "");
  }

  /* ===== Pattern + meaning ===== */

  function isAllSame(s){ return !!(s && s.length >= 2 && s.split("").every(ch => ch === s[0])); }
  function isPalindrome(s){ if(!s || s.length < 3) return false; return s === s.split("").reverse().join(""); }
  function isRepeatedHalf(s){ if(!s || s.length < 4 || s.length % 2) return false; const h=s.slice(0,s.length/2); return h+h===s; }
  function isAscendingSeq(s){
    if(!s || s.length < 3) return false;
    for(let i=1;i<s.length;i++){
      const a=s.charCodeAt(i-1)-48, b=s.charCodeAt(i)-48;
      if(b !== a+1) return false;
    }
    return true;
  }
  function isDescendingSeq(s){
    if(!s || s.length < 3) return false;
    for(let i=1;i<s.length;i++){
      const a=s.charCodeAt(i-1)-48, b=s.charCodeAt(i)-48;
      if(b !== a-1) return false;
    }
    return true;
  }

  function detectPattern(s){
    if(!s) return "—";
    if(isAllSame(s)) return `Repeating ${s[0]}s`;
    if(isAscendingSeq(s)) return "Sequential (up)";
    if(isDescendingSeq(s)) return "Sequential (down)";
    if(isRepeatedHalf(s)) return "Double pattern";
    if(isPalindrome(s)) return "Mirror (palindrome)";
    if(s.length === 3 && s[0] === s[2] && s[0] !== s[1]) return "Sandwich pattern";
    return "Mixed pattern";
  }

  function digitSummary(s){
    if(!s) return "";
    if(isAllSame(s)) return DIGIT_MEANING[s[0]] || "";
    const counts = {};
    for(const ch of s){ counts[ch] = (counts[ch]||0) + 1; }
    let best=null, bestN=0;
    for(const [k,v] of Object.entries(counts)){ if(v>bestN){ bestN=v; best=k; } }
    if(best && bestN >= Math.max(2, Math.ceil(s.length * 0.6))){
      return DIGIT_MEANING[best] || "";
    }
    const sum = s.split("").reduce((a,ch)=>a+(ch.charCodeAt(0)-48),0);
    const root = ((sum - 1) % 9) + 1;
    const rootLine = DIGIT_MEANING[String(root)] || "";
    return rootLine ? `Digit-sum lens (${sum} → ${root}): ${rootLine}` : "";
  }

  function deriveMeaning(s, pattern){
    if(!s) return {pattern:"—", meaning:"Enter a number to see its commonly shared meaning."};

    if(ANGEL_MAP[s]) return {pattern, meaning: ANGEL_MAP[s]};

    if(isAllSame(s) && s.length >= 2){
      const d=s[0];
      const base = DIGIT_MEANING[d] || "A repeating pattern—often treated as a heightened emphasis.";
      return {pattern, meaning: `Emphasis pattern (${s}): ${base}`};
    }

    if(pattern === "Sequential (up)") return {pattern, meaning:"Step-by-step progress. Keep it simple, keep moving, and let momentum build."};
    if(pattern === "Sequential (down)") return {pattern, meaning:"Release and simplify. Let go of what’s extra and return to essentials."};

    if(pattern === "Double pattern"){
      const half = s.slice(0, s.length/2);
      const lens = digitSummary(half);
      return {pattern, meaning: `Reinforced signal (repeated block ${half}): a theme repeating until you notice it.\n${lens}`.trim()};
    }

    if(pattern === "Mirror (palindrome)"){
      const lens = digitSummary(s);
      return {pattern, meaning: `Reflection and alignment. Consider what’s being mirrored back—choices, habits, or timing.\n${lens}`.trim()};
    }

    const lens = digitSummary(s);
    const fallback = "A general interpretation is heightened awareness: notice your thoughts, environment, and choices—then act deliberately.";
    return {pattern, meaning: lens ? `${fallback}\n${lens}` : fallback};
  }

  function buildIdentifyMeta(n, pattern){
    if(!n) return "—";
    const lens = digitSummary(n);
    const mapped = ANGEL_MAP[n] ? "Direct map: recognized as a common “named” angel number." : "Direct map: not in the preset list; derived from pattern + digit lenses.";
    const digits = n.split("").join(" • ");
    const uniqueDigits = [...new Set(n.split(""))].sort().join(", ");

    const lines = [];
    lines.push(`Digits: ${digits}`);
    if(uniqueDigits) lines.push(`Unique digits: ${uniqueDigits}`);
    lines.push(mapped);
    if(lens) lines.push(lens);
    lines.push(`Pattern method: repeating / sequential / double-block / mirror / sandwich / mixed.`);
    return lines.join("\n");
  }

  /* ===== Touch lock ===== */

  let lockTimer = null;
  function lockTouches(ms=200){
    const el = $("touchLock");
    el.classList.add("on");
    if(lockTimer) clearTimeout(lockTimer);
    lockTimer = setTimeout(()=> el.classList.remove("on"), ms);
  }
  function unlockTouches(){
    const el = $("touchLock");
    el.classList.remove("on");
    if(lockTimer) clearTimeout(lockTimer);
    lockTimer = null;
  }

  /* ===== Screens ===== */

  const swipeCycle = ["home","identify","calendar"];
  let currentScreen = "home";
  let returnScreen = "home";
  let animating = false;

  function focusTopOfPanel(screen){
    try{ window.scrollTo({top:0,left:0,behavior:"auto"}); }catch{}
    if(screen === "add"){
      try{ $("addScroll").scrollTop = 0; }catch{}
      if(editTs == null){
        setTimeout(() => { try{ $("anum").focus({preventScroll:true}); }catch{} }, 0);
      }else{
        setTimeout(() => { try{ document.activeElement?.blur(); }catch{} }, 0);
      }
    }else if(screen === "identify"){
      try{ $("identifyScroll").scrollTop = 0; }catch{}
      setTimeout(() => { try{ document.activeElement?.blur(); }catch{} }, 0);
    }else{
      try{ document.activeElement?.blur(); }catch{}
    }
  }

  function showInstant(screen){
    unlockTouches();
    for(const s of ["home","add","identify","calendar"]){
      $(s).classList.toggle("hidden", s !== screen);
      $(s).style.transform = "";
      $(s).style.transition = "";
    }
    currentScreen = screen;

    if(screen === "calendar") { initMonthDefaultIfNeeded(); renderCalendar(); }
    if(screen === "add") { tickTime(); adjustTimeFont(); updateMeaningUI(); }
    if(screen === "identify") { updateIdentifyUI(true); }

    focusTopOfPanel(screen);
  }

  /* ===== Swipe “wheel” ===== */

  const drag = {
    active:false,
    x0:0, y0:0,
    dx:0, dy:0,
    intent:null,
    from:null, to:null,
    width:0,
    dir:null
  };

  function nextInCycleRight(from){
    const i = swipeCycle.indexOf(from);
    if(i < 0) return null;
    return swipeCycle[(i+1) % swipeCycle.length];
  }
  function nextInCycleLeft(from){
    const i = swipeCycle.indexOf(from);
    if(i < 0) return null;
    return swipeCycle[(i-1+swipeCycle.length) % swipeCycle.length];
  }

  function setTransform(el, x){
    el.style.transform = `translateX(${x}px)`;
  }

  function startDrag(ev){
    if(animating) return;
    if(!(ev.touches && ev.touches.length === 1)) return;
    if(!swipeCycle.includes(currentScreen)) return;

    const t = ev.target;
    if(t && t.closest && t.closest("input, textarea, select")) return;

    drag.active = true;
    drag.intent = null;
    drag.dir = null;
    drag.x0 = ev.touches[0].clientX;
    drag.y0 = ev.touches[0].clientY;
    drag.dx = 0;
    drag.dy = 0;
    drag.from = currentScreen;
    drag.to = null;
    drag.width = $("screenArea").clientWidth || window.innerWidth;
  }

  function prepareTarget(dir){
    if(drag.dir === dir && drag.to) return;
    drag.dir = dir;

    const target = (dir === "right") ? nextInCycleRight(drag.from) : nextInCycleLeft(drag.from);
    if(!target) return;

    drag.to = target;

    const fromEl = $(drag.from);
    const toEl = $(drag.to);

    toEl.classList.remove("hidden");
    fromEl.style.transition = "none";
    toEl.style.transition = "none";

    const startX = (dir === "right") ? -drag.width : drag.width;
    setTransform(fromEl, 0);
    setTransform(toEl, startX);
  }

  function moveDrag(ev){
    if(!drag.active) return;
    if(!(ev.touches && ev.touches.length === 1)) return;

    const x = ev.touches[0].clientX;
    const y = ev.touches[0].clientY;
    drag.dx = x - drag.x0;
    drag.dy = y - drag.y0;

    if(!drag.intent){
      const ax = Math.abs(drag.dx);
      const ay = Math.abs(drag.dy);

      if(ax > 18 && ax > ay + 12){
        drag.intent = "h";
      }else if(ay > 18 && ay > ax + 8){
        drag.intent = "v";
        drag.active = false;
        return;
      }else{
        return;
      }
    }

    if(drag.intent !== "h") return;

    ev.preventDefault();

    const dir = (drag.dx >= 0) ? "right" : "left";
    prepareTarget(dir);
    if(!drag.to) return;

    const fromEl = $(drag.from);
    const toEl = $(drag.to);

    const w = drag.width || 1;
    const clamped = Math.max(-w, Math.min(w, drag.dx));

    setTransform(fromEl, clamped);
    const base = (dir === "right") ? -w : w;
    setTransform(toEl, base + clamped);
  }

  function endDrag(){
    if(!drag.active && drag.intent !== "h") return;

    const hadHorizontal = (drag.intent === "h" && drag.to);
    const from = drag.from;
    const to = drag.to;
    const w = drag.width || 1;
    const dx = drag.dx;

    drag.active = false;
    drag.intent = null;
    drag.dir = null;

    if(!hadHorizontal) return;

    animating = true;

    const progress = Math.min(1, Math.abs(dx) / w);
    const commit = progress >= 0.22;

    const dir = (dx >= 0) ? "right" : "left";
    const fromEl = $(from);
    const toEl = $(to);

    fromEl.style.transition = "transform 220ms cubic-bezier(.2,.9,.2,1)";
    toEl.style.transition   = "transform 220ms cubic-bezier(.2,.9,.2,1)";

    if(commit){
      setTransform(fromEl, (dir === "right") ? w : -w);
      setTransform(toEl, 0);

      setTimeout(() => {
        fromEl.classList.add("hidden");
        fromEl.style.transition = "";
        toEl.style.transition = "";
        fromEl.style.transform = "";
        toEl.style.transform = "";

        currentScreen = to;

        if(currentScreen === "calendar") { initMonthDefaultIfNeeded(); renderCalendar(); }
        if(currentScreen === "identify") { updateIdentifyUI(true); }

        focusTopOfPanel(currentScreen);
        animating = false;
        lockTouches(140);
      }, 235);
    }else{
      setTransform(fromEl, 0);
      setTransform(toEl, (dir === "right") ? -w : w);

      setTimeout(() => {
        toEl.classList.add("hidden");
        fromEl.style.transition = "";
        toEl.style.transition = "";
        fromEl.style.transform = "";
        toEl.style.transform = "";

        animating = false;
        lockTouches(90);
      }, 235);
    }
  }

  function attachSwipes(){
    const root = $("screenArea");
    root.addEventListener("touchstart", startDrag, {passive:true});
    root.addEventListener("touchmove", moveDrag, {passive:false});
    root.addEventListener("touchend", endDrag, {passive:true});
    root.addEventListener("touchcancel", endDrag, {passive:true});
  }

  /* ===== Add/Edit ===== */

  let timeTimer = null;
  let editTs = null;
  let editOriginalTs = null;

  function showDateTimeEditor(show){
    $("dtEditWrap").classList.toggle("hidden", !show);
  }

  function clearAddForm(){
    $("anum").value = "";
    $("notes").value = "";
    updateMeaningUI();
    try{ $("addScroll").scrollTop = 0; }catch{}
  }

  function enterAddNew(from="home"){
    editTs = null;
    editOriginalTs = null;
    returnScreen = from;

    $("editPill").classList.add("hidden");
    $("btnDelete").classList.add("hidden");

    showDateTimeEditor(false);

    clearAddForm();
    showInstant("add");
  }

  function enterAddEdit(ts){
    const recs = loadRecords();
    const r = recs.find(x => x.ts === ts);
    if(!r){ enterAddNew("calendar"); return; }

    editTs = ts;
    editOriginalTs = ts;
    returnScreen = "calendar";

    $("editPill").classList.remove("hidden");
    $("btnDelete").classList.remove("hidden");

    showDateTimeEditor(true);
    $("dtEdit").value = toLocalDatetimeValue(r.ts);

    $("anum").value = r.number || "";
    $("notes").value = (r.notes || "").toString();

    updateMeaningUI(r.pattern || "", r.meaning || "");
    showInstant("add");
  }

  function tickTime(){
    const line = $("timeLine");
    const ts = (editTs != null) ? editTs : Date.now();
    line.textContent = fmtTimeCommaDate(ts);
    adjustTimeFont();
    if(timeTimer) clearTimeout(timeTimer);
    timeTimer = setTimeout(tickTime, 900);
  }

  function adjustTimeFont(){
    const el = $("timeLine");
    const parent = el?.parentElement;
    if(!el || !parent) return;

    el.style.fontSize = "";
    const maxW = parent.clientWidth - 8;

    let fs = parseFloat(getComputedStyle(el).fontSize) || 28;
    let guard = 0;
    while(el.scrollWidth > maxW && fs > 16 && guard < 30){
      fs -= 1;
      el.style.fontSize = fs + "px";
      guard++;
    }
  }

  function updateMeaningUI(forcedPattern="", forcedMeaning=""){
    const raw = $("anum").value;
    const n = normalizeNumberInput(raw);

    const pattern = forcedPattern || detectPattern(n);
    const out = forcedMeaning ? {pattern, meaning: forcedMeaning} : deriveMeaning(n, pattern);

    $("numBig").textContent = n ? n : "—";
    $("patternPill").textContent = `Pattern: ${out.pattern || pattern || "—"}`;
    $("meaningText").textContent = out.meaning || "—";
  }

  $("anum").addEventListener("input", () => updateMeaningUI());

  function validateAnyInput(number, notes){
    return !!(String(number||"").trim() || String(notes||"").trim());
  }

  /* ===== Identify panel ===== */

  function updateIdentifyUI(forceNoScroll=false){
    const raw = $("idNum").value;
    const n = normalizeNumberInput(raw);

    if(!n){
      $("idResultNum").textContent = "—";
      $("idPatternPill").textContent = "Pattern: —";
      $("idMeaning").textContent =
        "Enter a number above, then tap Identify (or just type) to see its commonly shared meaning.";
      $("idMeta").textContent = "";
      const meta = document.createElement("div");
      meta.className = "metaLine";
      meta.innerHTML = "<b>How to use:</b> Treat the meaning as a reflective prompt—what it “means” depends on context and personal interpretation.";
      $("idMeta").appendChild(meta);
      if(forceNoScroll){
        try{ $("identifyScroll").scrollTop = 0; }catch{}
      }
      return;
    }

    const pattern = detectPattern(n);
    const out = deriveMeaning(n, pattern);

    $("idResultNum").textContent = n;
    $("idPatternPill").textContent = `Pattern: ${out.pattern || pattern || "—"}`;
    $("idMeaning").textContent = out.meaning || "—";

    const metaText = buildIdentifyMeta(n, out.pattern || pattern || "—");
    $("idMeta").textContent = metaText;

    if(forceNoScroll){
      // keep the input visible; do not jump the user down.
      // no scroll change needed.
    }
  }

  $("idNum").addEventListener("input", () => updateIdentifyUI(false));
  $("btnIdentify").addEventListener("click", (e)=>{ e.preventDefault(); updateIdentifyUI(false); try{ $("idNum").blur(); }catch{} });
  $("idNum").addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      updateIdentifyUI(false);
      try{ e.target.blur(); }catch{}
    }
  });

  $("btnIdentifyClear").addEventListener("click", (e)=>{
    e.preventDefault();
    $("idNum").value = "";
    updateIdentifyUI(true);
    try{ $("idNum").focus({preventScroll:true}); }catch{}
  });

  /* ===== Confirm modal ===== */

  let confirmState = null;

  function openConfirm({title, message, okText="OK", cancelText="Cancel", danger=false, onOk}){
    confirmState = { onOk };
    $("confirmTitle").textContent = title || "Confirm";
    $("confirmSub").textContent = message || "—";

    $("btnConfirmOk").textContent = okText;
    $("btnConfirmCancel").textContent = cancelText;

    if(danger){
      $("btnConfirmOk").classList.remove("primary");
      $("btnConfirmOk").classList.add("danger");
    }else{
      $("btnConfirmOk").classList.remove("danger");
      $("btnConfirmOk").classList.add("primary");
    }

    $("confirmModal").classList.remove("hidden");
    lockTouches(120);
  }

  function closeConfirm(){
    confirmState = null;
    $("confirmModal").classList.add("hidden");
    unlockTouches();
  }

  $("btnConfirmCancel").addEventListener("click", (e)=>{ e.preventDefault(); closeConfirm(); });
  $("btnConfirmOk").addEventListener("click", (e)=>{
    e.preventDefault();
    const fn = confirmState?.onOk;
    closeConfirm();
    try{ fn && fn(); }catch{}
  });

  $("confirmModal").addEventListener("click", (e) => {
    if(e.target === $("confirmModal")) closeConfirm();
  });

  document.addEventListener("keydown", (e)=>{
    if(!$("confirmModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeConfirm(); }
    }
  });

  /* ===== Card modal ===== */

  let cardTs = null;
  let cardReturn = { type: "screen", screen: "calendar" };

  function buildCardHtml(rec){
    const dt = fmtDateTime(rec.ts);
    const num = rec.number || "—";
    const pat = rec.pattern || "—";
    const meaning = rec.meaning?.trim() ? rec.meaning.trim() : "None";
    const notes = rec.notes?.trim() ? rec.notes.trim() : "None";

    return `
      <div style="margin-top:6px;">Date/Time: ${escapeHtml(dt)}</div>
      <div style="margin-top:10px; font-size:18px; font-weight:900;">Number: ${escapeHtml(num)}</div>
      <div style="margin-top:10px;">Notes: ${escapeHtml(notes)}</div>
      <div style="margin-top:10px;">Pattern: ${escapeHtml(pat)}</div>
      <div style="margin-top:10px;">Meaning: ${escapeHtml(meaning)}</div>
    `;
  }

  function buildCardText(rec){
    const dt = fmtDateTime(rec.ts);
    const num = rec.number || "—";
    const pat = rec.pattern || "—";
    const meaning = rec.meaning?.trim() ? rec.meaning.trim() : "None";
    const notes = rec.notes?.trim() ? rec.notes.trim() : "None";

    const lines = [
      "Angel Number Card",
      `Date/Time: ${dt}`,
      `Number: ${num}`,
      `Notes: ${notes}`,
      `Pattern: ${pat}`,
      `Meaning: ${meaning}`
    ];
    return lines.join("\n");
  }

  function openCard(ts, origin){
    const recs = loadRecords();
    const r = recs.find(x => x.ts === ts);
    if(!r) return;

    cardTs = ts;
    cardReturn = origin || { type:"screen", screen: currentScreen };

    $("cardBody").innerHTML = buildCardHtml(r);
    $("cardModal").classList.remove("hidden");
    lockTouches(120);
  }

  function closeCard(){
    $("cardModal").classList.add("hidden");
    $("cardBody").textContent = "—";
    const ret = cardReturn;
    cardTs = null;

    unlockTouches();

    if(ret && ret.type === "day" && Number.isFinite(ret.dayStartTs)){
      openDayModal(ret.dayStartTs);
    }
  }

  $("btnCardX").addEventListener("click", (e)=>{ e.preventDefault(); closeCard(); });

  $("btnCardCopy").addEventListener("click", async (e)=>{
    e.preventDefault();
    if(cardTs == null) return;
    const recs = loadRecords();
    const r = recs.find(x => x.ts === cardTs);
    if(!r) return;
    const text = buildCardText(r);
    try{ await copyToClipboard(text); alert("Copied."); }catch{ alert("Copy failed."); }
  });

  $("btnCardExport").addEventListener("click", (e)=>{
    e.preventDefault();
    if(cardTs == null) return;
    const recs = loadRecords();
    const r = recs.find(x => x.ts === cardTs);
    if(!r) return;

    exportReport(
      [r],
      {
        title: "Angel Number Card Export",
        rangeLabel: fmtDateTime(r.ts),
        notes: "This export contains a single Angel Number Card (full record)."
      },
      "angel_number_card"
    );
  });

  $("btnCardEdit").addEventListener("click", (e)=>{
    e.preventDefault();
    if(cardTs == null) return;
    const ts = cardTs;
    $("cardModal").classList.add("hidden");
    $("cardBody").textContent = "—";
    cardTs = null;
    unlockTouches();
    enterAddEdit(ts);
  });

  $("cardModal").addEventListener("click", (e)=>{
    if(e.target === $("cardModal")) closeCard();
  });

  document.addEventListener("keydown", (e)=>{
    if(!$("cardModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeCard(); }
    }
  });

  /* ===== Day modal ===== */

  let dayModalDate = null;

  function openDayModal(dayStartTs){
    const dayEnd = clampEndOfDay(dayStartTs);
    const all = loadRecords().slice().sort((a,b)=> a.ts - b.ts);
    const recs = all.filter(r => r.ts >= dayStartTs && r.ts <= dayEnd);
    if(recs.length === 0) return;

    dayModalDate = dayStartTs;

    const d = new Date(dayStartTs);
    const title = new Intl.DateTimeFormat(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" }).format(d);
    $("dayTitle").textContent = title;

    const wrap = document.createElement("div");
    wrap.className = "dayList";

    for(const r of recs){
      const item = document.createElement("div");
      item.className = "dayItem";
      item.dataset.ts = String(r.ts);

      item.innerHTML = `
        <div class="dayNum">${escapeHtml(r.number || "—")}</div>
        <div class="dayMeta">
          <div class="dayTime">${escapeHtml(fmtTimeOnly(r.ts))}</div>
          <div class="dayPat">${escapeHtml(r.pattern || "—")}</div>
        </div>
      `;

      item.addEventListener("click", (e)=>{
        e.preventDefault();
        closeDayModal();
        openCard(r.ts, { type:"day", dayStartTs });
      });

      wrap.appendChild(item);
    }

    const container = document.createElement("div");
    const hint = document.createElement("div");
    hint.className = "dayHint";
    hint.textContent = "Select Angel Number to View or Edit.";
    container.appendChild(hint);
    container.appendChild(wrap);

    $("dayBody").textContent = "";
    $("dayBody").appendChild(container);

    $("dayModal").classList.remove("hidden");
    lockTouches(120);
  }

  function closeDayModal(){
    dayModalDate = null;
    $("dayModal").classList.add("hidden");
    $("dayBody").textContent = "—";
    unlockTouches();
  }

  $("btnDayClose").addEventListener("click", (e)=>{ e.preventDefault(); closeDayModal(); });

  $("dayModal").addEventListener("click", (e)=>{
    if(e.target === $("dayModal")) closeDayModal();
  });

  document.addEventListener("keydown", (e)=>{
    if(!$("dayModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeDayModal(); }
    }
  });

  $("btnDayExport").addEventListener("click", (e)=>{
    e.preventDefault();
    if(dayModalDate == null) return;
    const a = dayModalDate;
    const b = clampEndOfDay(a);
    const recs = loadRecords().slice().reverse().filter(r => r.ts >= a && r.ts <= b);

    exportReport(
      recs,
      {
        title: "Day Export",
        rangeLabel: `${fmtDateTime(a)} to ${fmtDateTime(b)}`,
        notes: "This export contains all entries for the selected day."
      },
      "angel_numbers_day"
    );
  });

  /* ===== Export helpers ===== */

  let exportPayload = null;

  function isShareAvailable(){
    return !!(navigator.share && typeof navigator.share === "function");
  }

  async function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      return true;
    }
    return false;
  }

  function downloadText(text, filename){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function saveTextWithPicker(text, suggestedName){
    const canPick = typeof window.showSaveFilePicker === "function";
    if(!canPick) return false;

    const opts = {
      suggestedName: suggestedName || "angel_numbers_report.txt",
      types: [{ description: "Text", accept: {"text/plain": [".txt"]} }]
    };

    const handle = await window.showSaveFilePicker(opts);
    const writable = await handle.createWritable();
    await writable.write(new Blob([text], {type:"text/plain;charset=utf-8"}));
    await writable.close();
    return true;
  }

  function openExportModal(payload){
    exportPayload = payload;
    $("exportModal").classList.remove("hidden");
    lockTouches(120);

    $("btnExportClose").disabled = true;
    $("btnExportShare").disabled = true;
    $("btnExportSave").disabled  = true;

    setTimeout(() => {
      $("btnExportClose").disabled = false;
      $("btnExportShare").disabled = !isShareAvailable();
      $("btnExportSave").disabled  = false;
    }, 200);
  }

  function closeExportModal(){
    exportPayload = null;
    $("exportModal").classList.add("hidden");
    unlockTouches();
  }

  $("btnExportClose").addEventListener("click", (e)=>{ e.preventDefault(); closeExportModal(); });
  $("exportModal").addEventListener("click", (e)=>{ if(e.target === $("exportModal")) closeExportModal(); });
  document.addEventListener("keydown", (e)=>{
    if(!$("exportModal").classList.contains("hidden")){
      if(e.key === "Escape"){ e.preventDefault(); closeExportModal(); }
    }
  });

  $("btnExportShare").addEventListener("click", async (e)=>{
    e.preventDefault();
    if(!exportPayload) return;
    if($("btnExportShare").disabled) return;
    if(!isShareAvailable()){
      alert("Share is not available on this device/browser.");
      return;
    }
    try{
      await navigator.share({
        title: "Angel Numbers Tracker Export",
        text: exportPayload.text
      });
    }catch{}
  });

  $("btnExportSave").addEventListener("click", async (e)=>{
    e.preventDefault();
    if(!exportPayload) return;
    if($("btnExportSave").disabled) return;

    try{
      const ok = await saveTextWithPicker(exportPayload.text, exportPayload.filename);
      if(ok){ alert("Saved."); return; }
    }catch{}

    downloadText(exportPayload.text, exportPayload.filename || "angel_numbers_report.txt");
  });

  function buildReportHeader({title, rangeLabel, notes}){
    const now = fmtDateTime(Date.now());
    const lines = [
      "Angel Numbers Tracker — Export Report",
      `App Version: ${APP_VERSION}`,
      `Report: ${title}`,
      `Generated: ${now}`,
      rangeLabel ? `Range: ${rangeLabel}` : "",
      "",
      "How this data was captured:",
      "- Sightings are entered manually into Angel Numbers Tracker on this device.",
      "- Data is stored locally on the phone (no cloud sync, no account).",
      "- Each record may include the number, pattern type, a cultural/numerology meaning, and optional notes.",
      "",
      notes ? notes : "",
      "",
      "------------------------------",
      ""
    ].filter(Boolean);
    return lines.join("\n");
  }

  function exportReport(recs, headerInfo, filenameBase){
    const header = buildReportHeader(headerInfo);

    const lines = recs.map(r => {
      const dt = fmtDateTime(r.ts);
      const num = `Number: ${r.number || "—"}`;
      const pat = `Pattern: ${r.pattern || "—"}`;
      const notes = (r.notes && r.notes.trim()) ? r.notes.trim() : "None";
      const meaning = (r.meaning && r.meaning.trim()) ? r.meaning.trim() : "None";
      return `${dt}\n${num}\nNotes: ${notes}\n${pat}\nMeaning: ${meaning}\n`;
    });

    const out = header + lines.join("\n");
    const ts = new Date();
    const y = ts.getFullYear();
    const m = String(ts.getMonth()+1).padStart(2,"0");
    const d = String(ts.getDate()).padStart(2,"0");
    const filename = `${filenameBase || "angel_numbers_report"}_${y}-${m}-${d}.txt`;

    (async () => {
      try{ await copyToClipboard(out); }catch{}
      openExportModal({ text: out, filename });
    })();
  }

  /* ===== Calendar ===== */

  const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  function initMonthDefaultIfNeeded(){
    if($("calMonth").value) return;
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,"0");
    $("calMonth").value = `${y}-${m}`;
  }

  function monthValueToYMD(value){
    const m = /^(\d{4})-(\d{2})$/.exec(String(value || ""));
    if(!m) return null;
    const y = Number(m[1]);
    const mo = Number(m[2]);
    if(!y || !mo) return null;
    return { y, mo };
  }

  function buildDayIndexMap(recs){
    const map = new Map();
    for(const r of recs){
      const k = startOfDay(r.ts);
      const arr = map.get(k) || [];
      arr.push(r);
      map.set(k, arr);
    }
    for(const [k, arr] of map.entries()){
      arr.sort((a,b)=> a.ts - b.ts);
      map.set(k, arr);
    }
    return map;
  }

  function renderCalendar(){
    const mv = monthValueToYMD($("calMonth").value);
    if(!mv) return;

    const {y, mo} = mv;
    const first = new Date(y, mo-1, 1);
    const firstDow = first.getDay();
    const totalCells = 42;

    const gridStart = new Date(y, mo-1, 1 - firstDow);
    gridStart.setHours(0,0,0,0);

    const all = loadRecords();
    const dayMap = buildDayIndexMap(all);

    const dowRow = $("calDowRow");
    dowRow.innerHTML = "";
    for(const d of DOW){
      const el = document.createElement("div");
      el.className = "calDow";
      el.textContent = d;
      dowRow.appendChild(el);
    }

    const grid = $("calGrid");
    grid.innerHTML = "";

    for(let i=0;i<totalCells;i++){
      const d = new Date(gridStart.getTime() + i*DAY_MS);
      const dayStart = d.getTime();
      const inMonth = (d.getMonth() === (mo-1));

      const cell = document.createElement("div");
      cell.className = "calCell" + (inMonth ? "" : " outMonth");

      const dn = document.createElement("div");
      dn.className = "dnum";
      dn.textContent = String(d.getDate());
      cell.appendChild(dn);

      const recs = dayMap.get(dayStart) || [];
      if(recs.length > 0){
        cell.classList.add("hasData");
        cell.addEventListener("click", (e)=>{
          e.preventDefault();
          if(animating) return;
          openDayModal(dayStart);
        });
      }

      grid.appendChild(cell);
    }
  }

  /* ===== Clear / Install / Exit ===== */

  let deferredPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    refreshInstallButton();
  });

  window.addEventListener("appinstalled", () => {
    deferredPrompt = null;
    refreshInstallButton();
  });

  function isStandalone(){
    return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
  }

  function refreshInstallButton(){
    $("btnInstall").textContent = isStandalone() ? "Uninstall" : "Install";
  }

  $("btnInstall").addEventListener("click", async () => {
    if(isStandalone()){
      alert(
        "Uninstall:\n\n" +
        "Android: press-and-hold the app icon → Uninstall.\n" +
        "Uninstall typically does NOT delete your saved data, but device/browser behavior can vary.\n\n" +
        "To delete data on purpose: use Clear Data (home screen)."
      );
      return;
    }
    if(deferredPrompt){
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch {}
      deferredPrompt = null;
      refreshInstallButton();
      return;
    }
    alert("Install is available when your browser offers it (menu → Install app).");
  });

  function clearAllData(){
    openConfirm({
      title: "Clear all data?",
      message:
        "This deletes everything stored on this phone for Angel Numbers Tracker.\n\n" +
        "This cannot be undone.",
      okText: "Clear",
      cancelText: "Cancel",
      danger: true,
      onOk: () => {
        try{ localStorage.removeItem(STORAGE_KEY); }catch{}
        alert("All data cleared.");
        showInstant("home");
      }
    });
  }
  $("btnClearAll").addEventListener("click", clearAllData);

  /* KEEP THIS EXIT FUNCTION EXACTLY (known-good) */
  $("btnExitHome").addEventListener("click", () => {
    window.close();
    setTimeout(() => {
      alert("If it didn’t close: use your phone’s Back/Home.");
    }, 200);
  });

  /* ===== Buttons + Save/Delete + Exports ===== */

  $("btnGoAdd").addEventListener("click", () => enterAddNew("home"));
  $("btnGoIdentify").addEventListener("click", () => showInstant("identify"));
  $("btnGoCalendar").addEventListener("click", () => showInstant("calendar"));

  $("btnBackFromAdd").addEventListener("click", () => { editTs=null; editOriginalTs=null; showInstant(returnScreen || "home"); });
  $("btnBackFromIdentify").addEventListener("click", () => showInstant("home"));
  $("btnBackFromCalendar").addEventListener("click", () => showInstant("home"));

  $("dtEdit").addEventListener("change", () => {
    const ts = fromLocalDatetimeValue($("dtEdit").value);
    if(ts != null){
      if(editTs != null){
        editTs = ts;
        tickTime();
      }
    }
  });

  $("btnSave").addEventListener("click", () => {
    const number = normalizeNumberInput($("anum").value);
    const notes = ($("notes").value || "").toString();

    if(!validateAnyInput(number, notes)){
      alert("Enter a number or a note.");
      return;
    }

    const tsWanted = (editOriginalTs == null)
      ? Date.now()
      : (fromLocalDatetimeValue($("dtEdit").value) ?? editTs ?? Date.now());

    const pattern = number ? detectPattern(number) : "—";
    const meaning = number ? deriveMeaning(number, pattern).meaning : "—";

    const recs = loadRecords();

    if(editOriginalTs == null){
      recs.unshift({ ts: tsWanted, number, pattern, meaning, notes });
    }else{
      const idx = recs.findIndex(r => r.ts === editOriginalTs);
      if(idx >= 0){
        recs[idx] = { ts: tsWanted, number, pattern, meaning, notes };
      }else{
        recs.unshift({ ts: tsWanted, number, pattern, meaning, notes });
      }
    }

    recs.sort((a,b)=> b.ts - a.ts);
    saveRecords(recs);

    editTs = null;
    editOriginalTs = null;

    showInstant("calendar");
  });

  $("btnDelete").addEventListener("click", () => {
    if(editOriginalTs == null) return;

    openConfirm({
      title: "Delete this entry?",
      message: "This cannot be undone.",
      okText: "Delete",
      cancelText: "Cancel",
      danger: true,
      onOk: () => {
        const recs = loadRecords().filter(r => r.ts !== editOriginalTs);
        saveRecords(recs);

        editTs = null;
        editOriginalTs = null;

        showInstant("calendar");
      }
    });
  });

  $("calMonth").addEventListener("change", () => renderCalendar());
  $("btnCalToday").addEventListener("click", (e)=>{
    e.preventDefault();
    const now = new Date();
    $("calMonth").value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
    renderCalendar();
  });

  $("btnExportMonth").addEventListener("click", () => {
    const mv = monthValueToYMD($("calMonth").value);
    if(!mv) return;
    const {y, mo} = mv;
    const a = new Date(y, mo-1, 1, 0,0,0,0).getTime();
    const b = new Date(y, mo, 0, 23,59,59,999).getTime();
    const recs = loadRecords().slice().reverse().filter(r => r.ts >= a && r.ts <= b);

    exportReport(
      recs,
      {
        title: "Month Export",
        rangeLabel: `${y}-${String(mo).padStart(2,"0")}`,
        notes: "This export contains all entries within the selected month."
      },
      "angel_numbers_month"
    );
  });

  /* ===== Manifest + SW ===== */

  function injectManifest(){
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#8a6bff"/>
      <stop offset="55%" stop-color="#2f78ff"/>
      <stop offset="100%" stop-color="#0b1324"/>
    </linearGradient>
  </defs>
  <rect width="512" height="512" rx="110" fill="url(#g)"/>
  <ellipse cx="256" cy="150" rx="110" ry="44" fill="none" stroke="rgba(235,245,255,.92)" stroke-width="26"/>
  <path d="M256 240
           C196 210, 140 220, 112 270
           C154 294, 190 330, 214 380
           C226 330, 240 285, 256 240Z"
        fill="none" stroke="rgba(235,245,255,.92)" stroke-width="22" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M256 240
           C316 210, 372 220, 400 270
           C358 294, 322 330, 298 380
           C286 330, 272 285, 256 240Z"
        fill="none" stroke="rgba(235,245,255,.92)" stroke-width="22" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;
    const encoded = encodeURIComponent(svg).replace(/'/g,"%27").replace(/"/g,"%22");
    const icon = `data:image/svg+xml;charset=utf-8,${encoded}`;

    const manifest = {
      name: "Angel Numbers Tracker",
      short_name: "AngelNums",
      start_url: ".",
      display: "standalone",
      background_color: "#0b1324",
      theme_color: "#0b1324",
      icons: [{ src: icon, sizes: "512x512", type: "image/svg+xml", purpose: "any" }]
    };

    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    $("manifestLink").setAttribute("href", url);
  }

  async function registerSW(){
    if(!("serviceWorker" in navigator)) return;
    const swCode =
`self.addEventListener('install', (e)=>{ self.skipWaiting(); });
self.addEventListener('activate', (e)=>{ e.waitUntil(self.clients.claim()); });
self.addEventListener('fetch', (e)=>{ });`;
    const blob = new Blob([swCode], {type:"text/javascript"});
    const swUrl = URL.createObjectURL(blob);
    try { await navigator.serviceWorker.register(swUrl); } catch {}
  }

  /* ===== Test data seeding ===== */

  function seedTestDataIfEmpty(){
    if(!TEST_DATA_ENABLED) return;
    const existing = loadRecords();
    if(existing.length > 0) return;

    const now = new Date();
    const months = [
      { y: now.getFullYear(), m: now.getMonth() },
      { y: new Date(now.getFullYear(), now.getMonth()-1, 1).getFullYear(),
        m: new Date(now.getFullYear(), now.getMonth()-1, 1).getMonth() }
    ];

    const sampleNums = ["111","222","333","444","555","777","888","999","1212","1010","2222","2424","99099","1234"];
    const out = [];

    function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }

    for(const mm of months){
      const daysToFill = randInt(10, 14);
      const usedDays = new Set();
      while(usedDays.size < daysToFill){
        usedDays.add(randInt(1, 27));
      }
      for(const day of usedDays){
        const nEntries = randInt(1, 4);
        for(let i=0;i<nEntries;i++){
          const hr = randInt(8, 22);
          const mi = randInt(0, 59);
          const ts = new Date(mm.y, mm.m, day, hr, mi, 0, 0).getTime();

          const number = sampleNums[randInt(0, sampleNums.length-1)];
          const pattern = detectPattern(number);
          const meaning = deriveMeaning(number, pattern).meaning;

          out.push({ ts, number, pattern, meaning, notes: (i===0 ? "Test data (remove later)" : "") });
        }
      }
    }

    out.sort((a,b)=> b.ts - a.ts);
    saveRecords(out);
  }

  /* ===== Version modal + taps ===== */

  function openVersionModal(){
    $("verBody").textContent =
      `Actual app version: ${APP_VERSION}\n` +
      `Home label (visual only): ${HOME_VERSION_LABEL}\n` +
      `Storage key: ${STORAGE_KEY}`;
    $("versionModal").classList.remove("hidden");
    lockTouches(120);
  }
  function closeVersionModal(){ $("versionModal").classList.add("hidden"); unlockTouches(); }
  $("btnVerX").addEventListener("click", (e)=>{ e.preventDefault(); closeVersionModal(); });
  $("btnVerClose").addEventListener("click", (e)=>{ e.preventDefault(); closeVersionModal(); });
  $("versionModal").addEventListener("click", (e)=>{ if(e.target === $("versionModal")) closeVersionModal(); });

  let logoTapCount = 0;
  let logoTapTimer = null;
  document.querySelector(".logoTitle").addEventListener("click", () => {
    if(animating) return;
    logoTapCount++;
    if(logoTapTimer) clearTimeout(logoTapTimer);
    logoTapTimer = setTimeout(()=>{ logoTapCount=0; }, 650);
    if(logoTapCount >= 4){
      logoTapCount = 0;
      openVersionModal();
    }
  });

  function openHeart(){ $("heartModal").classList.remove("hidden"); lockTouches(120); }
  function closeHeart(){ $("heartModal").classList.add("hidden"); unlockTouches(); }
  $("btnHeartX").addEventListener("click", (e)=>{ e.preventDefault(); closeHeart(); });
  $("btnHeartClose").addEventListener("click", (e)=>{ e.preventDefault(); closeHeart(); });
  $("heartModal").addEventListener("click", (e)=>{ if(e.target === $("heartModal")) closeHeart(); });

  let vTapCount = 0;
  let vTapTimer = null;
  $("homeVerLabel").textContent = HOME_VERSION_LABEL;
  $("homeVerLabel").addEventListener("click", () => {
    if(animating) return;
    vTapCount++;
    if(vTapTimer) clearTimeout(vTapTimer);
    vTapTimer = setTimeout(()=>{ vTapCount = 0; }, 700);
    if(vTapCount >= 5){
      vTapCount = 0;
      openHeart();
    }
  });

  /* ===== Home pull-to-refresh ===== */

  const ptr = {
    active:false,
    y0:0,
    pulling:false,
    threshold: 64,
    max: 120,
    ready:false
  };

  function setPtr(on, text){
    const el = $("ptrHome");
    if(!el) return;
    if(on){
      el.classList.add("on");
      if(text) el.textContent = text;
    }else{
      el.classList.remove("on");
      el.textContent = "Pull down to refresh";
    }
  }

  function homeCanStartPtr(ev){
    if(currentScreen !== "home") return false;
    if(animating) return false;
    if(!(ev.touches && ev.touches.length === 1)) return false;

    const home = $("home");
    if(!home) return false;
    if(home.scrollTop > 0) return false;

    const t = ev.target;
    if(t && t.closest && t.closest("button, input, textarea, select")) return false;

    return true;
  }

  function ptrStart(ev){
    if(!homeCanStartPtr(ev)) return;
    ptr.active = true;
    ptr.pulling = false;
    ptr.ready = false;
    ptr.y0 = ev.touches[0].clientY;
    setPtr(true, "Pull down to refresh");
  }

  function ptrMove(ev){
    if(!ptr.active) return;
    if(!(ev.touches && ev.touches.length === 1)) return;

    const y = ev.touches[0].clientY;
    const dy = y - ptr.y0;

    if(dy <= 8){
      setPtr(true, "Pull down to refresh");
      ptr.ready = false;
      return;
    }

    ptr.pulling = true;
    ev.preventDefault();

    const amt = Math.min(ptr.max, dy);
    if(amt >= ptr.threshold){
      ptr.ready = true;
      setPtr(true, "Release to refresh");
    }else{
      ptr.ready = false;
      setPtr(true, "Pull down to refresh");
    }
  }

  function ptrEnd(){
    if(!ptr.active) return;
    const doRefresh = ptr.ready;

    ptr.active = false;
    ptr.pulling = false;
    ptr.ready = false;

    if(doRefresh){
      setPtr(true, "Refreshing…");
      setTimeout(() => {
        try{ location.reload(); }catch{ setPtr(false); }
      }, 140);
    }else{
      setPtr(false);
    }
  }

  function attachHomePTR(){
    const home = $("home");
    if(!home) return;
    home.addEventListener("touchstart", ptrStart, {passive:true});
    home.addEventListener("touchmove", ptrMove, {passive:false});
    home.addEventListener("touchend", ptrEnd, {passive:true});
    home.addEventListener("touchcancel", ptrEnd, {passive:true});
  }

  /* ===== Init ===== */

  injectManifest();
  registerSW();
  refreshInstallButton();

  seedTestDataIfEmpty();

  attachSwipes();
  attachHomePTR();

  showInstant("home");

  window.addEventListener("resize", () => {
    if(!$("add").classList.contains("hidden")) adjustTimeFont();
    if(!$("calendar").classList.contains("hidden")) renderCalendar();
  });

})();
  </script>
</body>
</html>

<!--
EOF Version Detail Notes (required)
App: Angel Numbers Tracker
Actual Version: v1.0B13
Home Label (visual only): v1.333 (do not change unless instructed)
Base: v1.0B12
Changes:
- Removed Log panel entirely.
- Added Identify panel (theme-matched) for quick Angel Number meaning lookup (pattern + meaning + supporting lenses).
- Home screen: replaced Log button with Identify button (positioned directly under ADD).
- Swipe cycle: Identify replaces Log in left/right rotation (home ↔ identify ↔ calendar).
- No changes to storage, exports, calendar day browsing, card modal, or Add/Edit behavior.
-->
