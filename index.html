<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vitals Tracker v2</title>
  <style>
    :root{
      --bg:#000;
      --panel:#0b0f14;
      --panel2:#0a0a0a;
      --border:#7ecbff;
      --text:#fff;
      --muted:#9aa7b1;
      --accent:#4da3ff;
      --danger:#ff6b6b;
      --ok:#7dffb2;
      --warn:#ffd36b;
      --focus:#b7e5ff;
      --line:#1f2a33;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Arial, Helvetica, sans-serif;
      padding:12px;
    }
    .app{
      border:4px solid var(--border);
      border-radius:14px;
      padding:16px;
      max-width:1050px;
      margin:0 auto;
      background:linear-gradient(180deg, rgba(126,203,255,0.06), rgba(0,0,0,0));
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .logo{
      width:52px;height:52px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--border));
      display:flex;align-items:center;justify-content:center;
      color:#000;font-weight:900;letter-spacing:0.5px;
      flex:0 0 auto;
    }
    h1{margin:0;font-size:22px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}

    .panel{
      border:1px solid var(--line);
      background:rgba(11,15,20,0.85);
      border-radius:12px;
      padding:12px;
      margin-top:10px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:10px;
    }

    .col-2{grid-column:span 2;}
    .col-3{grid-column:span 3;}
    .col-4{grid-column:span 4;}
    .col-5{grid-column:span 5;}
    .col-6{grid-column:span 6;}
    .col-7{grid-column:span 7;}
    .col-8{grid-column:span 8;}
    .col-12{grid-column:span 12;}

    @media (max-width:900px){
      .col-2,.col-3,.col-4,.col-5,.col-6,.col-7,.col-8{grid-column:span 12;}
    }

    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:0 0 6px 0;
    }

    input, select, textarea, button{
      width:100%;
      border-radius:10px;
      border:1px solid #2a3a45;
      background:#0a0a0a;
      color:var(--text);
      padding:10px 12px;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:70px;resize:vertical}
    input:focus, select:focus, textarea:focus, button:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(183,229,255,0.18);
    }

    .row-actions{
      display:flex;gap:10px;flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      background:var(--accent);
      color:#000;
      font-weight:800;
      cursor:pointer;
      border:none;
      padding:11px 12px;
    }
    button.secondary{
      background:#111;
      color:var(--text);
      border:1px solid #2a3a45;
      font-weight:700;
    }
    button.danger{
      background:var(--danger);
      color:#000;
    }
    button.ok{
      background:var(--ok);
      color:#000;
    }

    .pillbar{
      display:flex;flex-wrap:wrap;gap:8px;
      margin-top:8px;
    }
    .pill{
      border:1px solid #2a3a45;
      background:#0b0f14;
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-size:14px;
      cursor:pointer;
      user-select:none;
    }
    .pill[aria-pressed="true"]{
      border-color:var(--border);
      background:rgba(126,203,255,0.12);
    }

    .hint{
      font-size:12px;color:var(--muted);
      margin-top:6px;
    }

    .kpi{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:900px){ .kpi{grid-template-columns:repeat(2,1fr);} }
    .kpi .card{
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,0.35);
      padding:10px;
    }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:18px;font-weight:800;margin-top:4px}
    .kpi .sub{color:var(--muted);font-size:12px;margin-top:4px}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid #1e2a33;
      padding:10px 8px;
      vertical-align:top;
      text-align:left;
    }
    th{color:var(--border);font-size:12px;letter-spacing:0.3px}
    .small{color:var(--muted);font-size:12px}
    .nowrap{white-space:nowrap}

    .tag{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #2a3a45;
      color:var(--text);
      font-size:12px;
      margin:2px 6px 2px 0;
      background:rgba(255,255,255,0.03);
    }
    .flag{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      margin-left:6px;
    }
    .flag.warn{background:rgba(255,211,107,0.25); color:var(--warn); border:1px solid rgba(255,211,107,0.45);}
    .flag.danger{background:rgba(255,107,107,0.18); color:var(--danger); border:1px solid rgba(255,107,107,0.4);}
    .flag.ok{background:rgba(125,255,178,0.12); color:var(--ok); border:1px solid rgba(125,255,178,0.35);}

    .empty{
      padding:14px;
      color:var(--muted);
      border:1px dashed #2a3a45;
      border-radius:12px;
      margin-top:10px;
    }

    /* Print/PDF report styling */
    @media print{
      body{background:#fff;color:#000;padding:0}
      .app{border:none;border-radius:0;max-width:none;padding:0;background:none}
      .no-print{display:none !important}
      table{font-size:11px}
      th{color:#000}
      td,th{border-bottom:1px solid #bbb}
      .panel{border:none;background:none;padding:0;margin:0}
      .tag,.flag{border:1px solid #999;color:#000;background:none}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Vitals Tracker v2">
    <header>
      <div class="logo" aria-hidden="true">VT</div>
      <div>
        <h1>Vitals Tracker v2</h1>
        <div class="subtitle">Accessible, local-only BP/HR logging with flags, filters, and VA-ready print/PDF.</div>
      </div>
    </header>

    <div class="panel no-print" aria-label="New entry">
      <div class="grid">
        <div class="col-3">
          <label for="date">Date</label>
          <input id="date" type="date" />
        </div>
        <div class="col-3">
          <label for="time">Time</label>
          <input id="time" type="time" />
        </div>
        <div class="col-2">
          <label for="sys">Systolic</label>
          <input id="sys" type="number" inputmode="numeric" />
        </div>
        <div class="col-2">
          <label for="dia">Diastolic</label>
          <input id="dia" type="number" inputmode="numeric" />
        </div>
        <div class="col-2">
          <label for="hr">Heart Rate</label>
          <input id="hr" type="number" inputmode="numeric" />
        </div>

        <div class="col-4">
          <label for="position">Body position</label>
          <select id="position">
            <option>Sitting</option>
            <option>Standing</option>
            <option>Lying down</option>
          </select>
        </div>

        <div class="col-4">
          <label for="meds">Meds taken (optional)</label>
          <input id="meds" type="text" placeholder="e.g., Lisinopril 10mg, Ivabradine, Propranolol" />
          <div class="hint">Short list is best. This is for context, not perfection.</div>
        </div>

        <div class="col-4">
          <label for="severity">Day type</label>
          <select id="severity">
            <option value="typical">Typical</option>
            <option value="bad">Bad spike day</option>
            <option value="worst">Worst day</option>
          </select>
        </div>

        <div class="col-12">
          <label>Quick symptom tags</label>
          <div class="pillbar" id="pillbar" role="group" aria-label="Symptom tags"></div>
          <div class="grid" style="margin-top:10px">
            <div class="col-6">
              <label for="customTag">Add a custom tag (optional)</label>
              <input id="customTag" type="text" placeholder="e.g., blurred vision, hot ears, shakey, weakness" />
            </div>
            <div class="col-6">
              <label for="symptoms">Symptoms / notes</label>
              <textarea id="symptoms" placeholder="Write it exactly how it felt. Short is fine."></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="row-actions">
        <button id="saveBtn" onclick="saveEntry()">Save entry</button>
        <button class="secondary" onclick="resetForm()">Reset fields</button>
      </div>
    </div>

    <div class="panel no-print" aria-label="Tools and filters">
      <div class="grid">
        <div class="col-4">
          <label for="q">Search (notes/tags/meds)</label>
          <input id="q" type="text" placeholder="Type to filter..." oninput="render()" />
        </div>
        <div class="col-2">
          <label for="from">From</label>
          <input id="from" type="date" onchange="render()" />
        </div>
        <div class="col-2">
          <label for="to">To</label>
          <input id="to" type="date" onchange="render()" />
        </div>
        <div class="col-2">
          <label for="tagFilter">Tag</label>
          <select id="tagFilter" onchange="render()">
            <option value="">All</option>
          </select>
        </div>
        <div class="col-2">
          <label for="sort">Sort</label>
          <select id="sort" onchange="render()">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
          </select>
        </div>

        <div class="col-12">
          <label>Alert thresholds (local flags)</label>
          <div class="grid">
            <div class="col-2">
              <label for="tSysHigh">Sys high</label>
              <input id="tSysHigh" type="number" inputmode="numeric" />
            </div>
            <div class="col-2">
              <label for="tDiaHigh">Dia high</label>
              <input id="tDiaHigh" type="number" inputmode="numeric" />
            </div>
            <div class="col-2">
              <label for="tSysLow">Sys low</label>
              <input id="tSysLow" type="number" inputmode="numeric" />
            </div>
            <div class="col-2">
              <label for="tDiaLow">Dia low</label>
              <input id="tDiaLow" type="number" inputmode="numeric" />
            </div>
            <div class="col-2">
              <label for="tHrHigh">HR high</label>
              <input id="tHrHigh" type="number" inputmode="numeric" />
            </div>
            <div class="col-2">
              <label for="tHrLow">HR low</label>
              <input id="tHrLow" type="number" inputmode="numeric" />
            </div>
          </div>
          <div class="row-actions" style="margin-top:10px">
            <button class="secondary" onclick="saveThresholds()">Save thresholds</button>
            <button class="secondary" onclick="restoreDefaults()">Restore defaults</button>
          </div>
          <div class="hint">Flags are for your tracking/communication. They do not diagnose anything.</div>
        </div>

        <div class="col-12">
          <div class="row-actions">
            <button class="secondary" onclick="exportCSV()">Export CSV</button>
            <button class="secondary" onclick="backupJSON()">Backup (JSON)</button>
            <button class="secondary" onclick="document.getElementById('restoreFile').click()">Restore (JSON)</button>
            <input id="restoreFile" type="file" accept="application/json" style="display:none" onchange="restoreJSON(event)" />
            <button class="ok" onclick="printReport()">Print / Save as PDF</button>
            <button class="danger" onclick="clearAll()">Clear all data</button>
          </div>
          <div class="hint">Print/PDF creates a clean report of the filtered entries (date range/search/tag).</div>
        </div>
      </div>
    </div>

    <div class="panel" aria-label="Summary">
      <div class="kpi" id="kpi"></div>
    </div>

    <div class="panel" aria-label="Log">
      <div class="small" id="countLine"></div>
      <div id="empty" class="empty" style="display:none">No entries match your filters.</div>
      <div style="overflow:auto">
        <table aria-label="Vitals log table">
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th class="nowrap">Time</th>
              <th class="nowrap">BP</th>
              <th class="nowrap">HR</th>
              <th>Flags</th>
              <th>Position</th>
              <th>Day</th>
              <th>Tags</th>
              <th>Meds</th>
              <th>Notes</th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody id="log"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const STORAGE_KEY = "vitals_v2_entries";
  const THRESH_KEY  = "vitals_v2_thresholds";

  const TAGS = [
    "Sweaty", "Panic", "Chest tight", "Dizzy", "Nausea", "Blurred vision",
    "Weakness", "Head pain", "Hot ears", "Shaky", "Short breath", "Stomach pain",
    "Anxious", "Calm", "Foggy"
  ];

  // DOM
  const logEl = document.getElementById("log");
  const kpiEl = document.getElementById("kpi");
  const countLine = document.getElementById("countLine");
  const emptyEl = document.getElementById("empty");

  const dateEl = document.getElementById("date");
  const timeEl = document.getElementById("time");
  const sysEl = document.getElementById("sys");
  const diaEl = document.getElementById("dia");
  const hrEl  = document.getElementById("hr");
  const posEl = document.getElementById("position");
  const medsEl = document.getElementById("meds");
  const sevEl = document.getElementById("severity");
  const symptomsEl = document.getElementById("symptoms");
  const customTagEl = document.getElementById("customTag");

  const qEl = document.getElementById("q");
  const fromEl = document.getElementById("from");
  const toEl = document.getElementById("to");
  const tagFilterEl = document.getElementById("tagFilter");
  const sortEl = document.getElementById("sort");

  const tSysHigh = document.getElementById("tSysHigh");
  const tDiaHigh = document.getElementById("tDiaHigh");
  const tSysLow  = document.getElementById("tSysLow");
  const tDiaLow  = document.getElementById("tDiaLow");
  const tHrHigh  = document.getElementById("tHrHigh");
  const tHrLow   = document.getElementById("tHrLow");

  // State
  let selectedTags = new Set();
  let editId = null;

  function nowLocal(){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const dd = String(now.getDate()).padStart(2,"0");
    const hh = String(now.getHours()).padStart(2,"0");
    const mi = String(now.getMinutes()).padStart(2,"0");
    return { date:`${yyyy}-${mm}-${dd}`, time:`${hh}:${mi}` };
  }

  function getEntries(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch { return []; }
  }
  function setEntries(entries){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
  }

  function defaultThresholds(){
    return {
      sysHigh: 160,
      diaHigh: 100,
      sysLow:  90,
      diaLow:  60,
      hrHigh:  110,
      hrLow:   50
    };
  }

  function getThresholds(){
    try { return JSON.parse(localStorage.getItem(THRESH_KEY) || "null") || defaultThresholds(); }
    catch { return defaultThresholds(); }
  }

  function setThresholds(t){
    localStorage.setItem(THRESH_KEY, JSON.stringify(t));
  }

  function restoreDefaults(){
    const t = defaultThresholds();
    setThresholds(t);
    syncThresholdInputs();
    render();
  }

  function syncThresholdInputs(){
    const t = getThresholds();
    tSysHigh.value = t.sysHigh;
    tDiaHigh.value = t.diaHigh;
    tSysLow.value  = t.sysLow;
    tDiaLow.value  = t.diaLow;
    tHrHigh.value  = t.hrHigh;
    tHrLow.value   = t.hrLow;
  }

  function saveThresholds(){
    const t = {
      sysHigh: Number(tSysHigh.value || 0),
      diaHigh: Number(tDiaHigh.value || 0),
      sysLow:  Number(tSysLow.value || 0),
      diaLow:  Number(tDiaLow.value || 0),
      hrHigh:  Number(tHrHigh.value || 0),
      hrLow:   Number(tHrLow.value || 0)
    };
    setThresholds(t);
    render();
  }

  function buildPills(){
    const bar = document.getElementById("pillbar");
    bar.innerHTML = "";
    TAGS.forEach(tag=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "pill";
      b.textContent = tag;
      b.setAttribute("aria-pressed","false");
      b.onclick = ()=>{
        if(selectedTags.has(tag)) selectedTags.delete(tag);
        else selectedTags.add(tag);
        b.setAttribute("aria-pressed", selectedTags.has(tag) ? "true" : "false");
      };
      bar.appendChild(b);
    });
  }

  function normalizeText(s){ return (s || "").toString().toLowerCase(); }

  function flagsFor(entry){
    const t = getThresholds();
    const sys = Number(entry.sys);
    const dia = Number(entry.dia);
    const hr  = Number(entry.hr);

    const flags = [];

    if(!Number.isNaN(sys) && !Number.isNaN(dia)){
      if(sys >= t.sysHigh || dia >= t.diaHigh) flags.push({type:"danger", text:"High BP"});
      else if(sys >= (t.sysHigh-10) || dia >= (t.diaHigh-10)) flags.push({type:"warn", text:"Borderline BP"});
      if(sys <= t.sysLow || dia <= t.diaLow) flags.push({type:"warn", text:"Low BP"});
    }
    if(!Number.isNaN(hr)){
      if(hr >= t.hrHigh) flags.push({type:"danger", text:"High HR"});
      else if(hr <= t.hrLow) flags.push({type:"warn", text:"Low HR"});
    }

    if(entry.severity === "worst") flags.push({type:"danger", text:"Worst day"});
    else if(entry.severity === "bad") flags.push({type:"warn", text:"Bad day"});

    if(flags.length === 0) flags.push({type:"ok", text:"No flags"});
    return flags;
  }

  function validateEntry(entry){
    const errs = [];
    if(!entry.date) errs.push("Date is required.");
    if(!entry.time) errs.push("Time is required.");
    if(entry.sys === "" || entry.dia === "") errs.push("BP systolic and diastolic are required.");
    if(entry.hr === "") errs.push("Heart rate is required.");
    if(Number(entry.sys) <= 0 || Number(entry.dia) <= 0) errs.push("BP must be positive numbers.");
    if(Number(entry.hr) <= 0) errs.push("HR must be a positive number.");
    return errs;
  }

  function saveEntry(){
    const custom = customTagEl.value.trim();
    if(custom) selectedTags.add(custom);

    const entry = {
      id: editId || crypto.randomUUID(),
      date: dateEl.value,
      time: timeEl.value,
      sys: sysEl.value,
      dia: diaEl.value,
      hr:  hrEl.value,
      position: posEl.value,
      severity: sevEl.value,
      tags: Array.from(selectedTags),
      meds: medsEl.value.trim(),
      notes: symptomsEl.value.trim(),
      createdAt: Date.now()
    };

    const errs = validateEntry(entry);
    if(errs.length){
      alert(errs.join("\n"));
      return;
    }

    const entries = getEntries();
    const idx = entries.findIndex(e=>e.id === entry.id);
    if(idx >= 0) entries[idx] = entry;
    else entries.unshift(entry);
    setEntries(entries);

    resetForm();
    render();
  }

  function resetForm(){
    editId = null;
    const n = nowLocal();
    dateEl.value = n.date;
    timeEl.value = n.time;
    sysEl.value = "";
    diaEl.value = "";
    hrEl.value = "";
    posEl.value = "Sitting";
    medsEl.value = "";
    sevEl.value = "typical";
    symptomsEl.value = "";
    customTagEl.value = "";
    selectedTags.clear();

    // reset pill pressed states
    document.querySelectorAll(".pill").forEach(p=>p.setAttribute("aria-pressed","false"));

    document.getElementById("saveBtn").textContent = "Save entry";
    dateEl.focus();
  }

  function applyFilters(entries){
    let out = [...entries];

    const q = normalizeText(qEl.value);
    const from = fromEl.value ? new Date(fromEl.value + "T00:00:00") : null;
    const to   = toEl.value ? new Date(toEl.value + "T23:59:59") : null;
    const tagF = tagFilterEl.value;

    out = out.filter(e=>{
      const dt = new Date(e.date + "T" + (e.time || "00:00") + ":00");
      if(from && dt < from) return false;
      if(to && dt > to) return false;

      if(tagF){
        const tags = (e.tags || []);
        if(!tags.includes(tagF)) return false;
      }

      if(q){
        const hay = [
          e.notes || "",
          e.meds || "",
          (e.tags || []).join(" "),
          e.position || "",
          e.severity || ""
        ].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }

      return true;
    });

    if(sortEl.value === "oldest"){
      out.sort((a,b)=>{
        const da = new Date(a.date+"T"+(a.time||"00:00")+":00").getTime();
        const db = new Date(b.date+"T"+(b.time||"00:00")+":00").getTime();
        return da-db;
      });
    }else{
      out.sort((a,b)=>{
        const da = new Date(a.date+"T"+(a.time||"00:00")+":00").getTime();
        const db = new Date(b.date+"T"+(b.time||"00:00")+":00").getTime();
        return db-da;
      });
    }

    return out;
  }

  function updateTagFilter(entries){
    const all = new Set();
    entries.forEach(e => (e.tags||[]).forEach(t=>all.add(t)));
    const current = tagFilterEl.value;

    const opts = ["", ...Array.from(all).sort((a,b)=>a.localeCompare(b))];
    tagFilterEl.innerHTML = "";
    opts.forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v ? v : "All";
      tagFilterEl.appendChild(o);
    });
    // preserve selection if still exists
    if(opts.includes(current)) tagFilterEl.value = current;
  }

  function computeKPIs(filtered){
    if(filtered.length === 0){
      return [
        {label:"Entries", value:"0", sub:"No data in filter"},
        {label:"Average BP", value:"—", sub:""},
        {label:"Average HR", value:"—", sub:""},
        {label:"Most common tag", value:"—", sub:""}
      ];
    }

    const avg = (nums)=> Math.round(nums.reduce((a,b)=>a+b,0) / nums.length);
    const sys = filtered.map(e=>Number(e.sys)).filter(n=>Number.isFinite(n));
    const dia = filtered.map(e=>Number(e.dia)).filter(n=>Number.isFinite(n));
    const hr  = filtered.map(e=>Number(e.hr)).filter(n=>Number.isFinite(n));

    const tagCounts = {};
    filtered.forEach(e => (e.tags||[]).forEach(t=>tagCounts[t]=(tagCounts[t]||0)+1));
    const topTag = Object.entries(tagCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || "—";

    const t = getThresholds();
    const highs = filtered.filter(e => Number(e.sys)>=t.sysHigh || Number(e.dia)>=t.diaHigh).length;
    const lows  = filtered.filter(e => Number(e.sys)<=t.sysLow  || Number(e.dia)<=t.diaLow).length;
    const hrHi  = filtered.filter(e => Number(e.hr)>=t.hrHigh).length;

    return [
      {label:"Entries", value:String(filtered.length), sub:`High BP: ${highs} • Low BP: ${lows} • High HR: ${hrHi}`},
      {label:"Average BP", value:`${avg(sys)}/${avg(dia)}`, sub:"Within current filter"},
      {label:"Average HR", value:`${avg(hr)}`, sub:"Within current filter"},
      {label:"Top tag", value:topTag, sub:"Most frequent symptom tag"}
    ];
  }

  function renderKPIs(filtered){
    const cards = computeKPIs(filtered);
    kpiEl.innerHTML = "";
    cards.forEach(c=>{
      const d = document.createElement("div");
      d.className = "card";
      d.innerHTML = `<div class="label">${escapeHtml(c.label)}</div>
                     <div class="value">${escapeHtml(c.value)}</div>
                     <div class="sub">${escapeHtml(c.sub || "")}</div>`;
      kpiEl.appendChild(d);
    });
  }

  function renderTable(filtered){
    logEl.innerHTML = "";
    if(filtered.length === 0){
      emptyEl.style.display = "block";
      return;
    }
    emptyEl.style.display = "none";

    filtered.forEach(e=>{
      const tr = document.createElement("tr");
      const flags = flagsFor(e);
      const flagHtml = flags.map(f=>`<span class="flag ${f.type}">${escapeHtml(f.text)}</span>`).join(" ");

      const tagsHtml = (e.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(" ");

      tr.innerHTML = `
        <td class="nowrap">${escapeHtml(e.date)}</td>
        <td class="nowrap">${escapeHtml(e.time)}</td>
        <td class="nowrap">${escapeHtml(e.sys)}/${escapeHtml(e.dia)}</td>
        <td class="nowrap">${escapeHtml(e.hr)}</td>
        <td>${flagHtml}</td>
        <td>${escapeHtml(e.position || "")}</td>
        <td>${escapeHtml(e.severity || "")}</td>
        <td>${tagsHtml || `<span class="small">—</span>`}</td>
        <td>${escapeHtml(e.meds || "") || `<span class="small">—</span>`}</td>
        <td>${escapeHtml(e.notes || "") || `<span class="small">—</span>`}</td>
        <td class="no-print">
          <div class="row-actions" style="margin:0">
            <button class="secondary" onclick="startEdit('${e.id}')">Edit</button>
            <button class="danger" onclick="deleteEntry('${e.id}')">Delete</button>
          </div>
        </td>
      `;
      logEl.appendChild(tr);
    });
  }

  function render(){
    const entries = getEntries();
    updateTagFilter(entries);

    const filtered = applyFilters(entries);
    countLine.textContent = `Showing ${filtered.length} of ${entries.length} total entries.`;

    renderKPIs(filtered);
    renderTable(filtered);
  }

  function startEdit(id){
    const entries = getEntries();
    const e = entries.find(x=>x.id === id);
    if(!e) return;

    editId = e.id;
    dateEl.value = e.date || "";
    timeEl.value = e.time || "";
    sysEl.value = e.sys || "";
    diaEl.value = e.dia || "";
    hrEl.value  = e.hr || "";
    posEl.value = e.position || "Sitting";
    medsEl.value = e.meds || "";
    sevEl.value = e.severity || "typical";
    symptomsEl.value = e.notes || "";
    customTagEl.value = "";

    selectedTags = new Set(e.tags || []);
    document.querySelectorAll(".pill").forEach(p=>{
      const tag = p.textContent;
      p.setAttribute("aria-pressed", selectedTags.has(tag) ? "true" : "false");
    });

    document.getElementById("saveBtn").textContent = "Save changes";
    sysEl.focus();
  }

  function deleteEntry(id){
    if(!confirm("Delete this entry?")) return;
    const entries = getEntries().filter(e=>e.id !== id);
    setEntries(entries);
    if(editId === id) resetForm();
    render();
  }

  function clearAll(){
    if(!confirm("Delete ALL entries and settings?")) return;
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(THRESH_KEY);
    restoreDefaults();
    resetForm();
    render();
  }

  function exportCSV(){
    const entries = applyFilters(getEntries());
    let csv = "Date,Time,Systolic,Diastolic,HR,Position,DayType,Tags,Meds,Notes\n";
    entries.forEach(e=>{
      const tags = (e.tags||[]).join("; ");
      const row = [
        e.date, e.time, e.sys, e.dia, e.hr,
        e.position || "", e.severity || "",
        tags,
        csvEscape(e.meds || ""),
        csvEscape(e.notes || "")
      ].join(",");
      csv += row + "\n";
    });
    downloadBlob(csv, "text/csv", "vitals_export.csv");
  }

  function backupJSON(){
    const payload = {
      version: "v2",
      exportedAt: new Date().toISOString(),
      thresholds: getThresholds(),
      entries: getEntries()
    };
    downloadBlob(JSON.stringify(payload, null, 2), "application/json", "vitals_backup.json");
  }

  function restoreJSON(evt){
    const file = evt.target.files?.[0];
    evt.target.value = "";
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const payload = JSON.parse(reader.result);
        if(payload?.entries && Array.isArray(payload.entries)){
          setEntries(payload.entries);
        }
        if(payload?.thresholds){
          setThresholds(payload.thresholds);
        }
        syncThresholdInputs();
        render();
        alert("Restore complete.");
      }catch{
        alert("Restore failed: invalid JSON.");
      }
    };
    reader.readAsText(file);
  }

  function printReport(){
    // Uses current filters. Print dialog -> Save as PDF.
    window.print();
  }

  function downloadBlob(text, mime, filename){
    const blob = new Blob([text], {type:mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  function csvEscape(s){
    const v = String(s ?? "");
    const needs = /[",\n]/.test(v);
    const esc = v.replace(/"/g,'""');
    return needs ? `"${esc}"` : esc;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Init
  (function init(){
    buildPills();
    syncThresholdInputs();

    const n = nowLocal();
    dateEl.value = n.date;
    timeEl.value = n.time;

    // keyboard convenience: Enter on HR saves
    hrEl.addEventListener("keydown",(e)=>{
      if(e.key === "Enter"){ e.preventDefault(); saveEntry(); }
    });

    render();
  })();
</script>
</body>
</html>
