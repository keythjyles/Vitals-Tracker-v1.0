<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Vitals Tracker</title>

  <!-- Minimal PWA hooks (install works when served over https / GitHub Pages) -->
  <link rel="manifest" id="manifestLink" href="#" />

  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;
      --panel2:#0c1528f0;
      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --text:rgba(235,245,255,.86);
      --muted:rgba(235,245,255,.58);
      --muted2:rgba(235,245,255,.42);
      --accent:#2f78ff;
      --accent2:rgba(47,120,255,.18);
      --good:#5bd6b2;
      --shadow:0 14px 40px rgba(0,0,0,.38);
      --radius:26px;
      --radius2:18px;
      --btnH:56px;
      --pad:18px;
      --gap:12px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 0%, rgba(47,120,255,.22), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(91,214,178,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex;
      justify-content:center;
      padding: max(14px, env(safe-area-inset-top)) 12px max(14px, env(safe-area-inset-bottom));
    }

    .app{
      width:min(520px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    h1{
      margin:10px 6px 0;
      font-size: clamp(40px, 7.6vw, 64px);
      letter-spacing:.4px;
      color:rgba(235,245,255,.78);
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
      backdrop-filter: blur(10px);
    }

    .hidden{ display:none !important; }

    .btn{
      height:var(--btnH);
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color:rgba(235,245,255,.78);
      font-weight:650;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 18px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(47,120,255,.92), rgba(47,120,255,.72));
      border-color: rgba(120,170,255,.55);
      color: rgba(0,0,0,.78);
      text-shadow:none;
    }
    .btn.small{
      height:44px;
      font-size:14px;
      padding:0 14px;
      font-weight:650;
    }

    .row{ display:flex; gap:12px; }
    .row.between{ justify-content:space-between; }
    .row.center{ align-items:center; }
    .row.wrap{ flex-wrap:wrap; }
    .grow{ flex:1; }

    .divider{
      height:1px;
      background: rgba(235,245,255,.10);
      margin: 10px 4px 2px;
    }

    .label{
      font-size:16px;
      color:var(--muted);
      font-weight:650;
      margin: 12px 4px 8px;
    }
    .subtle{
      font-size:14px;
      color:var(--muted2);
      margin: 6px 4px 0;
    }

    .field{
      border:2px solid var(--strokeBold);
      background: rgba(255,255,255,.06);
      color: rgba(235,245,255,.86);
      border-radius: 18px;
      height:54px;
      padding: 0 14px;
      font-size:18px;
      outline:none;
      width:100%;
    }
    .field::placeholder{ color: rgba(235,245,255,.35); }
    .field:focus{
      border-color: rgba(90,150,255,.78);
      box-shadow: 0 0 0 4px rgba(47,120,255,.16);
    }
    textarea.field{
      height:64px;
      padding: 12px 14px;
      resize:none;
      line-height:1.25;
    }

    /* Home buttons */
    .homeMain{
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-top:8px;
    }

    .homeFooterRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:8px;
    }

    .footerTiny{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: rgba(235,245,255,.38);
    }

    /* Add screen time line */
    .timeLine{
      margin: 4px 4px 14px;
      color: rgba(235,245,255,.82);
      font-weight:750;
      letter-spacing:.3px;
      white-space:nowrap;          /* must stay on one line */
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.05;
      font-size: clamp(18px, 6.4vw, 44px); /* baseline; JS will shrink further if needed */
    }

    .triple{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    .triple .miniLabel{
      margin: 0 4px 8px;
      color: var(--muted);
      font-weight:650;
      font-size:16px;
    }

    /* Symptoms: two-column list, tight, no pills, no border around list */
    .symGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 18px;               /* tighter */
      padding: 6px 2px 2px;
      margin-top: 2px;
    }

    .symItem{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 4px 6px;            /* tight */
      border-radius: 14px;
      transition: background .12s ease, border-color .12s ease;
    }

    /* checkbox box */
    .box{
      width:30px;
      height:30px;
      border-radius: 8px;
      border:2px solid rgba(235,245,255,.40);
      background: rgba(255,255,255,.03);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }

    /* check mark */
    .check{
      width:14px;
      height:8px;
      border-left:3px solid transparent;
      border-bottom:3px solid transparent;
      transform: rotate(-45deg);
      margin-top:-2px;
    }

    .symText{
      font-size:18px;              /* slightly smaller */
      font-weight:600;             /* less bold (no shouting) */
      color: rgba(235,245,255,.78);
      line-height:1.1;
    }

    /* selected state: highlight + blue check */
    .symItem.selected{
      background: rgba(47,120,255,.16);
    }
    .symItem.selected .box{
      border-color: rgba(90,150,255,.90);
      background: rgba(47,120,255,.18);  /* highlighted box bg */
    }
    .symItem.selected .check{
      border-left-color: rgba(235,245,255,.92);
      border-bottom-color: rgba(235,245,255,.92);
    }

    /* Button row inside panels */
    .panelButtons{
      display:flex;
      gap:12px;
      margin-top: 10px;            /* just below content */
    }

    /* Log list cards */
    .entry{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: 22px;
      padding: 14px 14px 12px;
      margin-top: 12px;
    }
    .entryTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      margin-bottom: 6px;
    }
    .entryTime{
      font-size:14px;
      color: rgba(235,245,255,.46);
      white-space:nowrap;
    }
    .entryBPHR{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:baseline;
    }
    .bpBig{
      font-size:34px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .hrBig{
      font-size:28px;
      font-weight:800;
      color: rgba(235,245,255,.72);
      white-space:nowrap;
    }
    .entryLine{
      margin-top: 6px;
      color: rgba(235,245,255,.62);
      font-size:16px;
      line-height:1.25;
    }
    .entryLine b{
      color: rgba(235,245,255,.70);
    }

    /* Filters */
    .filters{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top:10px;
    }

    .dateField{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .dateField .miniLabel{
      margin: 0 4px;
      color: var(--muted);
      font-weight:650;
      font-size:14px;
    }

    input[type="date"].field{
      font-size:16px;              /* smaller so full date fits */
      padding-right: 10px;
    }

    /* Charts */
    canvas{
      width:100%;
      height:280px;
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      margin-top: 10px;
    }

    /* Utility */
    .noteLabel{
      margin: 12px 4px 8px;
      color: var(--muted);
      font-weight:650;
      font-size:16px;
    }
    .noteLabel em{
      font-style:italic;
      color: rgba(235,245,255,.42);
      font-weight:600;
    }

    /* Make tight overall */
    .tightTop{ margin-top: 4px; }
  </style>
</head>

<body>
  <div class="app">
    <h1>Vitals Tracker</h1>

    <!-- HOME -->
    <div id="home" class="card">
      <div class="homeMain">
        <button id="btnGoAdd" class="btn primary">Add</button>
        <button id="btnGoLog" class="btn">Log</button>
        <button id="btnGoCharts" class="btn">Charts</button>

        <div class="homeFooterRow">
          <!-- Install/Uninstall small (left), Exit small (right) -->
          <button id="btnInstall" class="btn small">Install</button>
          <div class="grow"></div>
          <button id="btnExitHome" class="btn small">Exit</button>
        </div>

        <div class="subtle">Data stays on your phone (local only).</div>

        <div class="footerTiny">
          <div>v1.13</div>
          <div>developed by Keyth Jyles</div>
        </div>
      </div>
    </div>

    <!-- ADD -->
    <div id="add" class="card hidden">
      <div id="timeLine" class="timeLine">--:--:-- --, --/--/----</div>

      <div class="triple">
        <div>
          <div class="miniLabel">Systolic</div>
          <input id="sys" class="field" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 132" />
        </div>
        <div>
          <div class="miniLabel">Diastolic</div>
          <input id="dia" class="field" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 91" />
        </div>
        <div>
          <div class="miniLabel">Heart Rate</div>
          <input id="hr" class="field" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 72" />
        </div>
      </div>

      <div class="noteLabel">Notes <em>(optional)</em></div>
      <textarea id="notes" class="field" placeholder="optional"></textarea>

      <div class="label">Symptoms</div>
      <div id="symGrid" class="symGrid"></div>

      <!-- Buttons just below symptoms (not at bottom of screen) -->
      <div class="panelButtons">
        <button id="btnSave" class="btn primary grow">Save</button>
        <button id="btnBackFromAdd" class="btn grow">Back</button>
      </div>
    </div>

    <!-- LOG -->
    <div id="log" class="card hidden">
      <div class="row center">
        <button id="btnExportLog" class="btn small">Export</button>
        <!-- Add button inserted in the middle of existing row -->
        <button id="btnAddFromLog" class="btn small">Add</button>
        <div class="grow"></div>
        <button id="btnBackFromLog" class="btn small">Back</button>
      </div>

      <div class="label tightTop">Search</div>
      <input id="search" class="field" placeholder="Type a word: sweaty, dizzy, headache..." />

      <!-- Date range calendar fields (not dropdowns). Defaults to all -->
      <div class="filters">
        <div class="dateField">
          <div class="miniLabel">From</div>
          <input id="fromDate" class="field" type="date" />
        </div>
        <div class="dateField">
          <div class="miniLabel">To</div>
          <input id="toDate" class="field" type="date" />
        </div>
      </div>

      <div id="logList"></div>
    </div>

    <!-- CHARTS -->
    <div id="charts" class="card hidden">
      <div class="row center">
        <button id="btnExportCharts" class="btn small">Export</button>
        <div class="grow"></div>
        <button id="btnBackFromCharts" class="btn small">Back</button>
      </div>

      <div class="subtle">Systolic, Diastolic, and Heart Rate over time.</div>

      <div class="filters">
        <div class="dateField">
          <div class="miniLabel">From</div>
          <input id="chartFrom" class="field" type="date" />
        </div>
        <div class="dateField">
          <div class="miniLabel">To</div>
          <input id="chartTo" class="field" type="date" />
        </div>
      </div>

      <canvas id="chart" width="900" height="520"></canvas>
    </div>

  </div>

<script>
(() => {
  "use strict";

  // =========================
  // Data model + persistence
  // =========================
  const STORAGE_KEY = "vitals_tracker_records_v1";
  const SYMPTOMS = [
    "Sweaty","Dizzy","Panic","Brain fog","Chest tight","Headache",
    "Nausea","Short breath","Hot ears","Shaky","Blurred vision","Weakness"
  ];

  /** record: {ts:number, sys:number|null, dia:number|null, hr:number|null, notes:string, symptoms:string[]} */
  function loadRecords(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return [];
      // sanitize
      return arr
        .filter(r => r && typeof r.ts === "number")
        .map(r => ({
          ts: r.ts,
          sys: numOrNull(r.sys),
          dia: numOrNull(r.dia),
          hr:  numOrNull(r.hr),
          notes: (r.notes ?? "").toString(),
          symptoms: Array.isArray(r.symptoms) ? r.symptoms.map(String) : []
        }))
        .sort((a,b)=> b.ts - a.ts);
    }catch{
      return [];
    }
  }

  function saveRecords(recs){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(recs));
  }

  function numOrNull(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  // =========================
  // UI helpers
  // =========================
  const $ = (id) => document.getElementById(id);

  const screens = ["home","add","log","charts"];
  function show(screen){
    for(const s of screens){
      $(s).classList.toggle("hidden", s !== screen);
    }
    // Defaults: log & charts populate with ALL data immediately
    if(screen === "log") renderLog();
    if(screen === "charts") renderCharts();
    if(screen === "add"){
      // reset add fields (do not change layout)
      // keep symptoms unchecked
      clearAddForm();
      tickTime(); // start immediately
      adjustTimeFont(); // fit one line
    }
  }

  function fmtDateTime(ts){
    const d = new Date(ts);
    const parts = new Intl.DateTimeFormat(undefined, {
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).formatToParts(d);

    // Build "MM/DD/YYYY, HH:MM:SS AM" style but stable
    const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
    const mm = map.month, dd = map.day, yy = map.year;
    const hh = map.hour, mi = map.minute, ss = map.second;
    const dp = map.dayPeriod ? ` ${map.dayPeriod}` : "";
    return `${mm}/${dd}/${yy}, ${hh}:${mi}:${ss}${dp}`;
  }

  function fmtTimeCommaDate(ts){
    const d = new Date(ts);
    const time = new Intl.DateTimeFormat(undefined, {
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).format(d);
    const date = new Intl.DateTimeFormat(undefined, {
      month:"2-digit", day:"2-digit", year:"numeric"
    }).format(d);
    return `${time}, ${date}`; // must stay one line
  }

  function isoDate(ts){
    const d = new Date(ts);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  // =========================
  // Add screen: symptoms grid
  // =========================
  const symGrid = $("symGrid");
  const symState = new Map();

  function buildSymptoms(){
    symGrid.innerHTML = "";
    symState.clear();

    for(const name of SYMPTOMS){
      const item = document.createElement("div");
      item.className = "symItem";
      item.setAttribute("role","checkbox");
      item.setAttribute("aria-checked","false");
      item.tabIndex = 0;

      const box = document.createElement("div");
      box.className = "box";
      const check = document.createElement("div");
      check.className = "check";
      box.appendChild(check);

      const text = document.createElement("div");
      text.className = "symText";
      text.textContent = name;

      item.appendChild(box);
      item.appendChild(text);

      const setSelected = (on) => {
        item.classList.toggle("selected", on);
        item.setAttribute("aria-checked", on ? "true" : "false");
        symState.set(name, on);
      };

      setSelected(false);

      const toggle = () => setSelected(!symState.get(name));
      item.addEventListener("click", toggle);
      item.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          toggle();
        }
      });

      symGrid.appendChild(item);
    }
  }

  function selectedSymptoms(){
    return SYMPTOMS.filter(s => symState.get(s));
  }

  function clearAddForm(){
    $("sys").value = "";
    $("dia").value = "";
    $("hr").value = "";
    $("notes").value = "";
    for(const k of SYMPTOMS) symState.set(k,false);
    // update DOM selected classes
    for(const el of symGrid.querySelectorAll(".symItem")){
      el.classList.remove("selected");
      el.setAttribute("aria-checked","false");
    }
  }

  // =========================
  // Time line: dynamic fit (no wrap)
  // =========================
  let timeTimer = null;

  function tickTime(){
    const line = $("timeLine");
    const now = Date.now();
    line.textContent = fmtTimeCommaDate(now);
    adjustTimeFont();
    if(timeTimer) clearTimeout(timeTimer);
    // align updates close to 1s
    timeTimer = setTimeout(tickTime, 900);
  }

  function adjustTimeFont(){
    const el = $("timeLine");
    if(!el) return;

    // Start from computed size and shrink until it fits container width.
    // This keeps it on ONE line. (white-space:nowrap + JS shrink)
    const parent = el.parentElement;
    if(!parent) return;

    const maxW = parent.clientWidth - 8; // small safety
    let fs = parseFloat(getComputedStyle(el).fontSize) || 28;

    // If it fits, try to grow slightly up to clamp max already applied—no need.
    // If it overflows, shrink down to minimum 16px.
    let guard = 0;
    while(el.scrollWidth > maxW && fs > 16 && guard < 20){
      fs -= 1;
      el.style.fontSize = fs + "px";
      guard++;
    }
  }

  // =========================
  // Log screen: filters + render
  // =========================
  function parseDateField(v){
    // v in YYYY-MM-DD; interpret as local midnight
    if(!v) return null;
    const [y,m,d] = v.split("-").map(Number);
    if(!y || !m || !d) return null;
    return new Date(y, m-1, d, 0, 0, 0, 0).getTime();
  }

  function clampEndOfDay(ts){
    // convert midnight to end-of-day
    const d = new Date(ts);
    d.setHours(23,59,59,999);
    return d.getTime();
  }

  function recordMatches(rec, q){
    if(!q) return true;
    const s = q.toLowerCase().trim();
    if(!s) return true;

    const bp = `${rec.sys ?? ""}/${rec.dia ?? ""}`.toLowerCase();
    const hr = `${rec.hr ?? ""}`.toLowerCase();
    const notes = (rec.notes || "").toLowerCase();
    const sym = (rec.symptoms || []).join(", ").toLowerCase();
    const dt = fmtDateTime(rec.ts).toLowerCase();

    return (
      bp.includes(s) ||
      hr.includes(s) ||
      notes.includes(s) ||
      sym.includes(s) ||
      dt.includes(s)
    );
  }

  function filteredRecords({fromId,toId,searchId}){
    const recs = loadRecords(); // already sorted desc
    const q = (searchId ? $(searchId).value : "").trim();

    const fromV = fromId ? $(fromId).value : "";
    const toV   = toId ? $(toId).value : "";

    const fromTs = parseDateField(fromV);
    const toMid  = parseDateField(toV);
    const toTs   = toMid != null ? clampEndOfDay(toMid) : null;

    return recs.filter(r => {
      if(fromTs != null && r.ts < fromTs) return false;
      if(toTs != null && r.ts > toTs) return false;
      return recordMatches(r, q);
    });
  }

  function renderLog(){
    const list = $("logList");
    const recs = filteredRecords({fromId:"fromDate", toId:"toDate", searchId:"search"});

    list.innerHTML = "";
    if(recs.length === 0){
      const empty = document.createElement("div");
      empty.className = "subtle";
      empty.style.marginTop = "10px";
      empty.textContent = "No matching records.";
      list.appendChild(empty);
      return;
    }

    for(const r of recs){
      const e = document.createElement("div");
      e.className = "entry";

      const top = document.createElement("div");
      top.className = "entryTop";

      const t = document.createElement("div");
      t.className = "entryTime";
      t.textContent = fmtDateTime(r.ts);

      top.appendChild(t);
      e.appendChild(top);

      const line1 = document.createElement("div");
      line1.className = "entryBPHR";

      const bp = document.createElement("div");
      bp.className = "bpBig";
      bp.textContent = `BP ${r.sys ?? "—"}/${r.dia ?? "—"}`;

      const hr = document.createElement("div");
      hr.className = "hrBig";
      hr.textContent = `HR ${r.hr ?? "—"}`;

      line1.appendChild(bp);
      line1.appendChild(hr);
      e.appendChild(line1);

      const sym = (r.symptoms && r.symptoms.length) ? r.symptoms.join(", ") : "None";
      const notes = (r.notes && r.notes.trim()) ? r.notes.trim() : "None";

      const l2 = document.createElement("div");
      l2.className = "entryLine";
      l2.innerHTML = `<b>Symptoms:</b> ${escapeHtml(sym)}`;
      e.appendChild(l2);

      const l3 = document.createElement("div");
      l3.className = "entryLine";
      l3.innerHTML = `<b>Notes:</b> ${escapeHtml(notes)}`;
      e.appendChild(l3);

      list.appendChild(e);
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =========================
  // Export
  // =========================
  function exportText(recs){
    // Export currently filtered log as text
    const lines = recs.map(r => {
      const dt = fmtDateTime(r.ts);
      const bp = `BP ${r.sys ?? "—"}/${r.dia ?? "—"}`;
      const hr = `HR ${r.hr ?? "—"}`;
      const sym = (r.symptoms && r.symptoms.length) ? r.symptoms.join(", ") : "None";
      const notes = (r.notes && r.notes.trim()) ? r.notes.trim() : "None";
      return `${dt}\n${bp} • ${hr}\nSymptoms: ${sym}\nNotes: ${notes}\n`;
    });

    const out = lines.join("\n");
    // Copy to clipboard if possible; otherwise download
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(out).then(() => {
        alert("Export copied to clipboard.");
      }).catch(() => {
        downloadText(out, "vitals_export.txt");
      });
    }else{
      downloadText(out, "vitals_export.txt");
    }
  }

  function downloadText(text, filename){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // =========================
  // Charts
  // =========================
  function renderCharts(){
    const canvas = $("chart");
    const ctx = canvas.getContext("2d");
    const recs = filteredRecords({fromId:"chartFrom", toId:"chartTo", searchId:null}).slice().reverse(); // chronological

    // Clear
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(recs.length === 0){
      drawChartEmpty(ctx, canvas, "No data in range.");
      return;
    }

    const sys = recs.map(r => r.sys).filter(v => v != null);
    const dia = recs.map(r => r.dia).filter(v => v != null);
    const hr  = recs.map(r => r.hr ).filter(v => v != null);

    const all = [...sys,...dia,...hr].filter(v => v != null);
    if(all.length === 0){
      drawChartEmpty(ctx, canvas, "No numeric values.");
      return;
    }

    const minV = Math.min(...all);
    const maxV = Math.max(...all);
    const padV = Math.max(8, Math.round((maxV-minV)*0.12));
    const yMin = minV - padV;
    const yMax = maxV + padV;

    const W = canvas.width, H = canvas.height;
    const pad = {l:62, r:18, t:18, b:56};

    // Background
    roundRect(ctx, 0, 0, W, H, 22, "rgba(255,255,255,.02)", "rgba(235,245,255,.12)");

    // Grid + axes labels (bigger, readable)
    ctx.font = "16px system-ui,Segoe UI,Roboto";
    ctx.fillStyle = "rgba(235,245,255,.60)";
    ctx.strokeStyle = "rgba(235,245,255,.10)";
    ctx.lineWidth = 1;

    const ticks = 5;
    for(let i=0;i<=ticks;i++){
      const y = pad.t + (H - pad.t - pad.b) * (i/ticks);
      ctx.beginPath();
      ctx.moveTo(pad.l, y);
      ctx.lineTo(W - pad.r, y);
      ctx.stroke();

      const val = Math.round(yMax - (yMax-yMin)*(i/ticks));
      ctx.fillText(String(val), 16, y+6);
    }

    // X labels: show up to 4 dates
    const xCount = recs.length;
    const labelCount = Math.min(4, xCount);
    for(let i=0;i<labelCount;i++){
      const idx = Math.round((xCount-1) * (i/(labelCount-1 || 1)));
      const x = xTo(idx, xCount, pad, W);
      const d = new Date(recs[idx].ts);
      const lab = new Intl.DateTimeFormat(undefined, {month:"2-digit", day:"2-digit"}).format(d);
      ctx.fillStyle = "rgba(235,245,255,.56)";
      ctx.fillText(lab, x-16, H-22);
    }

    // Lines
    drawSeries(ctx, recs.map(r=>r.sys), yMin, yMax, pad, W, H, "rgba(79,140,255,.98)");
    drawSeries(ctx, recs.map(r=>r.dia), yMin, yMax, pad, W, H, "rgba(216,224,240,.88)");
    drawSeries(ctx, recs.map(r=>r.hr ), yMin, yMax, pad, W, H, "rgba(120,220,180,.92)");

    // Legend (larger)
    const lx = pad.l + 8;
    let ly = pad.t + 22;
    ctx.font = "18px system-ui,Segoe UI,Roboto";
    function legend(text, color){
      ctx.fillStyle = color;
      ctx.fillRect(lx, ly-12, 18, 6);
      ctx.fillStyle = "rgba(235,245,255,.70)";
      ctx.fillText(text, lx+26, ly-6);
      ly += 24;
    }
    legend("Systolic", "rgba(79,140,255,.98)");
    legend("Diastolic", "rgba(216,224,240,.88)");
    legend("Heart Rate", "rgba(120,220,180,.92)");
  }

  function drawChartEmpty(ctx, canvas, msg){
    const W = canvas.width, H = canvas.height;
    roundRect(ctx, 0,0,W,H,22,"rgba(255,255,255,.02)","rgba(235,245,255,.12)");
    ctx.fillStyle = "rgba(235,245,255,.50)";
    ctx.font = "18px system-ui,Segoe UI,Roboto";
    ctx.fillText(msg, 22, 44);
  }

  function xTo(i, n, pad, W){
    if(n<=1) return pad.l;
    const span = W - pad.l - pad.r;
    return pad.l + span * (i/(n-1));
  }

  function yTo(v, yMin, yMax, pad, H){
    const span = H - pad.t - pad.b;
    const t = (v - yMin) / (yMax - yMin || 1);
    return pad.t + span * (1 - t);
  }

  function drawSeries(ctx, values, yMin, yMax, pad, W, H, color){
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.lineJoin = "round";
    ctx.lineCap = "round";

    let started = false;
    ctx.beginPath();
    for(let i=0;i<values.length;i++){
      const v = values[i];
      if(v == null) { started = false; continue; }
      const x = xTo(i, values.length, pad, W);
      const y = yTo(v, yMin, yMax, pad, H);
      if(!started){
        ctx.moveTo(x,y);
        started = true;
      }else{
        ctx.lineTo(x,y);
      }
    }
    ctx.stroke();
  }

  function roundRect(ctx, x,y,w,h,r, fill, stroke){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
    if(fill){
      ctx.fillStyle = fill;
      ctx.fill();
    }
    if(stroke){
      ctx.strokeStyle = stroke;
      ctx.lineWidth = 1;
      ctx.stroke();
    }
  }

  // =========================
  // Install / "Uninstall" UX
  // =========================
  let deferredPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    refreshInstallButton();
  });

  window.addEventListener("appinstalled", () => {
    deferredPrompt = null;
    refreshInstallButton();
  });

  function isStandalone(){
    // Android Chrome: matchMedia works; iOS uses navigator.standalone
    return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
  }

  function refreshInstallButton(){
    const btn = $("btnInstall");
    if(isStandalone()){
      btn.textContent = "Uninstall";
    }else{
      btn.textContent = "Install";
    }
  }

  $("btnInstall").addEventListener("click", async () => {
    if(isStandalone()){
      // You cannot programmatically uninstall a PWA. Provide clean instruction.
      // IMPORTANT: uninstall does NOT delete site data automatically (browser-dependent).
      alert(
        "Uninstall:\n\n" +
        "Android: press-and-hold the app icon → Uninstall.\n" +
        "This usually does NOT delete your saved data, but some devices/browsers may clear it.\n\n" +
        "If you want to delete data on purpose, clear site storage in your browser settings."
      );
      return;
    }

    if(deferredPrompt){
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch {}
      deferredPrompt = null;
      refreshInstallButton();
      return;
    }

    alert("Install is available when your browser offers it (menu → Install app).");
  });

  // =========================
  // Exit
  // =========================
  $("btnExitHome").addEventListener("click", () => {
    // Web apps cannot reliably close the tab unless opened by script.
    // Attempt and then instruct.
    window.close();
    setTimeout(() => {
      alert("If it didn’t close: use your phone’s Back/Home.");
    }, 200);
  });

  // =========================
  // Navigation buttons
  // =========================
  $("btnGoAdd").addEventListener("click", () => show("add"));
  $("btnGoLog").addEventListener("click", () => show("log"));
  $("btnGoCharts").addEventListener("click", () => show("charts"));

  $("btnBackFromAdd").addEventListener("click", () => show("home"));
  $("btnBackFromLog").addEventListener("click", () => show("home"));
  $("btnBackFromCharts").addEventListener("click", () => show("home"));

  // Add button in the middle on Log row
  $("btnAddFromLog").addEventListener("click", () => show("add"));

  // =========================
  // Save behavior: Save -> Log (new entry at top)
  // =========================
  $("btnSave").addEventListener("click", () => {
    const sys = intOrNull($("sys").value);
    const dia = intOrNull($("dia").value);
    const hr  = intOrNull($("hr").value);
    const notes = ($("notes").value || "").toString();
    const symptoms = selectedSymptoms();

    // basic: require at least one numeric value (prevents empty spam)
    if(sys==null && dia==null && hr==null && !notes.trim() && symptoms.length===0){
      alert("Enter at least one value (BP, HR, notes, or symptom).");
      return;
    }

    const recs = loadRecords();
    const rec = { ts: Date.now(), sys, dia, hr, notes, symptoms };
    recs.unshift(rec);
    saveRecords(recs);

    // After save: go to log and show the new record at top
    show("log");
    // ensure date filters default to ALL (blank) so everything shows
    $("fromDate").value = "";
    $("toDate").value = "";
    $("search").value = "";
    renderLog();

    // scroll list top
    $("logList").scrollIntoView({behavior:"smooth", block:"start"});
  });

  function intOrNull(v){
    const t = String(v).trim();
    if(!t) return null;
    const n = Number(t);
    if(!Number.isFinite(n)) return null;
    return Math.round(n);
  }

  // =========================
  // Filters trigger render (Log/Charts)
  // =========================
  ["search","fromDate","toDate"].forEach(id => {
    $(id).addEventListener("input", () => renderLog());
    $(id).addEventListener("change", () => renderLog());
  });

  ["chartFrom","chartTo"].forEach(id => {
    $(id).addEventListener("input", () => renderCharts());
    $(id).addEventListener("change", () => renderCharts());
  });

  // Export buttons (only on Log/Charts panels)
  $("btnExportLog").addEventListener("click", () => {
    const recs = filteredRecords({fromId:"fromDate", toId:"toDate", searchId:"search"});
    exportText(recs);
  });

  $("btnExportCharts").addEventListener("click", () => {
    const recs = filteredRecords({fromId:"chartFrom", toId:"chartTo", searchId:null});
    exportText(recs);
  });

  // =========================
  // PWA manifest inline (single-file)
  // =========================
  function injectManifest(){
    // Simple icon as SVG data URL
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#2f78ff"/>
      <stop offset="1" stop-color="#0b1324"/>
    </linearGradient>
  </defs>
  <rect width="512" height="512" rx="110" fill="url(#g)"/>
  <path d="M128 290h70l26-94 44 160 30-98h84" fill="none"
        stroke="rgba(235,245,255,.92)" stroke-width="28" stroke-linecap="round" stroke-linejoin="round"/>
  <circle cx="160" cy="290" r="10" fill="rgba(235,245,255,.92)"/>
  <circle cx="382" cy="258" r="10" fill="rgba(235,245,255,.92)"/>
</svg>`;
    const encoded = encodeURIComponent(svg)
      .replace(/'/g,"%27").replace(/"/g,"%22");

    const icon = `data:image/svg+xml;charset=utf-8,${encoded}`;

    const manifest = {
      name: "Vitals Tracker",
      short_name: "Vitals",
      start_url: ".",
      display: "standalone",
      background_color: "#0b1324",
      theme_color: "#0b1324",
      icons: [
        { src: icon, sizes: "512x512", type: "image/svg+xml", purpose: "any" }
      ]
    };

    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    $("manifestLink").setAttribute("href", url);
  }

  // =========================
  // Service worker (optional). Single-file sw via blob URL.
  // =========================
  async function registerSW(){
    if(!("serviceWorker" in navigator)) return;

    const swCode =
`self.addEventListener('install', (e)=>{ self.skipWaiting(); });
self.addEventListener('activate', (e)=>{ e.waitUntil(self.clients.claim()); });
self.addEventListener('fetch', (e)=>{ /* network-first */ });`;

    const blob = new Blob([swCode], {type:"text/javascript"});
    const swUrl = URL.createObjectURL(blob);
    try { await navigator.serviceWorker.register(swUrl); } catch {}
  }

  // =========================
  // Init
  // =========================
  buildSymptoms();
  injectManifest();
  registerSW();
  refreshInstallButton();

  // Default date filters: blank => ALL data
  $("fromDate").value = "";
  $("toDate").value = "";
  $("chartFrom").value = "";
  $("chartTo").value = "";

  // Initial view
  show("home");

  // Resize handling for time line fitting
  window.addEventListener("resize", () => {
    if(!$("add").classList.contains("hidden")) adjustTimeFont();
  });

})();  
</script>
</body>
</html>
