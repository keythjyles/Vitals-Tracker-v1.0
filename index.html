<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="color-scheme" content="dark" />
  <title>Vitals Tracker</title>

  <!-- PWA: manifest (single-file via data: URI) -->
  <link id="manifestLink" rel="manifest" href="" />

  <!-- iOS PWA hints -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Vitals Tracker" />
  <link id="appleTouchIcon" rel="apple-touch-icon" href="" />

  <style>
    :root{
      --bg0:#070b14;
      --bg1:#0b1220;

      --cardA: rgba(16,26,42,.95);
      --cardB: rgba(12,20,34,.92);

      --line:#23314a;
      --line2:#2e3e5c;

      --text:#d8e0f0;
      --muted:#9aa8c4;
      --muted2:#7f8fb0;

      --accent:#4f8cff;

      --radius:18px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --focus: 0 0 0 3px rgba(79,140,255,.30);

      --h1: 34px;
      --h2: 18px;
      --label: 13px;
      --small: 12px;
      --btn: 14px;
      --input: 16px;

      --pad: 14px;
      --gap: 10px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, #142443 0%, rgba(20,36,67,0) 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(79,140,255,.16) 0%, rgba(79,140,255,0) 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, #060913);
      color: var(--text);
    }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 18px 14px 22px;
    }

    .title{
      font-size: var(--h1);
      font-weight: 700;
      letter-spacing: .2px;
      margin: 6px 2px 10px;
      text-shadow: 0 2px 14px rgba(0,0,0,.35);
    }

    .divider{
      height:1px;
      background: linear-gradient(90deg, rgba(35,49,74,0), rgba(35,49,74,.85), rgba(35,49,74,0));
      margin: 10px 0 16px;
    }

    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border: 1px solid rgba(46,62,92,.72);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }

    .hidden{ display:none !important; }

    .toolbar{
      display:flex;
      gap: 10px;
      flex-wrap: nowrap;
      align-items:center;
      justify-content:flex-start;
    }
    .toolbar.spread{
      justify-content: space-between;
      width: 100%;
      gap: 12px;
    }
    .toolbar.spread .leftGroup,
    .toolbar.spread .rightGroup{
      display:flex;
      gap: 10px;
      align-items:center;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(46,62,92,.9);
      background: linear-gradient(180deg, rgba(22,34,54,.88), rgba(16,26,42,.88));
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: var(--btn);
      font-weight: 650;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 6px 14px rgba(0,0,0,.22);
      min-width: 96px;
      text-align:center;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(79,140,255,.85);
      background: linear-gradient(180deg, rgba(79,140,255,.92), rgba(58,114,221,.92));
      color:#081224;
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(46,62,92,.75);
    }

    .homeStack{ display:flex; flex-direction:column; gap: 12px; }
    .btnBig{
      width:100%;
      padding: 18px 16px;
      border-radius: 18px;
      font-size: 20px;
      font-weight: 750;
      min-width: auto;
    }

    .sectionTitle{
      font-size: var(--h2);
      font-weight: 750;
      margin: 10px 2px 8px;
    }
    .subtle{
      color: var(--muted);
      font-size: var(--small);
      margin-top: 10px;
      line-height: 1.35;
    }

    .metaLine{
      color: var(--muted2);
      font-size: 12px;
      margin-top: 8px;
      letter-spacing: .15px;
    }

    label{
      display:block;
      font-size: var(--label);
      font-weight: 650;
      color: var(--muted);
      margin: 8px 2px 6px;
      letter-spacing: .12px;
    }

    input, textarea, select{
      width:100%;
      padding: 11px 12px;
      background: rgba(255,255,255,.07);
      color: var(--text);
      border: 2px solid rgba(46,62,92,.92);
      border-radius: 14px;
      outline:none;
      font-size: var(--input);
    }
    input::placeholder, textarea::placeholder{ color: rgba(154,168,196,.62); }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(79,140,255,.95);
      box-shadow: var(--focus);
    }

    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 380px){
      .grid3{ grid-template-columns: 1fr 1fr; }
      .grid3 .forceRow{ grid-column: 1 / -1; }
    }

    /* Add screen time line: larger, more prominent */
    .nowline{
      font-size: 18px;
      font-weight: 750;
      color: rgba(216,224,240,.88);
      margin: 4px 2px 10px;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Symptoms: tightened substantially */
    .symptomsWrap{ margin-top: 2px; padding-top: 0; }
    .symptomsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px 14px;          /* tighter row gap */
      align-items:center;
    }
    .symRow{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0;            /* remove vertical padding */
      margin: 0;             /* remove margins */
      cursor:pointer;
      user-select:none;
      line-height: 1.15;     /* tighter line height */
    }
    .symRow input[type="checkbox"]{
      appearance:none;
      -webkit-appearance:none;
      width: 18px;
      height: 18px;
      border-radius: 5px;
      border: 2px solid rgba(154,168,196,.9);
      background: transparent;
      display:inline-block;
      position: relative;
      flex: 0 0 auto;
    }
    .symRow input[type="checkbox"]:checked{
      border-color: rgba(79,140,255,.95);
      background: rgba(79,140,255,.16);
    }
    .symRow input[type="checkbox"]:checked::after{
      content:"";
      position:absolute;
      left: 4px;
      top: 1px;
      width: 6px;
      height: 10px;
      border: solid rgba(216,224,240,.95);
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    .symRow span{
      font-size: 14px;
      font-weight: 650;
      letter-spacing: .08px;
      color: var(--text);
    }

    .logControls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:end;
      margin-top: 10px;
    }
    @media (max-width: 600px){
      .logControls{ grid-template-columns: 1fr; }
      .toolbar{ flex-wrap: wrap; }
    }
    .smallLabel{
      font-size: 12px;
      font-weight: 650;
      color: var(--muted2);
      margin-bottom: 6px;
    }

    .logList{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .entry{
      background: linear-gradient(180deg, rgba(12,20,34,.92), rgba(10,16,28,.92));
      border: 1px solid rgba(46,62,92,.72);
      border-radius: 18px;
      padding: 12px;
    }
    .entryTop{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap: 10px;
      margin-bottom: 6px;
      color: var(--muted2);
      font-size: 12px;
      letter-spacing: .15px;
      flex-wrap:wrap;
    }
    .entryMain{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap: 12px;
      flex-wrap:wrap;
      margin-bottom: 6px;
    }
    .bp{ font-size: 22px; font-weight: 820; letter-spacing: .15px; }
    .hr{ font-size: 18px; font-weight: 760; opacity: .92; white-space:nowrap; }
    .entryText{
      font-size: 14px;
      opacity: .92;
      line-height: 1.35;
    }
    .entryText b{ color: var(--muted); font-weight: 760; }

    .mutedBlock{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
      margin-top: 6px;
    }

    .chartBox{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(46,62,92,.70);
      border-radius: 18px;
      padding: 10px;
    }
    canvas{ width:100%; height:260px; display:block; }

    .homeVersion{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(154,168,196,.75);
      letter-spacing: .15px;
    }

    /* Add screen buttons: directly below symptoms list */
    .addButtons{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: nowrap;
    }
    .addButtons .btn{
      flex: 1 1 0;
      min-width: 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">Vitals Tracker</div>
    <div class="divider"></div>

    <!-- HOME -->
    <div id="screenHome" class="card">
      <div class="homeStack">
        <button class="btn btnBig primary" id="goAdd">Add</button>
        <button class="btn btnBig" id="goLog">Log</button>
        <button class="btn btnBig" id="goCharts">Charts</button>
      </div>

      <!-- Home: no Export at all -->
      <div class="toolbar spread" style="margin-top:14px;">
        <div class="leftGroup">
          <button class="btn ghost hidden" id="btnInstall">Install</button>
        </div>
        <div class="rightGroup">
          <button class="btn ghost" id="btnExitHome">Exit</button>
        </div>
      </div>

      <div class="subtle">Data stays on your phone (local only).</div>
      <div class="metaLine" id="homeCount">Records: 0</div>
      <div class="homeVersion">v1.07</div>
    </div>

    <!-- ADD -->
    <div id="screenAdd" class="card hidden" style="margin-top:14px;">
      <div class="nowline" id="nowLine">09:38:26 PM, 12/23/2025</div>

      <div class="grid3">
        <div>
          <label for="sys">Systolic</label>
          <input id="sys" inputmode="numeric" pattern="[0-9]*" placeholder="132" />
        </div>
        <div>
          <label for="dia">Diastolic</label>
          <input id="dia" inputmode="numeric" pattern="[0-9]*" placeholder="91" />
        </div>
        <div class="forceRow">
          <label for="hr">Heart Rate</label>
          <input id="hr" inputmode="numeric" pattern="[0-9]*" placeholder="72" />
        </div>
      </div>

      <label for="notes">Notes <i style="font-weight:650;color:var(--muted2)">(optional)</i></label>
      <input id="notes" placeholder="optional" />

      <label style="margin-bottom:4px;">Symptoms</label>
      <div class="symptomsWrap">
        <div class="symptomsGrid" id="symptomsGrid"></div>
      </div>

      <!-- Buttons: just below symptoms list -->
      <div class="addButtons">
        <button class="btn primary" id="saveAdd">Save</button>
        <button class="btn" id="backFromAdd">Back</button>
        <button class="btn ghost" id="exitFromAdd">Exit</button>
      </div>
    </div>

    <!-- LOG -->
    <div id="screenLog" class="card hidden" style="margin-top:14px;">
      <div class="toolbar">
        <button class="btn primary" id="btnExportLog" style="display:none;">Export</button>
        <button class="btn" id="backFromLog">Back</button>
        <button class="btn ghost" id="exitFromLog">Exit</button>
      </div>

      <div class="sectionTitle">Search</div>
      <input id="searchBox" placeholder="Type a word: sweaty, dizzy, headache..." />

      <!-- Calendar range (no dropdowns) -->
      <div class="logControls">
        <div>
          <div class="smallLabel">From</div>
          <input id="fromDate" type="date" />
        </div>
        <div>
          <div class="smallLabel">To</div>
          <input id="toDate" type="date" />
        </div>
      </div>

      <div class="metaLine" id="logCount">Showing: 0 of 0</div>
      <div class="logList" id="logList"></div>
    </div>

    <!-- CHARTS -->
    <div id="screenCharts" class="card hidden" style="margin-top:14px;">
      <div class="toolbar">
        <button class="btn primary" id="btnExportCharts" style="display:none;">Export</button>
        <button class="btn" id="backFromCharts">Back</button>
        <button class="btn ghost" id="exitFromCharts">Exit</button>
      </div>

      <div class="sectionTitle">Charts</div>

      <!-- Date options (default all) -->
      <div class="logControls">
        <div>
          <div class="smallLabel">From</div>
          <input id="chartFrom" type="date" />
        </div>
        <div>
          <div class="smallLabel">To</div>
          <input id="chartTo" type="date" />
        </div>
      </div>

      <div class="mutedBlock" id="chartHint"></div>

      <div class="chartBox" style="margin-top:10px;">
        <canvas id="chartCanvas" width="900" height="260" aria-label="Vitals chart" role="img"></canvas>
      </div>
    </div>
  </div>

<script>
(function setupPWA(){
  const iconSVG = encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#4f8cff"/>
          <stop offset="1" stop-color="#101a2a"/>
        </linearGradient>
      </defs>
      <rect width="512" height="512" rx="120" fill="url(#g)"/>
      <rect x="120" y="130" width="272" height="252" rx="34" fill="#d8e0f0" opacity="0.95"/>
      <path d="M170 300h55l25-60 40 120 30-70h55" fill="none" stroke="#081224" stroke-width="26" stroke-linecap="round" stroke-linejoin="round"/>
      <text x="256" y="210" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="52" font-weight="800" fill="#081224">VT</text>
    </svg>
  `);
  const iconData = "data:image/svg+xml;charset=utf-8," + iconSVG;

  const manifest = {
    name: "Vitals Tracker",
    short_name: "Vitals",
    start_url: "./",
    scope: "./",
    display: "standalone",
    background_color: "#0b1220",
    theme_color: "#0b1220",
    icons: [{ src: iconData, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }]
  };
  const manifestJSON = encodeURIComponent(JSON.stringify(manifest));
  document.getElementById("manifestLink").href =
    "data:application/manifest+json;charset=utf-8," + manifestJSON;
  document.getElementById("appleTouchIcon").href = iconData;

  if ("serviceWorker" in navigator) {
    const swCode = `
      const CACHE = "vitals-tracker-singlefile-cache-v1";
      self.addEventListener("install", (e) => {
        e.waitUntil(caches.open(CACHE).then((cache) => cache.addAll(["./"])));
        self.skipWaiting();
      });
      self.addEventListener("activate", (e) => {
        e.waitUntil(
          caches.keys().then(keys => Promise.all(keys.map(k => (k !== CACHE) ? caches.delete(k) : null)))
        );
        self.clients.claim();
      });
      self.addEventListener("fetch", (e) => {
        const req = e.request;
        if (req.method !== "GET") return;
        e.respondWith(
          caches.match(req).then((cached) => {
            if (cached) return cached;
            return fetch(req).then((resp) => {
              const copy = resp.clone();
              caches.open(CACHE).then((cache) => cache.put(req, copy)).catch(()=>{});
              return resp;
            }).catch(() => cached);
          })
        );
      });
    `;
    const swBlob = new Blob([swCode], { type: "text/javascript" });
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl, { scope: "./" }).catch(()=>{});
  }

  let deferredPrompt = null;
  const btnInstall = document.getElementById("btnInstall");
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btnInstall.classList.remove("hidden");
  });
  btnInstall.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    try { await deferredPrompt.userChoice; } catch(e){}
    deferredPrompt = null;
    btnInstall.classList.add("hidden");
  });
})();

/* =========================
   Storage / utilities
========================= */
const STORAGE_KEY = "vitals_tracker_entries_v1";
const SYMPTOMS = [
  "Sweaty","Dizzy","Panic","Brain fog","Chest tight","Headache",
  "Nausea","Short breath","Hot ears","Shaky","Blurred vision","Weakness"
];

function pad2(n){ return String(n).padStart(2,"0"); }

function isValidDate(d){
  return d instanceof Date && !Number.isNaN(d.getTime());
}

function normalizeISO(ts){
  if (ts == null) return null;
  if (typeof ts === "number" && Number.isFinite(ts)){
    const d = new Date(ts);
    return isValidDate(d) ? d.toISOString() : null;
  }
  const s = String(ts).trim();
  if (!s) return null;
  const d = new Date(s);
  return isValidDate(d) ? d.toISOString() : null;
}

function sanitizeEntries(raw){
  if (!Array.isArray(raw)) return [];
  const out = [];
  for (const e of raw){
    if (!e || typeof e !== "object") continue;

    const sys = Number.isFinite(+e.sys) ? parseInt(e.sys,10) : null;
    const dia = Number.isFinite(+e.dia) ? parseInt(e.dia,10) : null;
    const hr  = Number.isFinite(+e.hr)  ? parseInt(e.hr,10)  : null;

    if (sys == null || dia == null || hr == null) continue;

    const ts = normalizeISO(e.ts) || new Date().toISOString();
    const symptoms = Array.isArray(e.symptoms) ? e.symptoms.filter(Boolean).map(String) : [];
    const notes = (e.notes == null) ? "" : String(e.notes);

    out.push({
      id: e.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)),
      ts,
      sys, dia, hr,
      symptoms,
      notes
    });
  }
  out.sort((a,b) => new Date(b.ts) - new Date(a.ts));
  return out;
}

function loadEntries(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    const cleaned = sanitizeEntries(arr);

    const anyBad = Array.isArray(arr) && arr.some(e => !normalizeISO(e && e.ts));
    if (anyBad || cleaned.length !== arr.length){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cleaned));
    }
    return cleaned;
  }catch(e){
    return [];
  }
}

function saveEntries(entries){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(sanitizeEntries(entries)));
}

function fmtDateTimeLocal(iso){
  const d = new Date(iso);
  if (!isValidDate(d)) return "Unknown date/time";
  const mm = pad2(d.getMonth()+1);
  const dd = pad2(d.getDate());
  const yyyy = d.getFullYear();
  let hh = d.getHours();
  const ampm = hh >= 12 ? "PM" : "AM";
  hh = hh % 12; if (hh === 0) hh = 12;
  const min = pad2(d.getMinutes());
  const sec = pad2(d.getSeconds());
  return `${mm}/${dd}/${yyyy}, ${pad2(hh)}:${min}:${sec} ${ampm}`;
}

function isoDayKey(iso){
  const d = new Date(iso);
  if (!isValidDate(d)) return null;
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

function clampInt(v){
  const n = parseInt(String(v).trim(), 10);
  return Number.isFinite(n) ? n : null;
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

function parseYMD(s){
  if (!s) return null;
  const m = String(s).trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return null;
  return s;
}

/* =========================
   Navigation
========================= */
const screens = {
  home: document.getElementById("screenHome"),
  add: document.getElementById("screenAdd"),
  log: document.getElementById("screenLog"),
  charts: document.getElementById("screenCharts"),
};

function show(name){
  Object.keys(screens).forEach(k => screens[k].classList.toggle("hidden", k !== name));
  refreshCounts();
  if (name === "log") renderLog();
  if (name === "charts") renderCharts();
  if (name === "add") resetAdd();
}

document.getElementById("goAdd").onclick = () => show("add");
document.getElementById("goLog").onclick = () => show("log");
document.getElementById("goCharts").onclick = () => show("charts");

document.getElementById("backFromAdd").onclick = () => show("home");
document.getElementById("backFromLog").onclick = () => show("home");
document.getElementById("backFromCharts").onclick = () => show("home");

function doExit(){
  try{ window.close(); }catch(e){}
  setTimeout(()=>{ try{ window.location.href = "about:blank"; }catch(e){} }, 250);
}
document.getElementById("btnExitHome").onclick = doExit;
document.getElementById("exitFromAdd").onclick = doExit;
document.getElementById("exitFromLog").onclick = doExit;
document.getElementById("exitFromCharts").onclick = doExit;

function refreshCounts(){
  const all = loadEntries();
  document.getElementById("homeCount").textContent = `Records: ${all.length}`;

  // Export buttons only appear once there is data
  document.getElementById("btnExportLog").style.display = all.length ? "" : "none";
  document.getElementById("btnExportCharts").style.display = all.length ? "" : "none";
}

/* =========================
   ADD screen
========================= */
const elNowLine = document.getElementById("nowLine");
const elSys = document.getElementById("sys");
const elDia = document.getElementById("dia");
const elHr  = document.getElementById("hr");
const elNotes = document.getElementById("notes");
const elSymptomsGrid = document.getElementById("symptomsGrid");

let addTimer = null;
let currentStampISO = null;

function buildSymptoms(){
  elSymptomsGrid.innerHTML = "";
  SYMPTOMS.forEach((name, idx) => {
    const row = document.createElement("label");
    row.className = "symRow";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = name;
    cb.id = "sym_" + idx;

    const txt = document.createElement("span");
    txt.textContent = name;

    row.appendChild(cb);
    row.appendChild(txt);
    elSymptomsGrid.appendChild(row);
  });
}
buildSymptoms();

function tickNow(){
  const d = new Date();
  let hh = d.getHours();
  const ampm = hh >= 12 ? "PM" : "AM";
  hh = hh % 12; if (hh === 0) hh = 12;
  const min = pad2(d.getMinutes());
  const sec = pad2(d.getSeconds());
  const time = `${pad2(hh)}:${min}:${sec} ${ampm}`;
  const date = `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}/${d.getFullYear()}`;
  elNowLine.textContent = `${time}, ${date}`;
  currentStampISO = d.toISOString();
}

function resetAdd(){
  elSys.value = "";
  elDia.value = "";
  elHr.value = "";
  elNotes.value = "";
  elSymptomsGrid.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);

  tickNow();
  if (addTimer) clearInterval(addTimer);
  addTimer = setInterval(tickNow, 1000);
}

document.getElementById("saveAdd").onclick = () => {
  const sys = clampInt(elSys.value);
  const dia = clampInt(elDia.value);
  const hr  = clampInt(elHr.value);

  if (sys === null || dia === null || hr === null){
    alert("Enter Systolic, Diastolic, and Heart Rate.");
    return;
  }

  const notes = String(elNotes.value || "").trim();
  const symptoms = Array.from(elSymptomsGrid.querySelectorAll("input[type=checkbox]:checked"))
    .map(cb => cb.value);

  const entry = {
    id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)),
    ts: currentStampISO || new Date().toISOString(),
    sys, dia, hr,
    symptoms,
    notes
  };

  const entries = loadEntries();
  entries.unshift(entry);
  saveEntries(entries);

  show("home");
};

/* =========================
   LOG + filters + export
========================= */
const elSearch = document.getElementById("searchBox");
const elFrom = document.getElementById("fromDate");
const elTo = document.getElementById("toDate");
const elLogList = document.getElementById("logList");
const elLogCount = document.getElementById("logCount");

function passesDateRange(entry, fromYMD, toYMD){
  const k = isoDayKey(entry.ts);
  if (!k) return false;
  if (fromYMD && k < fromYMD) return false;
  if (toYMD && k > toYMD) return false;
  return true;
}

function passesSearch(entry, q){
  if (!q) return true;
  const s = q.toLowerCase();
  const hay = [
    `${entry.sys}/${entry.dia}`,
    String(entry.hr),
    (entry.symptoms || []).join(", "),
    String(entry.notes || "")
  ].join(" | ").toLowerCase();
  return hay.includes(s);
}

function getFilteredEntries(){
  const entries = loadEntries();
  const q = String(elSearch.value || "").trim();
  const fromYMD = parseYMD(elFrom.value);
  const toYMD = parseYMD(elTo.value);
  return entries.filter(e => passesDateRange(e, fromYMD, toYMD) && passesSearch(e, q));
}

function renderLog(){
  const entries = loadEntries();
  const filtered = getFilteredEntries();
  elLogCount.textContent = `Showing: ${filtered.length} of ${entries.length}`;

  elLogList.innerHTML = "";
  if (filtered.length === 0){
    const empty = document.createElement("div");
    empty.className = "mutedBlock";
    empty.textContent = "No matching entries.";
    elLogList.appendChild(empty);
    return;
  }

  filtered.forEach(e => {
    const card = document.createElement("div");
    card.className = "entry";

    const top = document.createElement("div");
    top.className = "entryTop";
    top.innerHTML = `<div>${fmtDateTimeLocal(e.ts)}</div>`;

    const main = document.createElement("div");
    main.className = "entryMain";
    main.innerHTML = `
      <div class="bp">BP ${e.sys}/${e.dia}</div>
      <div class="hr">HR ${e.hr}</div>
    `;

    const txt = document.createElement("div");
    txt.className = "entryText";
    const sym = (e.symptoms && e.symptoms.length) ? e.symptoms.join(", ") : "None";
    const notes = (e.notes && e.notes.trim().length) ? e.notes.trim() : "None";
    txt.innerHTML = `<b>Symptoms:</b> ${escapeHTML(sym)}<br/><b>Notes:</b> ${escapeHTML(notes)}`;

    card.appendChild(top);
    card.appendChild(main);
    card.appendChild(txt);
    elLogList.appendChild(card);
  });
}

elSearch.addEventListener("input", renderLog);
elFrom.addEventListener("change", renderLog);
elTo.addEventListener("change", renderLog);

function buildExportText(entries){
  const lines = [];
  lines.push("VITALS LOG (filtered)");
  lines.push("Format: Date/Time | BP | HR | Symptoms | Notes");
  lines.push("");

  entries.forEach(e => {
    const dt = fmtDateTimeLocal(e.ts);
    const bp = `${e.sys}/${e.dia}`;
    const hr = `${e.hr}`;
    const sym = (e.symptoms && e.symptoms.length) ? e.symptoms.join(", ") : "None";
    const notes = (e.notes && e.notes.trim().length) ? e.notes.trim() : "None";
    lines.push(`${dt} | BP ${bp} | HR ${hr}`);
    lines.push(`Symptoms: ${sym}`);
    lines.push(`Notes: ${notes}`);
    lines.push("");
  });

  return lines.join("\n").trim() + "\n";
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    alert("Export copied to clipboard.");
    return;
  }catch(e){}
  const ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position = "fixed";
  ta.style.left = "-9999px";
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try{
    document.execCommand("copy");
    alert("Export copied to clipboard.");
  }catch(e){
    alert("Copy failed. Try again or long-press to copy.");
  }
  document.body.removeChild(ta);
}

document.getElementById("btnExportLog").onclick = () => {
  const filtered = getFilteredEntries();
  copyText(buildExportText(filtered));
};

/* =========================
   Charts (no external libs)
========================= */
const canvas = document.getElementById("chartCanvas");
const ctx = canvas.getContext("2d");
const chartHint = document.getElementById("chartHint");
const chartFrom = document.getElementById("chartFrom");
const chartTo = document.getElementById("chartTo");

function getChartFiltered(){
  const all = loadEntries().slice().reverse();
  const fromYMD = parseYMD(chartFrom.value);
  const toYMD = parseYMD(chartTo.value);
  if (!fromYMD && !toYMD) return all;

  return all.filter(e => passesDateRange(e, fromYMD, toYMD));
}

function renderCharts(){
  const all = loadEntries();
  if (all.length < 2){
    chartHint.textContent = "Add at least 2 entries to show a chart.";
    ctx.clearRect(0,0,canvas.width,canvas.height);
    return;
  }

  const data0 = getChartFiltered();
  const data = data0.slice(Math.max(0, data0.length - 30));

  if (data.length < 2){
    chartHint.textContent = "Not enough entries in that date range (need at least 2).";
    ctx.clearRect(0,0,canvas.width,canvas.height);
    return;
  }

  chartHint.textContent = "Systolic, Diastolic, and Heart Rate over time.";

  const sys = data.map(e => e.sys);
  const dia = data.map(e => e.dia);
  const hr  = data.map(e => e.hr);
  drawChart(sys, dia, hr);
}

chartFrom.addEventListener("change", renderCharts);
chartTo.addEventListener("change", renderCharts);

document.getElementById("btnExportCharts").onclick = () => {
  const data = getChartFiltered();
  copyText(buildExportText(data.slice().reverse())); // export in newest-first order
};

function drawChart(sys, dia, hr){
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  ctx.fillStyle = "rgba(255,255,255,.06)";
  ctx.fillRect(0,0,W,H);

  const pad = {l:54, r:18, t:16, b:40};
  const innerW = W - pad.l - pad.r;
  const innerH = H - pad.t - pad.b;

  const all = [...sys, ...dia, ...hr];
  let minV = Math.min(...all);
  let maxV = Math.max(...all);
  const range0 = Math.max(10, maxV - minV);
  minV = Math.floor(minV - range0*0.15);
  maxV = Math.ceil(maxV + range0*0.15);

  ctx.strokeStyle = "rgba(154,168,196,.22)";
  ctx.lineWidth = 1;

  const gridY = 5;
  ctx.font = "13px system-ui,Segoe UI,Roboto,Arial";
  ctx.fillStyle = "rgba(216,224,240,.78)";

  for (let i=0;i<=gridY;i++){
    const y = pad.t + (innerH * i/gridY);
    ctx.beginPath();
    ctx.moveTo(pad.l, y);
    ctx.lineTo(pad.l + innerW, y);
    ctx.stroke();

    const val = Math.round(maxV - ((maxV-minV)*(i/gridY)));
    ctx.fillText(String(val), 10, y+4);
  }

  const n = sys.length;
  const xAt = (i) => pad.l + (innerW * (n === 1 ? 0 : i/(n-1)));
  const yAt = (v) => pad.t + ((maxV - v) / (maxV - minV)) * innerH;

  function line(vals, stroke){
    ctx.strokeStyle = stroke;
    ctx.lineWidth = 2.4;
    ctx.beginPath();
    vals.forEach((v,i) => {
      const x = xAt(i), y = yAt(v);
      if (i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.fillStyle = stroke;
    vals.forEach((v,i) => {
      const x = xAt(i), y = yAt(v);
      ctx.beginPath();
      ctx.arc(x,y,3.2,0,Math.PI*2);
      ctx.fill();
    });
  }

  line(sys, "rgba(79,140,255,.98)");
  line(dia, "rgba(216,224,240,.88)");
  line(hr,  "rgba(120,220,180,.92)");

  const lx = pad.l + 10;
  let ly = pad.t + 14;
  ctx.font = "13px system-ui,Segoe UI,Roboto,Arial";
  function leg(text, color){
    ctx.fillStyle = color;
    ctx.fillRect(lx, ly-8, 14, 4);
    ctx.fillStyle = "rgba(216,224,240,.90)";
    ctx.fillText(text, lx+18, ly-3);
    ly += 16;
  }
  leg("Systolic", "rgba(79,140,255,.98)");
  leg("Diastolic", "rgba(216,224,240,.88)");
  leg("Heart Rate", "rgba(120,220,180,.92)");
}

/* =========================
   Buttons + init
========================= */
document.getElementById("btnExportLog").style.display = "none";
document.getElementById("btnExportCharts").style.display = "none";

show("home");
</script>
</body>
  </html>
