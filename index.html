<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Vitals Tracker v2.02</title>
<style>
:root{
  --blue:#2a7fff;
  --red:#c62828;
  --green:#2e7d32;
  --amber:#9a6b00;
  --ink:#111;
  --muted:#666;
  --bg:#fff;
  --card:#f7f9fc;
  --border:6px solid var(--blue);
  --r:16px;
  --pad:14px;
  --font: 19px;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family: Arial, Helvetica, sans-serif;
  padding:12px;
}

.app{
  max-width:860px;
  margin:0 auto;
  border:var(--border);
  border-radius:var(--r);
  padding:var(--pad);
}

.header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:10px;
}
.logo{
  width:48px;height:48px;border-radius:50%;
  background:var(--blue);
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:800;font-size:22px;
}
.title{
  font-size:20px;
  font-weight:800;
}
.meta{
  margin-left:auto;
  font-size:14px;
  color:#222;
  text-align:right;
}
.meta .v{ font-weight:700; }
.meta .s{ color:var(--muted); }

.nav{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin:10px 0 12px;
}
.nav button{
  font-size:16px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #bbb;
  background:#fff;
  font-weight:800;
  cursor:pointer;
}
.nav button.active{
  border-color:var(--blue);
  outline:3px solid rgba(42,127,255,.25);
}
.nav .spacer{ flex:1; min-width:10px; }
.nav .exit{
  background:var(--red);
  border:none;
  color:#fff;
}

.card{
  background:var(--card);
  border:1px solid #cfd8ea;
  border-radius:14px;
  padding:12px;
}

.row{ display:flex; gap:10px; flex-wrap:wrap; }
.row > *{ flex:1; min-width:180px; }

label{ display:block; font-size:14px; color:var(--muted); margin:6px 0 6px; }
input, textarea, button, select{
  width:100%;
  font-size:var(--font);
  padding:10px;
  border-radius:12px;
  border:1px solid #bbb;
  background:#fff;
}
textarea{ min-height:90px; resize:vertical; }

.small{ font-size:14px; color:var(--muted); margin-top:6px; }

.vitalsline{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.vitalsline .box{
  flex:1;
  min-width:180px;
}
.vitalsline input{
  text-align:center;
  font-weight:800;
}

.steps{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin:10px 0;
}
.stepchip{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid #bbb;
  font-size:14px;
  font-weight:800;
  background:#fff;
  cursor:pointer;
}
.stepchip.active{
  border-color:var(--blue);
  outline:3px solid rgba(42,127,255,.25);
}
.stepchip.done{
  border-color:var(--green);
}

.symptoms{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px 12px;
  margin-top:8px;
}
.symptoms label{
  display:flex;
  align-items:center;
  gap:10px;
  border-radius:12px;
  padding:8px 10px;
  background:#fff;
  border:1px solid #ddd;
  font-size:16px;
  color:#111;
}
.symptoms input[type="checkbox"]{
  width:auto;
  transform:scale(1.25);
}

.alert{
  margin-top:10px;
  padding:10px;
  border-radius:12px;
  font-weight:900;
}
.alert.ok{ background:#e8f5e9; color:var(--green); }
.alert.warn{ background:#fdecea; color:var(--red); }
.alert.note{ background:#eef5ff; color:#0b3a7a; }
.alert.mid{ background:#fff7e6; color:var(--amber); }

.actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:12px;
}
.actions button{
  border:none;
  cursor:pointer;
  font-weight:900;
  font-size:18px;
  padding:12px 14px;
  border-radius:12px;
  width:auto;
}
.btn-blue{ background:var(--blue); color:#fff; }
.btn-gray{ background:#eee; color:#000; border:1px solid #bbb; }
.btn-red{ background:var(--red); color:#fff; }

.hr{ height:1px; background:#d6deef; margin:12px 0; }

.logwrap{
  background:#fff;
  border:1px solid #cfd8ea;
  border-radius:14px;
  padding:12px;
}
.logheader{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.logheader input{ max-width:320px; }
.log{
  margin-top:10px;
  max-height:420px;
  overflow:auto;
  border-top:1px solid #ddd;
  padding-top:10px;
}
.entry{
  border:1px solid #ddd;
  border-radius:14px;
  padding:10px;
  margin-bottom:10px;
}
.entrytop{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.pill{
  padding:4px 10px;
  border-radius:999px;
  font-size:13px;
  font-weight:900;
  border:1px solid #bbb;
}
.pill.ok{ border-color:var(--green); color:var(--green); }
.pill.warn{ border-color:var(--red); color:var(--red); }
.kv{
  margin-top:8px;
  font-size:16px;
}
.entryactions{
  margin-top:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.entryactions button{
  width:auto;
  font-size:16px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #bbb;
  background:#fff;
  font-weight:900;
}
.entryactions .danger{
  border:none;
  background:var(--red);
  color:#fff;
}

.hidden{ display:none; }

/* Print/PDF: hide navigation and buttons; show log/export content cleanly */
@media print{
  body{ padding:0; }
  .app{ border:none; }
  .nav, .steps, .actions, .small, .entryactions, .logheader, .printHide{ display:none !important; }
  .log{ max-height:none; overflow:visible; }
  .entry{ page-break-inside:avoid; }
}
</style>
</head>

<body>
<div class="app" role="application" aria-label="Vitals Tracker">
  <div class="header">
    <div class="logo" aria-hidden="true">VT</div>
    <div>
      <div class="title">Vitals Tracker</div>
      <div class="small">Fast capture. Clean log. Clinician-ready export.</div>
    </div>
    <div class="meta">
      <div class="v">v2.02</div>
      <div class="s" id="statusLine">Ready</div>
    </div>
  </div>

  <div class="nav" role="navigation" aria-label="Main navigation">
    <button id="navCapture" class="active" type="button">Capture</button>
    <button id="navLog" type="button">Log</button>
    <button id="navExport" type="button">Export</button>
    <div class="spacer"></div>
    <button id="exitBtn" class="exit" type="button">EXIT</button>
  </div>

  <!-- CAPTURE VIEW -->
  <section id="viewCapture" class="card" aria-label="Capture vitals">
    <div class="steps" aria-label="Capture steps">
      <button id="chip1" class="stepchip active" type="button">1) Vitals</button>
      <button id="chip2" class="stepchip" type="button">2) Symptoms</button>
      <button id="chip3" class="stepchip" type="button">3) Notes</button>
      <button id="chip4" class="stepchip" type="button">4) Review</button>
    </div>

    <!-- Step 1 -->
    <div id="step1">
      <div class="row">
        <div>
          <label for="dt">Date & Time</label>
          <input id="dt" type="datetime-local" aria-label="Date and time"/>
          <div class="small">Tip: log each reading separately (even 5 minutes apart).</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="vitalsline" aria-label="Vitals entry">
        <div class="box">
          <label for="sys">SYS</label>
          <input id="sys" type="number" inputmode="numeric" min="50" max="260" placeholder="Systolic" aria-label="Systolic"/>
        </div>
        <div class="box">
          <label for="dia">DIA</label>
          <input id="dia" type="number" inputmode="numeric" min="30" max="180" placeholder="Diastolic" aria-label="Diastolic"/>
        </div>
        <div class="box">
          <label for="hr">HR</label>
          <input id="hr" type="number" inputmode="numeric" min="30" max="220" placeholder="Heart rate" aria-label="Heart rate"/>
        </div>
      </div>

      <div class="actions">
        <button class="btn-blue" id="next1" type="button">Next</button>
        <button class="btn-gray" id="clear1" type="button">Clear</button>
      </div>
    </div>

    <!-- Step 2 -->
    <div id="step2" class="hidden">
      <div class="section-title" style="font-weight:900;font-size:18px;">Symptoms</div>
      <div id="symptomList" class="symptoms" aria-label="Symptoms list"></div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label for="customSymptom">Add custom symptom (saved permanently)</label>
          <input id="customSymptom" type="text" placeholder="e.g., tingling hands" aria-label="Custom symptom"/>
          <div class="small">Custom symptoms will appear in the list every time.</div>
        </div>
        <div style="flex:0.55; min-width:160px;">
          <label class="printHide">&nbsp;</label>
          <button id="addSymBtn" class="btn-gray" type="button" style="width:100%;">Add</button>
        </div>
      </div>

      <div class="actions">
        <button class="btn-gray" id="back2" type="button">Back</button>
        <button class="btn-blue" id="next2" type="button">Next</button>
      </div>
    </div>

    <!-- Step 3 -->
    <div id="step3" class="hidden">
      <div class="section-title" style="font-weight:900;font-size:18px;">Notes</div>
      <label for="notes">Optional details</label>
      <textarea id="notes" placeholder="Meds taken, trigger, what you were doing, etc." aria-label="Notes"></textarea>
      <div class="small">Keep it simple. Short notes are fine.</div>

      <div class="actions">
        <button class="btn-gray" id="back3" type="button">Back</button>
        <button class="btn-blue" id="next3" type="button">Next</button>
      </div>
    </div>

    <!-- Step 4 -->
    <div id="step4" class="hidden">
      <div class="section-title" style="font-weight:900;font-size:18px;">Review</div>
      <div class="small" id="reviewLine">—</div>

      <div id="alertBox" class="alert ok" role="status">No clinical alerts detected.</div>

      <div class="hr"></div>

      <div class="actions">
        <button class="btn-gray" id="back4" type="button">Back</button>
        <button class="btn-blue" id="saveBtn" type="button">Save Entry</button>
        <button class="btn-gray" id="clearAll" type="button">Clear Form</button>
      </div>
    </div>
  </section>

  <!-- LOG VIEW -->
  <section id="viewLog" class="logwrap hidden" aria-label="Saved log">
    <div class="logheader">
      <div style="flex:1;">
        <div style="font-size:18px;font-weight:900;">Saved Entries</div>
        <div class="small" id="countText">0 entries</div>
      </div>
      <input id="search" type="text" placeholder="Search (symptom/notes/date)" aria-label="Search log"/>
      <button id="wipeBtn" class="btn-red" type="button" style="width:auto;">Wipe Log</button>
    </div>
    <div id="log" class="log"></div>
  </section>

  <!-- EXPORT VIEW -->
  <section id="viewExport" class="card hidden" aria-label="Export">
    <div style="font-size:18px;font-weight:900;">Export</div>
    <div class="small">PDF uses your device print dialog (“Save as PDF”). CSV downloads a spreadsheet-friendly file.</div>

    <div class="hr"></div>

    <div class="actions">
      <button class="btn-blue" id="pdfBtn" type="button">PDF</button>
      <button class="btn-blue" id="csvBtn" type="button">CSV</button>
      <button class="btn-gray" id="printLogBtn" type="button">Print Log View</button>
    </div>

    <div class="hr"></div>

    <div class="small">
      Note: browsers often block scripted tab-closing. Use EXIT to clear the form, then close the tab/app normally.
    </div>
  </section>
</div>

<script>
/* =========================
   Storage + Constants
========================= */
const APP_VERSION = "2.02";
const KEY_ENTRIES  = "vt_entries";
const KEY_SYMPTOMS = "vt_symptoms";
const KEY_SCHEMA   = "vt_schema_version";

const DEFAULT_SYMPTOMS = [
  "Dizziness","Chest tightness","Nausea","Sweating",
  "Blurred vision","Weakness","Palpitations","Anxiety",
  "Head pain","Shortness of breath","Tremor","Confusion"
];

function safeParse(x){ try{ return JSON.parse(x); } catch(e){ return null; } }
function el(id){ return document.getElementById(id); }
function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : NaN; }
function uid(){ return "e_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

function ensureSchema(){
  const v = localStorage.getItem(KEY_SCHEMA);
  if (!v) localStorage.setItem(KEY_SCHEMA, APP_VERSION);
  // Future migrations can go here.
}

function loadSymptoms(){
  const stored = safeParse(localStorage.getItem(KEY_SYMPTOMS));
  if (Array.isArray(stored) && stored.length) return stored;
  localStorage.setItem(KEY_SYMPTOMS, JSON.stringify(DEFAULT_SYMPTOMS));
  return [...DEFAULT_SYMPTOMS];
}
function loadEntries(){
  const stored = safeParse(localStorage.getItem(KEY_ENTRIES));
  return Array.isArray(stored) ? stored : [];
}
function saveEntries(entries){
  localStorage.setItem(KEY_ENTRIES, JSON.stringify(entries));
}

/* =========================
   State
========================= */
let symptoms = loadSymptoms();
let entries = loadEntries();
let editingId = null;
let currentStep = 1;

/* =========================
   Navigation: Main Views
========================= */
function setStatus(text){ el("statusLine").textContent = text; }

function showView(which){
  const map = {
    capture: ["viewCapture","navCapture"],
    log:     ["viewLog","navLog"],
    export:  ["viewExport","navExport"]
  };

  // hide all
  el("viewCapture").classList.add("hidden");
  el("viewLog").classList.add("hidden");
  el("viewExport").classList.add("hidden");
  el("navCapture").classList.remove("active");
  el("navLog").classList.remove("active");
  el("navExport").classList.remove("active");

  const [viewId, btnId] = map[which];
  el(viewId).classList.remove("hidden");
  el(btnId).classList.add("active");

  if (which === "capture") setStatus("Capture");
  if (which === "log") { setStatus("Log"); renderLog(); }
  if (which === "export") setStatus("Export");
}

el("navCapture").addEventListener("click", ()=>showView("capture"));
el("navLog").addEventListener("click", ()=>showView("log"));
el("navExport").addEventListener("click", ()=>showView("export"));

/* =========================
   Step Flow
========================= */
function markChip(){
  // reset
  [1,2,3,4].forEach(i=>{
    el("chip"+i).classList.remove("active");
  });
  el("chip"+currentStep).classList.add("active");

  // done markers (basic)
  el("chip1").classList.toggle("done", hasVitals());
  el("chip2").classList.toggle("done", selectedSymptoms().length > 0);
  el("chip3").classList.toggle("done", (el("notes").value||"").trim().length > 0);
  el("chip4").classList.toggle("done", false);
}

function showStep(n){
  currentStep = n;
  ["step1","step2","step3","step4"].forEach((id, idx)=>{
    el(id).classList.toggle("hidden", idx !== (n-1));
  });
  markChip();
  if (n === 4) updateReview();
}

[1,2,3,4].forEach(i=>{
  el("chip"+i).addEventListener("click", ()=>showStep(i));
});

function hasVitals(){
  const sys = toNum(el("sys").value);
  const dia = toNum(el("dia").value);
  const hr  = toNum(el("hr").value);
  return Number.isFinite(sys) && Number.isFinite(dia) && Number.isFinite(hr);
}

el("next1").addEventListener("click", ()=>{
  if (!hasVitals()){
    setAlert(["SYS, DIA, and HR are required before continuing."], true);
    return;
  }
  showStep(2);
});
el("clear1").addEventListener("click", ()=>{
  el("sys").value=""; el("dia").value=""; el("hr").value="";
  setAlert([], false);
  markChip();
});

el("back2").addEventListener("click", ()=>showStep(1));
el("next2").addEventListener("click", ()=>showStep(3));
el("back3").addEventListener("click", ()=>showStep(2));
el("next3").addEventListener("click", ()=>showStep(4));
el("back4").addEventListener("click", ()=>showStep(3));

/* =========================
   Symptoms
========================= */
function renderSymptoms(){
  const box = el("symptomList");
  box.innerHTML = "";

  // Always include "Other" checkbox (notes should capture specifics)
  const all = [...symptoms, "Other"];

  all.forEach(s=>{
    const id = "sym_" + s.toLowerCase().replace(/[^a-z0-9]+/g,"_");
    const label = document.createElement("label");
    label.innerHTML = `
      <input id="${id}" type="checkbox" value="${escapeHtml(s)}" aria-label="${escapeHtml(s)}">
      <span>${escapeHtml(s)}</span>
    `;
    box.appendChild(label);
  });

  box.addEventListener("change", ()=>{
    markChip();
    if (currentStep === 4) updateReview();
  }, { once:false });
}

function selectedSymptoms(){
  return Array.from(document.querySelectorAll("#symptomList input[type=checkbox]:checked"))
    .map(cb => cb.value);
}

function addCustomSymptom(){
  const val = (el("customSymptom").value||"").trim();
  if (!val) return;
  if (val.toLowerCase() === "other") { el("customSymptom").value=""; return; }
  if (symptoms.some(s=>s.toLowerCase()===val.toLowerCase())){
    el("customSymptom").value="";
    return;
  }
  symptoms.push(val);
  localStorage.setItem(KEY_SYMPTOMS, JSON.stringify(symptoms));
  el("customSymptom").value="";
  renderSymptoms();
}

el("addSymBtn").addEventListener("click", addCustomSymptom);
el("customSymptom").addEventListener("keydown",(e)=>{
  if (e.key === "Enter"){ e.preventDefault(); addCustomSymptom(); }
});

/* =========================
   Clinical Alerts (standard ranges)
========================= */
function computeAlerts(sys, dia, hr, symList){
  const alerts = [];

  if (Number.isFinite(sys) && Number.isFinite(dia)){
    if (sys >= 180 || dia >= 120) alerts.push({level:"warn", msg:"Hypertensive crisis range"});
    else if (sys >= 140 || dia >= 90) alerts.push({level:"mid", msg:"High BP range"});
    else if (sys < 90 || dia < 60) alerts.push({level:"mid", msg:"Low BP range"});
  }

  if (Number.isFinite(hr)){
    if (hr > 120) alerts.push({level:"mid", msg:"High heart rate range"});
    else if (hr < 50) alerts.push({level:"mid", msg:"Low heart rate range"});
  }

  const redFlagSymptoms = ["Chest tightness","Shortness of breath","Confusion","Weakness","Blurred vision"];
  const redFlag = redFlagSymptoms.some(s => symList.includes(s));

  if (redFlag && (sys >= 180 || dia >= 120)){
    alerts.push({level:"warn", msg:"Symptoms + crisis range: consider urgent evaluation"});
  } else if (redFlag && (sys >= 140 || dia >= 90)){
    alerts.push({level:"note", msg:"Symptoms + high range: monitor closely; consider calling care team"});
  }

  return alerts;
}

function setAlert(alerts, hardWarn){
  const box = el("alertBox");
  if (!alerts || alerts.length === 0){
    box.className = "alert ok";
    box.textContent = "No clinical alerts detected.";
    return;
  }
  const levels = alerts.map(a=>a.level || "note");
  const top = hardWarn ? "warn" : (levels.includes("warn") ? "warn" : (levels.includes("mid") ? "mid" : "note"));
  box.className = "alert " + top;
  box.textContent = alerts.map(a=>a.msg || a).join(" • ");
}

function validateVitals(sys, dia, hr){
  const problems = [];
  if (!Number.isFinite(sys) || !Number.isFinite(dia) || !Number.isFinite(hr)){
    problems.push("SYS, DIA, and HR are required.");
    return problems;
  }
  if (sys < 50 || sys > 260) problems.push("SYS looks out of range.");
  if (dia < 30 || dia > 180) problems.push("DIA looks out of range.");
  if (hr  < 30 || hr  > 220) problems.push("HR looks out of range.");
  if (sys <= dia) problems.push("SYS should be higher than DIA.");
  return problems;
}

/* =========================
   Review + Save
========================= */
function formatStamp(ts){
  if (!ts) return "—";
  const [d,t] = ts.split("T");
  return `${d} ${t}`;
}

function updateReview(){
  const ts = el("dt").value || new Date().toISOString().slice(0,16);
  const sys = toNum(el("sys").value);
  const dia = toNum(el("dia").value);
  const hr  = toNum(el("hr").value);
  const sym = selectedSymptoms();
  const notes = (el("notes").value||"").trim();

  el("reviewLine").textContent =
    `Date/Time: ${formatStamp(ts)} | SYS/DIA/HR: ${Number.isFinite(sys)?sys:"—"}/${Number.isFinite(dia)?dia:"—"}/${Number.isFinite(hr)?hr:"—"} | Symptoms: ${sym.length?sym.join(", "):"None"} | Notes: ${notes?notes:"—"}`;

  const problems = validateVitals(sys, dia, hr);
  if (problems.length){
    setAlert(problems.map(p=>({level:"warn", msg:p})), true);
    return;
  }
  const alerts = computeAlerts(sys, dia, hr, sym);
  setAlert(alerts, false);
}

["sys","dia","hr","dt","notes"].forEach(id=>{
  el(id).addEventListener("input", ()=>{
    markChip();
    if (currentStep === 4) updateReview();
  });
});

function clearForm(){
  editingId = null;
  setNow();
  el("sys").value=""; el("dia").value=""; el("hr").value="";
  el("notes").value="";
  document.querySelectorAll("#symptomList input[type=checkbox]").forEach(cb=>cb.checked=false);
  setAlert([], false);
  showStep(1);
  setStatus("Capture");
}

el("clearAll").addEventListener("click", clearForm);

function saveEntry(){
  const ts = el("dt").value || new Date().toISOString().slice(0,16);
  const sys = toNum(el("sys").value);
  const dia = toNum(el("dia").value);
  const hr  = toNum(el("hr").value);
  const sym = selectedSymptoms();
  const notes = (el("notes").value||"").trim();

  const problems = validateVitals(sys, dia, hr);
  if (problems.length){
    setAlert(problems.map(p=>({level:"warn", msg:p})), true);
    return;
  }

  const entry = { id: editingId || uid(), ts, sys, dia, hr, symptoms:sym, notes };
  if (editingId){
    entries = entries.map(e => e.id === editingId ? entry : e);
  } else {
    entries.push(entry);
  }
  saveEntries(entries);
  editingId = null;
  setStatus("Saved");
  clearForm();
}

el("saveBtn").addEventListener("click", saveEntry);

/* =========================
   Log View
========================= */
function renderLog(){
  el("countText").textContent = `${entries.length} entr${entries.length===1?"y":"ies"}`;
  const q = (el("search").value||"").trim().toLowerCase();
  const box = el("log");
  box.innerHTML = "";

  const filtered = entries
    .slice()
    .sort((a,b)=> (b.ts||"").localeCompare(a.ts||""))
    .filter(e=>{
      if (!q) return true;
      const blob = [
        e.ts, e.sys, e.dia, e.hr,
        (e.symptoms||[]).join(", "),
        e.notes||""
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });

  if (filtered.length === 0){
    const d = document.createElement("div");
    d.className="small";
    d.textContent = q ? "No matches." : "No saved entries yet.";
    box.appendChild(d);
    return;
  }

  filtered.forEach(e=>{
    const sym = e.symptoms || [];
    const alerts = computeAlerts(e.sys, e.dia, e.hr, sym);
    const crisis = alerts.some(a=>a.level==="warn");

    const card = document.createElement("div");
    card.className="entry";
    card.innerHTML = `
      <div class="entrytop">
        <div style="font-weight:900;">${escapeHtml(formatStamp(e.ts))}</div>
        <div class="pill ${crisis?"warn":"ok"}">${crisis?"ALERT":"OK"}</div>
        <div class="small">SYS ${e.sys} / DIA ${e.dia} / HR ${e.hr}</div>
      </div>
      <div class="kv"><strong>Symptoms:</strong> ${escapeHtml(sym.length?sym.join(", "):"None")}</div>
      <div class="kv"><strong>Notes:</strong> ${escapeHtml((e.notes||"").trim() || "—")}</div>
      <div class="small"><strong>Flags:</strong> ${escapeHtml(alerts.length ? alerts.map(a=>a.msg).join(" • ") : "None")}</div>
      <div class="entryactions">
        <button data-edit="${escapeHtml(e.id)}" type="button">Edit</button>
        <button class="danger" data-del="${escapeHtml(e.id)}" type="button">Delete</button>
      </div>
    `;
    box.appendChild(card);
  });

  box.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-del");
      if (!confirm("Delete this entry?")) return;
      entries = entries.filter(e=>e.id!==id);
      saveEntries(entries);
      renderLog();
    });
  });

  box.querySelectorAll("button[data-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-edit");
      loadEntryForEdit(id);
    });
  });
}

function loadEntryForEdit(id){
  const e = entries.find(x=>x.id===id);
  if (!e) return;

  editingId = id;
  showView("capture");
  showStep(1);

  el("dt").value = e.ts || new Date().toISOString().slice(0,16);
  el("sys").value = e.sys ?? "";
  el("dia").value = e.dia ?? "";
  el("hr").value  = e.hr  ?? "";
  el("notes").value = e.notes || "";

  const set = new Set(e.symptoms || []);
  document.querySelectorAll("#symptomList input[type=checkbox]").forEach(cb=>{
    cb.checked = set.has(cb.value);
  });

  setStatus("Editing");
  showStep(4);
}

/* =========================
   Export
========================= */
function exportCSV(){
  const header = ["DateTime","SYS","DIA","HR","Symptoms","Notes"];
  const rows = entries
    .slice()
    .sort((a,b)=> (a.ts||"").localeCompare(b.ts||""))
    .map(e=>[
      e.ts || "",
      e.sys ?? "",
      e.dia ?? "",
      e.hr ?? "",
      (e.symptoms||[]).join("; "),
      (e.notes||"").replace(/\s+/g," ").trim()
    ]);

  const csv = [header, ...rows]
    .map(r => r.map(f => `"${String(f).replace(/"/g,'""')}"`).join(","))
    .join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "VitalsTracker_Log.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportPDF(){
  // Uses print stylesheet. Recommend: open Export view first if desired.
  window.print();
}

el("csvBtn").addEventListener("click", exportCSV);
el("pdfBtn").addEventListener("click", exportPDF);
el("printLogBtn").addEventListener("click", ()=>{
  showView("log");
  setTimeout(()=>window.print(), 200);
});

/* =========================
   Wipe
========================= */
el("wipeBtn").addEventListener("click", ()=>{
  if (!confirm("Wipe ALL saved entries? This cannot be undone.")) return;
  entries = [];
  saveEntries(entries);
  renderLog();
});

/* =========================
   Exit (mobile-safe)
========================= */
el("exitBtn").addEventListener("click", ()=>{
  clearForm();
  alert("Form cleared.\n\nTo exit:\n- Close this tab, or\n- Swipe away the browser/app.");
});

/* =========================
   Boot
========================= */
function setNow(){
  const now = new Date();
  el("dt").value = now.toISOString().slice(0,16);
}
ensureSchema();
renderSymptoms();
setNow();
showView("capture");
showStep(1);
setAlert([], false);

el("search").addEventListener("input", renderLog);
</script>
</body>
</html>
