<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="color-scheme" content="dark" />
  <title>Vitals Tracker</title>

  <!-- PWA: manifest (single-file via data: URI) -->
  <link id="manifestLink" rel="manifest" href="" />

  <!-- PWA: iOS-friendly -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Vitals Tracker" />
  <link id="appleTouchIcon" rel="apple-touch-icon" href="" />

  <style>
    :root{
      --bg0:#070b14;
      --bg1:#0b1220;
      --card:#101a2a;
      --card2:#0e1726;
      --line:#23314a;
      --line2:#2e3e5c;
      --text:#d8e0f0;
      --muted:#9aa8c4;
      --muted2:#7f8fb0;
      --accent:#4f8cff;
      --accent2:#3a72dd;

      --radius:18px;
      --radius2:14px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --focus: 0 0 0 3px rgba(79,140,255,.35);

      /* sizing (tuned down from “too bold/large”) */
      --h1: 36px;
      --h2: 20px;
      --label: 14px;
      --body: 15px;
      --small: 13px;
      --btn: 14px;
      --input: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, #142443 0%, rgba(20,36,67,0) 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(79,140,255,.22) 0%, rgba(79,140,255,0) 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1) 55%, #060913);
      color: var(--text);
    }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 22px 16px 28px;
    }

    .title{
      font-size: var(--h1);
      font-weight: 700;
      letter-spacing: .2px;
      margin: 6px 2px 10px;
      color: var(--text);
      text-shadow: 0 2px 14px rgba(0,0,0,.35);
    }

    .divider{
      height:1px;
      background: linear-gradient(90deg, rgba(35,49,74,0), rgba(35,49,74,.85), rgba(35,49,74,0));
      margin: 10px 0 18px;
    }

    .card{
      background: linear-gradient(180deg, rgba(16,26,42,.95), rgba(12,20,34,.92));
      border: 1px solid rgba(46,62,92,.72);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      margin-bottom: 10px;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(46,62,92,.9);
      background: linear-gradient(180deg, rgba(22,34,54,.88), rgba(16,26,42,.88));
      color: var(--text);
      border-radius: 14px;
      padding: 10px 14px;
      font-size: var(--btn);
      font-weight: 600;
      letter-spacing: .1px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
      min-width: 98px;
      text-align:center;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(79,140,255,.85);
      background: linear-gradient(180deg, rgba(79,140,255,.92), rgba(58,114,221,.92));
      color:#081224;
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(46,62,92,.75);
      color: var(--text);
    }

    .btnRowBig{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .btnBig{
      flex: 1 1 150px;
      padding: 16px 14px;
      border-radius: 18px;
      font-size: 18px;
      font-weight: 700;
      min-width: 140px;
    }

    .subtle{
      color: var(--muted);
      font-size: var(--small);
      margin-top: 6px;
      line-height: 1.35;
    }

    .sectionTitle{
      font-size: var(--h2);
      font-weight: 700;
      margin: 8px 2px 10px;
      color: var(--text);
    }

    label{
      display:block;
      font-size: var(--label);
      font-weight: 650;
      color: var(--muted);
      margin: 10px 2px 6px;
      letter-spacing: .15px;
    }

    input, textarea, select{
      width:100%;
      padding: 12px 12px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 2px solid rgba(46,62,92,.85); /* more contrasting/bold */
      border-radius: 14px;
      outline:none;
      font-size: var(--input);
    }
    input::placeholder, textarea::placeholder{ color: rgba(154,168,196,.65); }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(79,140,255,.95);
      box-shadow: var(--focus);
    }

    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width:720px){
      .grid3{ grid-template-columns: 1fr 1fr; }
      .grid3 .span2{ grid-column: 1 / -1; }
    }

    .nowline{
      font-size: var(--small);
      color: var(--muted2);
      margin: 0 2px 8px;
      letter-spacing: .2px;
    }

    /* economical symptoms list */
    .symptomsList{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;            /* tight */
      padding: 6px 2px 2px;
      margin: 2px 0 8px;
    }
    @media (max-width:520px){
      .symptomsList{ grid-template-columns: 1fr; }
    }
    .symItem{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 4px 0;          /* no “big pill boxes” */
    }
    .symItem input[type="checkbox"]{
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      background: transparent;
    }
    .symItem span{
      font-size: 14px;         /* halved feel vs earlier */
      color: var(--text);
      font-weight: 600;
      letter-spacing: .1px;
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(46,62,92,.70);
      border-radius: 14px;
      margin: 8px 0 10px;
      width:100%;
    }

    .logControls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:end;
      margin-top: 8px;
    }
    @media (max-width:600px){
      .logControls{ grid-template-columns: 1fr; }
    }
    .smallLabel{ font-size: 12px; font-weight: 650; color: var(--muted2); margin-bottom: 6px; }
    .hint{ color: var(--muted2); font-size: 12px; margin-top: 8px; }

    .logList{ margin-top: 12px; display:flex; flex-direction:column; gap:10px; }
    .entry{
      background: linear-gradient(180deg, rgba(12,20,34,.92), rgba(10,16,28,.92));
      border: 1px solid rgba(46,62,92,.72);
      border-radius: 18px;
      padding: 12px;
    }
    .entryTop{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap: 10px;
      margin-bottom: 6px;
      color: var(--muted2);
      font-size: 12px;           /* smaller so full date fits */
      letter-spacing: .15px;
    }
    .entryMain{
      display:flex;
      justify-content:space-between;  /* BP and HR same line */
      align-items:baseline;
      gap: 12px;
      flex-wrap:wrap;
      margin-bottom: 6px;
    }
    .bp{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .hr{
      font-size: 18px;
      font-weight: 750;
      color: var(--text);
      opacity: .92;
      white-space:nowrap;
    }

    .entryText{
      font-size: 14px;
      color: var(--text);
      opacity: .92;
      line-height: 1.35;
    }
    .entryText b{ color: var(--muted); font-weight: 750; }

    .mutedBlock{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
      margin-top: 6px;
    }

    .hidden{ display:none !important; }

    /* charts */
    .chartBox{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(46,62,92,.70);
      border-radius: 18px;
      padding: 10px;
    }
    canvas{ width:100%; height:260px; display:block; }

    /* accessibility */
    .sr{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); border:0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">Vitals Tracker</div>
    <div class="divider"></div>

    <!-- HOME -->
    <div id="screenHome" class="card">
      <div class="btnRowBig">
        <button class="btn btnBig primary" id="goAdd">Add</button>
        <button class="btn btnBig" id="goLog">Log</button>
        <button class="btn btnBig" id="goCharts">Charts</button>
      </div>

      <div class="subtle" id="installHint" style="margin-top:10px;">
        For full-screen app mode: open this in Chrome → menu → Add to Home screen → Install.
      </div>

      <div class="toolbar" style="margin-top:12px;">
        <button class="btn ghost hidden" id="btnInstall">Install</button>
        <button class="btn ghost" id="btnExportFromHome">Export</button>
        <button class="btn ghost" id="btnExitHome">Exit</button>
      </div>

      <div class="subtle">Data stays on your phone (local only).</div>
    </div>

    <!-- ADD -->
    <div id="screenAdd" class="card hidden" style="margin-top:14px;">
      <div class="toolbar">
        <button class="btn primary" id="saveAdd">Save</button>
        <button class="btn" id="backFromAdd">Back</button>
        <button class="btn ghost" id="exitFromAdd">Exit</button>
      </div>

      <!-- time ticking away then comma then date; no border, not editable -->
      <div class="nowline" id="nowLine">Time, Date</div>

      <div class="grid3">
        <div>
          <label for="sys">Systolic</label>
          <input id="sys" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 132" />
        </div>
        <div>
          <label for="dia">Diastolic</label>
          <input id="dia" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 91" />
        </div>
        <div>
          <label for="hr">Heart Rate</label>
          <input id="hr" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 72" />
        </div>
        <div class="span2"></div>
      </div>

      <label for="notes">Notes <i style="font-weight:650;color:var(--muted2)">(optional)</i></label>
      <input id="notes" placeholder="optional" />

      <label style="margin-bottom:4px;">Symptoms</label>
      <div class="symptomsList" id="symptomsList"></div>
    </div>

    <!-- LOG -->
    <div id="screenLog" class="card hidden" style="margin-top:14px;">
      <div class="toolbar">
        <button class="btn primary" id="btnExport">Export</button>
        <button class="btn" id="backFromLog">Back</button>
        <button class="btn ghost" id="exitFromLog">Exit</button>
      </div>

      <div class="sectionTitle" style="margin-top:8px;">Search</div>
      <input id="searchBox" placeholder="Type a word: sweaty, dizzy, headache..." />

      <div class="logControls">
        <div>
          <div class="smallLabel">From</div>
          <select id="fromDate"></select>
        </div>
        <div>
          <div class="smallLabel">To</div>
          <select id="toDate"></select>
        </div>
      </div>

      <div class="logList" id="logList"></div>
    </div>

    <!-- CHARTS -->
    <div id="screenCharts" class="card hidden" style="margin-top:14px;">
      <div class="toolbar">
        <button class="btn" id="backFromCharts">Back</button>
        <button class="btn ghost" id="exitFromCharts">Exit</button>
      </div>

      <div class="sectionTitle" style="margin-top:8px;">Charts</div>
      <div class="mutedBlock" id="chartHint"></div>

      <div class="chartBox" style="margin-top:10px;">
        <canvas id="chartCanvas" width="900" height="260" aria-label="Vitals chart" role="img"></canvas>
      </div>
    </div>
  </div>

<script>
/* =========================
   Single-file PWA implement
   - manifest via data: URI
   - service worker via Blob URL
   - optional in-app Install button if browser provides prompt
========================= */

(function setupPWA(){
  // manifest (data URI)
  const iconSVG = encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#4f8cff"/>
          <stop offset="1" stop-color="#101a2a"/>
        </linearGradient>
      </defs>
      <rect width="512" height="512" rx="120" fill="url(#g)"/>
      <g fill="#081224" opacity="0.95">
        <rect x="120" y="130" width="272" height="252" rx="34" fill="#d8e0f0" opacity="0.95"/>
      </g>
      <path d="M170 300h55l25-60 40 120 30-70h55" fill="none" stroke="#081224" stroke-width="26" stroke-linecap="round" stroke-linejoin="round"/>
      <text x="256" y="210" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="52" font-weight="800" fill="#081224">VT</text>
    </svg>
  `);

  const iconData = "data:image/svg+xml;charset=utf-8," + iconSVG;

  const manifest = {
    name: "Vitals Tracker",
    short_name: "Vitals",
    start_url: "./",
    scope: "./",
    display: "standalone",
    background_color: "#0b1220",
    theme_color: "#0b1220",
    icons: [
      { src: iconData, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
    ]
  };

  const manifestJSON = encodeURIComponent(JSON.stringify(manifest));
  document.getElementById("manifestLink").href = "data:application/manifest+json;charset=utf-8," + manifestJSON;
  document.getElementById("appleTouchIcon").href = iconData;

  // service worker (Blob URL)
  if ("serviceWorker" in navigator) {
    const swCode = `
      const CACHE = "vitals-tracker-singlefile-cache-v1";
      self.addEventListener("install", (e) => {
        e.waitUntil(
          caches.open(CACHE).then((cache) => cache.addAll(["./"]))
        );
        self.skipWaiting();
      });
      self.addEventListener("activate", (e) => {
        e.waitUntil(
          caches.keys().then(keys => Promise.all(keys.map(k => (k !== CACHE) ? caches.delete(k) : null)))
        );
        self.clients.claim();
      });
      self.addEventListener("fetch", (e) => {
        const req = e.request;
        if (req.method !== "GET") return;
        e.respondWith(
          caches.match(req).then((cached) => {
            if (cached) return cached;
            return fetch(req).then((resp) => {
              const copy = resp.clone();
              caches.open(CACHE).then((cache) => cache.put(req, copy)).catch(()=>{});
              return resp;
            }).catch(() => cached);
          })
        );
      });
    `;
    const swBlob = new Blob([swCode], { type: "text/javascript" });
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl, { scope: "./" }).catch(()=>{});
  }

  // install prompt button (where supported)
  let deferredPrompt = null;
  const btnInstall = document.getElementById("btnInstall");
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btnInstall.classList.remove("hidden");
    document.getElementById("installHint").classList.add("hidden");
  });

  btnInstall.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    try { await deferredPrompt.userChoice; } catch(e){}
    deferredPrompt = null;
    btnInstall.classList.add("hidden");
  });
})();

/* =========================
   App state / storage
========================= */
const STORAGE_KEY = "vitals_tracker_entries_v1";

const SYMPTOMS = [
  "Sweaty","Dizzy","Panic","Brain fog","Chest tight","Headache","Nausea","Short breath",
  "Hot ears","Shaky","Blurred vision","Weakness"
];

function loadEntries(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function saveEntries(entries){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
}

function pad2(n){ return String(n).padStart(2,"0"); }
function fmtDateTimeLocal(iso){
  const d = new Date(iso);
  const mm = pad2(d.getMonth()+1);
  const dd = pad2(d.getDate());
  const yyyy = d.getFullYear();
  let hh = d.getHours();
  const ampm = hh >= 12 ? "PM" : "AM";
  hh = hh % 12; if (hh === 0) hh = 12;
  const min = pad2(d.getMinutes());
  const sec = pad2(d.getSeconds());
  return `${mm}/${dd}/${yyyy}, ${pad2(hh)}:${min}:${sec} ${ampm}`;
}
function fmtDateOnly(iso){
  const d = new Date(iso);
  return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}/${d.getFullYear()}`;
}
function isoDayKey(iso){
  const d = new Date(iso);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function clampInt(v){
  const n = parseInt(String(v).trim(), 10);
  return Number.isFinite(n) ? n : null;
}

/* =========================
   Screens / navigation
========================= */
const screens = {
  home: document.getElementById("screenHome"),
  add: document.getElementById("screenAdd"),
  log: document.getElementById("screenLog"),
  charts: document.getElementById("screenCharts"),
};
function show(name){
  Object.keys(screens).forEach(k => screens[k].classList.toggle("hidden", k !== name));
  if (name === "log") renderLog();
  if (name === "charts") renderCharts();
  if (name === "add") resetAdd();
}

document.getElementById("goAdd").onclick = () => show("add");
document.getElementById("goLog").onclick = () => show("log");
document.getElementById("goCharts").onclick = () => show("charts");

document.getElementById("backFromAdd").onclick = () => show("home");
document.getElementById("backFromLog").onclick = () => show("home");
document.getElementById("backFromCharts").onclick = () => show("home");

document.getElementById("btnExportFromHome").onclick = () => { show("log"); setTimeout(()=>doExport(), 50); };

/* Exit behavior: browsers generally block programmatic close unless opened by script.
   We'll offer: try window.close(); if blocked, navigate to blank as a “soft exit”. */
function doExit(){
  try{ window.close(); }catch(e){}
  // fallback (user can hit back/home)
  setTimeout(()=>{ try{ window.location.href = "about:blank"; }catch(e){} }, 250);
}
document.getElementById("btnExitHome").onclick = doExit;
document.getElementById("exitFromAdd").onclick = doExit;
document.getElementById("exitFromLog").onclick = doExit;
document.getElementById("exitFromCharts").onclick = doExit;

/* =========================
   Add screen
========================= */
const elNowLine = document.getElementById("nowLine");
const elSys = document.getElementById("sys");
const elDia = document.getElementById("dia");
const elHr = document.getElementById("hr");
const elNotes = document.getElementById("notes");
const elSymptomsList = document.getElementById("symptomsList");

let addTimer = null;
let currentStampISO = null;

function buildSymptoms(){
  elSymptomsList.innerHTML = "";
  SYMPTOMS.forEach((name, idx) => {
    const row = document.createElement("label");
    row.className = "symItem";
    row.style.margin = "0";
    row.style.cursor = "pointer";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = name;
    cb.id = "sym_" + idx;

    const txt = document.createElement("span");
    txt.textContent = name;

    row.appendChild(cb);
    row.appendChild(txt);
    elSymptomsList.appendChild(row);
  });
}
buildSymptoms();

function tickNow(){
  const d = new Date();
  // “Time then Date”, no labels, no border
  let hh = d.getHours();
  const ampm = hh >= 12 ? "PM" : "AM";
  hh = hh % 12; if (hh === 0) hh = 12;
  const min = pad2(d.getMinutes());
  const sec = pad2(d.getSeconds());
  const time = `${pad2(hh)}:${min}:${sec} ${ampm}`;
  const date = `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}/${d.getFullYear()}`;
  elNowLine.textContent = `${time}, ${date}`;
  currentStampISO = d.toISOString();
}

function resetAdd(){
  elSys.value = "";
  elDia.value = "";
  elHr.value = "";
  elNotes.value = "";
  elSymptomsList.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);

  tickNow();
  if (addTimer) clearInterval(addTimer);
  addTimer = setInterval(tickNow, 1000);
}

document.getElementById("saveAdd").onclick = () => {
  const sys = clampInt(elSys.value);
  const dia = clampInt(elDia.value);
  const hr  = clampInt(elHr.value);

  if (sys === null || dia === null || hr === null){
    alert("Enter Systolic, Diastolic, and Heart Rate.");
    return;
  }

  const notes = String(elNotes.value || "").trim();
  const symptoms = Array.from(elSymptomsList.querySelectorAll("input[type=checkbox]:checked"))
    .map(cb => cb.value);

  const entry = {
    id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
    ts: currentStampISO || new Date().toISOString(),
    sys, dia, hr,
    symptoms,
    notes
  };

  const entries = loadEntries();
  entries.unshift(entry);
  saveEntries(entries);

  show("home");
};

/* =========================
   Log screen + filters + export
========================= */
const elSearch = document.getElementById("searchBox");
const elFrom = document.getElementById("fromDate");
const elTo = document.getElementById("toDate");
const elLogList = document.getElementById("logList");

function buildDateOptions(entries){
  // Unique days present in data (descending)
  const days = Array.from(new Set(entries.map(e => isoDayKey(e.ts)))).sort().reverse();
  const opts = ['(any)', ...days.map(d => d)];
  function setSelect(sel){
    sel.innerHTML = "";
    opts.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v === "(any)" ? "(any)" : v;
      sel.appendChild(o);
    });
  }
  setSelect(elFrom);
  setSelect(elTo);
}

function passesDateRange(entry, fromKey, toKey){
  const k = isoDayKey(entry.ts);
  if (fromKey && fromKey !== "(any)" && k < fromKey) return false;
  if (toKey && toKey !== "(any)" && k > toKey) return false;
  return true;
}

function passesSearch(entry, q){
  if (!q) return true;
  const s = q.toLowerCase();
  const hay = [
    `${entry.sys}/${entry.dia}`,
    String(entry.hr),
    (entry.symptoms || []).join(", "),
    String(entry.notes || "")
  ].join(" | ").toLowerCase();
  return hay.includes(s);
}

function getFilteredEntries(){
  const entries = loadEntries();
  const q = String(elSearch.value || "").trim();
  const fromKey = elFrom.value || "(any)";
  const toKey = elTo.value || "(any)";

  return entries.filter(e => passesDateRange(e, fromKey, toKey) && passesSearch(e, q));
}

function renderLog(){
  const entries = loadEntries();
  buildDateOptions(entries);

  // If user had selections, keep if still present
  // (best-effort; if not present, default "(any)")
  const fromPrev = elFrom.value || "(any)";
  const toPrev = elTo.value || "(any)";
  if ([...elFrom.options].some(o => o.value === fromPrev)) elFrom.value = fromPrev;
  if ([...elTo.options].some(o => o.value === toPrev)) elTo.value = toPrev;

  const filtered = getFilteredEntries();
  elLogList.innerHTML = "";

  if (filtered.length === 0){
    const empty = document.createElement("div");
    empty.className = "mutedBlock";
    empty.textContent = "No matching entries.";
    elLogList.appendChild(empty);
    return;
  }

  filtered.forEach(e => {
    const card = document.createElement("div");
    card.className = "entry";

    const top = document.createElement("div");
    top.className = "entryTop";
    top.innerHTML = `<div>${fmtDateTimeLocal(e.ts)}</div><div>${fmtDateOnly(e.ts)}</div>`;

    const main = document.createElement("div");
    main.className = "entryMain";
    main.innerHTML = `
      <div class="bp">BP ${e.sys}/${e.dia}</div>
      <div class="hr">HR ${e.hr}</div>
    `;

    const txt = document.createElement("div");
    txt.className = "entryText";
    const sym = (e.symptoms && e.symptoms.length) ? e.symptoms.join(", ") : "None";
    const notes = (e.notes && e.notes.trim().length) ? e.notes.trim() : "None";
    txt.innerHTML = `<b>Symptoms:</b> ${escapeHTML(sym)}<br/><b>Notes:</b> ${escapeHTML(notes)}`;

    card.appendChild(top);
    card.appendChild(main);
    card.appendChild(txt);
    elLogList.appendChild(card);
  });
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

elSearch.addEventListener("input", renderLog);
elFrom.addEventListener("change", renderLog);
elTo.addEventListener("change", renderLog);

function buildExportText(entries){
  // toddler-level readable, consistent blocks
  const lines = [];
  lines.push("VITALS LOG (filtered)");
  lines.push("Format: Date/Time | BP | HR | Symptoms | Notes");
  lines.push("");

  entries.forEach(e => {
    const dt = fmtDateTimeLocal(e.ts);
    const bp = `${e.sys}/${e.dia}`;
    const hr = `${e.hr}`;
    const sym = (e.symptoms && e.symptoms.length) ? e.symptoms.join(", ") : "None";
    const notes = (e.notes && e.notes.trim().length) ? e.notes.trim() : "None";
    lines.push(`${dt} | BP ${bp} | HR ${hr}`);
    lines.push(`Symptoms: ${sym}`);
    lines.push(`Notes: ${notes}`);
    lines.push("");
  });

  return lines.join("\n").trim() + "\n";
}

async function doExport(){
  const filtered = getFilteredEntries();
  const text = buildExportText(filtered);

  // Try modern clipboard
  try{
    await navigator.clipboard.writeText(text);
    alert("Export copied to clipboard.");
    return;
  }catch(e){}

  // Fallback: show prompt for copy
  const ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position = "fixed";
  ta.style.left = "-9999px";
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try{
    document.execCommand("copy");
    alert("Export copied to clipboard.");
  }catch(e){
    alert("Copy failed. Long-press to select/copy from your log screen, or try again.");
  }
  document.body.removeChild(ta);
}

document.getElementById("btnExport").onclick = doExport;

/* =========================
   Charts (no external libs)
========================= */
const canvas = document.getElementById("chartCanvas");
const ctx = canvas.getContext("2d");
const chartHint = document.getElementById("chartHint");

function renderCharts(){
  const entries = loadEntries().slice().reverse(); // chronological
  if (entries.length < 2){
    chartHint.textContent = "Add at least 2 entries to show a chart.";
    clearChart();
    return;
  }
  chartHint.textContent = "Chart shows Systolic, Diastolic, and Heart Rate over time.";

  // use last up to 30 points for readability
  const data = entries.slice(Math.max(0, entries.length - 30));
  const series = {
    sys: data.map(e => e.sys),
    dia: data.map(e => e.dia),
    hr:  data.map(e => e.hr),
    labels: data.map(e => new Date(e.ts))
  };

  drawChart(series);
}

function clearChart(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // subtle baseline
  ctx.globalAlpha = 1;
  ctx.fillStyle = "rgba(255,255,255,.06)";
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function drawChart(series){
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  // background
  ctx.fillStyle = "rgba(255,255,255,.03)";
  ctx.fillRect(0,0,W,H);

  const pad = {l:42, r:16, t:16, b:28};
  const innerW = W - pad.l - pad.r;
  const innerH = H - pad.t - pad.b;

  // range (combine sys/dia/hr) but keep sane
  const all = [...series.sys, ...series.dia, ...series.hr];
  let minV = Math.min(...all);
  let maxV = Math.max(...all);
  // pad range
  const range = Math.max(10, maxV - minV);
  minV = Math.floor((minV - range*0.12));
  maxV = Math.ceil((maxV + range*0.12));

  // grid
  ctx.strokeStyle = "rgba(46,62,92,.65)";
  ctx.lineWidth = 1;

  const gridY = 5;
  for (let i=0;i<=gridY;i++){
    const y = pad.t + (innerH * i/gridY);
    ctx.beginPath();
    ctx.moveTo(pad.l, y);
    ctx.lineTo(pad.l + innerW, y);
    ctx.stroke();

    const val = Math.round(maxV - (range*(i/gridY)));
    ctx.fillStyle = "rgba(154,168,196,.85)";
    ctx.font = "12px system-ui,Segoe UI,Roboto,Arial";
    ctx.fillText(String(val), 8, y+4);
  }

  // x spacing
  const n = series.sys.length;
  const xAt = (i) => pad.l + (innerW * (n === 1 ? 0 : i/(n-1)));
  const yAt = (v) => pad.t + ((maxV - v) / (maxV - minV)) * innerH;

  // draw a line helper
  function line(vals, stroke){
    ctx.strokeStyle = stroke;
    ctx.lineWidth = 2;
    ctx.beginPath();
    vals.forEach((v,i) => {
      const x = xAt(i), y = yAt(v);
      if (i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // points
    ctx.fillStyle = stroke;
    vals.forEach((v,i) => {
      const x = xAt(i), y = yAt(v);
      ctx.beginPath();
      ctx.arc(x,y,3,0,Math.PI*2);
      ctx.fill();
    });
  }

  // colors (kept subdued to reduce glare)
  line(series.sys, "rgba(79,140,255,.95)"); // systolic
  line(series.dia, "rgba(154,168,196,.95)"); // diastolic
  line(series.hr,  "rgba(120,220,180,.85)"); // heart rate

  // legend
  const lx = pad.l, ly = H - 10;
  ctx.font = "12px system-ui,Segoe UI,Roboto,Arial";
  function leg(text, color, x){
    ctx.fillStyle = color;
    ctx.fillRect(x, ly-9, 10, 3);
    ctx.fillStyle = "rgba(216,224,240,.92)";
    ctx.fillText(text, x+14, ly-4);
    return x + 14 + ctx.measureText(text).width + 14;
  }
  let x = lx;
  x = leg("Systolic", "rgba(79,140,255,.95)", x);
  x = leg("Diastolic", "rgba(154,168,196,.95)", x);
  x = leg("Heart Rate", "rgba(120,220,180,.85)", x);
}

document.getElementById("goCharts").addEventListener("click", () => setTimeout(renderCharts, 10));
document.getElementById("backFromCharts").addEventListener("click", () => setTimeout(clearChart, 10));

/* =========================
   Wire Log button on home to Log screen
========================= */
document.getElementById("btnExportFromHome").addEventListener("click", () => {
  show("log");
});

/* Initial */
show("home");
</script>
</body>
</html>
