<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Vitals Tracker</title>

  <style>
    :root{
      --bg0:#07101e;
      --bg1:#0b1730;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(245,248,255,.92);
      --muted:rgba(245,248,255,.62);
      --inputBg:rgba(44,56,76,.55);
      --inputStroke:rgba(255,255,255,.22);
      --focus:rgba(90,160,255,.70);
      --shadow:0 18px 55px rgba(0,0,0,.55);
      --r24:24px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(90,160,255,.25), transparent 60%),
        radial-gradient(900px 600px at 90% 15%, rgba(70,120,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }

    .wrap{
      max-width: 820px;
      margin: 0 auto;
      padding: 22px 14px 28px;
    }

    h1{
      margin: 8px 6px 14px;
      font-size: 52px;
      font-weight: 750;
      letter-spacing: .2px;
      opacity: .88;
    }

    .rule{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      margin: 8px 6px 18px;
    }

    .panel{
      margin: 0 6px;
      padding: 18px;
      border-radius: var(--r24);
      background: linear-gradient(180deg, rgba(30,42,64,.75), rgba(15,22,35,.65));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .hidden{ display:none !important; }

    /* Buttons */
    .btn{
      width:100%;
      border:none;
      border-radius: 28px;
      padding: 18px 18px;
      font-size: 22px;
      font-weight: 750;
      color: var(--text);
      background: linear-gradient(180deg, rgba(30,38,55,.85), rgba(18,24,38,.85));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      background: linear-gradient(180deg, rgba(90,160,255,.92), rgba(60,125,230,.92));
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(5,10,18,.92);
    }

    .btnSmall{
      border:none;
      border-radius: 18px;
      padding: 10px 14px;
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      background: linear-gradient(180deg, rgba(30,38,55,.85), rgba(18,24,38,.85));
      border: 1px solid rgba(255,255,255,.10);
      min-width: 120px;
    }
    .btnSmallPrimary{
      background: linear-gradient(180deg, rgba(90,160,255,.92), rgba(60,125,230,.92));
      color: rgba(5,10,18,.92);
      border: 1px solid rgba(255,255,255,.18);
    }
    .btnSmall:disabled{ opacity:.45; }

    .homeStack{ display:flex; flex-direction:column; gap:14px; }

    .rowBetween{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .footSmall{ margin-top: 10px; text-align:center; font-size:14px; opacity:.72; }
    .footTiny{ margin-top: 6px; text-align:center; font-size:11px; opacity:.52; letter-spacing:.2px; }

    /* Labels + inputs */
    .fieldLabel{
      font-size: 16px;
      font-weight: 720;
      opacity: .72;
      margin: 2px 2px 8px;
      letter-spacing:.15px;
    }
    .fieldLabel i{ opacity:.72; font-weight:650; }

    input[type="number"], input[type="text"], input[type="date"]{
      width:100%;
      border-radius: 18px;
      border: 2px solid var(--inputStroke);
      background: var(--inputBg);
      color: var(--text);
      padding: 14px 14px;
      font-size: 18px;
      outline: none;
    }
    input[type="date"]{
      font-size: 16px;
      padding: 12px 12px;
    }
    input:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 4px rgba(90,160,255,.14);
    }

    /* Add: time line */
    .timeLine{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: .3px;
      opacity: .86;
      margin: 2px 2px 14px;
      line-height: 1.05;
      white-space: nowrap; /* keep on one line */
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    /* Symptoms: tight 2-column list */
    .symWrap{ margin-top: 8px; }
    .symGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      column-gap: 18px;
      row-gap: 4px;
      margin-top: 6px;
      padding: 4px 2px 2px;
    }
    .symItem{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0;
    }
    .symBox{
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 2px solid rgba(255,255,255,.45);
      background: transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
    }
    .symBox.on{
      border-color: rgba(90,160,255,.85);
      box-shadow: 0 0 0 3px rgba(90,160,255,.12);
    }
    .symText{
      font-size: 19px;
      font-weight: 700;
      opacity: .86;
    }

    .subTitle{
      font-size: 30px;
      font-weight: 760;
      opacity:.86;
      margin: 6px 2px 10px;
    }

    .tinyLine{
      font-size: 13px;
      opacity: .60;
      margin: 2px 2px 10px;
    }
    .card{
      border-radius: var(--r24);
      padding: 14px 14px 12px;
      background: linear-gradient(180deg, rgba(30,40,58,.55), rgba(18,24,38,.55));
      border: 1px solid rgba(255,255,255,.10);
      margin: 12px 0;
    }
    .cardTime{
      font-size: 16px;
      opacity: .62;
      font-weight: 650;
      letter-spacing: .2px;
    }
    .bpLine{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-top: 8px;
      gap: 12px;
    }
    .bpBig{
      font-size: 38px;
      font-weight: 820;
      letter-spacing: .2px;
      opacity: .92;
    }
    .hrBig{
      font-size: 30px;
      font-weight: 820;
      opacity: .88;
      white-space: nowrap;
    }
    .metaLine{
      margin-top: 10px;
      font-size: 18px;
      opacity: .80;
      line-height: 1.25;
    }
    .metaLine b{ opacity:.88; }

    .chartBox{
      border-radius: var(--r24);
      padding: 12px;
      background: linear-gradient(180deg, rgba(30,40,58,.55), rgba(18,24,38,.55));
      border: 1px solid rgba(255,255,255,.10);
    }
    canvas{ width:100%; height: 320px; display:block; }

    /* Modal (uninstall instructions) */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modalCard{
      width:min(560px, 100%);
      border-radius: 18px;
      padding: 16px;
      background: rgba(25,32,45,.96);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
    }
    .modalTitle{ font-size: 16px; font-weight: 820; margin-bottom: 10px; opacity:.95; }
    .modalText{ font-size: 14px; line-height: 1.35; opacity:.85; }
    .modalActions{ display:flex; justify-content:flex-end; margin-top: 14px; }

    @media (max-width: 520px){
      h1{ font-size: 46px; }
      .grid3{ grid-template-columns: 1fr 1fr 1fr; gap:10px; }
      .timeLine{ font-size: 24px; } /* prevent wrapping on small screens */
      .symText{ font-size: 18px; }
      .bpBig{ font-size: 34px; }
      .hrBig{ font-size: 28px; }
      canvas{ height: 290px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Vitals Tracker</h1>
    <div class="rule"></div>

    <!-- HOME -->
    <div id="viewHome" class="panel">
      <div class="homeStack">
        <button id="btnGoAdd" class="btn btnPrimary">Add</button>
        <button id="btnGoLog" class="btn">Log</button>
        <button id="btnGoCharts" class="btn">Charts</button>

        <!-- Install (left) + Exit (right) -->
        <div class="rowBetween" style="margin-top:6px;">
          <button id="btnInstall" class="btnSmall">Install</button>
          <button id="btnExitHome" class="btnSmall">Exit</button>
        </div>

        <div class="footSmall">Data stays on your phone (local only).</div>
        <div class="footTiny">Vitals Tracker v1.10 • developed by Keyth Jyles</div>
      </div>
    </div>

    <!-- ADD (no Exit here) -->
    <div id="viewAdd" class="panel hidden">
      <div class="timeLine" id="addNowLine">--:--:-- --, --/--/----</div>

      <div class="grid3">
        <div>
          <div class="fieldLabel">Systolic</div>
          <input id="inSys" type="number" inputmode="numeric" placeholder="e.g., 132" />
        </div>
        <div>
          <div class="fieldLabel">Diastolic</div>
          <input id="inDia" type="number" inputmode="numeric" placeholder="e.g., 91" />
        </div>
        <div>
          <div class="fieldLabel">Heart Rate</div>
          <input id="inHr" type="number" inputmode="numeric" placeholder="e.g., 72" />
        </div>
      </div>

      <div style="margin-top:10px; margin-bottom:12px;">
        <div class="fieldLabel">Notes <i>(optional)</i></div>
        <input id="inNotes" type="text" placeholder="optional" />
      </div>

      <div class="symWrap">
        <div class="fieldLabel" style="margin-bottom:4px;">Symptoms</div>
        <div id="symGrid" class="symGrid"></div>
      </div>

      <!-- Buttons just below symptoms -->
      <div class="rowBetween" style="margin-top:12px;">
        <button id="btnSave" class="btnSmall btnSmallPrimary">Save</button>
        <button id="btnBackFromAdd" class="btnSmall">Back</button>
      </div>
    </div>

    <!-- LOG (no Exit here) -->
    <div id="viewLog" class="panel hidden">
      <div class="rowBetween" style="margin-bottom:8px;">
        <button id="btnExportLog" class="btnSmall btnSmallPrimary">Export</button>
        <button id="btnBackFromLog" class="btnSmall">Back</button>
      </div>

      <div class="subTitle">Search</div>

      <input id="inSearch" type="text" placeholder="Type a word: sweaty, dizzy, headache..." />

      <!-- Date range (blank = all) -->
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;">
        <div>
          <div class="fieldLabel" style="font-size:14px; margin-bottom:6px;">From</div>
          <input id="inFrom" type="date" />
        </div>
        <div>
          <div class="fieldLabel" style="font-size:14px; margin-bottom:6px;">To</div>
          <input id="inTo" type="date" />
        </div>
      </div>

      <div class="tinyLine" id="showingLine">Showing: 0 of 0</div>
      <div id="logList"></div>
    </div>

    <!-- CHARTS (no Exit here) -->
    <div id="viewCharts" class="panel hidden">
      <div class="rowBetween" style="margin-bottom:8px;">
        <button id="btnExportChart" class="btnSmall btnSmallPrimary">Export</button>
        <button id="btnBackFromCharts" class="btnSmall">Back</button>
      </div>

      <div class="subTitle">Charts</div>

      <!-- Date range (blank = all) -->
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;">
        <div>
          <div class="fieldLabel" style="font-size:14px; margin-bottom:6px;">From</div>
          <input id="chartFrom" type="date" />
        </div>
        <div>
          <div class="fieldLabel" style="font-size:14px; margin-bottom:6px;">To</div>
          <input id="chartTo" type="date" />
        </div>
      </div>

      <div class="tinyLine" id="chartCountLine">Showing: 0 records</div>

      <div class="chartBox">
        <canvas id="chartCanvas" width="820" height="360"></canvas>
      </div>
    </div>
  </div>

  <!-- Uninstall modal -->
  <div id="uninstallModal" class="modal">
    <div class="modalCard">
      <div class="modalTitle">Uninstall</div>
      <div class="modalText">
        Uninstalling the app typically removes the app and clears its storage, but behavior can vary by device/browser.<br><br>
        <b>Android:</b> home screen → long-press <i>Vitals Tracker</i> → <b>Uninstall</b> (or <b>Remove</b>).<br><br>
        If you want guaranteed deletion, I can add a <b>Clear Data</b> button inside the app.
      </div>
      <div class="modalActions">
        <button id="btnUninstallClose" class="btnSmall">Close</button>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  const LS_KEY = "vitalsTracker.logs.v1";

  function loadLogs(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return [];
      const data = JSON.parse(raw);
      if(!Array.isArray(data)) return [];
      return data.filter(x => x && typeof x === "object" && typeof x.ts === "number");
    }catch(e){
      return [];
    }
  }

  function saveLogs(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function formatDate(d){
    return pad2(d.getMonth()+1)+"/"+pad2(d.getDate())+"/"+d.getFullYear();
  }

  function formatTime(d){
    let h = d.getHours();
    const m = d.getMinutes();
    const s = d.getSeconds();
    const ap = h >= 12 ? "PM" : "AM";
    h = h % 12; if(h === 0) h = 12;
    return pad2(h)+":"+pad2(m)+":"+pad2(s)+" "+ap;
  }

  function fmtStamp(ts){
    const d = new Date(ts);
    return formatDate(d)+", "+formatTime(d);
  }

  function parseYmd(str){
    if(!str) return null;              // blank => all data
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(str);
    if(!m) return null;
    const dt = new Date(+m[1], +m[2]-1, +m[3], 0, 0, 0, 0);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function withinRange(ts, fromDt, toDt){
    if(!fromDt && !toDt) return true;  // default: all
    const d = new Date(ts);
    const day = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0).getTime();
    if(fromDt){
      const f = new Date(fromDt.getFullYear(), fromDt.getMonth(), fromDt.getDate(), 0,0,0,0).getTime();
      if(day < f) return false;
    }
    if(toDt){
      const t = new Date(toDt.getFullYear(), toDt.getMonth(), toDt.getDate(), 0,0,0,0).getTime();
      if(day > t) return false;
    }
    return true;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, ch => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[ch]));
  }

  const views = {
    home: document.getElementById("viewHome"),
    add: document.getElementById("viewAdd"),
    log: document.getElementById("viewLog"),
    charts: document.getElementById("viewCharts")
  };

  function showView(name){
    Object.keys(views).forEach(k => views[k].classList.add("hidden"));
    views[name].classList.remove("hidden");
    if(name === "log") renderLog();
    if(name === "charts") renderCharts();
  }

  /* Symptoms */
  const SYMPTOMS = [
    "Sweaty","Dizzy","Panic","Brain fog",
    "Chest tight","Headache","Nausea","Short breath",
    "Hot ears","Shaky","Blurred vision","Weakness"
  ];

  const symGrid = document.getElementById("symGrid");
  const symState = new Set();

  function renderSymptoms(){
    symGrid.innerHTML = "";
    SYMPTOMS.forEach(label => {
      const row = document.createElement("div");
      row.className = "symItem";
      row.tabIndex = 0;

      const box = document.createElement("div");
      box.className = "symBox";

      const text = document.createElement("div");
      text.className = "symText";
      text.textContent = label;

      function sync(){
        box.classList.toggle("on", symState.has(label));
      }
      function toggle(){
        if(symState.has(label)) symState.delete(label);
        else symState.add(label);
        sync();
      }

      row.addEventListener("click", toggle);
      row.addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); toggle(); }});

      row.appendChild(box);
      row.appendChild(text);
      symGrid.appendChild(row);
      sync();
    });
  }

  /* Add clock */
  const addNowLine = document.getElementById("addNowLine");
  let addClockTimer = null;

  function startAddClock(){
    stopAddClock();
    const tick = () => {
      const d = new Date();
      addNowLine.textContent = formatTime(d)+", "+formatDate(d);
    };
    tick();
    addClockTimer = setInterval(tick, 1000);
  }
  function stopAddClock(){
    if(addClockTimer){ clearInterval(addClockTimer); addClockTimer = null; }
  }

  function clearAddForm(){
    document.getElementById("inSys").value = "";
    document.getElementById("inDia").value = "";
    document.getElementById("inHr").value = "";
    document.getElementById("inNotes").value = "";
    symState.clear();
    renderSymptoms();
  }

  function toInt(v){
    const n = parseInt(String(v||"").trim(), 10);
    return Number.isFinite(n) ? n : null;
  }

  function saveRecord(){
    const sys = toInt(document.getElementById("inSys").value);
    const dia = toInt(document.getElementById("inDia").value);
    const hr  = toInt(document.getElementById("inHr").value);
    const notes = (document.getElementById("inNotes").value || "").trim();

    if(sys===null || dia===null || hr===null){
      alert("Enter Systolic, Diastolic, and Heart Rate.");
      return;
    }

    const rec = {
      ts: Date.now(),
      sys, dia, hr,
      notes: notes || "",
      symptoms: Array.from(symState)
    };

    const logs = loadLogs();
    logs.push(rec);
    logs.sort((a,b)=>b.ts - a.ts);
    saveLogs(logs);

    clearAddForm();
    stopAddClock();
    showView("home");
  }

  /* Log */
  const inSearch = document.getElementById("inSearch");
  const inFrom = document.getElementById("inFrom");
  const inTo = document.getElementById("inTo");
  const logList = document.getElementById("logList");
  const showingLine = document.getElementById("showingLine");
  const btnExportLog = document.getElementById("btnExportLog");

  function getFilteredLogs(){
    const logs = loadLogs();
    const q = (inSearch.value||"").trim().toLowerCase();
    const fromDt = parseYmd(inFrom.value);
    const toDt = parseYmd(inTo.value);

    const filtered = logs.filter(r => {
      if(!withinRange(r.ts, fromDt, toDt)) return false;
      if(!q) return true;

      const parts = [];
      parts.push(String(r.sys||""));
      parts.push(String(r.dia||""));
      parts.push(String(r.hr||""));
      if(r.notes) parts.push(r.notes);
      if(Array.isArray(r.symptoms)) parts.push(r.symptoms.join(", "));
      const hay = parts.join(" ").toLowerCase();
      return hay.includes(q);
    });

    return { logs, filtered };
  }

  function renderLog(){
    const { logs, filtered } = getFilteredLogs();
    showingLine.textContent = "Showing: "+filtered.length+" of "+logs.length;
    btnExportLog.disabled = filtered.length === 0;
    logList.innerHTML = "";

    if(filtered.length === 0){
      const empty = document.createElement("div");
      empty.className = "tinyLine";
      empty.style.marginTop = "12px";
      empty.textContent = "No matching records.";
      logList.appendChild(empty);
      return;
    }

    filtered.forEach(r => {
      const card = document.createElement("div");
      card.className = "card";

      const t = document.createElement("div");
      t.className = "cardTime";
      t.textContent = fmtStamp(r.ts);
      card.appendChild(t);

      const bp = document.createElement("div");
      bp.className = "bpLine";

      const bpBig = document.createElement("div");
      bpBig.className = "bpBig";
      bpBig.textContent = "BP "+r.sys+"/"+r.dia;

      const hrBig = document.createElement("div");
      hrBig.className = "hrBig";
      hrBig.textContent = "HR "+r.hr;

      bp.appendChild(bpBig);
      bp.appendChild(hrBig);
      card.appendChild(bp);

      const sym = (Array.isArray(r.symptoms) && r.symptoms.length) ? r.symptoms.join(", ") : "None";
      const notes = r.notes ? r.notes : "None";

      const meta1 = document.createElement("div");
      meta1.className = "metaLine";
      meta1.innerHTML = "<b>Symptoms:</b> "+escapeHtml(sym);

      const meta2 = document.createElement("div");
      meta2.className = "metaLine";
      meta2.innerHTML = "<b>Notes:</b> "+escapeHtml(notes);

      card.appendChild(meta1);
      card.appendChild(meta2);

      logList.appendChild(card);
    });
  }

  /* Export */
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      alert("Export copied to clipboard.");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position="fixed";
      ta.style.left="-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{
        document.execCommand("copy");
        alert("Export copied to clipboard.");
      }catch(_){
        alert("Copy failed. Your browser may block clipboard access.");
      }
      document.body.removeChild(ta);
    }
  }

  function buildExportText(records){
    return records.map(r => {
      const d = new Date(r.ts);
      const line1 = formatDate(d)+", "+formatTime(d)+" — BP "+r.sys+"/"+r.dia+" — HR "+r.hr;
      const sym = (Array.isArray(r.symptoms) && r.symptoms.length) ? r.symptoms.join(", ") : "None";
      const notes = r.notes ? r.notes : "None";
      return line1+"\nSymptoms: "+sym+"\nNotes: "+notes;
    }).join("\n\n");
  }

  async function exportLog(){
    const { filtered } = getFilteredLogs();
    if(filtered.length === 0) return;
    await copyText(buildExportText(filtered));
  }

  /* Charts */
  const chartFrom = document.getElementById("chartFrom");
  const chartTo = document.getElementById("chartTo");
  const chartCanvas = document.getElementById("chartCanvas");
  const chartCountLine = document.getElementById("chartCountLine");
  const btnExportChart = document.getElementById("btnExportChart");

  function getChartFiltered(){
    const logs = loadLogs().slice().sort((a,b)=>a.ts - b.ts);
    const fromDt = parseYmd(chartFrom.value);
    const toDt = parseYmd(chartTo.value);
    const filtered = logs.filter(r => withinRange(r.ts, fromDt, toDt));
    return { filtered };
  }

  function renderCharts(){
    const { filtered } = getChartFiltered();
    chartCountLine.textContent = "Showing: "+filtered.length+" records";
    btnExportChart.disabled = filtered.length === 0;
    drawChart(filtered);
  }

  function drawChart(data){
    const c = chartCanvas;
    const ctx = c.getContext("2d");

    const rect = c.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    c.width = Math.floor(rect.width * dpr);
    c.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const W = rect.width, H = rect.height;

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "rgba(10,14,22,.35)";
    ctx.fillRect(0,0,W,H);

    if(!data || data.length < 2){
      ctx.fillStyle = "rgba(245,248,255,.70)";
      ctx.font = "16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(data && data.length===1 ? "Add at least 2 records to chart trends." : "No data in this date range.", 14, 28);
      return;
    }

    const sys = data.map(d=>d.sys);
    const dia = data.map(d=>d.dia);
    const hr  = data.map(d=>d.hr);

    const minY = Math.min(...sys, ...dia, ...hr);
    const maxY = Math.max(...sys, ...dia, ...hr);
    const span = Math.max(10, maxY - minY);
    const y0 = Math.floor(minY - span*0.12);
    const y1 = Math.ceil(maxY + span*0.12);

    const pad = { l: 52, r: 14, t: 14, b: 46 };

    function xAt(i){
      const n = data.length;
      const innerW = W - pad.l - pad.r;
      return pad.l + (i/(n-1))*innerW;
    }
    function yAt(v){
      const innerH = H - pad.t - pad.b;
      const t = (v - y0) / (y1 - y0);
      return (H - pad.b) - t*innerH;
    }

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    ctx.font = "14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "rgba(245,248,255,.72)";

    const yTicks = 5;
    for(let i=0;i<=yTicks;i++){
      const v = y0 + (i/yTicks)*(y1-y0);
      const y = yAt(v);
      ctx.beginPath();
      ctx.moveTo(pad.l, y);
      ctx.lineTo(W-pad.r, y);
      ctx.stroke();
      ctx.fillText(String(Math.round(v)), 10, y+5);
    }

    const first = new Date(data[0].ts);
    const last  = new Date(data[data.length-1].ts);
    ctx.fillStyle = "rgba(245,248,255,.62)";
    ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(formatDate(first), pad.l, H-18);
    const lastTxt = formatDate(last);
    const lastW = ctx.measureText(lastTxt).width;
    ctx.fillText(lastTxt, W - pad.r - lastW, H-18);

    function drawLine(vals, color){
      ctx.strokeStyle = color;
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      vals.forEach((v,i)=>{
        const x = xAt(i), y = yAt(v);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle = color;
      vals.forEach((v,i)=>{
        const x = xAt(i), y = yAt(v);
        ctx.beginPath();
        ctx.arc(x,y,2.8,0,Math.PI*2);
        ctx.fill();
      });
    }

    drawLine(sys, "rgba(90,160,255,.92)");
    drawLine(dia, "rgba(220,230,245,.78)");
    drawLine(hr,  "rgba(120,220,180,.85)");

    let lx = pad.l + 6;
    let ly = pad.t + 22;
    ctx.font = "16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    function legendItem(name, color){
      ctx.fillStyle = color;
      ctx.fillRect(lx, ly-10, 18, 6);
      ctx.fillStyle = "rgba(245,248,255,.80)";
      ctx.fillText(name, lx+26, ly-4);
      ly += 20;
    }
    legendItem("Systolic", "rgba(90,160,255,.92)");
    legendItem("Diastolic", "rgba(220,230,245,.78)");
    legendItem("Heart Rate", "rgba(120,220,180,.85)");
  }

  async function exportChart(){
    const { filtered } = getChartFiltered();
    if(filtered.length === 0) return;
    const newestFirst = filtered.slice().sort((a,b)=>b.ts-a.ts);
    await copyText(buildExportText(newestFirst));
  }

  /* Install / Uninstall */
  const btnInstall = document.getElementById("btnInstall");
  const uninstallModal = document.getElementById("uninstallModal");
  const btnUninstallClose = document.getElementById("btnUninstallClose");

  let deferredInstallPrompt = null;

  function isStandaloneMode(){
    return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
  }

  function setInstallButtonState(){
    if(isStandaloneMode()){
      btnInstall.textContent = "Uninstall";
      btnInstall.dataset.mode = "uninstall";
      return;
    }
    btnInstall.textContent = "Install";
    btnInstall.dataset.mode = "install";
  }

  window.addEventListener("beforeinstallprompt", (e)=>{
    e.preventDefault();
    deferredInstallPrompt = e;
    setInstallButtonState();
  });

  window.addEventListener("appinstalled", ()=>{
    deferredInstallPrompt = null;
    setInstallButtonState();
  });

  function showUninstallModal(on){
    uninstallModal.style.display = on ? "flex" : "none";
  }

  btnInstall.addEventListener("click", async ()=>{
    if(btnInstall.dataset.mode === "uninstall"){
      showUninstallModal(true);
      return;
    }
    if(deferredInstallPrompt){
      deferredInstallPrompt.prompt();
      try{ await deferredInstallPrompt.userChoice; }catch(_){}
      deferredInstallPrompt = null;
      setInstallButtonState();
      return;
    }
    alert('To install: open your browser menu and tap "Install app" or "Add to Home screen".');
  });

  btnUninstallClose.addEventListener("click", ()=>showUninstallModal(false));
  uninstallModal.addEventListener("click", (e)=>{ if(e.target === uninstallModal) showUninstallModal(false); });

  document.addEventListener("visibilitychange", ()=>{
    if(!document.hidden) setInstallButtonState();
  });

  /* Navigation buttons */
  document.getElementById("btnGoAdd").addEventListener("click", ()=>{
    showView("add");
    startAddClock();
  });

  document.getElementById("btnGoLog").addEventListener("click", ()=>{
    showView("log");
    stopAddClock();
  });

  document.getElementById("btnGoCharts").addEventListener("click", ()=>{
    showView("charts");
    stopAddClock();
  });

  document.getElementById("btnBackFromAdd").addEventListener("click", ()=>{
    showView("home");
    stopAddClock();
  });

  document.getElementById("btnBackFromLog").addEventListener("click", ()=>showView("home"));
  document.getElementById("btnBackFromCharts").addEventListener("click", ()=>showView("home"));

  function attemptExit(){
    window.close();
    setTimeout(()=>{ alert("If Exit doesn't work: use your browser back/home."); }, 150);
  }
  document.getElementById("btnExitHome").addEventListener("click", attemptExit);

  document.getElementById("btnSave").addEventListener("click", saveRecord);
  document.getElementById("btnExportLog").addEventListener("click", exportLog);
  document.getElementById("btnExportChart").addEventListener("click", exportChart);

  /* Re-render on filters */
  ["input","change"].forEach(evt=>{
    document.getElementById("inSearch").addEventListener(evt, renderLog);
    document.getElementById("inFrom").addEventListener(evt, renderLog);
    document.getElementById("inTo").addEventListener(evt, renderLog);

    document.getElementById("chartFrom").addEventListener(evt, renderCharts);
    document.getElementById("chartTo").addEventListener(evt, renderCharts);
  });

  /* Init */
  renderSymptoms();
  clearAddForm();

  // Force date inputs blank on load (default = all data)
  requestAnimationFrame(()=>{
    document.getElementById("inFrom").value = "";
    document.getElementById("inTo").value = "";
    document.getElementById("chartFrom").value = "";
    document.getElementById("chartTo").value = "";
  });

  setInstallButtonState();
  showView("home");

})();
</script>
</body>
</html>
