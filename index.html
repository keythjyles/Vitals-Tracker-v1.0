<!-- File: index.html -->
<!--
Vitals Tracker — Function-First Shell
Copyright (c) 2026 Wendell K. Jiles. All rights reserved.
App Version: v2.022
Base: v2.021
Date: 2026-01-18

Change Log (v2.022)
1) Adds "Add Reading" as the primary CTA (Home + Top Nav) and introduces the Add panel shell (UI only).
2) Add panel is a structured, collapsible UX shell for future functionality:
   - Vitals section (BP/HR/Notes + Symptoms placeholder) is expanded by default.
   - Distress and Medication sections are present but collapsed.
3) No storage writes, no validation, no record creation in this version. Read-only behavior remains intact.
4) Version drift guard: script cache-busters updated to v2.022.

Add Feature Contract (locked reference)
- Flow: One tap -> Add panel -> Vitals expanded, others collapsed.
- Data model target (future): {ts, sys, dia, hr, notes, symptoms[], distress?, meds?}
- Distress scale target: 0–5 with user labels (never numbers alone).

File Structure / Reference Points
- Panels: #panelHome, #panelAdd, #panelLog, #panelCharts
- Add: #addCard, #addVitals, #addDistress, #addMeds
- Chart: #canvasWrap, #chartCanvas
- Log: #logList, #logMoreLink, #logCard
Dependencies expected:
- ./js/storage.js
- ./js/gestures.js
(Next file to implement Add logic: ./js/add.js)
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Vitals Tracker</title>

  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;
      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --text:rgba(235,245,255,.88);
      --muted:rgba(235,245,255,.58);
      --muted2:rgba(235,245,255,.42);
      --accent:#2b4e7a;
      --shadow:0 18px 42px rgba(0,0,0,.45);
      --r:22px;
      --r2:26px;
      --pad:16px;
      --gap:12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(70,140,255,.20), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(80,160,255,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:14px 12px calc(14px + env(safe-area-inset-bottom));
      gap:12px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border:1px solid var(--stroke2);
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      gap:10px;
    }
    .title{font-weight:800; letter-spacing:.2px; font-size:22px;}
    .boot{font-size:13px; color:var(--muted); letter-spacing:.25px; white-space:nowrap;}

    .shell{
      flex:1;
      min-height:0;
      border:2px solid rgba(60,120,210,.55);
      border-radius: var(--r2);
      padding:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panels{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }
    .panel{
      height:100%;
      display:none;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }
    .panel.active{display:flex}

    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--stroke2);
      border-radius:999px;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .panelHeader .name{
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:56%;
    }

    .nav{display:flex; gap:8px; flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling:touch;}
    .btn{
      border:1px solid var(--stroke2);
      color:var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius:999px;
      padding:10px 12px;
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      color:var(--muted);
      border-color:var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      font-weight:700;
    }
    .btn.primary{
      border-color: rgba(120,180,255,.45);
      background: linear-gradient(180deg, rgba(80,150,255,.34), rgba(80,150,255,.14));
    }
    .btn[disabled]{opacity:.55; cursor:not-allowed}

    .card{
      border:1px solid var(--stroke2);
      border-radius: var(--r);
      padding:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      overflow:auto;
      min-height:0;
    }
    .muted{color:var(--muted)}
    .small{font-size:13px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .kv{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:8px 12px;
      margin-top:10px;
      font-size:15px;
    }
    .kv .k{color:var(--muted)}
    .kv .v{color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .list{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(0,0,0,.18);
    }
    .rowTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-weight:800;
      flex-wrap:wrap;
    }
    .rowSub{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.25}
    .pill{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--stroke2);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .canvasWrap{
      border:1px solid var(--stroke2);
      border-radius: var(--r);
      padding:6px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      touch-action:none;
    }
    canvas{
      display:block;
      width:100%;
      height:260px;
      image-rendering: crisp-edges;
    }

    .hint{margin-top:10px; color:var(--muted); line-height:1.35;}

    .pull{
      height:0px;
      overflow:hidden;
      transition:height .18s ease;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.2px;
      text-align:center;
    }

    .linkish{
      margin-top:12px;
      display:inline-block;
      color:rgba(170,210,255,.92);
      font-weight:900;
      letter-spacing:.15px;
      text-decoration:none;
      border:1px solid rgba(170,210,255,.30);
      background: rgba(60,120,210,.12);
      padding:10px 12px;
      border-radius:999px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .linkish:active{transform:translateY(1px)}

    /* Chart label: hard single line, centered */
    #chartsTopNote{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
      display:block;
      padding:0 10px;
    }

    /* Add panel accordion shell */
    .acc{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    .accHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-bottom:1px solid rgba(255,255,255,.04);
    }
    .accHead .hTitle{
      font-weight:900;
      letter-spacing:.15px;
      font-size:15px;
    }
    .accHead .hMeta{
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .accBody{
      display:none;
      padding:12px;
    }
    .acc.open .accBody{display:block}
    .acc.open .accHead{border-bottom:1px solid var(--stroke)}
    .accArrow{
      width:28px;
      height:28px;
      border:1px solid var(--stroke2);
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-weight:900;
      flex:0 0 auto;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .label{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.15px;
    }
    .in{
      width:100%;
      border:1px solid var(--stroke2);
      border-radius:14px;
      padding:12px 12px;
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    .in:focus{
      border-color: rgba(120,180,255,.45);
      box-shadow: 0 0 0 3px rgba(80,150,255,.10);
    }
    textarea.in{
      min-height:76px;
      resize:none;
      line-height:1.2;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="title">Vitals Tracker</div>
      <div class="boot" id="bootText">BOOT OK v2.022</div>
    </div>

    <div class="shell">
      <div class="panels" id="panelsRoot">

        <!-- HOME PANEL -->
        <section class="panel active" id="panelHome" aria-label="Home">
          <div class="panelHeader">
            <div class="name">Home</div>
            <div class="nav">
              <button class="btn primary" id="btnAdd">Add Reading</button>
              <button class="btn secondary" id="btnHome">Home</button>
              <button class="btn secondary" id="btnLog">Log</button>
              <button class="btn secondary" id="btnCharts">Charts</button>
              <button class="btn primary" id="btnInstall" disabled>Install</button>
            </div>
          </div>

          <div class="pull" id="pullIndicator">Release to refresh</div>

          <div class="card" id="homeCard">
            <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
              <div class="muted">Function-first shell. Data detection is read-only.</div>
              <button class="btn primary" id="btnAdd2">Add Reading</button>
            </div>

            <div class="hint small">
              Pull down on Home to refresh (release).
              <div id="bridgeStatus" class="small" style="margin-top:10px;"></div>
            </div>

            <div class="card" style="margin-top:12px;" id="detectedCard">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <div style="font-weight:900; font-size:20px;">Data Detected (Read-Only)</div>
                <span class="pill" id="detectedPill">—</span>
              </div>
              <div class="kv" aria-label="Data summary">
                <div class="k">Source</div><div class="v" id="sumSource">Not loaded</div>
                <div class="k">Entries</div><div class="v" id="sumEntries">—</div>
                <div class="k">Newest</div><div class="v mono" id="sumNewest">—</div>
              </div>
            </div>
          </div>
        </section>

        <!-- ADD PANEL (SHELL ONLY) -->
        <section class="panel" id="panelAdd" aria-label="Add Reading">
          <div class="panelHeader">
            <div class="name">Add Reading</div>
            <div class="nav">
              <button class="btn secondary" id="btnBackFromAdd">Home</button>
              <button class="btn secondary" id="btnLogFromAdd">Log</button>
              <button class="btn secondary" id="btnChartsFromAdd">Charts</button>
            </div>
          </div>

          <div class="card" id="addCard">
            <div class="muted" id="addTopNote">Shell only (no saving in v2.022).</div>

            <div class="acc open" id="addVitals" style="margin-top:12px;">
              <div class="accHead" role="button" aria-expanded="true" tabindex="0">
                <div>
                  <div class="hTitle">Vitals</div>
                  <div class="hMeta">BP • HR • Notes</div>
                </div>
                <div class="accArrow" aria-hidden="true">▾</div>
              </div>
              <div class="accBody">
                <div class="grid2">
                  <div class="field">
                    <div class="label">Systolic</div>
                    <input class="in" id="inSys" inputmode="numeric" autocomplete="off" placeholder="e.g., 132" />
                  </div>
                  <div class="field">
                    <div class="label">Diastolic</div>
                    <input class="in" id="inDia" inputmode="numeric" autocomplete="off" placeholder="e.g., 84" />
                  </div>
                </div>
                <div class="grid2" style="margin-top:10px;">
                  <div class="field">
                    <div class="label">Heart Rate</div>
                    <input class="in" id="inHr" inputmode="numeric" autocomplete="off" placeholder="e.g., 74" />
                  </div>
                  <div class="field">
                    <div class="label">Time</div>
                    <input class="in" id="inTime" autocomplete="off" placeholder="Auto (next file)" disabled />
                  </div>
                </div>

                <div class="field" style="margin-top:10px;">
                  <div class="label">Notes</div>
                  <textarea class="in" id="inNotes" placeholder="Optional"></textarea>
                </div>

                <div class="muted small" style="margin-top:10px;">
                  Symptoms UI (expanded by default) will be wired in the next Add file.
                </div>
              </div>
            </div>

            <div class="acc" id="addDistress" style="margin-top:12px;">
              <div class="accHead" role="button" aria-expanded="false" tabindex="0">
                <div>
                  <div class="hTitle">Distress</div>
                  <div class="hMeta">0–5 labeled</div>
                </div>
                <div class="accArrow" aria-hidden="true">▸</div>
              </div>
              <div class="accBody">
                <div class="muted small">Distress scale + follow-up prompts will be implemented in a later file.</div>
              </div>
            </div>

            <div class="acc" id="addMeds" style="margin-top:12px;">
              <div class="accHead" role="button" aria-expanded="false" tabindex="0">
                <div>
                  <div class="hTitle">Medication</div>
                  <div class="hMeta">event marker only</div>
                </div>
                <div class="accArrow" aria-hidden="true">▸</div>
              </div>
              <div class="accBody">
                <div class="muted small">Medication event entry will be implemented in a later file.</div>
              </div>
            </div>

            <div class="muted small" style="margin-top:12px;">
              Save/Submit button is intentionally not present in v2.022 to prevent any accidental writes.
            </div>
          </div>
        </section>

        <!-- LOG PANEL -->
        <section class="panel" id="panelLog" aria-label="Log">
          <div class="panelHeader">
            <div class="name">Log (read-only)</div>
            <div class="nav">
              <button class="btn secondary" id="btnBackFromLog">Home</button>
              <button class="btn secondary" id="btnChartsFromLog">Charts</button>
              <button class="btn primary" id="btnAddFromLog">Add Reading</button>
            </div>
          </div>

          <div class="card" id="logCard">
            <div class="muted" id="logTopNote">Loading…</div>
            <ul class="list" id="logList" style="margin-top:12px;"></ul>
            <a href="#" class="linkish" id="logMoreLink" style="display:none;">Load next 25</a>
          </div>
        </section>

        <!-- CHARTS PANEL -->
        <section class="panel" id="panelCharts" aria-label="Charts">
          <div class="panelHeader">
            <div class="name">Charts (Read-Only)</div>
            <div class="nav">
              <button class="btn secondary" id="btnBackFromCharts">Home</button>
              <button class="btn secondary" id="btnLogFromCharts">Log</button>
              <button class="btn primary" id="btnAddFromCharts">Add Reading</button>
            </div>
          </div>

          <div class="card" id="chartsCard" style="padding:12px;">
            <div class="muted" id="chartsTopNote">Loading…</div>
            <div class="canvasWrap" id="canvasWrap" style="margin-top:10px;">
              <canvas id="chartCanvas"></canvas>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <script src="./js/storage.js?v=2.022"></script>
  <script src="./js/gestures.js?v=2.022"></script>

  <script>
    (function(){
      const APP_VERSION = "v2.022";
      const TZ = "America/Chicago";
      const PAGE_SIZE = 25;

      const panelHome = document.getElementById("panelHome");
      const panelAdd = document.getElementById("panelAdd");
      const panelLog = document.getElementById("panelLog");
      const panelCharts = document.getElementById("panelCharts");

      function showPanel(which){
        panelHome.classList.remove("active");
        panelAdd.classList.remove("active");
        panelLog.classList.remove("active");
        panelCharts.classList.remove("active");

        if(which === "home") panelHome.classList.add("active");
        if(which === "add") panelAdd.classList.add("active");
        if(which === "log") panelLog.classList.add("active");
        if(which === "charts") panelCharts.classList.add("active");

        if(which === "charts"){
          setupCanvas();
          renderCharts();
        }
      }

      const btnHome = document.getElementById("btnHome");
      const btnLog = document.getElementById("btnLog");
      const btnCharts = document.getElementById("btnCharts");
      const btnInstall = document.getElementById("btnInstall");

      const btnAdd = document.getElementById("btnAdd");
      const btnAdd2 = document.getElementById("btnAdd2");

      document.getElementById("btnBackFromLog").onclick = () => showPanel("home");
      document.getElementById("btnChartsFromLog").onclick = () => showPanel("charts");
      document.getElementById("btnBackFromCharts").onclick = () => showPanel("home");
      document.getElementById("btnLogFromCharts").onclick = () => showPanel("log");

      document.getElementById("btnBackFromAdd").onclick = () => showPanel("home");
      document.getElementById("btnLogFromAdd").onclick = () => showPanel("log");
      document.getElementById("btnChartsFromAdd").onclick = () => showPanel("charts");

      document.getElementById("btnAddFromLog").onclick = () => showPanel("add");
      document.getElementById("btnAddFromCharts").onclick = () => showPanel("add");

      btnHome.onclick = () => showPanel("home");
      btnLog.onclick = () => showPanel("log");
      btnCharts.onclick = () => showPanel("charts");

      btnAdd.onclick = () => showPanel("add");
      btnAdd2.onclick = () => showPanel("add");

      // Accordion shell toggles (UI only)
      function wireAcc(id){
        const el = document.getElementById(id);
        if(!el) return;
        const head = el.querySelector(".accHead");
        const arrow = el.querySelector(".accArrow");
        const setOpen = (open) => {
          el.classList.toggle("open", open);
          head.setAttribute("aria-expanded", open ? "true" : "false");
          if(arrow) arrow.textContent = open ? "▾" : "▸";
        };
        const toggle = () => setOpen(!el.classList.contains("open"));
        head.addEventListener("click", toggle);
        head.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            toggle();
          }
        });
      }
      wireAcc("addVitals");
      wireAcc("addDistress");
      wireAcc("addMeds");

      // Pull-to-refresh (Home only; safe)
      const pullIndicator = document.getElementById("pullIndicator");
      const homeCard = document.getElementById("homeCard");
      let pullStartY = null;
      let pullArmed = false;

      panelHome.addEventListener("touchstart", (e) => {
        if(homeCard.scrollTop !== 0) return;
        pullStartY = e.touches[0].clientY;
        pullArmed = false;
      }, {passive:true});

      panelHome.addEventListener("touchmove", (e) => {
        if(pullStartY == null) return;
        const dy = e.touches[0].clientY - pullStartY;
        if(dy > 0){
          const h = Math.min(48, Math.floor(dy/2));
          pullIndicator.style.height = h + "px";
          pullArmed = (h >= 36);
        }
      }, {passive:true});

      panelHome.addEventListener("touchend", () => {
        if(pullStartY == null) return;
        const armed = pullArmed;
        pullStartY = null;
        pullArmed = false;
        pullIndicator.style.height = "0px";
        if(armed) location.reload();
      });

      // Install prompt
      let deferredPrompt = null;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        btnInstall.disabled = false;
      });

      btnInstall.addEventListener("click", async () => {
        try{
          if(!deferredPrompt) return;
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
        } finally {
          deferredPrompt = null;
          btnInstall.disabled = true;
        }
      });

      // Service worker (cache-busted)
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./sw.js?v=2.022").catch(()=>{});
      }

      // UI summary nodes
      const bridgeStatus = document.getElementById("bridgeStatus");
      const sumSource = document.getElementById("sumSource");
      const sumEntries = document.getElementById("sumEntries");
      const sumNewest = document.getElementById("sumNewest");
      const detectedPill = document.getElementById("detectedPill");

      // Log nodes
      const logTopNote = document.getElementById("logTopNote");
      const logList = document.getElementById("logList");
      const logMoreLink = document.getElementById("logMoreLink");
      const logCard = document.getElementById("logCard");

      // Charts nodes
      const chartsTopNote = document.getElementById("chartsTopNote");
      const canvasWrap = document.getElementById("canvasWrap");
      const chartCanvas = document.getElementById("chartCanvas");

      // Data (read-only)
      let allRecords = [];
      let logOffset = 0;

      // --- Time formatting (Central) ---
      function fmtDT(ts){
        try{
          const d = new Date(ts);
          const s = new Intl.DateTimeFormat("en-US", {
            timeZone: TZ,
            year:"numeric", month:"2-digit", day:"2-digit",
            hour:"2-digit", minute:"2-digit",
            hour12:true
          }).format(d);
          return s.replace(",", "");
        }catch(_){ return String(ts); }
      }

      function fmtDateOnly(ts){
        try{
          const d = new Date(ts);
          return new Intl.DateTimeFormat("en-US", {
            timeZone: TZ,
            year:"numeric", month:"2-digit", day:"2-digit"
          }).format(d);
        }catch(_){ return String(ts); }
      }

      function safeNum(x){
        const n = Number(x);
        return Number.isFinite(n) ? n : null;
      }

      // --- Storage bridge (read-only) ---
      function tryReadViaModule(){
        const S = window.VTStorage || window.StorageBridge || null;
        if(!S) return null;

        // Try common shapes: getAllRecords(), readAll(), list(), getAll()
        const candidates = [
          () => S.getAllRecords && S.getAllRecords(),
          () => S.readAll && S.readAll(),
          () => S.getAll && S.getAll(),
          () => S.list && S.list(),
          () => S.records && S.records()
        ];

        for(const fn of candidates){
          try{
            const r = fn();
            if(!r) continue;
            if(typeof r.then === "function") return r;
            return Promise.resolve(r);
          }catch(_){}
        }
        return null;
      }

      function tryReadFromLocalStorage(){
        const keys = [
          "vitals_tracker_records_v2",
          "vitals_tracker_records_v1",
          "vitals_tracker_records",
          "VT_RECORDS",
          "records"
        ];
        for(const k of keys){
          try{
            const raw = localStorage.getItem(k);
            if(!raw) continue;
            const parsed = JSON.parse(raw);
            if(Array.isArray(parsed)) return { source:`localStorage:${k}`, records: parsed };
            if(parsed && Array.isArray(parsed.records)) return { source:`localStorage:${k}`, records: parsed.records };
          }catch(_){}
        }
        return { source:"localStorage:none", records: [] };
      }

      function normalizeRecords(arr){
        if(!Array.isArray(arr)) return [];
        const out = [];
        for(const it of arr){
          if(!it) continue;
          const ts = safeNum(it.ts ?? it.time ?? it.t ?? it.date ?? it.datetime);
          const sys = safeNum(it.sys ?? it.systolic ?? it.SYS);
          const dia = safeNum(it.dia ?? it.diastolic ?? it.DIA);
          const hr  = safeNum(it.hr  ?? it.heartRate ?? it.pulse ?? it.HR);

          // minimal acceptance: needs ts and at least one vital
          if(!ts) continue;
          if(sys==null && dia==null && hr==null) continue;

          out.push({
            ts,
            sys, dia, hr,
            notes: (it.notes ?? it.note ?? "").toString(),
            symptoms: Array.isArray(it.symptoms) ? it.symptoms : (Array.isArray(it.sx) ? it.sx : []),
          });
        }
        out.sort((a,b)=>a.ts-b.ts);
        return out;
      }

      async function loadRecordsReadOnly(){
        // 1) try module
        const p = tryReadViaModule();
        if(p){
          try{
            const r = await p;
            // r might be array or object
            if(Array.isArray(r)) return { source:"module", records: normalizeRecords(r) };
            if(r && Array.isArray(r.records)) return { source:(r.source||"module"), records: normalizeRecords(r.records) };
            // if module returns {items:[]}
            if(r && Array.isArray(r.items)) return { source:(r.source||"module"), records: normalizeRecords(r.items) };
          }catch(_){}
        }
        // 2) localStorage fallback
        const ls = tryReadFromLocalStorage();
        return { source: ls.source, records: normalizeRecords(ls.records) };
      }

      function updateHomeSummary(source, recs){
        const count = recs.length;
        const newest = count ? recs[count-1].ts : null;

        sumSource.textContent = source || "unknown";
        sumEntries.textContent = String(count);
        sumNewest.textContent = newest ? fmtDT(newest) : "—";

        detectedPill.textContent = count ? "YES" : "NO";
        bridgeStatus.textContent = count
          ? `Loaded ${count} record(s). No changes made.`
          : `No records found. This version does not create new records.`;
      }

      function escapeHtml(s){
        return (s ?? "").toString()
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function renderLogPage(append){
        if(!append){
          logList.innerHTML = "";
          logOffset = 0;
        }

        const slice = allRecords
          .slice()
          .sort((a,b)=>b.ts-a.ts)
          .slice(logOffset, logOffset + PAGE_SIZE);

        for(const r of slice){
          const li = document.createElement("li");
          li.className = "row";
          const bp = (r.sys!=null && r.dia!=null) ? `${r.sys}/${r.dia}` : (r.sys!=null ? `${r.sys}/—` : `—/${r.dia??"—"}`);
          const hr = (r.hr!=null) ? `${r.hr}` : "—";
          const dt = fmtDT(r.ts);
          li.innerHTML = `
            <div class="rowTop">
              <div>${escapeHtml(dt)}</div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
                <span class="pill">BP ${escapeHtml(bp)}</span>
                <span class="pill">HR ${escapeHtml(hr)}</span>
              </div>
            </div>
            ${r.notes ? `<div class="rowSub">${escapeHtml(r.notes)}</div>` : ``}
          `;
          logList.appendChild(li);
        }

        logOffset += slice.length;

        const remaining = allRecords.length - logOffset;
        logMoreLink.style.display = remaining > 0 ? "inline-block" : "none";

        logTopNote.textContent = allRecords.length
          ? `Showing ${Math.min(logOffset, allRecords.length)} of ${allRecords.length} record(s). Tap “Load next 25” to continue.`
          : `No records found.`;
      }

      logMoreLink.addEventListener("click", (e)=>{
        e.preventDefault();
        // append right where the button sits (no jump)
        const before = logMoreLink.getBoundingClientRect().top;
        renderLogPage(true);
        // keep viewport stable: keep the "button area" from jumping upward
        const after = logMoreLink.getBoundingClientRect().top;
        const delta = after - before;
        // If the button moved, adjust scroll to keep context stable
        if(delta !== 0){
          logCard.scrollTop += delta;
        }
      });

      // ---- Simple chart fallback (read-only) ----
      let ctx = null;
      let dpr = 1;

      function setupCanvas(){
        if(!chartCanvas) return;
        dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
        const cssW = canvasWrap.clientWidth - 2; // small safety
        const cssH = 260;
        chartCanvas.style.width = cssW + "px";
        chartCanvas.style.height = cssH + "px";
        chartCanvas.width = Math.floor(cssW * dpr);
        chartCanvas.height = Math.floor(cssH * dpr);
        ctx = chartCanvas.getContext("2d");
        if(ctx) ctx.setTransform(dpr,0,0,dpr,0,0);
      }

      function getLatest7DaysWindow(){
        if(!allRecords.length) return null;
        const newest = allRecords[allRecords.length-1].ts;
        const end = newest;
        const start = end - (7*24*3600*1000);
        return { start, end };
      }

      function renderCharts(){
        if(!ctx) setupCanvas();
        if(!ctx){
          chartsTopNote.textContent = "Chart unavailable.";
          return;
        }

        const W = chartCanvas.clientWidth || (chartCanvas.width/dpr);
        const H = chartCanvas.clientHeight || (chartCanvas.height/dpr);

        ctx.clearRect(0,0,W,H);

        if(!allRecords.length){
          chartsTopNote.textContent = "No data found.";
          ctx.globalAlpha = 1;
          ctx.fillStyle = "rgba(235,245,255,.65)";
          ctx.font = "700 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.fillText("No readings to chart.", 14, 26);
          return;
        }

        // Preferred: if external chart module exists, let it take over.
        if(window.VTChart && typeof window.VTChart.render === "function"){
          try{
            window.VTChart.render({
              canvas: chartCanvas,
              wrap: canvasWrap,
              records: allRecords,
              tz: TZ
            });
            return;
          }catch(_){}
        }

        // Fallback chart: last 7 days, systolic line only.
        const win = getLatest7DaysWindow();
        const start = win.start, end = win.end;

        const visible = allRecords.filter(r => r.ts>=start && r.ts<=end && r.sys!=null);
        const d0 = fmtDateOnly(start);
        const d1 = fmtDateOnly(end);
        chartsTopNote.textContent = `${d0} – ${d1}`;

        // margins
        const padL = 34;
        const padR = 12;
        const padT = 10;
        const padB = 18;

        const x0 = padL, x1 = W - padR;
        const y0 = padT, y1 = H - padB;

        // Determine y range (fit to data with small pad)
        let maxSys = -Infinity;
        let minSys = Infinity;
        for(const r of visible){
          if(r.sys>maxSys) maxSys = r.sys;
          if(r.sys<minSys) minSys = r.sys;
        }
        if(!Number.isFinite(maxSys)){
          ctx.fillStyle = "rgba(235,245,255,.65)";
          ctx.font = "700 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.fillText("No systolic points in view.", 14, 26);
          return;
        }
        const pad = Math.max(6, Math.round((maxSys-minSys)*0.06));
        const yMin = Math.max(60, minSys - pad);
        const yMax = Math.min(220, maxSys + pad);

        function xFor(ts){
          const t = (ts - start) / (end - start);
          return x0 + t*(x1-x0);
        }
        function yFor(v){
          const t = (v - yMin) / (yMax - yMin);
          return y1 - t*(y1-y0);
        }

        // day bands (alternating)
        const dayStart = Math.floor(start / 86400000) * 86400000;
        let day = dayStart;
        let idx = 0;
        while(day < end + 86400000){
          const a = Math.max(start, day);
          const b = Math.min(end, day + 86400000);
          const xa = xFor(a);
          const xb = xFor(b);
          ctx.fillStyle = idx % 2 === 0 ? "rgba(255,255,255,.03)" : "rgba(0,0,0,.10)";
          ctx.fillRect(xa, y0, Math.max(0, xb-xa), (y1-y0));
          idx++;
          day += 86400000;
        }

        // light grid
        ctx.strokeStyle = "rgba(235,245,255,.10)";
        ctx.lineWidth = 1;
        for(let i=0;i<=4;i++){
          const y = y0 + (i/4)*(y1-y0);
          ctx.beginPath();
          ctx.moveTo(x0, y);
          ctx.lineTo(x1, y);
          ctx.stroke();
        }

        // y labels
        ctx.fillStyle = "rgba(235,245,255,.62)";
        ctx.font = "700 11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        const ticks = 4;
        for(let i=0;i<=ticks;i++){
          const v = Math.round(yMax - (i/ticks)*(yMax-yMin));
          const y = yFor(v);
          ctx.fillText(String(v), 6, y+4);
        }

        // line
        ctx.strokeStyle = "rgba(235,245,255,.88)";
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        let started = false;
        for(const r of visible){
          const x = xFor(r.ts);
          const y = yFor(r.sys);
          if(!started){ ctx.moveTo(x,y); started = true; }
          else ctx.lineTo(x,y);
        }
        ctx.stroke();

        // points (small)
        ctx.fillStyle = "rgba(235,245,255,.92)";
        for(const r of visible){
          const x = xFor(r.ts);
          const y = yFor(r.sys);
          ctx.beginPath();
          ctx.arc(x,y,1.6,0,Math.PI*2);
          ctx.fill();
        }
      }

      // Boot: load records and render UI
      async function boot(){
        document.getElementById("bootText").textContent = `BOOT OK ${APP_VERSION}`;
        bridgeStatus.textContent = "Loading records…";
        logTopNote.textContent = "Loading…";
        chartsTopNote.textContent = "Loading…";

        const res = await loadRecordsReadOnly();
        allRecords = res.records || [];

        updateHomeSummary(res.source || "unknown", allRecords);

        // Log
        renderLogPage(false);

        // Charts: render only when panel shown; but set a safe label now
        if(allRecords.length){
          const newest = allRecords[allRecords.length-1].ts;
          chartsTopNote.textContent = `${fmtDateOnly(newest)} (open Charts to render)`;
        }else{
          chartsTopNote.textContent = "No data found.";
        }

        bridgeStatus.textContent = allRecords.length
          ? `Loaded ${allRecords.length} record(s) (read-only).`
          : `No records loaded (read-only).`;
      }

      // Minimal keyboard safety: prevent form submit reload
      document.addEventListener("submit", (e)=>e.preventDefault());

      boot().catch(()=>{
        bridgeStatus.textContent = "Load error. Records not available.";
        sumSource.textContent = "error";
        sumEntries.textContent = "—";
        sumNewest.textContent = "—";
        detectedPill.textContent = "—";
        logTopNote.textContent = "Load error.";
        chartsTopNote.textContent = "Load error.";
      });
    })();
  </script>
</body>
</html>

<!-- EOF File: index.html
------------------------------------------------------------
Vitals Tracker — Function-First Shell
Copyright (c) 2026 Wendell K. Jiles. All rights reserved.
App Version: v2.022
Notes:
- Read-only. No write operations performed.
- Add panel is UI shell only in v2.022.
- Next file: js/add.js to implement Add behavior without impacting existing data.
------------------------------------------------------------
-->
