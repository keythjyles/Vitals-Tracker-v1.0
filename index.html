<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vitals Tracker v2</title>
  <style>
    :root{
      --bg:#000;
      --panel:#0b0f14;
      --line:#1f2a33;
      --text:#fff;
      --muted:#9aa7b1;
      --blue:#4da3ff;            /* single source for logo + border */
      --blue2:#7ecbff;
      --danger:#ff6b6b;
      --warn:#ffd36b;
      --ok:#7dffb2;
      --focus:#b7e5ff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Arial, Helvetica, sans-serif;
      padding:12px;
    }

    .app{
      max-width:760px;
      margin:0 auto;
      border:4px solid var(--blue);
      border-radius:14px;
      padding:14px;
      background:linear-gradient(180deg, rgba(77,163,255,0.08), rgba(0,0,0,0));
    }

    .panel{
      border:1px solid var(--line);
      background:rgba(11,15,20,0.85);
      border-radius:12px;
      padding:12px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .logo{
      width:52px;height:52px;border-radius:14px;
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      display:flex;align-items:center;justify-content:center;
      color:#000;font-weight:900;letter-spacing:0.5px;
      flex:0 0 auto;
    }

    h1{margin:0;font-size:22px;line-height:1.1}
    .subtitle{color:var(--muted);font-size:12px;margin-top:4px}

    .header-actions{
      display:flex; gap:10px; align-items:center;
      flex:0 0 auto;
    }

    .btn{
      border-radius:12px;
      padding:12px 14px;
      font-size:16px;
      font-weight:800;
      border:none;
      cursor:pointer;
      width:auto;
      min-width:110px;
    }

    .btn.primary{ background:var(--blue); color:#000; }
    .btn.secondary{ background:#111; color:var(--text); border:1px solid #2a3a45; }
    .btn.danger{ background:var(--danger); color:#000; }
    .btn.ok{ background:var(--ok); color:#000; }

    input, select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid #2a3a45;
      background:#0a0a0a;
      color:var(--text);
      padding:12px 12px;
      font-size:18px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(183,229,255,0.18);
    }
    textarea{min-height:90px; resize:vertical; font-size:16px;}

    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:10px 0 6px 0;
    }

    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    .row-3{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
    }

    @media (max-width:520px){
      .grid-2{grid-template-columns:1fr}
      .row-3{grid-template-columns:1fr 1fr 1fr;}
      .btn{min-width:95px}
    }

    .symptom-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:8px;
    }

    .symptom{
      border:1px solid #2a3a45;
      background:#0b0f14;
      color:var(--text);
      padding:14px 12px;
      border-radius:14px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .symptom[aria-pressed="true"]{
      border-color:var(--blue2);
      background:rgba(126,203,255,0.12);
    }

    .hint{color:var(--muted); font-size:12px; margin-top:6px;}

    .banner{
      margin-top:12px;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid #2a3a45;
      background:rgba(0,0,0,0.35);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .banner strong{display:block; font-size:14px}
    .banner span{color:var(--muted); font-size:12px}
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid;
      white-space:nowrap;
      margin-left:8px;
    }
    .pill.ok{border-color:rgba(125,255,178,0.5); color:var(--ok); background:rgba(125,255,178,0.12)}
    .pill.warn{border-color:rgba(255,211,107,0.5); color:var(--warn); background:rgba(255,211,107,0.12)}
    .pill.danger{border-color:rgba(255,107,107,0.5); color:var(--danger); background:rgba(255,107,107,0.10)}

    .actions{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:12px;
    }
    .actions .btn{flex:1 1 150px}

    details{
      margin-top:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,0.25);
      border-radius:12px;
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight:900;
      color:var(--blue2);
      outline:none;
    }
    summary:focus{ box-shadow:0 0 0 3px rgba(183,229,255,0.18); border-radius:10px; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid #1e2a33;
      padding:10px 8px;
      text-align:left;
      vertical-align:top;
    }
    th{color:var(--blue2); font-size:12px; letter-spacing:0.3px}
    .small{color:var(--muted); font-size:12px}

    .tag{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #2a3a45;
      color:var(--text);
      font-size:12px;
      margin:2px 6px 2px 0;
      background:rgba(255,255,255,0.03);
    }

    @media print{
      body{background:#fff;color:#000;padding:0}
      .app{border:none;border-radius:0;max-width:none;padding:0;background:none}
      .no-print{display:none !important}
      .panel{border:none;background:none;padding:0}
      th{color:#000}
      td,th{border-bottom:1px solid #bbb}
      .tag,.pill{border:1px solid #999;color:#000;background:none}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Vitals Tracker v2">
    <div class="panel">
      <header class="no-print">
        <div class="brand">
          <div class="logo" aria-hidden="true">VT</div>
          <div style="min-width:0">
            <h1>Vitals Tracker v2</h1>
            <div class="subtitle">Local-only BP/HR + symptoms. Simple, accessible, print-ready.</div>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn secondary" type="button" onclick="exitApp()">Exit</button>
        </div>
      </header>

      <!-- DATE/TIME -->
      <div class="grid-2">
        <div>
          <label for="date">Date</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label for="time">Time</label>
          <input id="time" type="time" />
        </div>
      </div>

      <!-- SYS/DIA/HR ON ONE LINE -->
      <label>Vitals</label>
      <div class="row-3">
        <div>
          <input id="sys" type="number" inputmode="numeric" placeholder="SYS" aria-label="Systolic" />
        </div>
        <div>
          <input id="dia" type="number" inputmode="numeric" placeholder="DIA" aria-label="Diastolic" />
        </div>
        <div>
          <input id="hr" type="number" inputmode="numeric" placeholder="HR" aria-label="Heart rate" />
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="position">Body position</label>
          <select id="position">
            <option>Sitting</option>
            <option>Standing</option>
            <option>Lying down</option>
          </select>
        </div>
        <div>
          <label for="daytype">Day type</label>
          <select id="daytype">
            <option value="typical">Typical</option>
            <option value="bad">Bad spike day</option>
            <option value="worst">Worst day</option>
          </select>
        </div>
      </div>

      <label for="meds">Meds taken (optional)</label>
      <input id="meds" type="text" placeholder="e.g., Lisinopril 10mg, Ivabradine, Propranolol" />

      <!-- SYMPTOMS 2-COLUMN + DYNAMIC OTHER -->
      <label>Symptoms (tap to select)</label>
      <div id="symptomGrid" class="symptom-grid" role="group" aria-label="Symptom options"></div>

      <div class="grid-2" style="margin-top:10px">
        <div>
          <label for="newSymptom">Other (add a new symptom)</label>
          <input id="newSymptom" type="text" placeholder="Type a new symptom name" />
          <div class="hint">Add once and it becomes a permanent option.</div>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn secondary" type="button" onclick="addNewSymptom()">Add symptom</button>
        </div>
      </div>

      <label for="notes">Notes (free text)</label>
      <textarea id="notes" placeholder="Write it exactly how it felt. Short is fine."></textarea>

      <!-- ALERT BANNER (CLINICAL STANDARD CATEGORIES) -->
      <div class="banner" id="banner" aria-live="polite">
        <div>
          <strong id="bannerTitle">No reading yet</strong>
          <span id="bannerText">Enter SYS/DIA/HR to see clinical category flags.</span>
        </div>
        <div id="bannerPills"></div>
      </div>

      <div class="actions no-print">
        <button class="btn primary" type="button" id="saveBtn" onclick="saveEntry()">Save</button>
        <button class="btn secondary" type="button" onclick="resetForm()">Reset</button>
      </div>

      <!-- ONE PANEL: "MORE" COLLAPSES TO KEEP PRIMARY FLOW SIMPLE -->
      <details class="no-print">
        <summary>More</summary>

        <label for="search">Search (notes/symptoms/meds)</label>
        <input id="search" type="text" placeholder="Type to filter..." oninput="render()" />

        <div class="grid-2">
          <div>
            <label for="from">From</label>
            <input id="from" type="date" onchange="render()" />
          </div>
          <div>
            <label for="to">To</label>
            <input id="to" type="date" onchange="render()" />
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label for="symFilter">Symptom filter</label>
            <select id="symFilter" onchange="render()">
              <option value="">All</option>
            </select>
          </div>
          <div>
            <label for="sort">Sort</label>
            <select id="sort" onchange="render()">
              <option value="newest">Newest first</option>
              <option value="oldest">Oldest first</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="btn secondary" type="button" onclick="exportCSV()">Export CSV</button>
          <button class="btn secondary" type="button" onclick="backup()">Backup</button>
          <button class="btn secondary" type="button" onclick="document.getElementById('restoreFile').click()">Restore</button>
          <input id="restoreFile" type="file" accept="application/json" style="display:none" onchange="restore(event)" />
          <button class="btn ok" type="button" onclick="printReport()">Print / Save as PDF</button>
          <button class="btn danger" type="button" onclick="clearAll()">Clear all data</button>
        </div>

        <div class="hint">Print/PDF uses your current filters.</div>
      </details>

      <!-- LOG -->
      <div id="countLine" class="small" style="margin-top:12px"></div>
      <div id="empty" class="small" style="margin-top:10px; display:none; padding:12px; border:1px dashed #2a3a45; border-radius:12px;">
        No entries match your filters.
      </div>

      <div style="overflow:auto">
        <table aria-label="Vitals log table">
          <thead>
            <tr>
              <th>Date</th><th>Time</th><th>BP</th><th>HR</th><th>Flags</th><th>Symptoms</th><th>Meds</th><th>Notes</th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody id="log"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const STORAGE_KEY = "vitals_v2_entries";
  const SYMPTOM_KEY = "vitals_v2_symptoms";

  // Default symptom options (user can add permanently)
  const DEFAULT_SYMPTOMS = [
    "Sweaty","Panic","Chest tight","Dizzy","Nausea","Blurred vision",
    "Weakness","Head pain","Hot ears","Shaky","Short breath","Stomach pain",
    "Anxious","Calm","Foggy"
  ];

  // DOM
  const dateEl = document.getElementById("date");
  const timeEl = document.getElementById("time");
  const sysEl = document.getElementById("sys");
  const diaEl = document.getElementById("dia");
  const hrEl  = document.getElementById("hr");
  const posEl = document.getElementById("position");
  const dayEl = document.getElementById("daytype");
  const medsEl = document.getElementById("meds");
  const notesEl = document.getElementById("notes");

  const symptomGrid = document.getElementById("symptomGrid");
  const newSymptomEl = document.getElementById("newSymptom");

  const bannerTitle = document.getElementById("bannerTitle");
  const bannerText  = document.getElementById("bannerText");
  const bannerPills = document.getElementById("bannerPills");

  const searchEl = document.getElementById("search");
  const fromEl = document.getElementById("from");
  const toEl = document.getElementById("to");
  const symFilterEl = document.getElementById("symFilter");
  const sortEl = document.getElementById("sort");

  const logEl = document.getElementById("log");
  const countLine = document.getElementById("countLine");
  const emptyEl = document.getElementById("empty");

  let selectedSymptoms = new Set();
  let editId = null;

  function nowLocal(){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const dd = String(now.getDate()).padStart(2,"0");
    const hh = String(now.getHours()).padStart(2,"0");
    const mi = String(now.getMinutes()).padStart(2,"0");
    return { date:`${yyyy}-${mm}-${dd}`, time:`${hh}:${mi}` };
  }

  function getEntries(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch { return []; }
  }
  function setEntries(entries){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
  }

  function getSymptoms(){
    try{
      const saved = JSON.parse(localStorage.getItem(SYMPTOM_KEY) || "null");
      if(Array.isArray(saved) && saved.length) return saved;
    }catch{}
    return [...DEFAULT_SYMPTOMS];
  }
  function setSymptoms(list){
    localStorage.setItem(SYMPTOM_KEY, JSON.stringify(list));
  }

  function buildSymptomGrid(){
    const list = getSymptoms();
    symptomGrid.innerHTML = "";
    list.forEach(sym=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "symptom";
      b.textContent = sym;
      b.setAttribute("aria-pressed", selectedSymptoms.has(sym) ? "true" : "false");
      b.onclick = ()=>{
        if(selectedSymptoms.has(sym)) selectedSymptoms.delete(sym);
        else selectedSymptoms.add(sym);
        b.setAttribute("aria-pressed", selectedSymptoms.has(sym) ? "true" : "false");
        renderBanner();
      };
      symptomGrid.appendChild(b);
    });
  }

  function addNewSymptom(){
    const s = (newSymptomEl.value || "").trim();
    if(!s) return;

    // normalize: title-case-ish, but preserve user intent
    const list = getSymptoms();
    const exists = list.some(x => x.toLowerCase() === s.toLowerCase());
    if(exists){
      newSymptomEl.value = "";
      return;
    }
    list.push(s);
    list.sort((a,b)=>a.localeCompare(b));
    setSymptoms(list);

    selectedSymptoms.add(s);
    newSymptomEl.value = "";
    buildSymptomGrid();
    render();
  }

  // CLINICAL STANDARD BP CATEGORY FLAGS
  // Categories (ACC/AHA style): Normal, Elevated, Stage 1, Stage 2, Crisis
  // Plus hypotension flag (commonly: <90 systolic or <60 diastolic)
  function bpCategory(sys, dia){
    if(!Number.isFinite(sys) || !Number.isFinite(dia)) return null;

    const hypotension = (sys < 90 || dia < 60);

    // Hypertensive crisis (commonly: >=180 and/or >=120)
    if(sys >= 180 || dia >= 120) return {level:"danger", title:"Hypertensive Crisis", text:"Consider urgent evaluation if symptoms are present.", extra: hypotension ? "Low BP flag also present." : ""};

    // Stage 2: >=140 or >=90
    if(sys >= 140 || dia >= 90) return {level:"danger", title:"High BP (Stage 2)", text:"Above standard threshold. Track pattern and discuss with clinician.", extra: hypotension ? "Low BP flag also present." : ""};

    // Stage 1: 130-139 or 80-89
    if((sys >= 130 && sys <= 139) || (dia >= 80 && dia <= 89)) return {level:"warn", title:"High BP (Stage 1)", text:"Above target range. Monitor trends and symptoms.", extra: hypotension ? "Low BP flag also present." : ""};

    // Elevated: 120-129 and <80
    if(sys >= 120 && sys <= 129 && dia < 80) return {level:"warn", title:"Elevated BP", text:"Slightly elevated systolic with normal diastolic.", extra: hypotension ? "Low BP flag also present." : ""};

    // Normal: <120 and <80
    if(sys < 120 && dia < 80){
      if(hypotension) return {level:"warn", title:"Low BP pattern", text:"Systolic <90 or diastolic <60 flagged.", extra:""};
      return {level:"ok", title:"Normal BP", text:"Within standard normal range.", extra:""};
    }

    // fallback
    if(hypotension) return {level:"warn", title:"Low BP pattern", text:"Systolic <90 or diastolic <60 flagged.", extra:""};
    return {level:"ok", title:"BP recorded", text:"", extra:""};
  }

  function hrFlags(hr){
    if(!Number.isFinite(hr)) return [];
    const flags = [];
    if(hr > 100) flags.push({level:"warn", text:"Tachy (>100)"});
    if(hr < 60) flags.push({level:"warn", text:"Brady (<60)"});
    return flags;
  }

  function dayFlags(){
    const v = dayEl.value;
    if(v === "worst") return [{level:"danger", text:"Worst day"}];
    if(v === "bad") return [{level:"warn", text:"Bad day"}];
    return [];
  }

  function renderBanner(){
    const sys = Number(sysEl.value);
    const dia = Number(diaEl.value);
    const hr  = Number(hrEl.value);

    const bp = bpCategory(sys, dia);
    const pills = [];

    if(bp){
      bannerTitle.textContent = bp.title;
      bannerText.textContent = bp.text;
      pills.push({level:bp.level, text:"BP"});
      if(bp.extra) pills.push({level:"warn", text:"Note"});
    }else{
      bannerTitle.textContent = "No reading yet";
      bannerText.textContent = "Enter SYS/DIA/HR to see clinical category flags.";
    }

    hrFlags(hr).forEach(f=>pills.push({level:f.level, text:f.text}));
    dayFlags().forEach(f=>pills.push({level:f.level, text:f.text}));

    if(selectedSymptoms.size){
      pills.push({level:"ok", text:`Symptoms: ${selectedSymptoms.size}`});
    }

    bannerPills.innerHTML = pills.map(p=>`<span class="pill ${p.level}">${escapeHtml(p.text)}</span>`).join("");
  }

  function validate(entry){
    const errs = [];
    if(!entry.date) errs.push("Date required.");
    if(!entry.time) errs.push("Time required.");
    if(entry.sys === "" || entry.dia === "" || entry.hr === "") errs.push("SYS/DIA/HR required.");
    if(Number(entry.sys) <= 0 || Number(entry.dia) <= 0 || Number(entry.hr) <= 0) errs.push("Vitals must be positive numbers.");
    return errs;
  }

  function saveEntry(){
    const entry = {
      id: editId || crypto.randomUUID(),
      date: dateEl.value,
      time: timeEl.value,
      sys: sysEl.value,
      dia: diaEl.value,
      hr:  hrEl.value,
      position: posEl.value,
      daytype: dayEl.value,
      symptoms: Array.from(selectedSymptoms),
      meds: medsEl.value.trim(),
      notes: notesEl.value.trim(),
      createdAt: Date.now()
    };

    const errs = validate(entry);
    if(errs.length){ alert(errs.join("\n")); return; }

    const entries = getEntries();
    const idx = entries.findIndex(e=>e.id === entry.id);
    if(idx >= 0) entries[idx] = entry;
    else entries.unshift(entry);
    setEntries(entries);

    resetForm();
    render();
  }

  function resetForm(){
    editId = null;
    const n = nowLocal();
    dateEl.value = n.date;
    timeEl.value = n.time;
    sysEl.value = "";
    diaEl.value = "";
    hrEl.value  = "";
    posEl.value = "Sitting";
    dayEl.value = "typical";
    medsEl.value = "";
    notesEl.value = "";
    selectedSymptoms.clear();
    document.getElementById("saveBtn").textContent = "Save";
    buildSymptomGrid();
    renderBanner();
    sysEl.focus();
  }

  function applyFilters(entries){
    let out = [...entries];
    const q = (searchEl?.value || "").toLowerCase();
    const from = fromEl?.value ? new Date(fromEl.value + "T00:00:00") : null;
    const to   = toEl?.value ? new Date(toEl.value + "T23:59:59") : null;
    const sf   = symFilterEl?.value || "";

    out = out.filter(e=>{
      const dt = new Date(e.date + "T" + (e.time || "00:00") + ":00");
      if(from && dt < from) return false;
      if(to && dt > to) return false;
      if(sf){
        const syms = e.symptoms || [];
        if(!syms.includes(sf)) return false;
      }
      if(q){
        const hay = [
          e.notes||"",
          e.meds||"",
          (e.symptoms||[]).join(" "),
          e.position||"",
          e.daytype||""
        ].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });

    const sort = sortEl?.value || "newest";
    out.sort((a,b)=>{
      const da = new Date(a.date+"T"+(a.time||"00:00")+":00").getTime();
      const db = new Date(b.date+"T"+(b.time||"00:00")+":00").getTime();
      return sort === "oldest" ? (da-db) : (db-da);
    });

    return out;
  }

  function updateSymptomFilter(entries){
    const all = new Set();
    entries.forEach(e => (e.symptoms||[]).forEach(s=>all.add(s)));
    const current = symFilterEl.value;

    const opts = ["", ...Array.from(all).sort((a,b)=>a.localeCompare(b))];
    symFilterEl.innerHTML = "";
    opts.forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v ? v : "All";
      symFilterEl.appendChild(o);
    });
    if(opts.includes(current)) symFilterEl.value = current;
  }

  function entryFlagsText(e){
    const sys = Number(e.sys), dia = Number(e.dia), hr = Number(e.hr);
    const bp = bpCategory(sys, dia);
    const flags = [];
    if(bp) flags.push(bp.title);
    hrFlags(hr).forEach(f=>flags.push(f.text));
    if(e.daytype === "worst") flags.push("Worst day");
    else if(e.daytype === "bad") flags.push("Bad day");
    return flags.join("; ");
  }

  function render(){
    const entries = getEntries();
    updateSymptomFilter(entries);

    const filtered = applyFilters(entries);
    countLine.textContent = `Showing ${filtered.length} of ${entries.length} entries.`;

    logEl.innerHTML = "";
    if(filtered.length === 0){
      emptyEl.style.display = "block";
      return;
    }
    emptyEl.style.display = "none";

    filtered.forEach(e=>{
      const tr = document.createElement("tr");
      const syms = (e.symptoms||[]).map(s=>`<span class="tag">${escapeHtml(s)}</span>`).join(" ");
      tr.innerHTML = `
        <td>${escapeHtml(e.date)}</td>
        <td>${escapeHtml(e.time)}</td>
        <td>${escapeHtml(e.sys)}/${escapeHtml(e.dia)}</td>
        <td>${escapeHtml(e.hr)}</td>
        <td>${escapeHtml(entryFlagsText(e))}</td>
        <td>${syms || '<span class="small">—</span>'}</td>
        <td>${escapeHtml(e.meds||"") || '<span class="small">—</span>'}</td>
        <td>${escapeHtml(e.notes||"") || '<span class="small">—</span>'}</td>
        <td class="no-print">
          <button class="btn secondary" style="min-width:auto;padding:10px 12px;margin-right:8px" onclick="startEdit('${e.id}')">Edit</button>
          <button class="btn danger" style="min-width:auto;padding:10px 12px" onclick="deleteEntry('${e.id}')">Delete</button>
        </td>
      `;
      logEl.appendChild(tr);
    });
  }

  function startEdit(id){
    const entries = getEntries();
    const e = entries.find(x=>x.id === id);
    if(!e) return;

    editId = e.id;
    dateEl.value = e.date || "";
    timeEl.value = e.time || "";
    sysEl.value = e.sys || "";
    diaEl.value = e.dia || "";
    hrEl.value  = e.hr || "";
    posEl.value = e.position || "Sitting";
    dayEl.value = e.daytype || "typical";
    medsEl.value = e.meds || "";
    notesEl.value = e.notes || "";

    selectedSymptoms = new Set(e.symptoms || []);
    buildSymptomGrid();
    document.getElementById("saveBtn").textContent = "Save changes";
    renderBanner();
    sysEl.focus();
  }

  function deleteEntry(id){
    if(!confirm("Delete this entry?")) return;
    const entries = getEntries().filter(e=>e.id !== id);
    setEntries(entries);
    if(editId === id) resetForm();
    render();
  }

  function clearAll(){
    if(!confirm("Delete ALL entries and custom symptoms?")) return;
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(SYMPTOM_KEY);
    selectedSymptoms.clear();
    buildSymptomGrid();
    resetForm();
    render();
  }

  function exportCSV(){
    const entries = applyFilters(getEntries());
    let csv = "Date,Time,Systolic,Diastolic,HR,Position,DayType,Symptoms,Meds,Notes,Flags\n";
    entries.forEach(e=>{
      const symptoms = (e.symptoms||[]).join("; ");
      const row = [
        e.date, e.time, e.sys, e.dia, e.hr,
        e.position||"", e.daytype||"",
        csvEscape(symptoms),
        csvEscape(e.meds||""),
        csvEscape(e.notes||""),
        csvEscape(entryFlagsText(e))
      ].join(",");
      csv += row + "\n";
    });
    downloadBlob(csv, "text/csv", "vitals_export.csv");
  }

  function backup(){
    const payload = {
      version: "v2",
      exportedAt: new Date().toISOString(),
      symptoms: getSymptoms(),
      entries: getEntries()
    };
    downloadBlob(JSON.stringify(payload, null, 2), "application/json", "vitals_backup.json");
  }

  function restore(evt){
    const file = evt.target.files?.[0];
    evt.target.value = "";
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const payload = JSON.parse(reader.result);
        if(payload?.entries && Array.isArray(payload.entries)) setEntries(payload.entries);
        if(payload?.symptoms && Array.isArray(payload.symptoms)) setSymptoms(payload.symptoms);
        buildSymptomGrid();
        render();
        alert("Restore complete.");
      }catch{
        alert("Restore failed: invalid file.");
      }
    };
    reader.readAsText(file);
  }

  function printReport(){
    window.print();
  }

  function exitApp(){
    // Works in some contexts; if blocked, gives a clear instruction.
    try{
      window.close();
      // If close is blocked, window will remain open:
      setTimeout(()=>{
        alert("If Exit is blocked, use your device Back button or close the tab/window.");
      }, 200);
    }catch{
      alert("Use your device Back button or close the tab/window.");
    }
  }

  function downloadBlob(text, mime, filename){
    const blob = new Blob([text], {type:mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  function csvEscape(s){
    const v = String(s ?? "");
    const needs = /[",\n]/.test(v);
    const esc = v.replace(/"/g,'""');
    return needs ? `"${esc}"` : esc;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Live banner updates
  [sysEl, diaEl, hrEl, dayEl].forEach(el=>{
    el.addEventListener("input", renderBanner);
    el.addEventListener("change", renderBanner);
  });

  // Enter on HR saves
  hrEl.addEventListener("keydown",(e)=>{
    if(e.key === "Enter"){ e.preventDefault(); saveEntry(); }
  });

  (function init(){
    const n = nowLocal();
    dateEl.value = n.date;
    timeEl.value = n.time;
    buildSymptomGrid();
    renderBanner();
    render();
  })();
</script>
</body>
</html>
