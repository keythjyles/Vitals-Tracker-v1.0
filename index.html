<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Vitals Tracker</title>
  <meta name="theme-color" content="#0b0d10" />

  <style>
    :root{
      --bg:#0b0d10;
      --panel:#121827;
      --panel2:#161e31;
      --fg:#e7eaf0;
      --muted:#a9b2c2;
      --border:rgba(255,255,255,.10);
      --shadow:rgba(0,0,0,.35);

      --accent:#5a93ff;
      --accent2:#3f78ea;

      --radius:22px;
      --font:22px;
      --gap:12px;
      --pad:16px;
      --btnpad:16px;
    }

    html, body{
      height:100%;
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--fg);
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      font-size: var(--font);
      font-weight: 500;
    }

    *{ box-sizing:border-box; }
    *::before, *::after{ unicode-bidi:isolate; }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 18px 16px 28px;
    }

    header{
      padding: 10px 2px 18px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      margin-bottom: 16px;
    }

    h1{
      margin:0;
      font-size: 1.75em;
      font-weight: 700;
      letter-spacing: .2px;
    }

    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: 0 10px 30px var(--shadow);
      overflow:hidden;
    }

    .row{ display:flex; gap: var(--gap); }
    .col{ flex:1; min-width: 0; }
    .stack{ display:flex; flex-direction:column; gap: var(--gap); }

    label{
      display:block;
      margin: 0 0 8px;
      font-weight: 650;
      letter-spacing: .1px;
    }

    .metaLabel{
      color: var(--muted);
      font-size: .9em;
      font-weight: 550;
      margin-bottom: 6px;
    }
    .metaValue{
      font-size: 1em;
      font-weight: 600;
      color: var(--fg);
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      user-select: text;
      -webkit-user-select: text;
    }

    input, textarea, select{
      width:100%;
      font-size: 1em;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,14,24,.55);
      color: var(--fg);
      padding: 14px 14px;
      outline: none;
      font-weight: 520;
    }
    textarea{ min-height: 100px; resize: vertical; }

    input:focus, textarea:focus, select:focus{
      border-color: rgba(90,147,255,.55);
      box-shadow: 0 0 0 4px rgba(90,147,255,.12);
    }

    /* Compact buttons for top bar */
    .topBar{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: nowrap;
    }
    .btn{
      width:100%;
      padding: var(--btnpad);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--fg);
      font-size: 1.15em;
      font-weight: 650;
      letter-spacing: .1px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,.16);
    }
    .btn:active{ transform: translateY(1px); }

    .btn.small{
      width: auto;
      flex: 1 1 auto;
      padding: 12px 14px;
      border-radius: 18px;
      font-size: 1.02em;
      font-weight: 650;
      box-shadow: 0 8px 18px rgba(0,0,0,.14);
    }

    .btn.primary{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color: #0b1020;
      border-color: rgba(0,0,0,.18);
      box-shadow: 0 10px 25px rgba(90,147,255,.16);
      font-weight: 750;
    }

    .btn.danger{
      background: rgba(255,80,80,.10);
      border-color: rgba(255,80,80,.25);
      color: var(--fg);
    }

    .hint{
      color: var(--muted);
      margin-top: 10px;
      font-size: .92em;
      font-weight: 500;
    }

    .miniHint{
      color: var(--muted);
      font-size: .86em;
      font-weight: 500;
      margin-top: 8px;
      line-height: 1.25;
    }

    .topActions{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .symptoms{
      margin-top: 6px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
      font-size: 0.62em;
    }
    .symptoms .chip{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.18);
      background: transparent;
    }
    .symptoms input[type="checkbox"]{
      width: 24px;
      height: 24px;
      margin:0;
      accent-color: var(--accent);
      flex: 0 0 auto;
    }
    .symptoms span{
      line-height: 1.05;
      font-weight: 550;
      color: var(--fg);
    }

    .logItem{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 20px;
      padding: 14px 14px;
    }
    .logWhen{
      color: var(--muted);
      font-size: .9em;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .logBig{
      font-size: 1.15em;
      font-weight: 750;
      letter-spacing: .1px;
      margin-bottom: 6px;
    }
    .logLine{
      font-size: .95em;
      color: var(--fg);
      margin: 2px 0;
      font-weight: 520;
      overflow-wrap: anywhere;
    }
    .logLine b{ font-weight: 700; }

    .chartBox{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 12px;
    }
    canvas{
      width: 100%;
      height: 280px;
      display:block;
    }
    .chartLegend{
      display:flex;
      flex-wrap:wrap;
      gap: 10px 16px;
      margin-top: 10px;
      color: var(--muted);
      font-size: .9em;
      font-weight: 500;
    }

    .toast{
      margin-top: 12px;
      color: var(--muted);
      font-size: .95em;
      min-height: 1.2em;
      font-weight: 500;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    @media (max-width: 420px){
      :root{ --font: 21px; }
      canvas{ height: 260px; }
      .btn.small{ padding: 11px 12px; font-size: .98em; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Vitals Tracker</h1>
    </header>

    <!-- HOME -->
    <section id="home" class="screen active">
      <div class="card">
        <div class="topActions">
          <button class="btn primary" id="goAdd">Add</button>
          <button class="btn" id="goLog">Log</button>
          <button class="btn" id="goCharts">Charts</button>
        </div>
        <div class="hint" id="homeHint">Tap “Add” to record BP.</div>
        <div class="toast" id="homeToast" aria-live="polite"></div>
      </div>
    </section>

    <!-- ADD -->
    <section id="add" class="screen">
      <div class="card stack">
        <div>
          <div class="metaLabel">Time</div>
          <div class="metaValue" id="whenText"></div>
        </div>

        <div class="row">
          <div class="col">
            <label for="sys">Systolic</label>
            <input id="sys" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 132" />
          </div>
          <div class="col">
            <label for="dia">Diastolic</label>
            <input id="dia" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 91" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="hr">Heart Rate</label>
            <input id="hr" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 72" />
          </div>
          <div class="col">
            <label for="notes">Notes</label>
            <input id="notes" placeholder="optional" />
          </div>
        </div>

        <div>
          <label>Symptoms</label>
          <div class="symptoms" id="symptomsGrid"></div>
          <div class="hint">Check only what matters.</div>
        </div>

        <div class="row">
          <div class="col">
            <button class="btn primary" id="save">Save</button>
          </div>
          <div class="col">
            <button class="btn" id="cancelAdd">Back</button>
          </div>
        </div>

        <div class="toast" id="addToast" aria-live="polite"></div>
      </div>
    </section>

    <!-- LOG -->
    <section id="log" class="screen">
      <div class="card stack">
        <!-- Top bar: small horizontal buttons -->
        <div class="topBar">
          <button class="btn small" id="export">Export</button>
          <button class="btn small" id="backFromLog">Back</button>
        </div>
        <div class="miniHint" id="exportHint">
          Export copies the currently filtered log (date + search) as text. Data stays on your phone.
        </div>

        <!-- Search -->
        <div class="row">
          <div class="col">
            <label for="search">Search</label>
            <input id="search" placeholder="Type a word: sweaty, dizzy, heartburn..." />
            <div class="miniHint">Search looks in symptoms, notes, and BP.</div>
          </div>
        </div>

        <!-- Date filter -->
        <div class="row">
          <div class="col">
            <label for="fromDate">From</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="col">
            <label for="toDate">To</label>
            <input id="toDate" type="date" />
          </div>
        </div>
        <div class="miniHint">Tip: set both dates to export a single day.</div>

        <!-- Default log -->
        <div id="logList" class="stack" aria-live="polite"></div>

        <button class="btn danger" id="clearAll">Delete ALL data (local)</button>
        <div class="toast" id="logToast" aria-live="polite"></div>
      </div>
    </section>

    <!-- CHARTS -->
    <section id="charts" class="screen">
      <div class="card stack">
        <div class="row">
          <div class="col">
            <label for="range">Range</label>
            <select id="range">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="365">Last 365 days</option>
              <option value="all">All</option>
            </select>
          </div>
          <div class="col">
            <label for="metric">Metric</label>
            <select id="metric">
              <option value="bp">Blood Pressure</option>
              <option value="hr">Heart Rate</option>
            </select>
          </div>
        </div>

        <div class="chartBox">
          <canvas id="chart" width="800" height="300"></canvas>
          <div class="chartLegend" id="legend"></div>
        </div>

        <button class="btn" id="backFromCharts">Back</button>
        <div class="toast" id="chartToast" aria-live="polite"></div>
      </div>
    </section>
  </div>

  <script>
    const STORAGE_KEY = "vitals_tracker_entries_v1";

    function loadEntries(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveEntries(entries){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }
    function nowISO(){ return new Date().toISOString(); }

    function formatWhen(iso){
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString(undefined, {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }

    function clampInt(s){
      const n = parseInt(String(s).replace(/[^\d]/g,''), 10);
      return Number.isFinite(n) ? n : null;
    }

    function toDateInputValue(iso){
      const d = new Date(iso);
      if(isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function startOfDayMs(yyyy_mm_dd){
      if(!yyyy_mm_dd) return null;
      const [y,m,d] = yyyy_mm_dd.split("-").map(n=>parseInt(n,10));
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d, 0,0,0,0).getTime();
    }
    function endOfDayMs(yyyy_mm_dd){
      if(!yyyy_mm_dd) return null;
      const [y,m,d] = yyyy_mm_dd.split("-").map(n=>parseInt(n,10));
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d, 23,59,59,999).getTime();
    }

    const screens = {
      home: document.getElementById("home"),
      add: document.getElementById("add"),
      log: document.getElementById("log"),
      charts: document.getElementById("charts"),
    };

    function setToast(id, msg){
      const el = document.getElementById(id);
      if(el) el.textContent = msg || "";
    }

    function show(name){
      Object.values(screens).forEach(s => s.classList.remove("active"));
      screens[name].classList.add("active");
      setToast("homeToast","");
      setToast("addToast","");
      setToast("logToast","");
      setToast("chartToast","");
      if(name === "add") startAdd();
      if(name === "log") renderLog();
      if(name === "charts") renderChart();
      if(name === "home") refreshHomeHint();
    }

    const SYMPTOMS = [
      "Sweaty","Dizzy","Panic","Brain fog",
      "Chest tight","Headache","Nausea","Short breath",
      "Hot ears","Shaky","Blurred vision","Weakness"
    ];

    const symptomsGrid = document.getElementById("symptomsGrid");

    function buildSymptoms(){
      symptomsGrid.innerHTML = "";
      SYMPTOMS.forEach((name, i) => {
        const id = "sym_" + i;
        const wrap = document.createElement("label");
        wrap.className = "chip";
        wrap.setAttribute("for", id);

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.dataset.symptom = name;

        const txt = document.createElement("span");
        txt.textContent = name;

        wrap.appendChild(cb);
        wrap.appendChild(txt);
        symptomsGrid.appendChild(wrap);
      });
    }
    buildSymptoms();

    function getCheckedSymptoms(){
      const cbs = symptomsGrid.querySelectorAll("input[type=checkbox]");
      const out = [];
      cbs.forEach(cb => { if(cb.checked) out.push(cb.dataset.symptom); });
      return out;
    }
    function clearSymptoms(){
      symptomsGrid.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
    }

    const sysEl = document.getElementById("sys");
    const diaEl = document.getElementById("dia");
    const hrEl  = document.getElementById("hr");
    const notesEl = document.getElementById("notes");
    const whenTextEl = document.getElementById("whenText");

    let addTimestampISO = null;
    let whenTimer = null;

    function startAdd(){
      sysEl.value = "";
      diaEl.value = "";
      hrEl.value  = "";
      notesEl.value = "";
      clearSymptoms();

      addTimestampISO = nowISO();
      whenTextEl.textContent = formatWhen(addTimestampISO);

      if(whenTimer) clearInterval(whenTimer);
      whenTimer = setInterval(() => {
        addTimestampISO = nowISO();
        whenTextEl.textContent = formatWhen(addTimestampISO);
      }, 1000);

      setTimeout(() => sysEl.focus(), 120);
    }

    document.getElementById("save").addEventListener("click", () => {
      const sys = clampInt(sysEl.value);
      const dia = clampInt(diaEl.value);
      const hr  = clampInt(hrEl.value);

      if(sys === null || dia === null || hr === null){
        setToast("addToast","Enter Systolic, Diastolic, and Heart Rate.");
        return;
      }
      if(sys < 50 || sys > 300 || dia < 30 || dia > 200 || hr < 25 || hr > 250){
        setToast("addToast","Numbers look off. Please re-check.");
        return;
      }

      const entry = {
        t: addTimestampISO || nowISO(),
        sys, dia, hr,
        symptoms: getCheckedSymptoms(),
        notes: (notesEl.value || "").trim()
      };

      const entries = loadEntries();
      entries.push(entry);
      entries.sort((a,b) => new Date(b.t) - new Date(a.t));
      saveEntries(entries);

      if(whenTimer) clearInterval(whenTimer);
      document.getElementById("homeToast").textContent = "Saved.";
      show("home");
    });

    document.getElementById("cancelAdd").addEventListener("click", () => {
      if(whenTimer) clearInterval(whenTimer);
      show("home");
    });

    document.getElementById("goAdd").addEventListener("click", () => show("add"));
    document.getElementById("goLog").addEventListener("click", () => show("log"));
    document.getElementById("goCharts").addEventListener("click", () => show("charts"));

    const logList = document.getElementById("logList");
    const searchEl = document.getElementById("search");
    const fromDateEl = document.getElementById("fromDate");
    const toDateEl = document.getElementById("toDate");

    function entryMatches(entry, q){
      if(!q) return true;
      q = q.toLowerCase().trim();
      const sym = (entry.symptoms || []).join(" ").toLowerCase();
      const notes = (entry.notes || "").toLowerCase();
      const bp = `${entry.sys}/${entry.dia}`.toLowerCase();
      return sym.includes(q) || notes.includes(q) || bp.includes(q);
    }

    function inDateRange(entry, fromStr, toStr){
      const t = new Date(entry.t).getTime();
      if(!Number.isFinite(t)) return true;

      const from = startOfDayMs(fromStr);
      const to = endOfDayMs(toStr);

      if(from !== null && t < from) return false;
      if(to !== null && t > to) return false;
      return true;
    }

    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getFilteredEntries(){
      const entries = loadEntries();
      const q = (searchEl.value || "");
      const fromStr = (fromDateEl.value || "");
      const toStr = (toDateEl.value || "");

      return entries
        .filter(e => entryMatches(e, q))
        .filter(e => inDateRange(e, fromStr, toStr));
    }

    function renderLog(){
      // sensible defaults: if blank, leave blank (show all)
      const entriesAll = loadEntries();

      // if user never set date filters, keep blank
      // (no auto-fill to avoid surprising behavior)

      const filtered = getFilteredEntries();

      logList.innerHTML = "";

      if(filtered.length === 0){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = entriesAll.length ? "No matches for that search/date range." : "No entries yet. Tap Add.";
        logList.appendChild(empty);
      }else{
        filtered.forEach(e => {
          const item = document.createElement("div");
          item.className = "logItem";

          const when = document.createElement("div");
          when.className = "logWhen";
          when.textContent = formatWhen(e.t);

          const big = document.createElement("div");
          big.className = "logBig";
          big.textContent = `BP ${e.sys}/${e.dia}  •  HR ${e.hr}`;

          const sym = document.createElement("div");
          sym.className = "logLine";
          const symText = (e.symptoms && e.symptoms.length) ? e.symptoms.join(", ") : "None";
          sym.innerHTML = `<b>Symptoms:</b> ${escapeHTML(symText)}`;

          const notes = document.createElement("div");
          notes.className = "logLine";
          const noteText = e.notes ? e.notes : "None";
          notes.innerHTML = `<b>Notes:</b> ${escapeHTML(noteText)}`;

          item.appendChild(when);
          item.appendChild(big);
          item.appendChild(sym);
          item.appendChild(notes);

          logList.appendChild(item);
        });
      }

      setTimeout(() => searchEl.focus(), 80);
    }

    searchEl.addEventListener("input", renderLog);
    fromDateEl.addEventListener("change", renderLog);
    toDateEl.addEventListener("change", renderLog);

    document.getElementById("backFromLog").addEventListener("click", () => show("home"));

    function makeExportText(entries){
      const lines = [];
      const fromStr = (fromDateEl.value || "");
      const toStr = (toDateEl.value || "");
      const q = (searchEl.value || "").trim();

      lines.push("Vitals Tracker Export");
      if(fromStr || toStr || q){
        lines.push("Filters:");
        if(fromStr) lines.push(`- From: ${fromStr}`);
        if(toStr) lines.push(`- To: ${toStr}`);
        if(q) lines.push(`- Search: ${q}`);
      }
      lines.push("----");

      entries
        .slice()
        .sort((a,b) => new Date(a.t) - new Date(b.t))
        .forEach(e => {
          const stamp = formatWhen(e.t);
          const sym = (e.symptoms && e.symptoms.length) ? e.symptoms.join(", ") : "None";
          const notes = (e.notes && e.notes.trim()) ? e.notes.trim() : "None";
          lines.push(`${stamp} | BP ${e.sys}/${e.dia} | HR ${e.hr} | Symptoms: ${sym} | Notes: ${notes}`);
        });

      lines.push("----");
      lines.push("CSV:");
      lines.push("timestamp_iso,sys,dia,hr,symptoms,notes");
      entries
        .slice()
        .sort((a,b) => new Date(a.t) - new Date(b.t))
        .forEach(e => {
          const sym = (e.symptoms && e.symptoms.length) ? e.symptoms.join(";") : "";
          const notes = (e.notes || "").replaceAll('"','""');
          lines.push(`${e.t},${e.sys},${e.dia},${e.hr},"${sym}","${notes}"`);
        });

      return lines.join("\n");
    }

    document.getElementById("export").addEventListener("click", async () => {
      const filtered = getFilteredEntries();
      if(!filtered.length){
        setToast("logToast","Nothing to export for that search/date range.");
        return;
      }
      const payload = makeExportText(filtered);
      try{
        await navigator.clipboard.writeText(payload);
        setToast("logToast","Copied. Paste into ChatGPT.");
      }catch(e){
        window.prompt("Copy this text:", payload);
        setToast("logToast","Copy prompt opened.");
      }
    });

    document.getElementById("clearAll").addEventListener("click", () => {
      const ok = confirm("Delete ALL vitals data on this phone?");
      if(!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      setToast("logToast","Deleted.");
      renderLog();
      renderChart();
    });

    const chartCanvas = document.getElementById("chart");
    const ctx = chartCanvas.getContext("2d");
    const rangeEl = document.getElementById("range");
    const metricEl = document.getElementById("metric");
    const legendEl = document.getElementById("legend");

    rangeEl.addEventListener("change", renderChart);
    metricEl.addEventListener("change", renderChart);

    document.getElementById("backFromCharts").addEventListener("click", () => show("home"));

    function filterByRange(entries, rangeVal){
      if(rangeVal === "all") return entries.slice();
      const days = parseInt(rangeVal, 10);
      const cutoff = Date.now() - days*24*60*60*1000;
      return entries.filter(e => new Date(e.t).getTime() >= cutoff);
    }

    function drawEmpty(msg){
      const w = chartCanvas.width, h = chartCanvas.height;
      ctx.fillStyle = "rgba(255,255,255,.05)";
      ctx.fillRect(0,0,w,h);

      ctx.fillStyle = "rgba(231,234,240,.85)";
      ctx.font = "600 22px Roboto, system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(msg, w/2, h/2);
      setToast("chartToast","");
    }

    function drawAxes(padL, padR, padT, padB){
      const w = chartCanvas.width, h = chartCanvas.height;
      ctx.strokeStyle = "rgba(255,255,255,.16)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, h-padB);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(padL, h-padB);
      ctx.lineTo(w-padR, h-padB);
      ctx.stroke();
    }

    function mapX(i, n, padL, padR){
      const w = chartCanvas.width;
      if(n === 1) return (padL + (w-padR)) / 2;
      const span = (w - padL - padR);
      return padL + (i/(n-1))*span;
    }

    function mapY(v, vmin, vmax, padT, padB){
      const h = chartCanvas.height;
      if(vmax === vmin) return (padT + (h-padB))/2;
      const span = (h - padT - padB);
      const t = (v - vmin) / (vmax - vmin);
      return (h - padB) - t*span;
    }

    function drawLine(points, color){
      ctx.strokeStyle = color;
      ctx.lineWidth = 4;
      ctx.beginPath();
      points.forEach((p, idx) => {
        if(idx === 0) ctx.moveTo(p.x, p.y);
        else ctx.lineTo(p.x, p.y);
      });
      ctx.stroke();

      ctx.fillStyle = color;
      points.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
        ctx.fill();
      });
    }

    function drawLabelsY(vmin, vmax, padL, padT, padB){
      const ticks = 4;
      ctx.fillStyle = "rgba(233,236,244,.75)";
      ctx.font = "500 16px Roboto, system-ui, sans-serif";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";

      for(let i=0;i<=ticks;i++){
        const val = vmin + (i/ticks)*(vmax-vmin);
        const y = mapY(val, vmin, vmax, padT, padB);
        ctx.fillText(String(Math.round(val)), padL-10, y);

        ctx.strokeStyle = "rgba(255,255,255,.07)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(chartCanvas.width-18, y);
        ctx.stroke();
      }
    }

    function legendChip(name, color){
      const wrap = document.createElement("span");
      wrap.style.display = "inline-flex";
      wrap.style.alignItems = "center";
      wrap.style.gap = "8px";
      const dot = document.createElement("span");
      dot.style.width = "12px";
      dot.style.height = "12px";
      dot.style.borderRadius = "999px";
      dot.style.background = color;
      dot.style.boxShadow = "0 0 0 2px rgba(0,0,0,.25)";
      const txt = document.createElement("span");
      txt.textContent = name;
      wrap.appendChild(dot);
      wrap.appendChild(txt);
      return wrap;
    }

    function drawBP(entries){
      const padL=66, padR=18, padT=18, padB=44;
      const n = entries.length;

      const sysVals = entries.map(e=>e.sys);
      const diaVals = entries.map(e=>e.dia);

      let vmin = Math.min(...diaVals, ...sysVals);
      let vmax = Math.max(...diaVals, ...sysVals);
      const extra = Math.max(10, Math.round((vmax - vmin)*0.2));
      vmin = Math.max(0, vmin - extra);
      vmax = vmax + extra;

      ctx.fillStyle = "rgba(0,0,0,.10)";
      ctx.fillRect(0,0,chartCanvas.width, chartCanvas.height);

      drawAxes(padL,padR,padT,padB);
      drawLabelsY(vmin,vmax,padL,padT,padB);

      const sysPts = entries.map((e,i)=>({ x: mapX(i,n,padL,padR), y: mapY(e.sys,vmin,vmax,padT,padB) }));
      const diaPts = entries.map((e,i)=>({ x: mapX(i,n,padL,padR), y: mapY(e.dia,vmin,vmax,padT,padB) }));

      drawLine(sysPts, "rgba(90,147,255,.92)");
      drawLine(diaPts, "rgba(231,234,240,.82)");

      ctx.fillStyle = "rgba(233,236,244,.70)";
      ctx.font = "500 16px Roboto, system-ui, sans-serif";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      const first = new Date(entries[0].t);
      const last = new Date(entries[n-1].t);
      const firstTxt = isNaN(first.getTime()) ? String(entries[0].t) : first.toLocaleDateString();
      const lastTxt  = isNaN(last.getTime()) ? String(entries[n-1].t) : last.toLocaleDateString();
      ctx.fillText(firstTxt, padL, chartCanvas.height-padB+10);
      ctx.textAlign = "right";
      ctx.fillText(lastTxt, chartCanvas.width-padR, chartCanvas.height-padB+10);

      legendEl.innerHTML = "";
      legendEl.appendChild(legendChip("Systolic", "rgba(90,147,255,.92)"));
      legendEl.appendChild(legendChip("Diastolic", "rgba(231,234,240,.82)"));
      setToast("chartToast", n===1 ? "Showing 1 reading." : "");
    }

    function drawHR(entries){
      const padL=66, padR=18, padT=18, padB=44;
      const n = entries.length;

      const vals = entries.map(e=>e.hr);
      let vmin = Math.min(...vals);
      let vmax = Math.max(...vals);
      const extra = Math.max(8, Math.round((vmax - vmin)*0.25));
      vmin = Math.max(0, vmin - extra);
      vmax = vmax + extra;

      ctx.fillStyle = "rgba(0,0,0,.10)";
      ctx.fillRect(0,0,chartCanvas.width, chartCanvas.height);

      drawAxes(padL,padR,padT,padB);
      drawLabelsY(vmin,vmax,padL,padT,padB);

      const pts = entries.map((e,i)=>({ x: mapX(i,n,padL,padR), y: mapY(e.hr,vmin,vmax,padT,padB) }));
      drawLine(pts, "rgba(90,147,255,.92)");

      ctx.fillStyle = "rgba(233,236,244,.70)";
      ctx.font = "500 16px Roboto, system-ui, sans-serif";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      const first = new Date(entries[0].t);
      const last = new Date(entries[n-1].t);
      const firstTxt = isNaN(first.getTime()) ? String(entries[0].t) : first.toLocaleDateString();
      const lastTxt  = isNaN(last.getTime()) ? String(entries[n-1].t) : last.toLocaleDateString();
      ctx.fillText(firstTxt, padL, chartCanvas.height-padB+10);
      ctx.textAlign = "right";
      ctx.fillText(lastTxt, chartCanvas.width-padR, chartCanvas.height-padB+10);

      legendEl.innerHTML = "";
      legendEl.appendChild(legendChip("Heart Rate", "rgba(90,147,255,.92)"));
      setToast("chartToast", n===1 ? "Showing 1 reading." : "");
    }

    function renderChart(){
      const entriesAll = loadEntries().slice().sort((a,b) => new Date(a.t) - new Date(b.t));
      const entries = filterByRange(entriesAll, rangeEl.value);

      ctx.clearRect(0,0,chartCanvas.width, chartCanvas.height);
      legendEl.textContent = "";

      if(entries.length === 0){
        drawEmpty("No data yet. Tap Add.");
        return;
      }

      if(metricEl.value === "bp") drawBP(entries);
      else drawHR(entries);
    }

    function refreshHomeHint(){
      const entries = loadEntries();
      document.getElementById("homeHint").textContent =
        entries.length ? `You have ${entries.length} saved reading${entries.length===1?"":"s"}.` : "Tap “Add” to record BP.";
    }
    refreshHomeHint();

    window.addEventListener("resize", () => {
      if(screens.charts.classList.contains("active")) renderChart();
    });
  </script>
</body>
</html>
