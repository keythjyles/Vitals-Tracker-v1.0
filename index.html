<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Vitals Tracker</title>
  <meta name="theme-color" content="#0b1324" />

  <!-- Minimal PWA manifest (inline via blob at runtime) -->
  <link id="dyn-manifest" rel="manifest" href="" />

  <style>
    :root{
      --bg1:#071024;
      --bg2:#0c1630;
      --panel:#0e1a33cc;
      --panel2:#0a1328cc;
      --stroke:#1f2d4d;
      --stroke2:#2a3a5f;
      --text:#d7deee;
      --muted:#9fb0cf;
      --muted2:#7f93b8;
      --accent:#4b88ff;
      --accent2:#2f6cf0;
      --input:#152241;
      --danger:#ff5b6a;
      --ok:#4b88ff;
      --radius:28px;
      --radius2:18px;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --inner: inset 0 1px 0 rgba(255,255,255,.06);
      --font: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 30% 10%, rgba(70,120,255,.25), transparent 60%),
        radial-gradient(900px 700px at 80% 0%, rgba(40,90,190,.18), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1) 60%, #050a16);
      padding: 18px 14px 28px;
    }

    .wrap{
      max-width: 560px;
      margin: 0 auto;
    }

    .title{
      font-weight: 800;
      letter-spacing: .4px;
      font-size: 52px;
      line-height: 1.05;
      margin: 14px 6px 18px;
      color: #d6deef;
      opacity:.95;
      text-shadow: 0 10px 28px rgba(0,0,0,.55);
    }
    @media (max-width:420px){
      .title{font-size:44px}
    }

    .panel{
      background: linear-gradient(180deg, rgba(16,28,58,.65), rgba(9,16,34,.55));
      border: 1px solid rgba(120,150,210,.18);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      position: relative;
      overflow: hidden;
    }

    .panel::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: var(--radius);
      pointer-events:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    .row{display:flex; gap:12px; align-items:center}
    .row.space{justify-content:space-between}
    .row.center{justify-content:center}
    .mt8{margin-top:8px}
    .mt12{margin-top:12px}
    .mt16{margin-top:16px}
    .mt18{margin-top:18px}
    .mt22{margin-top:22px}
    .mt26{margin-top:26px}
    .mb6{margin-bottom:6px}
    .mb10{margin-bottom:10px}
    .hidden{display:none !important}

    /* Buttons */
    .btn{
      border: 1px solid rgba(140,170,230,.18);
      background: linear-gradient(180deg, rgba(22,36,70,.85), rgba(10,18,40,.85));
      color: var(--text);
      padding: 14px 16px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: .2px;
      box-shadow: var(--inner);
      cursor: pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(90,145,255,.95), rgba(46,108,240,.92));
      border-color: rgba(160,200,255,.35);
      color:#0b1324;
      font-weight: 800;
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(140,170,230,.18);
      color: var(--text);
    }
    .btn.small{
      padding: 10px 14px;
      font-size: 16px;
      font-weight: 750;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,106,125,.92), rgba(220,60,85,.92));
      border-color: rgba(255,170,185,.35);
      color:#0b1324;
      font-weight: 850;
    }

    .bigStack .btn{
      width:100%;
      padding: 20px 18px;
      font-size: 26px;
      border-radius: 999px;
    }
    .bigStack .btn:not(:first-child){margin-top:14px}

    .footerLine{
      margin-top: 16px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.25;
      opacity: .92;
      text-align:center;
    }

    /* Headings/labels */
    h2{
      margin: 0 0 10px;
      font-size: 34px;
      letter-spacing: .2px;
    }
    .label{
      font-size: 16px;
      font-weight: 750;
      color: var(--muted);
      letter-spacing: .2px;
      margin: 10px 2px 6px;
    }
    .labelSmall{
      font-size: 13px;
      font-weight: 700;
      color: var(--muted2);
      margin: 0;
      opacity: .95;
    }
    .noteOptional{
      font-style: italic;
      font-weight: 650;
      color: var(--muted2);
    }

    /* Inputs */
    input[type="text"], input[type="number"], textarea, input[type="date"]{
      width:100%;
      padding: 14px 14px;
      border-radius: 22px;
      border: 2px solid rgba(160,190,240,.28);
      background: rgba(21,34,65,.75);
      color: var(--text);
      outline: none;
      font-size: 18px;
      box-shadow: var(--inner);
    }
    input::placeholder, textarea::placeholder{color: rgba(180,200,235,.45)}
    input:focus, textarea:focus{
      border-color: rgba(120,170,255,.78);
      box-shadow: 0 0 0 3px rgba(80,140,255,.20), var(--inner);
    }

    /* Force numeric inputs to look consistent on mobile */
    input[type="number"]{
      -moz-appearance:textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance: none;
      margin: 0;
    }

    textarea{
      min-height: 54px;
      resize: none;
    }

    /* Add screen grid */
    .threeCols{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      align-items:end;
    }
    @media (max-width:420px){
      .threeCols{gap:10px}
      input[type="number"]{font-size:17px}
    }

    /* Time display on Add screen */
    .timeLine{
      margin: 6px 2px 10px;
      font-size: 34px;
      font-weight: 850;
      letter-spacing: .2px;
      color: #d7deee;
      opacity: .96;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (max-width:420px){
      .timeLine{font-size:30px}
    }

    /* Symptoms: tight 2-column list, no pill containers */
    .symWrap{
      margin-top: 8px;
      border: 1px solid rgba(140,170,230,.14);
      border-radius: var(--radius2);
      padding: 12px 10px 10px;
      background: linear-gradient(180deg, rgba(10,18,40,.35), rgba(8,14,30,.22));
    }
    .symGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 14px; /* tighter vertical spacing */
      align-items:center;
      padding: 6px 4px 2px;
    }
    .symItem{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 2px 0; /* tight */
      min-height: 30px;
    }
    .chk{
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 2px solid rgba(210,230,255,.55);
      background: transparent;
      position: relative;
      flex: 0 0 auto;
    }
    .chk.on{
      border-color: rgba(120,170,255,.95);
      box-shadow: 0 0 0 3px rgba(80,140,255,.18);
    }
    .chk.on::after{
      content:"";
      position:absolute;
      left: 7px;
      top: 3px;
      width: 10px;
      height: 16px;
      border-right: 3px solid rgba(210,235,255,.95);
      border-bottom: 3px solid rgba(210,235,255,.95);
      transform: rotate(40deg);
    }
    .symText{
      font-size: 20px;
      font-weight: 800;
      color: #d7deee;
      line-height: 1.05;
      user-select:none;
    }
    @media (max-width:420px){
      .symText{font-size:18px}
      .chk{width:26px;height:26px}
    }

    /* Log cards */
    .logCard{
      margin-top: 12px;
      border-radius: 24px;
      border: 1px solid rgba(140,170,230,.18);
      background: linear-gradient(180deg, rgba(16,28,58,.55), rgba(8,14,30,.45));
      padding: 14px 14px 12px;
      box-shadow: var(--inner);
    }
    .logTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap: 12px;
    }
    .logDt{
      font-size: 15px;
      color: rgba(180,200,235,.70);
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .logBp{
      font-size: 38px;
      font-weight: 900;
      letter-spacing: .3px;
      margin: 0;
      line-height: 1.0;
    }
    .logHr{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
      color: rgba(215,235,255,.92);
      margin-bottom: 6px;
      white-space: nowrap;
    }
    .logLine{
      margin-top: 10px;
      font-size: 18px;
      color: rgba(210,230,255,.90);
      line-height: 1.25;
    }
    .logLine b{color: rgba(230,240,255,.95)}

    .subPanel{
      margin-top: 12px;
      border-radius: 24px;
      border: 1px solid rgba(140,170,230,.14);
      background: linear-gradient(180deg, rgba(12,20,44,.45), rgba(7,12,28,.40));
      padding: 14px;
      box-shadow: var(--inner);
    }

    /* Chart */
    canvas{
      width: 100%;
      height: 260px;
      display:block;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(10,16,36,.55), rgba(6,10,22,.55));
      border: 1px solid rgba(140,170,230,.16);
      box-shadow: var(--inner);
    }

    /* Top button bars inside screens */
    .topBar{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .topBar .left, .topBar .right{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .topBar .left{justify-content:flex-start}
    .topBar .right{justify-content:flex-end}

    /* Make search/date rows compact */
    .twoCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:end;
    }

    .tinyFooter{
      margin-top: 14px;
      font-size: 12px;
      color: rgba(165,190,235,.70);
      text-align:center;
      line-height: 1.25;
    }

    /* “Only home has exit/install” bar */
    .homeFooterBar{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:12px;
      margin-top: 14px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">Vitals Tracker</div>

    <!-- HOME -->
    <div id="screen-home" class="panel">
      <div class="bigStack">
        <button class="btn primary" id="goAdd">Add</button>
        <button class="btn" id="goLog">Log</button>
        <button class="btn" id="goCharts">Charts</button>
      </div>

      <div class="homeFooterBar">
        <button class="btn small" id="btnInstall">Install</button>
        <button class="btn small danger" id="btnExitHome">Exit</button>
      </div>

      <div class="tinyFooter">
        Data stays on your phone (local only).<br>
        <span id="homeVersion">v1.11</span> · developed by Keyth Jyles
      </div>
    </div>

    <!-- ADD -->
    <div id="screen-add" class="panel hidden">
      <div class="timeLine" id="timeLine">--:--:-- --, --/--/----</div>

      <div class="threeCols">
        <div>
          <div class="label">Systolic</div>
          <input inputmode="numeric" type="number" id="inSys" placeholder="e.g., 132" min="0" max="300" />
        </div>
        <div>
          <div class="label">Diastolic</div>
          <input inputmode="numeric" type="number" id="inDia" placeholder="e.g., 91" min="0" max="200" />
        </div>
        <div>
          <div class="label">Heart Rate</div>
          <input inputmode="numeric" type="number" id="inHr" placeholder="e.g., 72" min="0" max="250" />
        </div>
      </div>

      <div class="mt12">
        <div class="label">Notes <span class="noteOptional">(optional)</span></div>
        <textarea id="inNotes" placeholder="optional"></textarea>
      </div>

      <div class="mt12">
        <div class="label">Symptoms</div>
        <div class="symWrap">
          <div class="symGrid" id="symGrid"></div>
        </div>
      </div>

      <!-- Buttons go directly under symptoms list (not at page bottom) -->
      <div class="mt16 row space">
        <button class="btn primary" id="btnSave">Save</button>
        <button class="btn" id="btnBackFromAdd">Back</button>
      </div>
    </div>

    <!-- LOG -->
    <div id="screen-log" class="panel hidden">
      <div class="topBar">
        <div class="left">
          <button class="btn small" id="btnBackFromLog">Back</button>
        </div>
        <div class="right">
          <button class="btn small primary" id="btnExportLog">Export</button>
        </div>
      </div>

      <h2 class="mb10">Search</h2>

      <div class="subPanel">
        <div class="label">Search</div>
        <input type="text" id="logSearch" placeholder="Type a word: sweaty, dizzy, headache..." />

        <div class="twoCols mt12">
          <div>
            <div class="label">From</div>
            <input type="date" id="logFrom" />
          </div>
          <div>
            <div class="label">To</div>
            <input type="date" id="logTo" />
          </div>
        </div>

        <div class="mt12 labelSmall" id="logStatus"></div>
      </div>

      <div id="logList"></div>
    </div>

    <!-- CHARTS -->
    <div id="screen-charts" class="panel hidden">
      <div class="topBar">
        <div class="left">
          <button class="btn small" id="btnBackFromCharts">Back</button>
        </div>
        <div class="right">
          <button class="btn small primary" id="btnExportCharts">Export</button>
        </div>
      </div>

      <h2 class="mb10">Charts</h2>

      <div class="subPanel">
        <div class="twoCols">
          <div>
            <div class="label">From</div>
            <input type="date" id="chFrom" />
          </div>
          <div>
            <div class="label">To</div>
            <input type="date" id="chTo" />
          </div>
        </div>
        <div class="mt12 labelSmall" id="chartStatus"></div>
      </div>

      <div class="mt12">
        <canvas id="chart" width="900" height="420"></canvas>
      </div>
    </div>

  </div>

<script>
(() => {
  "use strict";

  // ==========================
  // Version
  // ==========================
  const VERSION = "v1.11";

  // ==========================
  // Data model
  // ==========================
  // record: { id, ts, sys, dia, hr, notes, symptoms:[...] }
  const STORAGE_KEY = "vitals_tracker_records_v1";
  const SYMPTOMS = [
    "Sweaty","Dizzy",
    "Panic","Brain fog",
    "Chest tight","Headache",
    "Nausea","Short breath",
    "Hot ears","Shaky",
    "Blurred vision","Weakness"
  ];

  // ==========================
  // Helpers
  // ==========================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,"0");

  function fmtDate(d){
    // MM/DD/YYYY
    return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}/${d.getFullYear()}`;
  }
  function fmtTime(d){
    let h = d.getHours();
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    const m = pad2(d.getMinutes());
    const s = pad2(d.getSeconds());
    return `${pad2(h)}:${m}:${s} ${ampm}`;
  }
  function fmtTimeNoSeconds(d){
    let h = d.getHours();
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if (h === 0) h = 12;
    const m = pad2(d.getMinutes());
    return `${pad2(h)}:${m} ${ampm}`;
  }

  function dateToYMD(d){
    // local date => YYYY-MM-DD
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function parseYMD(ymd){
    // ymd string => Date at local midnight
    if(!ymd) return null;
    const [y,m,da] = ymd.split("-").map(Number);
    if(!y || !m || !da) return null;
    return new Date(y, m-1, da, 0,0,0,0);
  }

  function loadRecords(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return [];
      return arr.filter(r => r && typeof r.ts === "number");
    }catch{
      return [];
    }
  }

  function saveRecords(records){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }

  function normalizeRecords(records){
    // newest first
    records.sort((a,b)=>b.ts - a.ts);
    return records;
  }

  function withinDateRange(ts, fromYMD, toYMD){
    const d = new Date(ts);
    const ymd = dateToYMD(d);
    if(fromYMD && ymd < fromYMD) return false;
    if(toYMD && ymd > toYMD) return false;
    return true;
  }

  function matchSearch(r, q){
    if(!q) return true;
    const t = q.trim().toLowerCase();
    if(!t) return true;
    const parts = [
      String(r.sys ?? ""),
      String(r.dia ?? ""),
      String(r.hr ?? ""),
      (r.notes ?? ""),
      (Array.isArray(r.symptoms) ? r.symptoms.join(", ") : "")
    ].join(" ").toLowerCase();
    return parts.includes(t);
  }

  // ==========================
  // Screens
  // ==========================
  const screens = ["home","add","log","charts"];
  function show(name){
    for(const s of screens){
      const el = $("screen-"+s);
      if(el) el.classList.toggle("hidden", s !== name);
    }
    // Default populate with all data when opening log/charts
    if(name === "log"){
      // Do not clear filters; just render with current controls.
      renderLog();
    }
    if(name === "charts"){
      renderCharts();
    }
  }

  // ==========================
  // Symptoms UI
  // ==========================
  const symGrid = $("symGrid");
  const symState = new Set();

  function buildSymptoms(){
    symGrid.innerHTML = "";
    for(const label of SYMPTOMS){
      const item = document.createElement("div");
      item.className = "symItem";

      const box = document.createElement("div");
      box.className = "chk";
      box.setAttribute("role","checkbox");
      box.setAttribute("aria-checked","false");
      box.tabIndex = 0;

      const text = document.createElement("div");
      text.className = "symText";
      text.textContent = label;

      function toggle(){
        if(symState.has(label)) symState.delete(label);
        else symState.add(label);
        sync();
      }
      function sync(){
        const on = symState.has(label);
        box.classList.toggle("on", on);
        box.setAttribute("aria-checked", on ? "true" : "false");
      }

      item.addEventListener("click", (e) => { e.preventDefault(); toggle(); });
      box.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          toggle();
        }
      });

      item.appendChild(box);
      item.appendChild(text);
      symGrid.appendChild(item);
      sync();
    }
  }

  function setSymptoms(selected){
    symState.clear();
    (selected || []).forEach(s => symState.add(s));
    // rebuild to sync visuals
    buildSymptoms();
  }

  function getSymptoms(){
    return Array.from(symState.values());
  }

  // ==========================
  // Add screen clock
  // ==========================
  let clockTimer = null;
  function startClock(){
    stopClock();
    const tick = () => {
      const d = new Date();
      $("timeLine").textContent = `${fmtTime(d)}, ${fmtDate(d)}`;
    };
    tick();
    clockTimer = setInterval(tick, 250);
  }
  function stopClock(){
    if(clockTimer){ clearInterval(clockTimer); clockTimer = null; }
  }

  // ==========================
  // Save record
  // ==========================
  function clearAddForm(){
    $("inSys").value = "";
    $("inDia").value = "";
    $("inHr").value = "";
    $("inNotes").value = "";
    setSymptoms([]);
  }

  function validateNum(val, min, max){
    if(val === "" || val === null || typeof val === "undefined") return null;
    const n = Number(val);
    if(!Number.isFinite(n)) return null;
    if(n < min || n > max) return null;
    return Math.round(n);
  }

  function saveCurrentRecord(){
    const sys = validateNum($("inSys").value, 0, 300);
    const dia = validateNum($("inDia").value, 0, 200);
    const hr  = validateNum($("inHr").value, 0, 250);

    if(sys === null || dia === null || hr === null){
      alert("Enter Systolic, Diastolic, and Heart Rate.");
      return;
    }

    const now = Date.now();
    const rec = {
      id: "r_" + now + "_" + Math.random().toString(16).slice(2),
      ts: now,
      sys, dia, hr,
      notes: ($("inNotes").value || "").trim(),
      symptoms: getSymptoms()
    };

    const records = normalizeRecords(loadRecords());
    records.unshift(rec);
    saveRecords(records);

    clearAddForm();
    // return to home
    stopClock();
    show("home");
  }

  // ==========================
  // Log screen
  // ==========================
  function filteredRecords(fromEl, toEl, searchEl){
    const records = normalizeRecords(loadRecords());
    const fromYMD = (fromEl.value || "").trim();
    const toYMD   = (toEl.value || "").trim();
    const q = (searchEl.value || "").trim();

    return records.filter(r =>
      withinDateRange(r.ts, fromYMD, toYMD) &&
      matchSearch(r, q)
    );
  }

  function renderLog(){
    const list = $("logList");
    const status = $("logStatus");

    const recs = filteredRecords($("logFrom"), $("logTo"), $("logSearch"));
    list.innerHTML = "";

    status.textContent = `Showing: ${recs.length} of ${loadRecords().length}`;

    for(const r of recs){
      const d = new Date(r.ts);

      const card = document.createElement("div");
      card.className = "logCard";

      const top = document.createElement("div");
      top.className = "logTop";

      const left = document.createElement("div");
      const dt = document.createElement("div");
      dt.className = "logDt";
      dt.textContent = `${fmtDate(d)}, ${fmtTimeNoSeconds(d)}`;

      const bp = document.createElement("p");
      bp.className = "logBp";
      bp.textContent = `BP ${r.sys}/${r.dia}`;

      left.appendChild(dt);
      left.appendChild(bp);

      const hr = document.createElement("div");
      hr.className = "logHr";
      hr.textContent = `HR ${r.hr}`;

      top.appendChild(left);
      top.appendChild(hr);

      const sym = document.createElement("div");
      sym.className = "logLine";
      const symText = (r.symptoms && r.symptoms.length) ? r.symptoms.join(", ") : "None";
      sym.innerHTML = `<b>Symptoms:</b> ${escapeHtml(symText)}`;

      const notes = document.createElement("div");
      notes.className = "logLine";
      notes.innerHTML = `<b>Notes:</b> ${escapeHtml(r.notes ? r.notes : "None")}`;

      card.appendChild(top);
      card.appendChild(sym);
      card.appendChild(notes);
      list.appendChild(card);
    }

    if(recs.length === 0){
      const empty = document.createElement("div");
      empty.className = "subPanel";
      empty.innerHTML = `<div class="labelSmall">No matching records.</div>`;
      list.appendChild(empty);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function exportText(records){
    // Always exports the currently filtered set (log or charts)
    const lines = [];
    for(const r of records){
      const d = new Date(r.ts);
      const dt = `${fmtDate(d)}, ${fmtTime(d)}`;
      const sym = (r.symptoms && r.symptoms.length) ? r.symptoms.join(", ") : "None";
      const notes = r.notes ? r.notes : "None";
      lines.push(`${dt}`);
      lines.push(`BP ${r.sys}/${r.dia} • HR ${r.hr}`);
      lines.push(`Symptoms: ${sym}`);
      lines.push(`Notes: ${notes}`);
      lines.push(""); // blank line
    }
    return lines.join("\n");
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      alert("Copied to clipboard.");
      return true;
    }catch{
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      let ok = false;
      try{
        ok = document.execCommand("copy");
      }catch{}
      document.body.removeChild(ta);
      alert(ok ? "Copied to clipboard." : "Copy failed. Try again.");
      return ok;
    }
  }

  // ==========================
  // Charts
  // ==========================
  function renderCharts(){
    const canvas = $("chart");
    const ctx = canvas.getContext("2d");
    const status = $("chartStatus");

    const recs = normalizeRecords(loadRecords()).slice().reverse(); // oldest -> newest for chart
    const fromYMD = ($("chFrom").value || "").trim();
    const toYMD   = ($("chTo").value || "").trim();

    const filtered = recs.filter(r => withinDateRange(r.ts, fromYMD, toYMD));
    status.textContent = `Showing: ${filtered.length} of ${loadRecords().length}`;

    // Clear
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // If no data
    if(filtered.length === 0){
      drawChartFrame(ctx, canvas, []);
      drawCenteredText(ctx, canvas, "No data in selected range");
      return;
    }

    // Build series
    const sys = filtered.map(r => r.sys);
    const dia = filtered.map(r => r.dia);
    const hr  = filtered.map(r => r.hr);

    const all = sys.concat(dia).concat(hr);
    let minV = Math.min(...all);
    let maxV = Math.max(...all);
    // pad range
    const pad = Math.max(6, Math.round((maxV - minV) * 0.12));
    minV = Math.max(0, minV - pad);
    maxV = maxV + pad;

    drawChartFrame(ctx, canvas, {minV, maxV});

    // plot
    const padL = 56, padR = 18, padT = 16, padB = 40;
    const W = canvas.width, H = canvas.height;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    const xFor = (i) => padL + (filtered.length === 1 ? plotW/2 : (i * (plotW/(filtered.length-1))));
    const yFor = (v) => padT + (maxV - v) * (plotH / (maxV - minV || 1));

    // lines
    plotLine(ctx, filtered, sys, xFor, yFor, "rgba(79,140,255,.98)", 3);
    plotLine(ctx, filtered, dia, xFor, yFor, "rgba(216,224,240,.88)", 3);
    plotLine(ctx, filtered, hr,  xFor, yFor, "rgba(120,220,180,.92)", 3);

    // Legend: readable labels
    drawLegend(ctx, canvas, [
      ["Systolic", "rgba(79,140,255,.98)"],
      ["Diastolic", "rgba(216,224,240,.88)"],
      ["Heart Rate", "rgba(120,220,180,.92)"]
    ]);
  }

  function drawChartFrame(ctx, canvas, range){
    const W = canvas.width, H = canvas.height;
    const padL = 56, padR = 18, padT = 16, padB = 40;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    // grid
    ctx.save();
    ctx.globalAlpha = 1;

    // faint background already from CSS
    ctx.lineWidth = 1;

    const gridLines = 5;
    for(let i=0;i<=gridLines;i++){
      const y = padT + (i*(plotH/gridLines));
      ctx.strokeStyle = "rgba(210,230,255,.10)";
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(padL+plotW, y);
      ctx.stroke();
    }

    // y labels
    if(range && typeof range.minV === "number"){
      ctx.fillStyle = "rgba(215,230,255,.70)";
      ctx.font = "16px system-ui,Segoe UI,Arial";
      for(let i=0;i<=gridLines;i++){
        const v = Math.round(range.maxV - (i*(range.maxV-range.minV)/gridLines));
        const y = padT + (i*(plotH/gridLines));
        ctx.fillText(String(v), 10, y+6);
      }
    }

    ctx.restore();
  }

  function plotLine(ctx, filtered, series, xFor, yFor, color, width){
    ctx.save();
    ctx.lineWidth = width;
    ctx.strokeStyle = color;
    ctx.beginPath();
    for(let i=0;i<series.length;i++){
      const x = xFor(i);
      const y = yFor(series[i]);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // points
    ctx.fillStyle = color;
    for(let i=0;i<series.length;i++){
      const x = xFor(i), y = yFor(series[i]);
      ctx.beginPath();
      ctx.arc(x,y,3.2,0,Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function drawLegend(ctx, canvas, items){
    const W = canvas.width, H = canvas.height;
    const x = 64;
    let y = H - 18;
    ctx.save();
    ctx.font = "18px system-ui,Segoe UI,Arial";
    ctx.textBaseline = "middle";
    for(const [text, color] of items){
      ctx.fillStyle = color;
      ctx.fillRect(x, y-6, 18, 6);
      ctx.fillStyle = "rgba(235,245,255,.92)";
      ctx.fillText(text, x+26, y-3);
      x += 220; // spread labels so they do not overlap
    }
    ctx.restore();
  }

  function drawCenteredText(ctx, canvas, text){
    ctx.save();
    ctx.fillStyle = "rgba(235,245,255,.80)";
    ctx.font = "22px system-ui,Segoe UI,Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, canvas.width/2, canvas.height/2);
    ctx.restore();
  }

  // ==========================
  // Install / Uninstall behavior (best-effort in browser)
  // ==========================
  let deferredPrompt = null;

  function isStandalone(){
    return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
  }

  function setInstallButtonState(){
    const btn = $("btnInstall");
    // If in standalone, show "Uninstall". If not, show "Install" (even if install prompt unavailable).
    const installed = isStandalone() || localStorage.getItem("vt_installed_hint") === "1";
    btn.textContent = installed ? "Uninstall" : "Install";
  }

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // show install (not prominent; user requested small button)
    setInstallButtonState();
  });

  window.addEventListener("appinstalled", () => {
    localStorage.setItem("vt_installed_hint","1");
    deferredPrompt = null;
    setInstallButtonState();
  });

  async function handleInstallClick(){
    const installed = isStandalone() || localStorage.getItem("vt_installed_hint") === "1";
    if(installed){
      // Browsers do not allow programmatic uninstall. Provide clear instructions.
      alert("To uninstall: long-press the app icon and choose Uninstall (or remove from Home screen). Uninstall may remove local app data depending on your phone/browser.");
      return;
    }
    if(deferredPrompt){
      deferredPrompt.prompt();
      await deferredPrompt.userChoice.catch(()=>{});
      deferredPrompt = null;
      // user may still not install; update label heuristically
      setInstallButtonState();
    }else{
      // No prompt available (already installed, or not supported)
      alert("Install prompt not available. If you see an Install / Add to Home screen option in your browser menu, use that.");
    }
  }

  // ==========================
  // “Exit” on Home only
  // ==========================
  function exitApp(){
    // Best-effort. PWAs may close; browsers often ignore.
    try{
      window.close();
    }catch{}
    // Fallback: return to home and scroll top
    show("home");
    window.scrollTo({top:0, behavior:"smooth"});
  }

  // ==========================
  // Wire up UI
  // ==========================
  function init(){
    $("homeVersion").textContent = VERSION;

    // Home nav
    $("goAdd").addEventListener("click", () => {
      show("add");
      startClock();
      // do not wipe symptoms by default; but best UX: start blank each time
      clearAddForm();
    });
    $("goLog").addEventListener("click", () => show("log"));
    $("goCharts").addEventListener("click", () => show("charts"));

    // Install / Exit on home only
    $("btnInstall").addEventListener("click", handleInstallClick);
    $("btnExitHome").addEventListener("click", exitApp);

    // Add actions
    $("btnSave").addEventListener("click", saveCurrentRecord);
    $("btnBackFromAdd").addEventListener("click", () => { stopClock(); show("home"); });

    // Log actions
    $("btnBackFromLog").addEventListener("click", () => show("home"));
    $("logSearch").addEventListener("input", renderLog);
    $("logFrom").addEventListener("change", renderLog);
    $("logTo").addEventListener("change", renderLog);
    $("btnExportLog").addEventListener("click", async () => {
      const recs = filteredRecords($("logFrom"), $("logTo"), $("logSearch"));
      const txt = exportText(recs);
      await copyToClipboard(txt);
    });

    // Charts actions
    $("btnBackFromCharts").addEventListener("click", () => show("home"));
    $("chFrom").addEventListener("change", renderCharts);
    $("chTo").addEventListener("change", renderCharts);
    $("btnExportCharts").addEventListener("click", async () => {
      // Export the chart-filtered records as text (same format)
      const all = normalizeRecords(loadRecords());
      const fromYMD = ($("chFrom").value || "").trim();
      const toYMD   = ($("chTo").value || "").trim();
      const filtered = all.filter(r => withinDateRange(r.ts, fromYMD, toYMD));
      const txt = exportText(filtered);
      await copyToClipboard(txt);
    });

    // Build symptoms list
    buildSymptoms();

    // Create manifest + SW (single file friendly)
    setupPWA();

    // Default state
    setInstallButtonState();
    show("home");
  }

  // ==========================
  // PWA: inline manifest + service worker (created from blobs)
  // ==========================
  function setupPWA(){
    // Manifest
    const manifest = {
      name: "Vitals Tracker",
      short_name: "Vitals",
      start_url: "./",
      display: "standalone",
      background_color: "#071024",
      theme_color: "#0b1324",
      icons: [
        // Data-URL SVG icon so you do not need extra files
        {
          src: makeIconDataUrl("#2f6cf0"),
          sizes: "192x192",
          type: "image/png"
        },
        {
          src: makeIconDataUrl("#2f6cf0"),
          sizes: "512x512",
          type: "image/png"
        }
      ]
    };
    const manBlob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const manUrl = URL.createObjectURL(manBlob);
    $("dyn-manifest").setAttribute("href", manUrl);

    // Service worker (cache-first)
    if("serviceWorker" in navigator){
      const swCode = `
        const CACHE = "vt_cache_v111";
        self.addEventListener("install", (e) => {
          e.waitUntil((async() => {
            const c = await caches.open(CACHE);
            await c.addAll(["./"]);
            self.skipWaiting();
          })());
        });
        self.addEventListener("activate", (e) => {
          e.waitUntil((async() => {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => (k !== CACHE) ? caches.delete(k) : Promise.resolve()));
            self.clients.claim();
          })());
        });
        self.addEventListener("fetch", (e) => {
          const req = e.request;
          e.respondWith((async() => {
            const cached = await caches.match(req);
            if(cached) return cached;
            try{
              const fresh = await fetch(req);
              const c = await caches.open(CACHE);
              c.put(req, fresh.clone());
              return fresh;
            }catch{
              return cached || Response.error();
            }
          })());
        });
      `;
      const swBlob = new Blob([swCode], {type:"text/javascript"});
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(()=>{});
    }
  }

  function makeIconDataUrl(color){
    // Return a PNG via inline SVG -> data URL. (Browser will rasterize.)
    const svg =
      `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="${color}" stop-opacity="1"/>
            <stop offset="1" stop-color="#0b1324" stop-opacity="1"/>
          </linearGradient>
        </defs>
        <rect width="512" height="512" rx="110" fill="url(#g)"/>
        <path d="M128 290h70l26-94 44 160 30-98h84" fill="none" stroke="rgba(235,245,255,.92)" stroke-width="28" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="160" cy="290" r="10" fill="rgba(235,245,255,.92)"/>
        <circle cx="382" cy="258" r="10" fill="rgba(235,245,255,.92)"/>
      </svg>`;
    const encoded = encodeURIComponent(svg)
      .replace(/'/g,"%27").replace(/"/g,"%22");
    // SVG data URL (most launchers accept it; if not, icons may fallback)
    return `data:image/svg+xml;charset=utf-8,${encoded}`;
  }

  // ==========================
  // Start
  // ==========================
  init();

})();
</script>
</body>
</html>
```0
