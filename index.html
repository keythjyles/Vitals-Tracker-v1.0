<!-- Vitals Tracker v1.18A08 -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Vitals Tracker</title>

  <link rel="manifest" id="manifestLink" href="#" />

  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;
      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --text:rgba(235,245,255,.86);
      --muted:rgba(235,245,255,.58);
      --muted2:rgba(235,245,255,.42);
      --accent:#2b4e7a;
      --good:rgba(120,255,190,.9);
      --warn:rgba(255,210,120,.9);
      --bad:rgba(255,120,140,.92);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --pad:14px;
      --btnH:52px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: radial-gradient(1200px 800px at 40% 0%, #14284d 0%, var(--bg0) 50%, #050a14 100%);
    }

    .wrap{ max-width:980px; margin:0 auto; padding:14px 14px 28px; }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 10px 6px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.4px;
      font-size:20px;
    }
    .brand .logo{
      width:26px; height:26px; border-radius:8px;
      background: linear-gradient(135deg, rgba(60,140,255,.35), rgba(60,140,255,.05));
      border:1px solid rgba(120,180,255,.25);
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .sub{
      font-size:12px; color:var(--muted);
      margin-top:2px;
    }

    .card{
      background: linear-gradient(180deg, rgba(12,21,40,.78), rgba(10,16,30,.68));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card + .card{ margin-top:12px; }
    .cardHd{
      padding:12px var(--pad);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(6,10,18,.25);
    }
    .cardHd h2{
      margin:0; font-size:15px; letter-spacing:.25px;
      color:rgba(235,245,255,.9);
    }
    .cardBd{ padding:12px var(--pad); }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width:760px){
      .grid2, .grid3{ grid-template-columns:1fr; }
    }

    .btn{
      height:var(--btnH);
      border-radius:14px;
      border:1px solid rgba(120,180,255,.22);
      background: linear-gradient(180deg, rgba(40,80,140,.35), rgba(20,40,80,.18));
      color:rgba(235,245,255,.9);
      font-weight:700;
      font-size:16px;
      letter-spacing:.2px;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:rgba(235,245,255,.86);
    }
    .btn.danger{
      border:1px solid rgba(255,130,160,.28);
      background: linear-gradient(180deg, rgba(255,90,130,.22), rgba(255,90,130,.08));
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 auto; }

    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    label{
      font-size:12px; color:var(--muted);
      letter-spacing:.2px;
    }
    input, textarea, select{
      width:100%;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(5,9,18,.35);
      color:rgba(235,245,255,.92);
      padding:12px 12px;
      outline:none;
      font-size:16px;
    }
    textarea{ min-height:88px; resize:vertical; }
    input[type="range"]{ padding:10px 8px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:rgba(235,245,255,.86);
      font-size:13px;
      font-weight:700;
    }

    /* Symptom grid */
    .symGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:8px;
    }
    @media (max-width:560px){ .symGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .sym{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      color:rgba(235,245,255,.85);
      font-weight:700;
      font-size:14px;
      text-align:center;
      user-select:none;
    }
    .sym.on{
      border-color: rgba(120,180,255,.35);
      background: rgba(70,130,255,.16);
    }

    /* Pages */
    .page{ display:none; }
    .page.active{ display:block; }

    /* Log list */
    .logTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
    }
    .logTop .field{ flex:1 1 220px; }
    .list{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }

    .item{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px 12px;
      position:relative;
      user-select:none;
      transition: background .08s ease, border-color .08s ease;
    }
    .item.press{
      background: rgba(70,130,255,.14);
      border-color: rgba(140,200,255,.35);
    }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .dt{ font-size:12px; color:var(--muted); font-weight:700; }
    .bpLine{
      margin-top:6px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:baseline;
    }
    .bpBig{
      font-size:22px; font-weight:900; letter-spacing:.2px;
      color:rgba(235,245,255,.92);
    }
    /* A08 change: BP label reduced by 50% */
    .bpLabel{
      font-size:11px;           /* reduced */
      font-weight:900;
      letter-spacing:.35px;
      color:rgba(235,245,255,.62);
      text-transform:uppercase;
    }
    .hr{
      font-size:15px; font-weight:800; color:rgba(235,245,255,.78);
    }
    .meta{
      margin-top:8px;
      font-size:13px;
      color:rgba(235,245,255,.74);
      line-height:1.35;
    }
    .meta b{ color:rgba(235,245,255,.86); }
    .tags{
      margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;
    }
    .tag{
      padding:6px 9px; border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      font-size:12px; font-weight:800;
      color:rgba(235,245,255,.76);
    }

    /* Modal */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modalMask.show{ display:flex; }
    .modal{
      width:min(520px, 100%);
      border-radius:18px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(12,21,40,.95), rgba(8,12,22,.92));
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHd{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .modalHd h3{ margin:0; font-size:14px; letter-spacing:.2px; }
    .modalBd{ padding:12px 14px; }
    .modalFt{ padding:12px 14px; border-top:1px solid var(--stroke); display:flex; gap:10px; }
    .modalFt .btn{ flex:1 1 auto; }

    /* Chart */
    .chartWrap{
      border:1px solid var(--stroke);
      border-radius:18px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    canvas{ display:block; width:100%; height:260px; }
    .chartControls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .chartControls .field{ flex: 1 1 220px; }
    .hint{
      font-size:12px; color:var(--muted);
      line-height:1.25;
    }

    footer{
      margin-top:14px;
      color:rgba(235,245,255,.42);
      font-size:12px;
      text-align:center;
      padding:10px 0 2px;
    }
    .smallLink{
      color:rgba(180,210,255,.62);
      text-decoration:none;
      border-bottom:1px dotted rgba(180,210,255,.28);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            Vitals Tracker
            <div class="sub" id="subtitle">Offline • Local-only • v1.18A08</div>
          </div>
        </div>
      </div>
      <div class="pill" id="todayPill">—</div>
    </header>

    <!-- HOME -->
    <section class="page active" id="pageHome">
      <div class="card">
        <div class="cardHd">
          <h2>Home</h2>
          <span class="pill" id="countPill">0 entries</span>
        </div>
        <div class="cardBd">
          <div class="grid3">
            <button class="btn" id="btnAddHome">Add Reading</button>
            <button class="btn secondary" id="btnLogHome">Open Log</button>
            <button class="btn secondary" id="btnChartsHome">Charts</button>
          </div>

          <div style="height:10px"></div>

          <div class="grid3">
            <button class="btn secondary" id="btnExportHome">Export / Report</button>
            <button class="btn secondary" id="btnInstall">Install</button>
            <button class="btn danger" id="btnExit">Exit</button>
          </div>

          <div style="height:10px"></div>

          <div class="grid2">
            <button class="btn secondary" id="btnUninstall">Uninstall Help</button>
            <button class="btn danger" id="btnClearData">Clear Data</button>
          </div>

          <div style="height:12px"></div>
          <div class="hint">
            Data stays on this device only. No accounts. No network calls.
          </div>
        </div>
      </div>
    </section>

    <!-- ADD / EDIT -->
    <section class="page" id="pageAdd">
      <div class="card">
        <div class="cardHd">
          <h2 id="addTitle">Add Reading</h2>
          <button class="btn secondary" id="btnBackFromAdd" style="height:40px; font-size:14px; padding:0 12px;">Back</button>
        </div>
        <div class="cardBd">
          <div class="grid3">
            <div class="field">
              <label for="inpSys">Systolic</label>
              <input id="inpSys" inputmode="numeric" placeholder="e.g., 128" />
            </div>
            <div class="field">
              <label for="inpDia">Diastolic</label>
              <input id="inpDia" inputmode="numeric" placeholder="e.g., 82" />
            </div>
            <div class="field">
              <label for="inpHr">Heart Rate</label>
              <input id="inpHr" inputmode="numeric" placeholder="e.g., 74" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <label>Symptoms (tap to toggle)</label>
            <div class="symGrid" id="symGrid"></div>
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <label for="inpNotes">Notes</label>
            <textarea id="inpNotes" placeholder="Context, meds, triggers, etc."></textarea>
          </div>

          <div style="height:12px"></div>

          <div class="grid2">
            <button class="btn" id="btnSave">Save</button>
            <button class="btn danger" id="btnDelete" style="display:none;">Delete</button>
          </div>
        </div>
      </div>
    </section>

    <!-- LOG -->
    <section class="page" id="pageLog">
      <div class="card">
        <div class="cardHd">
          <h2>Log</h2>
          <button class="btn secondary" id="btnBackFromLog" style="height:40px; font-size:14px; padding:0 12px;">Back</button>
        </div>
        <div class="cardBd">
          <div class="logTop">
            <div class="field">
              <label for="inpSearch">Search (symptom/notes)</label>
              <input id="inpSearch" placeholder="e.g., panic, sweaty, lisinopril" />
            </div>
            <div class="field">
              <label for="inpFrom">From (date)</label>
              <input id="inpFrom" type="date" />
            </div>
            <div class="field">
              <label for="inpTo">To (date)</label>
              <input id="inpTo" type="date" />
            </div>
          </div>

          <div class="list" id="list"></div>

          <div style="height:10px"></div>
          <div class="hint">
            Tap and release an item to edit. Slide off to cancel.
          </div>
        </div>
      </div>
    </section>

    <!-- CHARTS -->
    <section class="page" id="pageCharts">
      <div class="card">
        <div class="cardHd">
          <h2>Charts</h2>
          <button class="btn secondary" id="btnBackFromCharts" style="height:40px; font-size:14px; padding:0 12px;">Back</button>
        </div>
        <div class="cardBd">
          <div class="grid2">
            <div class="field">
              <label for="weekPick">Week (any date in week)</label>
              <input id="weekPick" type="date" />
            </div>
            <div class="field">
              <label for="zoomRange">Zoom (max = 48 hours)</label>
              <input id="zoomRange" type="range" min="0" max="5" step="1" />
            </div>
          </div>

          <div class="chartControls">
            <div class="pill" id="weekLabel">—</div>
            <div class="pill" id="zoomLabel">—</div>
          </div>

          <div style="height:10px"></div>

          <div class="chartWrap" id="chartWrap">
            <canvas id="chart" width="1200" height="520"></canvas>
          </div>

          <div style="height:10px"></div>
          <div class="hint">
            One-finger slide left/right to pan when zoomed in. Zoom is constrained so the narrowest window is 48 hours.
          </div>
        </div>
      </div>
    </section>

    <footer id="foot">v1.18A08</footer>
  </div>

  <!-- Confirm / Edit modal -->
  <div class="modalMask" id="mask">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHd">
        <h3 id="mTitle">Edit entry?</h3>
        <button class="btn secondary" id="mClose" style="height:36px; font-size:13px; padding:0 10px;">Close</button>
      </div>
      <div class="modalBd" id="mBody">—</div>
      <div class="modalFt">
        <button class="btn secondary" id="mCancel">Cancel</button>
        <button class="btn" id="mEdit">Edit</button>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const VERSION = "v1.18A08";
  const STORAGE_KEY = "vitals_tracker_records_v1";
  const SYMPTOMS = [
    "Panic","Sweaty","Nausea","Chest tight","Dizzy","Brain fog",
    "Head pain","Blurred vision","Weakness","Heat intolerance","Shaky","Other"
  ];

  const $ = (id) => document.getElementById(id);

  const pageHome = $("pageHome");
  const pageAdd = $("pageAdd");
  const pageLog = $("pageLog");
  const pageCharts = $("pageCharts");

  const subtitle = $("subtitle");
  const foot = $("foot");
  subtitle.textContent = `Offline • Local-only • ${VERSION}`;
  foot.textContent = VERSION;

  const todayPill = $("todayPill");
  const countPill = $("countPill");

  // Home buttons
  $("btnAddHome").onclick = () => openAdd();
  $("btnLogHome").onclick = () => openLog();
  $("btnChartsHome").onclick = () => openCharts();
  $("btnExportHome").onclick = () => exportReport();
  $("btnBackFromAdd").onclick = () => openHome();
  $("btnBackFromLog").onclick = () => openHome();
  $("btnBackFromCharts").onclick = () => openHome();

  // Install/Uninstall help
  $("btnInstall").onclick = () => alert("Install:\n\nAndroid/Chrome: Menu (⋮) → Add to Home screen.\n\niPhone/Safari: Share → Add to Home Screen.\n\nThis app is offline-first and stores data on-device.");
  $("btnUninstall").onclick = () => alert("Uninstall:\n\nRemove the app icon from your Home screen. Data is stored on-device.\n\nIf you want to erase entries: use Clear Data on Home.");
  $("btnClearData").onclick = () => clearData();

  // Exit handler (frozen known-good pattern)
  $("btnExit").onclick = () => {
    try { window.close(); } catch(e) {}
    setTimeout(() => {
      alert("If Exit did not close this window:\n\n• Use your device Back button, or\n• Close the app from Recent Apps.\n\n(Installed PWA behavior varies by device.)");
    }, 350);
  };

  // Add/Edit fields
  const addTitle = $("addTitle");
  const inpSys = $("inpSys");
  const inpDia = $("inpDia");
  const inpHr  = $("inpHr");
  const inpNotes = $("inpNotes");
  const symGrid = $("symGrid");
  const btnSave = $("btnSave");
  const btnDelete = $("btnDelete");

  // Log fields
  const inpSearch = $("inpSearch");
  const inpFrom = $("inpFrom");
  const inpTo = $("inpTo");
  const list = $("list");

  // Modal
  const mask = $("mask");
  const mClose = $("mClose");
  const mCancel = $("mCancel");
  const mEdit = $("mEdit");
  const mBody = $("mBody");
  const mTitle = $("mTitle");

  // Charts
  const weekPick = $("weekPick");
  const zoomRange = $("zoomRange");
  const weekLabel = $("weekLabel");
  const zoomLabel = $("zoomLabel");
  const chart = $("chart");
  const chartWrap = $("chartWrap");
  const ctx = chart.getContext("2d");

  let records = loadRecords();
  let editId = null;
  let selectedSyms = new Set();

  // Chart state
  // Zoom levels represent window width in hours; A08: narrowest = 48 hours.
  const ZOOM_HOURS = [168, 120, 96, 72, 60, 48]; // 7d -> 48h
  zoomRange.value = "0";

  let weekStartMs = startOfWeek(Date.now());
  let weekEndMs = weekStartMs + 7*86400000;
  let viewHours = ZOOM_HOURS[0];
  let viewWidthMs = viewHours * 3600000;
  let panCenterMs = weekStartMs + (7*86400000)/2;

  // Touch pan
  let panActive = false;
  let panStartX = 0;
  let panStartCenter = 0;

  // Build symptom grid
  function renderSymGrid(){
    symGrid.innerHTML = "";
    SYMPTOMS.forEach(s => {
      const b = document.createElement("div");
      b.className = "sym" + (selectedSyms.has(s) ? " on" : "");
      b.textContent = s;
      b.onclick = () => {
        if(selectedSyms.has(s)) selectedSyms.delete(s);
        else selectedSyms.add(s);
        renderSymGrid();
      };
      symGrid.appendChild(b);
    });
  }

  // Navigation
  function setPage(active){
    [pageHome,pageAdd,pageLog,pageCharts].forEach(p => p.classList.remove("active"));
    active.classList.add("active");
  }
  function openHome(){
    setPage(pageHome);
    refreshTop();
  }
  function openAdd(id=null){
    setPage(pageAdd);
    editId = id;
    selectedSyms = new Set();
    btnDelete.style.display = id ? "block" : "none";
    addTitle.textContent = id ? "Edit Reading" : "Add Reading";

    if(id){
      const r = records.find(x => x.id === id);
      if(r){
        inpSys.value = r.sys ?? "";
        inpDia.value = r.dia ?? "";
        inpHr.value  = r.hr ?? "";
        inpNotes.value = r.notes ?? "";
        (r.symptoms || []).forEach(s => selectedSyms.add(s));
      }
    } else {
      inpSys.value = "";
      inpDia.value = "";
      inpHr.value  = "";
      inpNotes.value = "";
    }
    renderSymGrid();
  }
  function openLog(){
    setPage(pageLog);
    renderLog();
  }
  function openCharts(){
    setPage(pageCharts);
    // default to current week
    weekPick.value = toDateInputValue(Date.now());
    setWeekFromDate(Date.now());
    updateViewFromZoom();
    drawChart();
  }

  // Save/Delete
  btnSave.onclick = () => {
    const sys = numOrNull(inpSys.value);
    const dia = numOrNull(inpDia.value);
    const hr  = numOrNull(inpHr.value);

    if(sys === null || dia === null){
      alert("Please enter systolic and diastolic.");
      return;
    }

    const now = Date.now();
    const rec = {
      id: editId || cryptoId(),
      t: editId ? (records.find(x=>x.id===editId)?.t ?? now) : now,
      sys, dia,
      hr,
      symptoms: Array.from(selectedSyms),
      notes: (inpNotes.value || "").trim()
    };

    if(editId){
      const idx = records.findIndex(x => x.id === editId);
      if(idx >= 0) records[idx] = rec;
      else records.unshift(rec);
    } else {
      records.unshift(rec);
    }

    records.sort((a,b)=>b.t-a.t);
    saveRecords();
    openHome();
  };

  btnDelete.onclick = () => {
    if(!editId) return;
    const ok = confirm("Delete this entry?");
    if(!ok) return;
    records = records.filter(x => x.id !== editId);
    saveRecords();
    openHome();
  };

  // Log filters
  inpSearch.addEventListener("input", () => renderLog());
  inpFrom.addEventListener("change", () => renderLog());
  inpTo.addEventListener("change", () => renderLog());

  // Modal handlers
  mClose.onclick = closeModal;
  mCancel.onclick = closeModal;
  mask.addEventListener("click", (e) => { if(e.target === mask) closeModal(); });

  let pendingEditId = null;
  mEdit.onclick = () => {
    closeModal();
    if(pendingEditId) openAdd(pendingEditId);
  };

  function openModalForRecord(r){
    pendingEditId = r.id;
    mTitle.textContent = "Edit entry?";
    mBody.innerHTML =
      `<div class="dt">${fmtDT(r.t)}</div>
       <div class="bpLine" style="margin-top:8px">
         <div class="bpLabel">BP</div>
         <div class="bpBig">${r.sys}/${r.dia}</div>
         <div class="hr">${r.hr ? `HR ${r.hr}` : ""}</div>
       </div>
       <div class="meta" style="margin-top:10px">
         <b>Symptoms:</b> ${(r.symptoms && r.symptoms.length) ? esc(r.symptoms.join(", ")) : "None"}<br/>
         <b>Notes:</b> ${r.notes ? esc(r.notes) : "None"}
       </div>`;
    mask.classList.add("show");
  }
  function closeModal(){
    mask.classList.remove("show");
    pendingEditId = null;
  }

  // Press-highlight + release-to-edit
  function attachPressHandlers(el, r){
    let pressed = false;
    let startX=0, startY=0;
    const CANCEL_MOVE = 14;

    const onDown = (x,y) => {
      pressed = true;
      startX=x; startY=y;
      el.classList.add("press");
    };
    const onMove = (x,y) => {
      if(!pressed) return;
      const dx = Math.abs(x-startX), dy = Math.abs(y-startY);
      if(dx > CANCEL_MOVE || dy > CANCEL_MOVE){
        pressed = false;
        el.classList.remove("press");
      }
    };
    const onUp = () => {
      const wasPressed = pressed;
      pressed = false;
      el.classList.remove("press");
      if(wasPressed){
        openModalForRecord(r);
      }
    };

    el.addEventListener("pointerdown", (e) => {
      el.setPointerCapture(e.pointerId);
      onDown(e.clientX, e.clientY);
    });
    el.addEventListener("pointermove", (e) => onMove(e.clientX, e.clientY));
    el.addEventListener("pointerup", onUp);
    el.addEventListener("pointercancel", () => { pressed=false; el.classList.remove("press"); });
    el.addEventListener("lostpointercapture", () => { pressed=false; el.classList.remove("press"); });
  }

  function renderLog(){
    const q = (inpSearch.value || "").trim().toLowerCase();
    const from = inpFrom.value ? new Date(inpFrom.value + "T00:00:00").getTime() : null;
    const to = inpTo.value ? (new Date(inpTo.value + "T23:59:59").getTime()) : null;

    const filtered = records.filter(r => {
      if(from !== null && r.t < from) return false;
      if(to !== null && r.t > to) return false;
      if(q){
        const hay = [
          (r.notes || ""),
          (r.symptoms || []).join(" "),
          `${r.sys}/${r.dia}`,
          r.hr ? `hr ${r.hr}` : ""
        ].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });

    list.innerHTML = "";
    if(!filtered.length){
      const d = document.createElement("div");
      d.className = "hint";
      d.textContent = "No entries match your filters.";
      list.appendChild(d);
      return;
    }

    filtered.forEach(r => {
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div class="dt">${fmtDT(r.t)}</div>
          <div class="dt">${fmtDateOnly(r.t)}</div>
        </div>
        <div class="bpLine">
          <div class="bpLabel">BP</div>
          <div class="bpBig">${r.sys}/${r.dia}</div>
          <div class="hr">${r.hr ? `HR ${r.hr}` : ""}</div>
        </div>
        <div class="meta">
          <b>Symptoms:</b> ${(r.symptoms && r.symptoms.length) ? esc(r.symptoms.join(", ")) : "None"}<br/>
          <b>Notes:</b> ${r.notes ? esc(r.notes) : "None"}
        </div>
        ${ (r.symptoms && r.symptoms.length)
          ? `<div class="tags">${r.symptoms.map(s=>`<span class="tag">${esc(s)}</span>`).join("")}</div>`
          : "" }
      `;
      attachPressHandlers(item, r);
      list.appendChild(item);
    });
  }

  // Charts: week selection + zoom + pan (max zoom = 48h)
  weekPick.addEventListener("change", () => {
    const t = weekPick.value ? new Date(weekPick.value + "T12:00:00").getTime() : Date.now();
    setWeekFromDate(t);
    updateViewFromZoom(true);
    drawChart();
  });

  zoomRange.addEventListener("input", () => {
    updateViewFromZoom(true);
    drawChart();
  });

  function setWeekFromDate(tMs){
    weekStartMs = startOfWeek(tMs);
    weekEndMs = weekStartMs + 7*86400000;
    // reset pan to center of week
    panCenterMs = weekStartMs + (weekEndMs - weekStartMs)/2;
    weekLabel.textContent = `${fmtShort(weekStartMs)} – ${fmtShort(weekEndMs - 1)}`;
  }

  function updateViewFromZoom(resetPan=false){
    const idx = clamp(parseInt(zoomRange.value,10) || 0, 0, ZOOM_HOURS.length-1);
    viewHours = ZOOM_HOURS[idx];
    viewWidthMs = viewHours * 3600000;

    // A08 requirement: maximize zoom to 48 hours width
    // (enforced via ZOOM_HOURS array; idx max produces 48h)

    zoomLabel.textContent = `Window: ${viewHours}h`;
    if(resetPan){
      // keep center, but clamp to week
      panCenterMs = clamp(panCenterMs, weekStartMs + viewWidthMs/2, weekEndMs - viewWidthMs/2);
    }
  }

  function viewBounds(){
    const half = viewWidthMs/2;
    let left = panCenterMs - half;
    let right = panCenterMs + half;

    // clamp within week
    if(viewWidthMs >= (weekEndMs-weekStartMs)){
      left = weekStartMs;
      right = weekEndMs;
    } else {
      if(left < weekStartMs){ left = weekStartMs; right = left + viewWidthMs; }
      if(right > weekEndMs){ right = weekEndMs; left = right - viewWidthMs; }
    }
    return {left,right};
  }

  // Touch pan on chart (one finger)
  chartWrap.addEventListener("pointerdown", (e) => {
    if(e.pointerType === "mouse" && e.buttons !== 1) return;
    updateViewFromZoom(false);
    if(viewWidthMs >= (weekEndMs-weekStartMs)) return; // no pan at full week
    panActive = true;
    panStartX = e.clientX;
    panStartCenter = panCenterMs;
    chartWrap.setPointerCapture(e.pointerId);
  });

  chartWrap.addEventListener("pointermove", (e) => {
    if(!panActive) return;
    const dx = e.clientX - panStartX;
    // pixels-to-ms scale based on current view
    const rect = chart.getBoundingClientRect();
    const msPerPx = viewWidthMs / Math.max(1, rect.width);
    panCenterMs = panStartCenter - dx * msPerPx;
    panCenterMs = clamp(panCenterMs, weekStartMs + viewWidthMs/2, weekEndMs - viewWidthMs/2);
    drawChart();
  });

  chartWrap.addEventListener("pointerup", () => { panActive=false; });
  chartWrap.addEventListener("pointercancel", () => { panActive=false; });
  chartWrap.addEventListener("lostpointercapture", () => { panActive=false; });

  function drawChart(){
    const rect = chart.getBoundingClientRect();
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const w = Math.max(320, Math.floor(rect.width * dpr));
    const h = Math.max(240, Math.floor(260 * dpr));
    if(chart.width !== w || chart.height !== h){
      chart.width = w;
      chart.height = h;
    }

    const {left, right} = viewBounds();
    const weekMs = weekEndMs - weekStartMs;

    // background
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "rgba(0,0,0,.10)";
    ctx.fillRect(0,0,w,h);

    // alternating day bands (subtle)
    for(let d=0; d<7; d++){
      const d0 = weekStartMs + d*86400000;
      const d1 = d0 + 86400000;
      const x0 = xForTime(d0,left,right,w);
      const x1 = xForTime(d1,left,right,w);
      if(x1 <= 0 || x0 >= w) continue;
      ctx.fillStyle = (d % 2 === 0) ? "rgba(255,255,255,.03)" : "rgba(255,255,255,.01)";
      ctx.fillRect(Math.max(0,x0), 0, Math.min(w,x1)-Math.max(0,x0), h);
    }

    // plot area
    const padL = 52*dpr;
    const padR = 14*dpr;
    const padT = 12*dpr;
    const padB = 34*dpr;
    const plotW = w - padL - padR;
    const plotH = h - padT - padB;

    // frame
    ctx.strokeStyle = "rgba(235,245,255,.14)";
    ctx.lineWidth = 1*dpr;
    ctx.strokeRect(padL, padT, plotW, plotH);

    // week records filtered
    const weekRecs = records
      .filter(r => r.t >= weekStartMs && r.t < weekEndMs)
      .slice()
      .sort((a,b)=>a.t-b.t);

    if(!weekRecs.length){
      ctx.fillStyle = "rgba(235,245,255,.55)";
      ctx.font = `${14*dpr}px ${getFontStack()}`;
      ctx.fillText("No data in this week.", padL + 10*dpr, padT + 26*dpr);
      drawXAxisLabels(left,right,w,h,padL,padT,plotW,plotH,dpr);
      return;
    }

    // Determine ranges (BP)
    const sysVals = weekRecs.map(r => r.sys).filter(v => typeof v==="number");
    const diaVals = weekRecs.map(r => r.dia).filter(v => typeof v==="number");
    const all = sysVals.concat(diaVals);
    let minV = Math.min(...all);
    let maxV = Math.max(...all);
    // padding
    minV = Math.max(40, minV - 10);
    maxV = Math.min(240, maxV + 10);
    if(maxV - minV < 30){ maxV = minV + 30; }

    // gridlines + y labels
    ctx.font = `${12*dpr}px ${getFontStack()}`;
    ctx.fillStyle = "rgba(235,245,255,.55)";
    ctx.strokeStyle = "rgba(235,245,255,.10)";
    ctx.lineWidth = 1*dpr;

    const steps = 5;
    for(let i=0;i<=steps;i++){
      const v = minV + (maxV-minV)*(i/steps);
      const y = padT + plotH - (i/steps)*plotH;
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(padL+plotW, y);
      ctx.stroke();
      ctx.fillText(Math.round(v).toString(), 8*dpr, y + 4*dpr);
    }

    // lines
    const ptsSys = [];
    const ptsDia = [];

    weekRecs.forEach(r => {
      if(r.t < left || r.t > right) return;
      const x = padL + ( (r.t - left) / (right-left) ) * plotW;
      if(typeof r.sys==="number"){
        const y = padT + plotH - ((r.sys - minV)/(maxV-minV))*plotH;
        ptsSys.push([x,y,r]);
      }
      if(typeof r.dia==="number"){
        const y = padT + plotH - ((r.dia - minV)/(maxV-minV))*plotH;
        ptsDia.push([x,y,r]);
      }
    });

    // draw sys
    ctx.lineWidth = 2*dpr;
    ctx.strokeStyle = "rgba(120,180,255,.9)";
    drawLine(ptsSys);
    // draw dia
    ctx.strokeStyle = "rgba(120,255,190,.85)";
    drawLine(ptsDia);

    // points
    ctx.fillStyle = "rgba(120,180,255,.95)";
    ptsSys.forEach(p => {
      ctx.beginPath(); ctx.arc(p[0],p[1], 3*dpr, 0, Math.PI*2); ctx.fill();
    });
    ctx.fillStyle = "rgba(120,255,190,.9)";
    ptsDia.forEach(p => {
      ctx.beginPath(); ctx.arc(p[0],p[1], 3*dpr, 0, Math.PI*2); ctx.fill();
    });

    // title overlay
    ctx.fillStyle = "rgba(235,245,255,.70)";
    ctx.font = `${12*dpr}px ${getFontStack()}`;
    const windowTxt = `${viewHours}h view`;
    ctx.fillText(windowTxt, padL + 10*dpr, padT + 18*dpr);

    // x axis labels
    drawXAxisLabels(left,right,w,h,padL,padT,plotW,plotH,dpr);
  }

  function drawXAxisLabels(left,right,w,h,padL,padT,plotW,plotH,dpr){
    const padB = 34*dpr;
    const baseY = padT + plotH + 22*dpr;

    ctx.fillStyle = "rgba(235,245,255,.55)";
    ctx.font = `${12*dpr}px ${getFontStack()}`;
    ctx.strokeStyle = "rgba(235,245,255,.10)";
    ctx.lineWidth = 1*dpr;

    // tick interval based on view hours
    const hours = (right-left)/3600000;
    let tickH = 24;
    if(hours <= 48) tickH = 6;
    else if(hours <= 72) tickH = 12;
    else if(hours <= 120) tickH = 24;
    else tickH = 24;

    const firstTick = Math.ceil(left / (tickH*3600000)) * (tickH*3600000);
    for(let t=firstTick; t<=right; t += tickH*3600000){
      const x = padL + ((t-left)/(right-left))*plotW;
      ctx.beginPath();
      ctx.moveTo(x, padT + plotH);
      ctx.lineTo(x, padT + plotH + 6*dpr);
      ctx.stroke();
      const d = new Date(t);
      const label = (tickH < 24)
        ? `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,"0")}:00`
        : `${d.getMonth()+1}/${d.getDate()}`;
      ctx.fillText(label, x - 24*dpr, baseY);
    }
  }

  function drawLine(pts){
    if(pts.length < 2) return;
    ctx.beginPath();
    ctx.moveTo(pts[0][0], pts[0][1]);
    for(let i=1;i<pts.length;i++){
      ctx.lineTo(pts[i][0], pts[i][1]);
    }
    ctx.stroke();
  }

  function xForTime(t,left,right,w){
    if(t<=left) return 0;
    if(t>=right) return w;
    return ((t-left)/(right-left))*w;
  }

  function refreshTop(){
    todayPill.textContent = fmtToday();
    countPill.textContent = `${records.length} entr${records.length===1?"y":"ies"}`;
  }

  // Export/report
  function exportReport(){
    const lines = [];
    const now = new Date();
    lines.push("VITALS TRACKER REPORT");
    lines.push(`Generated: ${now.toLocaleString()}`);
    lines.push("Capture method: user-entered readings in an offline, local-only PWA (Vitals Tracker).");
    lines.push("Notes: Times are device-local. Data has not been modified by any server.");
    lines.push("------------------------------------------------------------");
    lines.push("");

    // newest first
    records.slice().sort((a,b)=>b.t-a.t).forEach(r => {
      lines.push(fmtDT(r.t));
      const hrTxt = r.hr ? ` • HR ${r.hr}` : "";
      lines.push(`BP ${r.sys}/${r.dia}${hrTxt}`);
      lines.push(`Symptoms: ${(r.symptoms && r.symptoms.length) ? r.symptoms.join(", ") : "None"}`);
      lines.push(`Notes: ${r.notes ? r.notes : "None"}`);
      lines.push("");
    });

    const text = lines.join("\n");
    // Prefer file download, fallback clipboard
    const blob = new Blob([text], {type:"text/plain"});
    const fname = `Vitals-Tracker-Report_${toFileStamp(Date.now())}.txt`;
    try{
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 300);
    } catch(e){
      navigator.clipboard?.writeText(text).then(() => {
        alert("Report copied to clipboard.");
      }).catch(() => {
        alert("Could not export. Your browser blocked it.");
      });
    }
  }

  // Clear data
  function clearData(){
    const ok = confirm("Clear ALL vitals data from this device?\n\nThis cannot be undone.");
    if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    records = [];
    refreshTop();
    alert("Data cleared.");
  }

  // Storage
  function loadRecords(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return [];
      return arr.filter(x => x && typeof x==="object" && typeof x.t==="number");
    } catch(e){
      return [];
    }
  }
  function saveRecords(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    refreshTop();
  }

  // Helpers
  function numOrNull(v){
    const n = parseInt(String(v).trim(), 10);
    return Number.isFinite(n) ? n : null;
  }
  function cryptoId(){
    // Simple, stable-enough local ID
    return "r_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function fmtDT(t){
    return new Date(t).toLocaleString();
  }
  function fmtDateOnly(t){
    return new Date(t).toLocaleDateString();
  }
  function fmtToday(){
    const d = new Date();
    return d.toLocaleDateString(undefined, {weekday:"short", month:"short", day:"numeric"}) + " • " + d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }
  function toDateInputValue(t){
    const d = new Date(t);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function toFileStamp(t){
    const d = new Date(t);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    return `${y}${m}${day}_${hh}${mm}${ss}`;
  }
  function esc(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function getFontStack(){ return 'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial'; }

  // Week starts Monday (00:00 local)
  function startOfWeek(t){
    const d = new Date(t);
    const day = d.getDay(); // 0 Sun ... 6 Sat
    const diffToMon = (day === 0) ? -6 : (1 - day);
    d.setHours(0,0,0,0);
    d.setDate(d.getDate() + diffToMon);
    return d.getTime();
  }
  function fmtShort(t){
    const d = new Date(t);
    return d.toLocaleDateString(undefined, {month:"short", day:"numeric"});
  }

  // Init
  refreshTop();

  // Default to Home
  openHome();

})();
</script>
</body>
</html>
