<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dicom deCoder - 3D Medical Imaging</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            overflow: hidden;
        }
        
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .glass-panel {
            background: rgba(20, 20, 25, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            outline: none;
        }
        
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .control-slider::-webkit-slider-thumb:hover {
            background: #60a5fa;
            transform: scale(1.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
        }
        
        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dicom-drop-zone {
            border: 2px dashed #374151;
            transition: all 0.3s ease;
        }
        
        .dicom-drop-zone.drag-over {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .viewport-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            background: #000;
        }
        
        .viewport {
            position: relative;
            background: #050505;
            overflow: hidden;
        }
        
        .viewport-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            z-index: 10;
        }
        
        .toolbar-btn {
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .toolbar-btn.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        .measurement-overlay {
            position: absolute;
            pointer-events: none;
            font-size: 11px;
            color: #fbbf24;
            font-weight: 600;
        }
        
        .crosshair {
            position: absolute;
            pointer-events: none;
        }
        
        .crosshair-h {
            width: 100%;
            height: 1px;
            background: rgba(251, 191, 36, 0.6);
            top: 50%;
            left: 0;
        }
        
        .crosshair-v {
            width: 1px;
            height: 100%;
            background: rgba(251, 191, 36, 0.6);
            left: 50%;
            top: 0;
        }
        
        #volume-canvas {
            width: 100%;
            height: 100%;
        }
        
        .preset-btn {
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .preset-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .preset-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #60a5fa;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Header -->
    <header class="h-14 glass-panel flex items-center justify-between px-6 z-50 relative">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                </svg>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight">Dicom deCoder</h1>
                <p class="text-xs text-gray-400 mono">v2.0.1 â€¢ 3D Volume Renderer</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <button onclick="document.getElementById('dicom-input').click()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                </svg>
                Open DICOM Directory
            </button>
            <input type="file" id="dicom-input" webkitdirectory directory multiple class="hidden" onchange="handleDicomSelect(event)">
            
            <button onclick="exportSnapshot()" class="px-4 py-2 rounded-lg text-sm font-medium border border-gray-600 hover:bg-gray-800 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Export
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left Sidebar - Tools -->
        <aside class="w-80 glass-panel border-r border-gray-800 flex flex-col overflow-y-auto">
            
            <!-- Windowing Controls -->
            <div class="p-6 border-b border-gray-800">
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Windowing</h3>
                
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-gray-300">Window Center</label>
                            <span id="wc-value" class="text-sm mono text-blue-400">40</span>
                        </div>
                        <input type="range" id="window-center" class="control-slider" min="-1000" max="3000" value="40" oninput="updateWindowing()">
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-gray-300">Window Width</label>
                            <span id="ww-value" class="text-sm mono text-blue-400">400</span>
                        </div>
                        <input type="range" id="window-width" class="control-slider" min="1" max="4000" value="400" oninput="updateWindowing()">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button onclick="applyPreset('soft')" class="preset-btn px-3 py-2 rounded text-xs font-medium bg-gray-800 text-gray-300">Soft Tissue</button>
                    <button onclick="applyPreset('bone')" class="preset-btn px-3 py-2 rounded text-xs font-medium bg-gray-800 text-gray-300">Bone</button>
                    <button onclick="applyPreset('lung')" class="preset-btn px-3 py-2 rounded text-xs font-medium bg-gray-800 text-gray-300">Lung</button>
                    <button onclick="applyPreset('brain')" class="preset-btn px-3 py-2 rounded text-xs font-medium bg-gray-800 text-gray-300">Brain</button>
                </div>
            </div>

            <!-- 3D Rendering Controls -->
            <div class="p-6 border-b border-gray-800">
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">3D Rendering</h3>
                
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-gray-300">Opacity</label>
                            <span id="opacity-value" class="text-sm mono text-blue-400">0.8</span>
                        </div>
                        <input type="range" id="opacity" class="control-slider" min="0" max="1" step="0.01" value="0.8" oninput="updateRendering()">
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-gray-300">Threshold Low</label>
                            <span id="thresh-low-value" class="text-sm mono text-blue-400">-1000</span>
                        </div>
                        <input type="range" id="threshold-low" class="control-slider" min="-1000" max="3000" value="-1000" oninput="updateRendering()">
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-gray-300">Threshold High</label>
                            <span id="thresh-high-value" class="text-sm mono text-blue-400">3000</span>
                        </div>
                        <input type="range" id="threshold-high" class="control-slider" min="-1000" max="3000" value="3000" oninput="updateRendering()">
                    </div>
                </div>

                <div class="mt-4 flex gap-2">
                    <button onclick="setRenderMode('volume')" id="mode-volume" class="flex-1 py-2 rounded text-xs font-medium bg-blue-600 text-white">Volume</button>
                    <button onclick="setRenderMode('surface')" id="mode-surface" class="flex-1 py-2 rounded text-xs font-medium bg-gray-800 text-gray-400 hover:bg-gray-700">Surface</button>
                </div>
            </div>

            <!-- View Controls -->
            <div class="p-6 border-b border-gray-800">
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">View</h3>
                
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="resetCamera()" class="toolbar-btn p-2 rounded-lg flex flex-col items-center gap-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span class="text-[10px]">Reset</span>
                    </button>
                    <button onclick="toggleCrosshairs()" id="btn-crosshair" class="toolbar-btn p-2 rounded-lg flex flex-col items-center gap-1 active">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span class="text-[10px]">Crosshair</span>
                    </button>
                    <button onclick="toggleRuler()" id="btn-ruler" class="toolbar-btn p-2 rounded-lg flex flex-col items-center gap-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <span class="text-[10px]">Measure</span>
                    </button>
                </div>

                <div class="mt-4 space-y-2">
                    <button onclick="viewOrientation('axial')" class="w-full py-2 px-3 rounded bg-gray-800 hover:bg-gray-700 text-sm text-left flex items-center justify-between">
                        <span>Axial View</span>
                        <span class="text-xs text-gray-500">Top</span>
                    </button>
                    <button onclick="viewOrientation('sagittal')" class="w-full py-2 px-3 rounded bg-gray-800 hover:bg-gray-700 text-sm text-left flex items-center justify-between">
                        <span>Sagittal View</span>
                        <span class="text-xs text-gray-500">Side</span>
                    </button>
                    <button onclick="viewOrientation('coronal')" class="w-full py-2 px-3 rounded bg-gray-800 hover:bg-gray-700 text-sm text-left flex items-center justify-between">
                        <span>Coronal View</span>
                        <span class="text-xs text-gray-500">Front</span>
                    </button>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="p-6 flex-1">
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Study Info</h3>
                <div id="study-info" class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-500">Patient:</span>
                        <span class="text-gray-300 mono" id="info-patient">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Study:</span>
                        <span class="text-gray-300 mono" id="info-study">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Series:</span>
                        <span class="text-gray-300 mono" id="info-series">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Dimensions:</span>
                        <span class="text-gray-300 mono" id="info-dims">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Voxel Size:</span>
                        <span class="text-gray-300 mono" id="info-voxel">-</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Viewport -->
        <main class="flex-1 relative bg-black">
            
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center hidden">
                <div class="loading-spinner mb-4"></div>
                <p class="text-blue-400 font-medium">Loading DICOM Series...</p>
                <p class="text-gray-500 text-sm mt-2 mono" id="loading-text">Parsing files...</p>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center z-40">
                <div class="w-24 h-24 mb-6 text-gray-700">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-light text-gray-400 mb-2">No DICOM Data Loaded</h2>
                <p class="text-gray-600 mb-8">Select a directory containing DICOM files to begin</p>
                <button onclick="document.getElementById('dicom-input').click()" class="px-6 py-3 rounded-lg border-2 border-dashed border-gray-700 text-gray-500 hover:border-blue-500 hover:text-blue-400 transition-colors">
                    Browse for DICOM Folder
                </button>
            </div>

            <!-- 3D Canvas Container -->
            <div id="canvas-container" class="absolute inset-0 hidden">
                <canvas id="volume-canvas"></canvas>
                
                <!-- Overlay Controls -->
                <div class="absolute bottom-6 right-6 flex gap-2">
                    <div class="glass-panel rounded-lg p-2 flex gap-2">
                        <button onclick="zoomIn()" class="p-2 hover:bg-white/10 rounded transition-colors" title="Zoom In">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                            </svg>
                        </button>
                        <button onclick="zoomOut()" class="p-2 hover:bg-white/10 rounded transition-colors" title="Zoom Out">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Orientation Labels -->
                <div class="absolute top-6 left-6 pointer-events-none">
                    <div class="flex items-center gap-2 text-xs text-gray-500 mono">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                        <span>X: Right</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-500 mono mt-1">
                        <span class="w-2 h-2 rounded-full bg-red-500"></span>
                        <span>Y: Anterior</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-500 mono mt-1">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        <span>Z: Superior</span>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let volumeMesh, volumeTexture;
        let dicomData = null;
        let windowCenter = 40;
        let windowWidth = 400;
        let renderMode = 'volume';
        let crosshairsVisible = true;
        let rulerMode = false;
        
        // Initialize Three.js scene
        function initScene() {
            const container = document.getElementById('canvas-container');
            const canvas = document.getElementById('volume-canvas');
            
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            
            // Camera
            const aspect = container.clientWidth / container.clientHeight;
            camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
            camera.position.set(0, 0, 3);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 1;
            controls.maxDistance = 10;
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Handle resize
            window.addEventListener('resize', onWindowResize);
            
            // Start render loop
            animate();
        }
        
        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            if (!container || container.classList.contains('hidden')) return;
            
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer && scene && camera) renderer.render(scene, camera);
        }
        
        // DICOM Handling
        async function handleDicomSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            // Filter DICOM files
            const dicomFiles = files.filter(f => 
                f.name.toLowerCase().endsWith('.dcm') || 
                f.name.toLowerCase().endsWith('.dicom') ||
                f.name.toLowerCase().includes('.dcm')
            );
            
            if (dicomFiles.length === 0) {
                alert('No DICOM files found in selected directory');
                return;
            }
            
            showLoading(true);
            updateLoadingText(`Found ${dicomFiles.length} DICOM files...`);
            
            // Simulate processing (in real app, use dicom-parser library)
            setTimeout(() => {
                processDicomFiles(dicomFiles);
            }, 1000);
        }
        
        function processDicomFiles(files) {
            updateLoadingText('Parsing DICOM metadata...');
            
            // Simulate creating a 3D volume
            // In real implementation, you would:
            // 1. Parse each DICOM file using dicom-parser
            // 2. Sort by slice position
            // 3. Extract pixel data
            // 4. Create 3D texture
            
            setTimeout(() => {
                createDemoVolume();
                showLoading(false);
                showViewer();
                updateStudyInfo(files);
            }, 1500);
        }
        
        function createDemoVolume() {
            // Create a demo 3D volume (sphere with noise)
            const size = 128;
            const data = new Uint8Array(size * size * size);
            
            for (let z = 0; z < size; z++) {
                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                        const idx = z * size * size + y * size + x;
                        const dx = x - size/2;
                        const dy = y - size/2;
                        const dz = z - size/2;
                        const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
                        
                        // Create a skull-like structure
                        let value = 0;
                        if (dist < size/3) {
                            value = 100 + Math.random() * 50; // Brain tissue
                        }
                        if (dist > size/3 - 2 && dist < size/3) {
                            value = 1000 + Math.random() * 200; // Bone
                        }
                        if (dist < size/6) {
                            value = 50 + Math.random() * 30; // Ventricles
                        }
                        
                        data[idx] = Math.min(255, value / 4);
                    }
                }
            }
            
            // Create 3D texture
            volumeTexture = new THREE.DataTexture3D(data, size, size, size);
            volumeTexture.format = THREE.RedFormat;
            volumeTexture.minFilter = THREE.LinearFilter;
            volumeTexture.magFilter = THREE.LinearFilter;
            volumeTexture.unpackAlignment = 1;
            
            // Create volume rendering material
            const vertexShader = `
                varying vec3 vWorldPosition;
                void main() {
                    vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;
            
            const fragmentShader = `
                precision highp float;
                precision highp sampler3D;
                
                uniform sampler3D map;
                uniform float thresholdLow;
                uniform float thresholdHigh;
                uniform float opacity;
                uniform float windowCenter;
                uniform float windowWidth;
                
                varying vec3 vWorldPosition;
                
                void main() {
                    vec3 pos = vWorldPosition * 0.5 + 0.5;
                    
                    if (pos.x < 0.0 || pos.x > 1.0 || pos.y < 0.0 || pos.y > 1.0 || pos.z < 0.0 || pos.z > 1.0) {
                        discard;
                    }
                    
                    float rawValue = texture(map, pos).r * 255.0;
                    
                    // Apply windowing
                    float minVal = windowCenter - windowWidth / 2.0;
                    float maxVal = windowCenter + windowWidth / 2.0;
                    float windowed = (rawValue - minVal) / (maxVal - minVal);
                    windowed = clamp(windowed, 0.0, 1.0);
                    
                    // Apply threshold
                    if (rawValue < thresholdLow || rawValue > thresholdHigh) {
                        discard;
                    }
                    
                    // Color mapping (simple grayscale to pseudo-color)
                    vec3 color = vec3(windowed);
                    
                    // Pseudo-color mapping for different tissues
                    if (rawValue > 800.0) {
                        color = vec3(0.9, 0.9, 0.8); // Bone - white/yellow
                    } else if (rawValue > 100.0) {
                        color = vec3(0.8, 0.6, 0.5); // Soft tissue - pink
                    } else {
                        color = vec3(0.2, 0.2, 0.3); // Fluid - dark blue
                    }
                    
                    gl_FragColor = vec4(color, windowed * opacity);
                }
            `;
            
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    map: { value: volumeTexture },
                    thresholdLow: { value: -1000.0 },
                    thresholdHigh: { value: 3000.0 },
                    opacity: { value: 0.8 },
                    windowCenter: { value: 40.0 },
                    windowWidth: { value: 400.0 }
                },
                vertexShader: vertexShader,
                fragmentShader: fragmentShader,
                transparent: true,
                side: THREE.DoubleSide
            });
            
            // Create box geometry for volume
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            volumeMesh = new THREE.Mesh(geometry, material);
            scene.add(volumeMesh);
            
            // Add wireframe box
            const edges = new THREE.EdgesGeometry(geometry);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x3b82f6, opacity: 0.3, transparent: true }));
            volumeMesh.add(line);
            
            // Add crosshairs
            createCrosshairs();
        }
        
        function createCrosshairs() {
            const crosshairGroup = new THREE.Group();
            
            // Axial crosshair
            const material = new THREE.LineBasicMaterial({ color: 0xfbbf24, opacity: 0.6, transparent: true });
            
            const hGeometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(-1.1, 0, 0),
                new THREE.Vector3(1.1, 0, 0)
            ]);
            const hLine = new THREE.Line(hGeometry, material);
            crosshairGroup.add(hLine);
            
            const vGeometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, -1.1, 0),
                new THREE.Vector3(0, 1.1, 0)
            ]);
            const vLine = new THREE.Line(vGeometry, material);
            crosshairGroup.add(vLine);
            
            crosshairGroup.name = 'crosshairs';
            crosshairGroup.visible = crosshairsVisible;
            scene.add(crosshairGroup);
        }
        
        // UI Controls
        function updateWindowing() {
            windowCenter = parseInt(document.getElementById('window-center').value);
            windowWidth = parseInt(document.getElementById('window-width').value);
            
            document.getElementById('wc-value').textContent = windowCenter;
            document.getElementById('ww-value').textContent = windowWidth;
            
            if (volumeMesh) {
                volumeMesh.material.uniforms.windowCenter.value = windowCenter;
                volumeMesh.material.uniforms.windowWidth.value = windowWidth;
            }
        }
        
        function updateRendering() {
            const opacity = parseFloat(document.getElementById('opacity').value);
            const threshLow = parseFloat(document.getElementById('threshold-low').value);
            const threshHigh = parseFloat(document.getElementById('threshold-high').value);
            
            document.getElementById('opacity-value').textContent = opacity.toFixed(2);
            document.getElementById('thresh-low-value').textContent = threshLow;
            document.getElementById('thresh-high-value').textContent = threshHigh;
            
            if (volumeMesh) {
                volumeMesh.material.uniforms.opacity.value = opacity;
                volumeMesh.material.uniforms.thresholdLow.value = threshLow;
                volumeMesh.material.uniforms.thresholdHigh.value = threshHigh;
            }
        }
        
        function applyPreset(type) {
            // Update active button
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const presets = {
                'soft': { wc: 40, ww: 400 },
                'bone': { wc: 500, ww: 3000 },
                'lung': { wc: -600, ww: 1500 },
                'brain': { wc: 30, ww: 80 }
            };
            
            const preset = presets[type];
            if (preset) {
                document.getElementById('window-center').value = preset.wc;
                document.getElementById('window-width').value = preset.ww;
                updateWindowing();
            }
        }
        
        function setRenderMode(mode) {
            renderMode = mode;
            document.getElementById('mode-volume').className = mode === 'volume' ? 
                'flex-1 py-2 rounded text-xs font-medium bg-blue-600 text-white' : 
                'flex-1 py-2 rounded text-xs font-medium bg-gray-800 text-gray-400 hover:bg-gray-700';
            document.getElementById('mode-surface').className = mode === 'surface' ? 
                'flex-1 py-2 rounded text-xs font-medium bg-blue-600 text-white' : 
                'flex-1 py-2 rounded text-xs font-medium bg-gray-800 text-gray-400 hover:bg-gray-700';
        }
        
        function resetCamera() {
            if (camera && controls) {
                camera.position.set(0, 0, 3);
                controls.reset();
            }
        }
        
        function viewOrientation(orientation) {
            if (!camera) return;
            
            switch(orientation) {
                case 'axial':
                    camera.position.set(0, 0, 3);
                    break;
                case 'sagittal':
                    camera.position.set(3, 0, 0);
                    break;
                case 'coronal':
                    camera.position.set(0, 3, 0);
                    break;
            }
            camera.lookAt(0, 0, 0);
            controls.update();
        }
        
        function toggleCrosshairs() {
            crosshairsVisible = !crosshairsVisible;
            document.getElementById('btn-crosshair').classList.toggle('active');
            
            const crosshairs = scene.getObjectByName('crosshairs');
            if (crosshairs) crosshairs.visible = crosshairsVisible;
        }
        
        function toggleRuler() {
            rulerMode = !rulerMode;
            document.getElementById('btn-ruler').classList.toggle('active');
        }
        
        function zoomIn() {
            if (camera) camera.position.multiplyScalar(0.9);
        }
        
        function zoomOut() {
            if (camera) camera.position.multiplyScalar(1.1);
        }
        
        function exportSnapshot() {
            if (!renderer) return;
            
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL('image/png');
            
            const link = document.createElement('a');
            link.download = `dicom-decoder-snapshot-${Date.now()}.png`;
            link.href = dataURL;
            link.click();
        }
        
        // UI Helpers
        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }
        
        function updateLoadingText(text) {
            document.getElementById('loading-text').textContent = text;
        }
        
        function showViewer() {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('canvas-container').classList.remove('hidden');
            
            if (!scene) initScene();
        }
        
        function updateStudyInfo(files) {
            // Simulate DICOM metadata
            document.getElementById('info-patient').textContent = 'DOE^JOHN';
            document.getElementById('info-study').textContent = 'HEAD^BRAIN';
            document.getElementById('info-series').textContent = 'T1W_SE_AX';
            document.getElementById('info-dims').textContent = '512 x 512 x ' + files.length;
            document.getElementById('info-voxel').textContent = '0.5 x 0.5 x 1.0 mm';
        }
        
        // Drag and drop support
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.body;
            
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('drag-over');
            });
            
            container.addEventListener('dragleave', () => {
                container.classList.remove('drag-over');
            });
            
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                container.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    handleDicomSelect({ target: { files: e.dataTransfer.files } });
                }
            });
        });
    </script>
</body>
</html>
