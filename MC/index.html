<!--
Master Code — BOF Version Detail Notes
App Version: v1.1A3
Base: v1.1A2
Changes (requested):
- Each swipe panel now embeds and runs its associated app INSIDE the panel (iframe).
- Removed “Open …” buttons from app panels (the app itself is the panel).
- Added edge-swipe gutters over embedded apps so left/right panel swipes still work.
- Help feature remains removed.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Master Code v1.1A3</title>

  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;
      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --text:rgba(235,245,255,.86);
      --muted:rgba(235,245,255,.58);
      --muted2:rgba(235,245,255,.42);
      --accentBorder: rgba(43,78,122,.85);
      --shadow:0 14px 40px rgba(0,0,0,.38);
      --radius:26px;
      --btnH:56px;
      --pad:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 0%, rgba(47,120,255,.22), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(155,120,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex;
      justify-content:center;
      padding: max(14px, env(safe-area-inset-top)) 12px max(14px, env(safe-area-inset-bottom));
      overflow:hidden;
    }

    .app{
      width:min(520px, 100%);
      height: 100%;
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:hidden;
    }

    .logoTitle{
      margin:4px 6px 0;
      display:flex;
      justify-content:center;
      align-items:center;
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .logoTitle svg{
      width:min(520px, 100%);
      height:auto;
      display:block;
    }

    .logoVer{
      margin: -4px 0 2px;
      text-align:center;
      font-size: 12px;
      font-weight: 850;
      letter-spacing: .2px;
      color: rgba(235,245,255,.38);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .screenArea{
      position:relative;
      flex:1;
      overflow:hidden;
      border-radius: var(--radius);
      touch-action: pan-y;
    }

    .ptr{
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 60;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(235,245,255,.16);
      background: rgba(12,21,40,.86);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 34px rgba(0,0,0,.36);
      color: rgba(235,245,255,.84);
      font-weight: 850;
      font-size: 13px;
      letter-spacing: .2px;
      display:none;
      align-items:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: none;
    }
    .ptr.show{ display:flex; }
    .ptrDot{
      width:10px; height:10px;
      border-radius: 50%;
      background: rgba(47,120,255,.88);
      box-shadow: 0 0 0 4px rgba(47,120,255,.18);
      opacity:.95;
    }
    .ptrHint{ opacity:.90; }
    .ptrSmall{ opacity:.60; font-weight:800; }

    .deck{
      position:absolute;
      inset:0;
      display:flex;
      height:100%;
      transform: translate3d(0,0,0);
      will-change: transform;
    }
    .deck.anim{ transition: transform 260ms cubic-bezier(.2,.9,.2,1); }

    .card{
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:3px solid var(--accentBorder);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0;
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .cardScroll{
      height:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: var(--pad);
      overscroll-behavior: contain;
      touch-action: pan-y;
    }

    .h1{
      font-weight: 950;
      letter-spacing: .2px;
      color: rgba(235,245,255,.92);
      font-size: clamp(28px, 8.0vw, 44px);
      line-height: 1.02;
      margin: 6px 2px 10px;
    }

    .sub{
      color: rgba(235,245,255,.70);
      font-size: 15px;
      line-height: 1.28;
      margin: 0 2px 14px;
    }

    .sectionLabel{
      font-size:15px;
      color:var(--muted);
      font-weight:800;
      margin: 12px 4px 10px;
      letter-spacing:.2px;
    }

    .btn{
      height:var(--btnH);
      width:100%;
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color:rgba(235,245,255,.78);
      font-weight:850;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 18px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-size:20px;
      touch-action: manipulation;
      white-space:nowrap;
      max-width: 100%;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(47,120,255,.92), rgba(47,120,255,.72));
      border-color: rgba(120,170,255,.55);
      color: rgba(235,245,255,.90);
    }

    .btn.tight{
      height: 52px;
      font-size: 18px;
      font-weight: 900;
    }

    .btn:disabled{
      opacity:.55;
      filter:saturate(.85);
      transform:none !important;
      pointer-events:none;
    }

    .stack{
      display:flex;
      flex-direction:column;
      gap:12px;
      width:100%;
    }

    .hintLine{
      margin-top: 12px;
      font-size: 13px;
      color: rgba(235,245,255,.44);
      line-height: 1.25;
    }

    .footerTiny{
      margin-top: 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: rgba(235,245,255,.38);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: max(6px, env(safe-area-inset-bottom));
    }

    /* Embedded app panel */
    .embedWrap{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    .embedTop{
      flex: 0 0 auto;
      padding: 14px 16px 10px;
      border-bottom: 1px solid rgba(235,245,255,.10);
      background: linear-gradient(180deg, rgba(12,21,40,.70), rgba(12,21,40,.22));
      backdrop-filter: blur(10px);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .embedTitle{
      margin:0;
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 22px;
      color: rgba(235,245,255,.92);
      line-height: 1.05;
    }
    .embedSub{
      margin: 6px 0 0;
      font-size: 12px;
      color: rgba(235,245,255,.44);
      line-height: 1.25;
    }

    .embedBody{
      position:relative;
      flex: 1 1 auto;
      min-height: 0;
      background: rgba(0,0,0,.10);
    }

    .embedFrame{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
      background: transparent;
    }

    /* Edge swipe gutters (capture left/right swipes even when iframe is present) */
    .edge{
      position:absolute;
      top:0;
      bottom:0;
      width: 22px;
      z-index: 80;
      background: transparent;
      touch-action: none; /* allow us to capture horizontal gestures */
    }
    .edge.left{ left:0; }
    .edge.right{ right:0; }

    .modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: max(16px, env(safe-area-inset-top)) 14px max(16px, env(safe-area-inset-bottom));
      background: rgba(0,0,0,.56);
      z-index: 9998;
      touch-action: none;
    }
    .modal.hidden{ display:none; }
    .modalCard{
      width:min(520px, 100%);
      border-radius: 26px;
      border: 3px solid var(--accentBorder);
      background: linear-gradient(180deg, rgba(12,21,40,.96), rgba(8,16,31,.96));
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 16px;
      backdrop-filter: blur(10px);
      max-height: calc(100vh - 60px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalTitle{
      font-weight: 950;
      letter-spacing: .2px;
      color: rgba(235,245,255,.92);
      font-size: clamp(22px, 6.5vw, 34px);
      line-height: 1.05;
      margin: 4px 2px 10px;
    }
    .modalSub{
      color: rgba(235,245,255,.76);
      font-size: 15px;
      margin: 0 2px 12px;
      white-space: pre-wrap;
      line-height: 1.28;
    }
    .modalBtns{
      display:flex;
      gap:12px;
      margin-top: 10px;
      flex-wrap:wrap;
    }
    .modalBtns .btn{
      flex:1;
      height: 54px;
      font-size: 18px;
      font-weight: 900;
      min-width: 140px;
    }
    .xCloseRow{
      display:flex;
      justify-content:flex-end;
      margin: -6px -6px 6px;
    }
    .xBtn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color: rgba(235,245,255,.82);
      font-weight: 900;
      font-size: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <div class="logoTitle" aria-label="Master Code">
      <svg viewBox="0 0 900 140" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Master Code">
        <defs>
          <linearGradient id="mcG" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%" stop-color="#8a6bff"/>
            <stop offset="55%" stop-color="#4fa3ff"/>
            <stop offset="100%" stop-color="#2f78ff"/>
          </linearGradient>
          <filter id="mcS" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="rgba(0,0,0,.35)"/>
          </filter>
        </defs>

        <g transform="translate(46 24)" filter="url(#mcS)">
          <rect x="0" y="0" width="92" height="92" rx="26" fill="rgba(255,255,255,.06)" stroke="rgba(235,245,255,.22)" stroke-width="2"/>
          <path d="M30 62 h32" stroke="url(#mcG)" stroke-width="8" stroke-linecap="round"/>
          <path d="M30 46 h32" stroke="url(#mcG)" stroke-width="8" stroke-linecap="round" opacity=".9"/>
          <path d="M30 30 h32" stroke="url(#mcG)" stroke-width="8" stroke-linecap="round" opacity=".8"/>
          <path d="M38 26 v44" stroke="rgba(235,245,255,.78)" stroke-width="6" stroke-linecap="round" opacity=".55"/>
          <path d="M54 26 v44" stroke="rgba(235,245,255,.78)" stroke-width="6" stroke-linecap="round" opacity=".55"/>
        </g>

        <text x="160" y="92"
          font-family="system-ui,Segoe UI,Roboto,Helvetica,Arial"
          font-size="66"
          font-weight="860"
          fill="url(#mcG)"
          letter-spacing=".6"
          filter="url(#mcS)">Master Code</text>
      </svg>
    </div>

    <div class="logoVer" id="logoVer">v—</div>

    <div class="screenArea" id="screenArea">
      <div class="ptr" id="ptr">
        <div class="ptrDot"></div>
        <div class="ptrHint" id="ptrHint">Pull to refresh</div>
        <div class="ptrSmall" id="ptrSmall"></div>
      </div>

      <div class="deck" id="deck">

        <!-- Panel 0: Launch Pad -->
        <div class="card" id="panelLaunch">
          <div class="cardScroll" id="launchScroll">
            <div class="h1">Launch Pad</div>
            <div class="sub">Tap an app to open it. Swipe left/right to switch panels. Pull down to refresh.</div>

            <div class="sectionLabel">Apps</div>
            <div class="stack">
              <button class="btn primary" id="btnVitals">Vitals Tracker</button>
              <button class="btn" id="btnAngel">Angel Code (AN)</button>
              <button class="btn" id="btnBirthday">Birthday Code (BC)</button>
              <button class="btn" id="btnGlucose">Glucose Tracker (DB)</button>
              <button class="btn primary" id="btnCompat">Compatibility Code (CC)</button>
            </div>

            <div class="sectionLabel" style="margin-top:16px;">Actions</div>
            <div class="stack">
              <button class="btn tight" id="btnInstall">Install</button>
            </div>

            <div class="hintLine">Swipe left to view each embedded app panel in order.</div>

            <div class="footerTiny">
              <div id="footerVer">v—</div>
              <div>developed by Keyth Jyles</div>
            </div>
          </div>
        </div>

        <!-- Panel 1: Vitals (embedded) -->
        <div class="card" id="panelVitals">
          <div class="embedWrap">
            <div class="embedTop">
              <div class="embedTitle">Vitals Tracker</div>
              <div class="embedSub">Embedded view. Swipe on the left/right edge to switch panels.</div>
            </div>
            <div class="embedBody">
              <iframe class="embedFrame" id="frameVitals" title="Vitals Tracker"
                loading="lazy"
                allow="clipboard-read; clipboard-write"></iframe>
              <div class="edge left" data-edge="1"></div>
              <div class="edge right" data-edge="1"></div>
            </div>
          </div>
        </div>

        <!-- Panel 2: Angel (embedded) -->
        <div class="card" id="panelAngel">
          <div class="embedWrap">
            <div class="embedTop">
              <div class="embedTitle">Angel Code (AN)</div>
              <div class="embedSub">Embedded view. Swipe on the left/right edge to switch panels.</div>
            </div>
            <div class="embedBody">
              <iframe class="embedFrame" id="frameAngel" title="Angel Code"
                loading="lazy"
                allow="clipboard-read; clipboard-write"></iframe>
              <div class="edge left" data-edge="1"></div>
              <div class="edge right" data-edge="1"></div>
            </div>
          </div>
        </div>

        <!-- Panel 3: Birthday (embedded) -->
        <div class="card" id="panelBirthday">
          <div class="embedWrap">
            <div class="embedTop">
              <div class="embedTitle">Birthday Code (BC)</div>
              <div class="embedSub">Embedded view. Swipe on the left/right edge to switch panels.</div>
            </div>
            <div class="embedBody">
              <iframe class="embedFrame" id="frameBirthday" title="Birthday Code"
                loading="lazy"
                allow="clipboard-read; clipboard-write"></iframe>
              <div class="edge left" data-edge="1"></div>
              <div class="edge right" data-edge="1"></div>
            </div>
          </div>
        </div>

        <!-- Panel 4: Glucose (embedded) -->
        <div class="card" id="panelGlucose">
          <div class="embedWrap">
            <div class="embedTop">
              <div class="embedTitle">Glucose Tracker (DB)</div>
              <div class="embedSub">Embedded view. Swipe on the left/right edge to switch panels.</div>
            </div>
            <div class="embedBody">
              <iframe class="embedFrame" id="frameGlucose" title="Glucose Tracker"
                loading="lazy"
                allow="clipboard-read; clipboard-write"></iframe>
              <div class="edge left" data-edge="1"></div>
              <div class="edge right" data-edge="1"></div>
            </div>
          </div>
        </div>

        <!-- Panel 5: Compatibility (embedded) -->
        <div class="card" id="panelCompat">
          <div class="embedWrap">
            <div class="embedTop">
              <div class="embedTitle">Compatibility Code (CC)</div>
              <div class="embedSub">Embedded view. Swipe on the left/right edge to switch panels.</div>
            </div>
            <div class="embedBody">
              <iframe class="embedFrame" id="frameCompat" title="Compatibility Code"
                loading="lazy"
                allow="clipboard-read; clipboard-write"></iframe>
              <div class="edge left" data-edge="1"></div>
              <div class="edge right" data-edge="1"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="infoModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <div class="modalCard">
      <div class="xCloseRow">
        <button class="xBtn" id="btnInfoX" aria-label="Close">×</button>
      </div>
      <div class="modalTitle" id="infoTitle">Info</div>
      <div class="modalSub" id="infoSub">—</div>
      <div class="modalBtns">
        <button id="btnInfoOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <script>
(() => {
  "use strict";

  const APP_VERSION = "v1.1A3";
  const $ = (id) => document.getElementById(id);

  function openInfo(title, msg){
    $("infoTitle").textContent = title || "Info";
    $("infoSub").textContent = msg || "—";
    $("infoModal").classList.remove("hidden");
    try{ document.activeElement?.blur(); }catch{}
  }
  function closeInfo(){ $("infoModal").classList.add("hidden"); }
  $("btnInfoX").addEventListener("click", (e)=>{ e.preventDefault(); closeInfo(); });
  $("btnInfoOk").addEventListener("click", (e)=>{ e.preventDefault(); closeInfo(); });
  $("infoModal").addEventListener("click", (e)=>{ if(e.target === $("infoModal")) closeInfo(); });

  function isStandalone(){
    try{
      if(window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) return true;
      if(window.navigator && "standalone" in window.navigator && window.navigator.standalone) return true;
    }catch{}
    return false;
  }

  let deferredInstallPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;
    updateInstallButton();
  });

  window.addEventListener("appinstalled", () => {
    deferredInstallPrompt = null;
    updateInstallButton(true);
  });

  async function tryInstall(){
    if(!deferredInstallPrompt){
      openInfo("Install", "Install is only available when your browser offers it.\n\nTip: In Chrome, use menu ⋮ → Install app (if shown).");
      return;
    }
    try{
      deferredInstallPrompt.prompt();
      await deferredInstallPrompt.userChoice;
    }catch{}
    deferredInstallPrompt = null;
    updateInstallButton();
  }

  function uninstallGuidance(){
    const msg =
      "To uninstall the app:\n\n" +
      "Android:\n" +
      "• Long-press the app icon → Uninstall\n" +
      "or\n" +
      "• Settings → Apps → Master Code → Uninstall\n\n" +
      "iPhone/iPad:\n" +
      "• Long-press the app icon → Remove App\n\n" +
      "If you installed from Chrome, removing the app icon uninstalls the PWA.";
    openInfo("Uninstall", msg);
  }

  function updateInstallButton(installedMaybe=false){
    const btn = $("btnInstall");
    if(!btn) return;

    const standaloneNow = installedMaybe || isStandalone();
    if(standaloneNow){
      btn.dataset.mode = "uninstall";
      btn.disabled = false;
      btn.textContent = "Uninstall";
      return;
    }
    btn.dataset.mode = "install";
    btn.textContent = "Install";
    btn.disabled = !deferredInstallPrompt;
  }

  // ---- URL resolution (robust for subfolder hosting) ----
  // Use URL(relative, location.href).href so the paths resolve correctly no matter where Master Code is hosted.
  function abs(rel){
    try{ return new URL(rel, location.href).href; }catch{ return rel; }
  }

  // IMPORTANT:
  // Adjust these paths ONLY if your repo structure differs.
  // These are the same paths you were already using for navigation.
  const URLS = {
    vitals: abs("../index.html"),
    angel: abs("../AN/"),
    birthday: abs("../BC/"),
    glucose: abs("../DB/"),
    compat: abs("../CC/")
  };

  // Embed apps into panels (index runs inside the panel)
  function setFrameSrc(id, src){
    const f = $(id);
    if(!f) return;
    try{
      if(f.getAttribute("src")) return; // do not reload once set
      f.setAttribute("src", src);
    }catch{}
  }

  // Load launch pad buttons -> snap to panel and ensure iframe is loaded
  function gotoPanel(idx){
    snapToIndex(idx, true);
    if(idx === 1) setFrameSrc("frameVitals", URLS.vitals);
    if(idx === 2) setFrameSrc("frameAngel", URLS.angel);
    if(idx === 3) setFrameSrc("frameBirthday", URLS.birthday);
    if(idx === 4) setFrameSrc("frameGlucose", URLS.glucose);
    if(idx === 5) setFrameSrc("frameCompat", URLS.compat);
  }

  $("btnVitals").addEventListener("click", ()=> gotoPanel(1));
  $("btnAngel").addEventListener("click", ()=> gotoPanel(2));
  $("btnBirthday").addEventListener("click", ()=> gotoPanel(3));
  $("btnGlucose").addEventListener("click", ()=> gotoPanel(4));
  $("btnCompat").addEventListener("click", ()=> gotoPanel(5));

  function injectManifest(){
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#8a6bff"/>
      <stop offset="55%" stop-color="#2f78ff"/>
      <stop offset="100%" stop-color="#0b1324"/>
    </linearGradient>
  </defs>
  <rect width="512" height="512" rx="110" fill="url(#g)"/>
  <path d="M168 304 h176" stroke="rgba(235,245,255,.92)" stroke-width="28" stroke-linecap="round"/>
  <path d="M168 240 h176" stroke="rgba(235,245,255,.82)" stroke-width="24" stroke-linecap="round"/>
  <path d="M168 176 h176" stroke="rgba(235,245,255,.72)" stroke-width="20" stroke-linecap="round"/>
</svg>`;
    const encoded = encodeURIComponent(svg).replace(/'/g,"%27").replace(/"/g,"%22");
    const icon = `data:image/svg+xml;charset=utf-8,${encoded}`;

    const manifest = {
      name: "Master Code",
      short_name: "MasterCode",
      start_url: ".",
      display: "standalone",
      background_color: "#0b1324",
      theme_color: "#0b1324",
      icons: [{ src: icon, sizes: "512x512", type: "image/svg+xml", purpose: "any" }]
    };

    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);

    let link = document.getElementById("manifestLink");
    if(!link){
      link = document.createElement("link");
      link.rel = "manifest";
      link.id = "manifestLink";
      document.head.appendChild(link);
    }
    link.setAttribute("href", url);
  }

  async function registerSW(){
    if(!("serviceWorker" in navigator)) return;
    const swCode =
`self.addEventListener('install', (e)=>{ self.skipWaiting(); });
self.addEventListener('activate', (e)=>{ e.waitUntil(self.clients.claim()); });
self.addEventListener('fetch', (e)=>{ });`;
    const blob = new Blob([swCode], {type:"text/javascript"});
    const swUrl = URL.createObjectURL(blob);
    try { await navigator.serviceWorker.register(swUrl); } catch {}
  }

  // ---- Deck swipe (horizontal) ----
  const deck = $("deck");
  const screenArea = $("screenArea");

  const panelCount = 6;
  let deckIndex = 0;

  function getWidth(){
    return screenArea.clientWidth || window.innerWidth;
  }

  function setDeckX(px, animate=false){
    if(animate) deck.classList.add("anim");
    else deck.classList.remove("anim");
    deck.style.transform = `translate3d(${px}px,0,0)`;
  }

  function deckTargetXForIndex(idx){
    const w = getWidth();
    return -idx * w;
  }

  function snapToIndex(idx, animate=true){
    idx = Math.max(0, Math.min(panelCount-1, idx));
    deckIndex = idx;
    setDeckX(deckTargetXForIndex(deckIndex), animate);

    // lazy-load embedded apps the first time we land on their panel
    if(deckIndex === 1) setFrameSrc("frameVitals", URLS.vitals);
    if(deckIndex === 2) setFrameSrc("frameAngel", URLS.angel);
    if(deckIndex === 3) setFrameSrc("frameBirthday", URLS.birthday);
    if(deckIndex === 4) setFrameSrc("frameGlucose", URLS.glucose);
    if(deckIndex === 5) setFrameSrc("frameCompat", URLS.compat);

    try{ document.activeElement?.blur(); }catch{}
  }

  function swipeBlockedByModal(){
    return !$("infoModal").classList.contains("hidden");
  }

  // Only start horizontal swipe if touch begins on:
  // - Launch Pad area (non-button)
  // - OR on the edge gutters over embedded panels
  function isSwipeStartAllowed(target){
    if(!target) return false;
    if(target.closest && target.closest(".edge")) return true;
    // Launch pad: allow swipe unless starting on a button/input
    if(deckIndex === 0){
      if(target.closest && target.closest("button, input, textarea, select, a")) return false;
      return true;
    }
    // Embedded panels: require edge gutters (iframe otherwise captures)
    return false;
  }

  let dragging=false, intent=null;
  let x0=0, y0=0, baseX=0, lastX=0, lastT=0, vx=0;

  function onTouchStart(ev){
    if(swipeBlockedByModal()) return;
    if(!(ev.touches && ev.touches.length === 1)) return;
    const target = ev.target;
    if(!isSwipeStartAllowed(target)) return;

    dragging = true;
    intent = null;

    x0 = ev.touches[0].clientX;
    y0 = ev.touches[0].clientY;

    baseX = deckTargetXForIndex(deckIndex);
    setDeckX(baseX, false);

    lastX = x0;
    lastT = performance.now();
    vx = 0;
  }

  function onTouchMove(ev){
    if(!dragging) return;
    if(!(ev.touches && ev.touches.length === 1)) return;

    const x = ev.touches[0].clientX;
    const y = ev.touches[0].clientY;
    const dx = x - x0;
    const dy = y - y0;

    if(!intent){
      const ax = Math.abs(dx);
      const ay = Math.abs(dy);
      if(ax > 14 && ax > ay + 10){
        intent = "h";
      }else if(ay > 14 && ay > ax + 8){
        dragging = false;
        intent = null;
        return;
      }else{
        return;
      }
    }

    if(intent !== "h") return;
    ev.preventDefault();

    const w = getWidth();
    let nextX = baseX + dx;

    const minX = -(panelCount-1)*w;
    const maxX = 0;

    if(nextX > maxX){
      const over = nextX - maxX;
      nextX = maxX + over * 0.22;
    }else if(nextX < minX){
      const over = nextX - minX;
      nextX = minX + over * 0.22;
    }

    const now = performance.now();
    const dt = Math.max(1, now - lastT);
    const instV = (x - lastX) / dt;
    vx = vx * 0.75 + instV * 0.25;
    lastX = x;
    lastT = now;

    setDeckX(nextX, false);
  }

  function onTouchEnd(){
    if(!dragging) return;
    dragging = false;

    const w = getWidth();
    const matrix = deck.style.transform || "";
    const m = /translate3d\(([-\d.]+)px/.exec(matrix);
    const curX = m ? Number(m[1]) : deckTargetXForIndex(deckIndex);

    const progress = (-curX) / w;
    const nearest = Math.round(progress);

    const fling = vx;
    const FLING_V = 0.65;

    let target = nearest;
    if(Math.abs(fling) > FLING_V){
      if(fling < 0) target = Math.ceil(progress);
      else target = Math.floor(progress);
    }

    snapToIndex(target, true);
  }

  screenArea.addEventListener("touchstart", onTouchStart, {passive:true});
  screenArea.addEventListener("touchmove", onTouchMove, {passive:false});
  screenArea.addEventListener("touchend", onTouchEnd, {passive:true});
  screenArea.addEventListener("touchcancel", onTouchEnd, {passive:true});

  // ---- Pull-to-refresh (Launch Pad only, and only when at top) ----
  const PTR_THRESHOLD = 225;
  const PTR_MAX = Math.max(260, PTR_THRESHOLD + 35);

  let ptrActive=false, ptrTriggered=false, ptrStartY=0, ptrStartX=0;

  function ptrSet(show, hint, small){
    const el = $("ptr");
    if(show) el.classList.add("show");
    else el.classList.remove("show");
    $("ptrHint").textContent = hint || "Pull to refresh";
    $("ptrSmall").textContent = small || "";
  }

  function canPtrStart(target){
    if(swipeBlockedByModal()) return false;
    if(deckIndex !== 0) return false; // refresh only on Launch Pad
    if(target && target.closest && target.closest("button, input, textarea, select, a")) return false;
    const sc = $("launchScroll");
    if(!sc) return false;
    return sc.scrollTop <= 0;
  }

  screenArea.addEventListener("touchstart", (e)=>{
    if(!(e.touches && e.touches.length === 1)) return;
    const target = e.target;
    if(!canPtrStart(target)) return;

    ptrActive = true;
    ptrTriggered = false;
    ptrStartY = e.touches[0].clientY;
    ptrStartX = e.touches[0].clientX;
    ptrSet(true, "Pull to refresh", "");
  }, {passive:true});

  screenArea.addEventListener("touchmove", (e)=>{
    if(!ptrActive) return;
    if(!(e.touches && e.touches.length === 1)) return;

    const x = e.touches[0].clientX;
    const y = e.touches[0].clientY;
    const dy = y - ptrStartY;
    const dx = x - ptrStartX;

    // cancel if user begins a horizontal swipe
    if(Math.abs(dx) > 14 && Math.abs(dx) > Math.abs(dy) + 10){
      ptrActive = false;
      ptrTriggered = false;
      ptrSet(false);
      return;
    }

    if(dy <= 0){
      ptrSet(false);
      ptrTriggered = false;
      return;
    }

    e.preventDefault();

    const pull = Math.min(PTR_MAX, dy);
    const pct = Math.max(0, Math.min(100, Math.round((pull / PTR_THRESHOLD) * 100)));

    if(pull >= PTR_THRESHOLD){
      ptrSet(true, "Release to refresh", `${pct}%`);
      ptrTriggered = true;
    }else{
      ptrSet(true, "Pull to refresh", `${pct}%`);
      ptrTriggered = false;
    }
  }, {passive:false});

  screenArea.addEventListener("touchend", ()=>{
    if(!ptrActive) return;
    ptrActive = false;

    if(ptrTriggered){
      ptrSet(true, "Refreshing…", "");
      setTimeout(() => {
        try{ location.reload(); }catch{}
      }, 180);
    }else{
      ptrSet(false);
    }
    ptrTriggered = false;
  }, {passive:true});

  screenArea.addEventListener("touchcancel", ()=>{
    if(!ptrActive) return;
    ptrActive = false;
    ptrTriggered = false;
    ptrSet(false);
  }, {passive:true});

  // Install / Uninstall
  $("btnInstall").addEventListener("click", (e)=>{
    e.preventDefault();
    const mode = $("btnInstall").dataset.mode || "install";
    if(mode === "uninstall"){ uninstallGuidance(); return; }
    tryInstall();
  });

  // Init
  injectManifest();
  registerSW();

  $("logoVer").textContent = APP_VERSION;
  $("footerVer").textContent = APP_VERSION;
  updateInstallButton();
  snapToIndex(0, false);

  window.addEventListener("resize", () => {
    setDeckX(deckTargetXForIndex(deckIndex), false);
  });

})();
  </script>

  <!--
  Master Code — EOF Version Detail Notes
  App Version: v1.1A3
  Notes:
  - Embedded apps run inside their swipe panels via iframe.
  - Edge gutters capture left/right swipes so panels remain navigable on mobile.
  -->
</body>
</html>
