<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1324" />
  <title>Master Code</title>
  <link rel="manifest" id="manifestLink" href="#" />
  <style>
    :root{
      --bg0:#08101f;
      --bg1:#0b1324;
      --panel:#0c1528cc;
      --stroke:rgba(235,245,255,.16);
      --stroke2:rgba(235,245,255,.22);
      --strokeBold:rgba(180,210,255,.42);
      --text:rgba(235,245,255,.86);
      --muted:rgba(235,245,255,.58);
      --muted2:rgba(235,245,255,.42);
      --accentBorder: rgba(43,78,122,.85);
      --shadow:0 14px 40px rgba(0,0,0,.38);
      --radius:26px;
      --btnH:56px;
      --pad:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 0%, rgba(47,120,255,.22), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(155,120,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex;
      justify-content:center;
      padding: max(14px, env(safe-area-inset-top)) 12px max(14px, env(safe-area-inset-bottom));
      overflow:hidden;
    }

    .app{
      width:min(520px, 100%);
      height: 100%;
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:hidden;
    }

    .logoTitle{
      margin:4px 6px 0;
      display:flex;
      justify-content:center;
      align-items:center;
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .logoTitle svg{
      width:min(520px, 100%);
      height:auto;
      display:block;
    }

    .logoVer{
      margin: -4px 0 2px;
      text-align:center;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      color: rgba(235,245,255,.40);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .screenArea{
      position:relative;
      flex:1;
      overflow:hidden;
      border-radius: var(--radius);
      touch-action: pan-y;
    }

    .ptr{
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(235,245,255,.16);
      background: rgba(12,21,40,.86);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 34px rgba(0,0,0,.36);
      color: rgba(235,245,255,.84);
      font-weight: 900;
      font-size: 13px;
      letter-spacing: .2px;
      display:none;
      align-items:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: none;
    }
    .ptr.show{ display:flex; }
    .ptrDot{
      width:10px; height:10px;
      border-radius: 50%;
      background: rgba(47,120,255,.88);
      box-shadow: 0 0 0 4px rgba(47,120,255,.18);
      opacity:.95;
    }
    .ptrHint{ opacity:.90; }
    .ptrSmall{ opacity:.60; font-weight:850; }

    .deck{
      position:absolute;
      inset:0;
      display:flex;
      height:100%;
      transform: translate3d(0,0,0);
      will-change: transform;
    }
    .deck.anim{
      transition: transform 260ms cubic-bezier(.2,.9,.2,1);
    }

    .card{
      height: 100%;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:3px solid var(--accentBorder);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
      backdrop-filter: blur(10px);
      overflow:hidden;
      touch-action: pan-y;
      position:relative;
    }

    #home.card{
      border:none;
      box-shadow:none;
      background: transparent;
      backdrop-filter: none;
      padding: 0;
    }

    .hidden{ display:none !important; }

    .btn{
      height:var(--btnH);
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color:rgba(235,245,255,.78);
      font-weight:700;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 18px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-size:18px;
      touch-action: manipulation;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(47,120,255,.92), rgba(47,120,255,.72));
      border-color: rgba(120,170,255,.55);
      color: rgba(235,245,255,.90);
      font-weight: 900;
    }
    .btn.tight{
      height: 48px;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .btn:disabled{
      opacity:.55;
      filter:saturate(.85);
      transform:none !important;
      pointer-events:none;
    }

    .label{
      font-size:15px;
      color:var(--muted);
      font-weight:750;
      margin: 10px 4px 6px;
    }
    .subtle{
      font-size:14px;
      color:var(--muted2);
      margin: 6px 4px 0;
      line-height:1.25;
    }

    .homeScroll{
      height:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 0 10px;
      touch-action: pan-y;
      overscroll-behavior: contain;
    }

    .homeShell{
      margin: 10px 12px 0;
      border-radius: var(--radius);
      border:3px solid var(--accentBorder);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      padding: var(--pad);
      backdrop-filter: blur(10px);
    }

    .homeTitle{
      font-size: 26px;
      font-weight: 950;
      letter-spacing: .2px;
      margin: 2px 2px 6px;
      color: rgba(235,245,255,.92);
    }
    .homeHint{
      margin: 0 2px 10px;
      color: rgba(235,245,255,.54);
      font-size: 14px;
      line-height: 1.25;
    }

    .appGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin: 12px 0 0;
    }
    .appGrid .btn{ width:100%; }
    .appGrid .btn.wide{ grid-column: 1 / -1; }

    .actionRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }

    .footerTiny{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: rgba(235,245,255,.40);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .infoCard{
      border:1px solid rgba(235,245,255,.12);
      background: rgba(0,0,0,.10);
      border-radius: 18px;
      padding: 12px;
      color: rgba(235,245,255,.84);
      line-height: 1.3;
    }

    .touchLock{
      position:fixed;
      inset:0;
      z-index: 9997;
      background: transparent;
      pointer-events:none;
    }
    .touchLock.on{ pointer-events:auto; }

    .modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: max(16px, env(safe-area-inset-top)) 14px max(16px, env(safe-area-inset-bottom));
      background: rgba(0,0,0,.56);
      z-index: 9998;
      touch-action: none;
    }
    .modal.hidden{ display:none; }

    .modalCard{
      width:min(520px, 100%);
      border-radius: 26px;
      border: 3px solid var(--accentBorder);
      background: linear-gradient(180deg, rgba(12,21,40,.96), rgba(8,16,31,.96));
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 16px;
      backdrop-filter: blur(10px);
      max-height: calc(100vh - 60px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalTitle{
      font-weight: 950;
      letter-spacing: .2px;
      color: rgba(235,245,255,.92);
      font-size: clamp(22px, 6.5vw, 34px);
      line-height: 1.05;
      margin: 4px 2px 10px;
    }
    .modalSub{
      color: rgba(235,245,255,.78);
      font-size: 15px;
      margin: 0 2px 12px;
      white-space: pre-wrap;
      line-height: 1.28;
    }
    .modalBtns{
      display:flex;
      gap:12px;
      margin-top: 10px;
      flex-wrap:wrap;
    }
    .modalBtns .btn{
      flex:1;
      height: 54px;
      font-size: 18px;
      font-weight: 900;
      min-width: 140px;
    }

    .xCloseRow{
      display:flex;
      justify-content:flex-end;
      margin: -6px -6px 6px;
    }
    .xBtn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      color: rgba(235,245,255,.82);
      font-weight: 950;
      font-size: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
  <div class="touchLock" id="touchLock"></div>

  <div class="app" id="appRoot">
    <div class="logoTitle" aria-label="Master Code">
      <svg viewBox="0 0 900 140" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Master Code">
        <defs>
          <linearGradient id="mcG" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%" stop-color="#8a6bff"/>
            <stop offset="55%" stop-color="#4fa3ff"/>
            <stop offset="100%" stop-color="#2f78ff"/>
          </linearGradient>
          <filter id="mcS" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="rgba(0,0,0,.35)"/>
          </filter>
        </defs>
        <g transform="translate(46 24)" filter="url(#mcS)">
          <rect x="0" y="0" width="92" height="92" rx="26" fill="rgba(255,255,255,.06)" stroke="rgba(235,245,255,.22)" stroke-width="2"/>
          <path d="M22 60 C30 46, 42 40, 56 40 C70 40, 82 46, 90 60"
                transform="translate(-2 0)"
                fill="none" stroke="url(#mcG)" stroke-width="6" stroke-linecap="round"/>
          <path d="M26 70 L66 70" fill="none" stroke="rgba(235,245,255,.86)" stroke-width="6" stroke-linecap="round"/>
          <path d="M34 52 L34 88" fill="none" stroke="rgba(235,245,255,.70)" stroke-width="5" stroke-linecap="round"/>
          <path d="M46 46 L46 92" fill="none" stroke="rgba(235,245,255,.84)" stroke-width="5" stroke-linecap="round"/>
          <path d="M58 52 L58 88" fill="none" stroke="rgba(235,245,255,.70)" stroke-width="5" stroke-linecap="round"/>
        </g>
        <text x="160" y="92"
          font-family="system-ui,Segoe UI,Roboto,Helvetica,Arial"
          font-size="66"
          font-weight="900"
          fill="url(#mcG)"
          letter-spacing=".6"
          filter="url(#mcS)">Master Code</text>
      </svg>
    </div>

    <div class="logoVer" id="logoVer">v—</div>

    <div class="screenArea" id="screenArea">
      <div class="ptr" id="ptr">
        <div class="ptrDot"></div>
        <div class="ptrHint" id="ptrHint">Pull to refresh</div>
        <div class="ptrSmall" id="ptrSmall"></div>
      </div>

      <div class="deck" id="deck">
        <div id="home" class="card">
          <div class="homeScroll" id="homeScroll">
            <div class="homeShell">
              <div class="homeTitle">Launch Pad</div>
              <div class="homeHint">
                Tap an app to open it. Swipe left/right to switch panels. Pull down to refresh.
              </div>

              <div class="label">Apps</div>
              <div class="appGrid">
                <button class="btn primary wide" id="btnVitals">Vitals Tracker</button>
                <button class="btn" id="btnAngel">Angel Code (AN)</button>
                <button class="btn" id="btnBirthday">Birthday Code (BC)</button>
                <button class="btn" id="btnGlucose">Glucose Tracker (DB)</button>
                <button class="btn primary wide" id="btnCompat">Compatibility Code (CC)</button>
              </div>

              <div class="label">Actions</div>
              <div class="actionRow">
                <button class="btn" id="btnInstall">Install</button>
                <button class="btn tight" id="btnHelp">Help</button>
              </div>

              <div class="footerTiny">
                <div id="homeVerLabel">v—</div>
                <div>developed by Keyth Jyles</div>
              </div>
            </div>
          </div>
        </div>

        <div id="panelInfo" class="card">
          <div class="label" style="margin-top:0;">How this works</div>
          <div class="infoCard">
            <div style="font-weight:950; margin-bottom:8px;">Master Code is a local launcher.</div>
            <div style="margin-bottom:10px;">
              It does not store your data. Each app (Vitals / Angel / Birthday / Glucose / Compatibility) keeps its own local storage inside its own folder.
            </div>
            <div style="margin-bottom:10px;">
              If a button opens the wrong place, your folder path is the only thing to adjust:
              <div style="margin-top:8px; opacity:.92; white-space:pre-wrap;">
• Vitals: ../index.html
• Angel Code: ../AN/
• Birthday Code: ../BC/
• Glucose: ../DB/
• Compatibility: ../CC/
              </div>
            </div>
            <div class="subtle">Swipe right to return to Home. Swipe left for Quick Links.</div>
          </div>

          <div class="label">Navigation</div>
          <div class="infoCard">
            <div style="white-space:pre-wrap; opacity:.92;">
• Vertical scroll: inside a panel
• Horizontal swipe: switch panels
• Pull down at top: refresh
            </div>
          </div>

          <div class="footerTiny">
            <div id="infoVerLabel">v—</div>
            <div>Master Code</div>
          </div>
        </div>

        <div id="panelLinks" class="card">
          <div class="label" style="margin-top:0;">Quick Links</div>
          <div class="infoCard" style="margin-bottom:12px;">
            <div style="font-weight:950; margin-bottom:8px;">Open a specific app:</div>
            <div class="appGrid" style="margin:0;">
              <button class="btn primary wide" id="btnVitals2">Vitals Tracker</button>
              <button class="btn" id="btnAngel2">Angel Code</button>
              <button class="btn" id="btnBirthday2">Birthday Code</button>
              <button class="btn" id="btnGlucose2">Glucose Tracker</button>
              <button class="btn primary wide" id="btnCompat2">Compatibility Code</button>
            </div>
          </div>

          <div class="label">Install status</div>
          <div class="infoCard">
            <div id="installStatus" style="white-space:pre-wrap; opacity:.92;">—</div>
            <div class="subtle">Install visibility depends on what Chrome offers on your device.</div>
          </div>

          <div class="footerTiny">
            <div id="linksVerLabel">v—</div>
            <div>developed by Keyth Jyles</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="infoModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <div class="modalCard">
      <div class="xCloseRow">
        <button class="xBtn" id="btnInfoX" aria-label="Close">×</button>
      </div>
      <div class="modalTitle" id="infoTitle">Help</div>
      <div class="modalSub" id="infoSub">—</div>
      <div class="modalBtns">
        <button id="btnInfoOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <script>
(() => {
  "use strict";

  const APP_VERSION = "v1.1A1";

  const $ = (id) => document.getElementById(id);

  const PANEL_IDS = ["home","panelInfo","panelLinks"];
  const panelCount = PANEL_IDS.length;

  function setDeckLayout(){
    const deck = $("deck");
    if(!deck) return;
    deck.style.width = (panelCount * 100) + "%";
    for(const id of PANEL_IDS){
      const el = $(id);
      if(!el) continue;
      el.style.flex = `0 0 ${100 / panelCount}%`;
      el.style.width = `${100 / panelCount}%`;
    }
  }

  function isStandalone(){
    try{
      if(window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) return true;
      if(window.navigator && "standalone" in window.navigator && window.navigator.standalone) return true;
    }catch{}
    return false;
  }

  let deferredInstallPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;
    updateInstallButton();
    renderInstallStatus();
  });

  window.addEventListener("appinstalled", () => {
    deferredInstallPrompt = null;
    updateInstallButton(true);
    renderInstallStatus();
  });

  async function tryInstall(){
    if(!deferredInstallPrompt){
      openInfo("Install", "Install is only available when your browser offers it.\n\nTip: In Chrome, use menu ⋮ → Install app (if shown).");
      return;
    }
    try{
      deferredInstallPrompt.prompt();
      await deferredInstallPrompt.userChoice;
    }catch{}
    deferredInstallPrompt = null;
    updateInstallButton();
    renderInstallStatus();
  }

  function uninstallGuidance(){
    const msg =
      "To uninstall the app:\n\n" +
      "Android:\n" +
      "• Long-press the app icon → Uninstall\n" +
      "or\n" +
      "• Settings → Apps → Master Code → Uninstall\n\n" +
      "iPhone/iPad:\n" +
      "• Long-press the app icon → Remove App\n\n" +
      "If you installed from Chrome, removing the app icon uninstalls the PWA.";
    openInfo("Uninstall", msg);
  }

  function updateInstallButton(installedMaybe=false){
    const btn = $("btnInstall");
    if(!btn) return;

    const standaloneNow = installedMaybe || isStandalone();

    if(standaloneNow){
      btn.dataset.mode = "uninstall";
      btn.disabled = false;
      btn.textContent = "Uninstall";
      return;
    }

    btn.dataset.mode = "install";
    btn.textContent = "Install";
    btn.disabled = !deferredInstallPrompt;
  }

  function renderInstallStatus(){
    const el = $("installStatus");
    if(!el) return;

    const standaloneNow = isStandalone();
    const offered = !!deferredInstallPrompt;

    let s = "";
    s += `App Version: ${APP_VERSION}\n`;
    s += `Installed (standalone): ${standaloneNow ? "Yes" : "No"}\n`;
    s += `Install prompt available: ${offered ? "Yes" : "No"}\n\n`;
    s += "If Install prompt is No:\n";
    s += "• Use Chrome menu ⋮ and look for Install app.\n";
    s += "• Or Add to Home screen (if offered).\n";
    s += "• Some devices/browsers do not offer PWA install for all pages.\n";
    el.textContent = s;
  }

  function openInfo(title, message){
    $("infoTitle").textContent = title || "Info";
    $("infoSub").textContent = message || "—";
    $("infoModal").classList.remove("hidden");
    lockTouches(120);
  }
  function closeInfo(){
    $("infoModal").classList.add("hidden");
    unlockTouches();
  }

  $("btnInfoX").addEventListener("click", (e)=>{ e.preventDefault(); closeInfo(); });
  $("btnInfoOk").addEventListener("click", (e)=>{ e.preventDefault(); closeInfo(); });
  $("infoModal").addEventListener("click", (e)=>{ if(e.target === $("infoModal")) closeInfo(); });

  let lockTimer = null;
  function lockTouches(ms=140){
    const el = $("touchLock");
    el.classList.add("on");
    if(lockTimer) clearTimeout(lockTimer);
    lockTimer = setTimeout(() => el.classList.remove("on"), ms);
  }
  function unlockTouches(){
    const el = $("touchLock");
    el.classList.remove("on");
    if(lockTimer) clearTimeout(lockTimer);
    lockTimer = null;
  }

  function navigateTo(path){
    try{ location.href = path; }catch{}
  }

  function wireLaunchButtons(){
    const toVitals = () => navigateTo("../index.html");
    const toAN     = () => navigateTo("../AN/");
    const toBC     = () => navigateTo("../BC/");
    const toDB     = () => navigateTo("../DB/");
    const toCC     = () => navigateTo("../CC/");

    $("btnVitals").addEventListener("click", toVitals);
    $("btnAngel").addEventListener("click", toAN);
    $("btnBirthday").addEventListener("click", toBC);
    $("btnGlucose").addEventListener("click", toDB);
    $("btnCompat").addEventListener("click", toCC);

    $("btnVitals2").addEventListener("click", toVitals);
    $("btnAngel2").addEventListener("click", toAN);
    $("btnBirthday2").addEventListener("click", toBC);
    $("btnGlucose2").addEventListener("click", toDB);
    $("btnCompat2").addEventListener("click", toCC);

    $("btnHelp").addEventListener("click", (e)=>{
      e.preventDefault();
      openInfo(
        "Help",
        "Master Code is a launcher.\n\n" +
        "If an app does not open:\n" +
        "• Confirm your folder names: AN, BC, DB, CC, MC\n" +
        "• Confirm the buttons point to:\n" +
        "  Vitals: ../index.html\n" +
        "  AN: ../AN/\n" +
        "  BC: ../BC/\n" +
        "  DB: ../DB/\n" +
        "  CC: ../CC/\n\n" +
        "Swipe panels left/right. Pull down at top to refresh."
      );
    });

    $("btnInstall").addEventListener("click", (e)=>{
      e.preventDefault();
      const mode = $("btnInstall").dataset.mode || "install";
      if(mode === "uninstall"){ uninstallGuidance(); return; }
      tryInstall();
    });
  }

  const deck = $("deck");
  const screenArea = $("screenArea");

  let deckIndex = 0;
  let dragging = false;
  let intent = null;
  let x0=0, y0=0;
  let baseX=0;
  let lastX=0, lastT=0;
  let vx=0;

  function getWidth(){
    return screenArea.clientWidth || window.innerWidth;
  }

  function deckTargetXForIndex(idx){
    const w = getWidth();
    return -idx * w;
  }

  function setDeckX(px, animate=false){
    if(animate) deck.classList.add("anim");
    else deck.classList.remove("anim");
    deck.style.transform = `translate3d(${px}px,0,0)`;
  }

  function snapToIndex(idx, animate=true){
    idx = Math.max(0, Math.min(panelCount-1, idx));
    deckIndex = idx;
    setDeckX(deckTargetXForIndex(deckIndex), animate);
    try{ document.activeElement?.blur(); }catch{}
  }

  function swipeBlockedByModal(){
    const el = $("infoModal");
    return el && !el.classList.contains("hidden");
  }

  function isInteractiveTarget(target){
    if(!target || !target.closest) return false;
    if(target.closest("input, textarea, select, button")) return true;
    if(target.closest(".modalCard, .modal")) return true;
    return false;
  }

  function onTouchStart(ev){
    if(swipeBlockedByModal()) return;
    if(!(ev.touches && ev.touches.length === 1)) return;
    const target = ev.target;
    if(isInteractiveTarget(target)) return;

    dragging = true;
    intent = null;
    x0 = ev.touches[0].clientX;
    y0 = ev.touches[0].clientY;

    baseX = deckTargetXForIndex(deckIndex);
    setDeckX(baseX, false);

    lastX = x0;
    lastT = performance.now();
    vx = 0;
  }

  function onTouchMove(ev){
    if(!dragging) return;
    if(!(ev.touches && ev.touches.length === 1)) return;

    const x = ev.touches[0].clientX;
    const y = ev.touches[0].clientY;
    const dx = x - x0;
    const dy = y - y0;

    if(!intent){
      const ax = Math.abs(dx);
      const ay = Math.abs(dy);
      if(ax > 14 && ax > ay + 10){
        intent = "h";
      }else if(ay > 14 && ay > ax + 8){
        dragging = false;
        intent = null;
        return;
      }else{
        return;
      }
    }

    if(intent !== "h") return;
    ev.preventDefault();

    const w = getWidth();
    let nextX = baseX + dx;

    const minX = -w * (panelCount - 1);
    const maxX = 0;

    if(nextX > maxX){
      const over = nextX - maxX;
      nextX = maxX + over * 0.22;
    }else if(nextX < minX){
      const over = nextX - minX;
      nextX = minX + over * 0.22;
    }

    const now = performance.now();
    const dt = Math.max(1, now - lastT);
    const instV = (x - lastX) / dt;
    vx = vx * 0.75 + instV * 0.25;
    lastX = x;
    lastT = now;

    setDeckX(nextX, false);
  }

  function onTouchEnd(){
    if(!dragging) return;
    dragging = false;

    const w = getWidth();
    const matrix = deck.style.transform || "";
    const m = /translate3d\(([-\d.]+)px/.exec(matrix);
    const curX = m ? Number(m[1]) : deckTargetXForIndex(deckIndex);

    const progress = (-curX) / w;

    const fling = vx;
    const FLING_V = 0.65;

    let target = deckIndex;
    if(Math.abs(fling) > FLING_V){
      if(fling < 0) target = Math.min(panelCount-1, deckIndex + 1);
      else target = Math.max(0, deckIndex - 1);
    }else{
      target = Math.round(progress);
      target = Math.max(0, Math.min(panelCount-1, target));
    }

    snapToIndex(target, true);
  }

  function attachSmoothSwipe(){
    screenArea.addEventListener("touchstart", onTouchStart, {passive:true});
    screenArea.addEventListener("touchmove", onTouchMove, {passive:false});
    screenArea.addEventListener("touchend", onTouchEnd, {passive:true});
    screenArea.addEventListener("touchcancel", onTouchEnd, {passive:true});
  }

  const PTR_THRESHOLD = 225;
  const PTR_MAX = Math.max(260, PTR_THRESHOLD + 35);

  let ptrActive = false;
  let ptrTriggered = false;
  let ptrStartY = 0;
  let ptrStartX = 0;

  function ptrSet(show, hint, small){
    const el = $("ptr");
    if(show) el.classList.add("show");
    else el.classList.remove("show");
    $("ptrHint").textContent = hint || "Pull to refresh";
    $("ptrSmall").textContent = small || "";
  }

  function currentScrollEl(){
    if(deckIndex === 0) return $("homeScroll");
    return $(PANEL_IDS[deckIndex]);
  }

  function canPtrStart(target){
    if(swipeBlockedByModal()) return false;
    if(target && target.closest && target.closest("input, textarea, select, button")) return false;

    const sc = currentScrollEl();
    if(!sc) return false;

    if(sc === $("homeScroll")) return sc.scrollTop <= 0;

    return sc.scrollTop <= 0;
  }

  function attachPullToRefresh(){
    screenArea.addEventListener("touchstart", (e)=>{
      if(!(e.touches && e.touches.length === 1)) return;
      const target = e.target;
      if(!canPtrStart(target)) return;

      ptrActive = true;
      ptrTriggered = false;
      ptrStartY = e.touches[0].clientY;
      ptrStartX = e.touches[0].clientX;
      ptrSet(true, "Pull to refresh", "");
    }, {passive:true});

    screenArea.addEventListener("touchmove", (e)=>{
      if(!ptrActive) return;
      if(!(e.touches && e.touches.length === 1)) return;

      const x = e.touches[0].clientX;
      const y = e.touches[0].clientY;
      const dy = y - ptrStartY;
      const dx = x - ptrStartX;

      if(Math.abs(dx) > 14 && Math.abs(dx) > Math.abs(dy) + 10){
        ptrActive = false;
        ptrTriggered = false;
        ptrSet(false);
        return;
      }

      if(dy <= 0){
        ptrSet(false);
        ptrTriggered = false;
        return;
      }

      e.preventDefault();

      const pull = Math.min(PTR_MAX, dy);
      const pct = Math.max(0, Math.min(100, Math.round((pull / PTR_THRESHOLD) * 100)));

      if(pull >= PTR_THRESHOLD){
        ptrSet(true, "Release to refresh", `${pct}%`);
        ptrTriggered = true;
      }else{
        ptrSet(true, "Pull to refresh", `${pct}%`);
        ptrTriggered = false;
      }
    }, {passive:false});

    screenArea.addEventListener("touchend", ()=>{
      if(!ptrActive) return;
      ptrActive = false;

      if(ptrTriggered){
        ptrSet(true, "Refreshing…", "");
        setTimeout(() => {
          try{ location.reload(); }catch{}
        }, 180);
      }else{
        ptrSet(false);
      }
      ptrTriggered = false;
    }, {passive:true});

    screenArea.addEventListener("touchcancel", ()=>{
      if(!ptrActive) return;
      ptrActive = false;
      ptrTriggered = false;
      ptrSet(false);
    }, {passive:true});
  }

  function injectManifest(){
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#8a6bff"/>
      <stop offset="55%" stop-color="#2f78ff"/>
      <stop offset="100%" stop-color="#0b1324"/>
    </linearGradient>
  </defs>
  <rect width="512" height="512" rx="110" fill="url(#g)"/>
  <path d="M120 312 C170 225, 250 190, 320 190 C390 190, 450 225, 470 312" fill="none" stroke="rgba(235,245,255,.92)" stroke-width="26" stroke-linecap="round"/>
  <path d="M160 350 L352 350" fill="none" stroke="rgba(235,245,255,.86)" stroke-width="26" stroke-linecap="round"/>
</svg>`;
    const encoded = encodeURIComponent(svg).replace(/'/g,"%27").replace(/"/g,"%22");
    const icon = `data:image/svg+xml;charset=utf-8,${encoded}`;

    const manifest = {
      name: "Master Code",
      short_name: "MasterCode",
      start_url: ".",
      display: "standalone",
      background_color: "#0b1324",
      theme_color: "#0b1324",
      icons: [{ src: icon, sizes: "512x512", type: "image/svg+xml", purpose: "any" }]
    };

    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    $("manifestLink").setAttribute("href", url);
  }

  async function registerSW(){
    if(!("serviceWorker" in navigator)) return;
    const swCode =
`self.addEventListener('install', (e)=>{ self.skipWaiting(); });
self.addEventListener('activate', (e)=>{ e.waitUntil(self.clients.claim()); });
self.addEventListener('fetch', (e)=>{ });`;
    const blob = new Blob([swCode], {type:"text/javascript"});
    const swUrl = URL.createObjectURL(blob);
    try { await navigator.serviceWorker.register(swUrl); } catch {}
  }

  function applyVersionLabels(){
    $("logoVer").textContent = APP_VERSION;
    $("homeVerLabel").textContent = APP_VERSION;
    $("infoVerLabel").textContent = APP_VERSION;
    $("linksVerLabel").textContent = APP_VERSION;
  }

  injectManifest();
  registerSW();

  setDeckLayout();
  applyVersionLabels();

  wireLaunchButtons();
  attachSmoothSwipe();
  attachPullToRefresh();

  updateInstallButton();
  renderInstallStatus();

  snapToIndex(0, false);

  window.addEventListener("resize", () => {
    setDeckLayout();
    setDeckX(deckTargetXForIndex(deckIndex), false);
  });

})();
  </script>

  <div style="display:none" aria-hidden="true">Master Code v1.1A1</div>
</body>
</html>
